{% extends "layout/base.html" %}

{% block content %}
<h1 class="mb-4">üõí Neue Bestellung</h1>

<form method="post" id="bestellungForm">
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Grunddaten</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label"><strong>Lieferant:</strong> <span class="text-danger">*</span></label>
                    <select name="lieferant_id" class="form-select" required id="lieferantSelect">
                        <option value="">-- Bitte w√§hlen --</option>
                        {% for l in lieferanten %}
                        <option value="{{ l.ID }}">{{ l.Name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-12">
                    <label class="form-label"><strong>Bemerkung:</strong></label>
                    <textarea name="bemerkung" class="form-control" rows="2" placeholder="Optionale Bemerkung zur Bestellung"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Positionen</h5>
        </div>
        <div class="card-body">
            <div id="positionenContainer">
            </div>
            <div id="emptyMessage" class="alert alert-info">
                <i class="bi bi-info-circle"></i> Bitte f√ºgen Sie mindestens eine Position hinzu.
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-success" onclick="addPosition()">
                    <i class="bi bi-plus-circle"></i> Position hinzuf√ºgen
                </button>
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">üëÅÔ∏è Sichtbarkeit (optional)</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">W√§hlen Sie optional die Abteilungen aus, die diese Bestellung sehen k√∂nnen. Wenn keine Abteilung ausgew√§hlt wird, wird automatisch Ihre Prim√§rabteilung verwendet:</p>
            {% for gruppe in auswaehlbare_abteilungen %}
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           name="sichtbare_abteilungen" 
                           value="{{ gruppe.parent.ID }}" 
                           id="abt_{{ gruppe.parent.ID }}"
                           {% if gruppe.parent.is_primaer %}checked{% endif %}>
                    <label class="form-check-label fw-bold" for="abt_{{ gruppe.parent.ID }}">
                        {{ gruppe.parent.Bezeichnung }}
                    </label>
                    {% if gruppe.parent.is_primaer %}
                    <small class="text-muted">(Prim√§rabteilung)</small>
                    {% endif %}
                </div>
                {% if gruppe.children %}
                <div class="mt-2">
                    {% for child in gruppe.children %}
                    <div class="form-check" style="margin-left: {{ (child.level + 1) * 1.5 }}rem;">
                        <input class="form-check-input" type="checkbox" 
                               name="sichtbare_abteilungen" 
                               value="{{ child.ID }}" 
                               id="abt_{{ child.ID }}">
                        <label class="form-check-label" for="abt_{{ child.ID }}">
                            {% for i in range(child.level + 1) %}‚Ü≥{% endfor %} {{ child.Bezeichnung }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="mb-3">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg"></i> Bestellung erstellen
        </button>
        <a href="{{ url_for('ersatzteile.bestellung_liste') }}" class="btn btn-secondary">
            <i class="bi bi-x-lg"></i> Abbrechen
        </a>
    </div>
</form>

<script>
function addPosition() {
    const container = document.getElementById('positionenContainer');
    const emptyMessage = document.getElementById('emptyMessage');
    
    const positionRow = document.createElement('div');
    positionRow.className = 'position-row mb-3 p-3 border rounded';
    positionRow.setAttribute('data-row-id', 'row-' + Date.now());
    positionRow.innerHTML = `
        <div class="row g-3">
            <div class="col-md-2">
                <label class="form-label">ErsatzteilID:</label>
                <div class="input-group">
                    <input type="number" name="ersatzteil_id[]" class="form-control ersatzteil-id-input" placeholder="Optional">
                    <button type="button" class="btn btn-outline-secondary btn-lookup" onclick="lookupErsatzteil(this)">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">Bestellnummer:</label>
                <input type="text" name="bestellnummer[]" class="form-control bestellnummer-display" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Bezeichnung:</label>
                <input type="text" name="bezeichnung[]" class="form-control bezeichnung-display" required>
            </div>
            <div class="col-md-1">
                <label class="form-label">Menge:</label>
                <input type="number" name="menge[]" class="form-control" value="1" min="1" required>
            </div>
            <div class="col-md-1">
                <label class="form-label">Einheit:</label>
                <input type="text" name="einheit[]" class="form-control einheit-display" value="St√ºck" placeholder="St√ºck">
            </div>
            <div class="col-md-2">
                <label class="form-label">Preis:</label>
                <input type="number" name="preis[]" class="form-control" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="col-md-1">
                <label class="form-label">W√§hrung:</label>
                <select name="waehrung[]" class="form-select">
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                    <option value="CHF">CHF</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Bemerkung:</label>
                <input type="text" name="position_bemerkung[]" class="form-control" placeholder="Optional...">
            </div>
            <div class="col-md-2">
                <label class="form-label">Link:</label>
                <input type="url" name="link[]" class="form-control link-display" placeholder="Optional">
            </div>
            <div class="col-md-1">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-danger w-100" onclick="removePosition(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(positionRow);
    emptyMessage.style.display = 'none';
}

function removePosition(button) {
    const row = button.closest('.position-row');
    row.remove();
    
    const container = document.getElementById('positionenContainer');
    if (container.children.length === 0) {
        document.getElementById('emptyMessage').style.display = 'block';
    }
}

function lookupErsatzteil(button) {
    const row = button.closest('.position-row');
    const ersatzteilInput = row.querySelector('.ersatzteil-id-input');
    const bestellnummerDisplay = row.querySelector('.bestellnummer-display');
    const bezeichnungDisplay = row.querySelector('.bezeichnung-display');
    const einheitDisplay = row.querySelector('.einheit-display');
    const linkDisplay = row.querySelector('.link-display');
    
    const ersatzteilId = ersatzteilInput.value.trim();
    
    // Wenn keine ID eingegeben, Modal √∂ffnen
    if (!ersatzteilId) {
        const lieferantSelect = document.getElementById('lieferantSelect');
        const lieferantId = lieferantSelect ? lieferantSelect.value : null;
        
        if (!lieferantId) {
            alert('Bitte w√§hlen Sie zuerst einen Lieferanten aus.');
            return;
        }
        
        // Modal √∂ffnen und Ersatzteile laden
        openErsatzteilModal(lieferantId, row);
        return;
    }
    
    // Button deaktivieren w√§hrend der Suche
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    // AJAX-Anfrage
    fetch(`{{ url_for('ersatzteile.api_ersatzteil_info', ersatzteil_id=0) }}`.replace('/0', `/${ersatzteilId}`))
        .then(response => response.json())
        .then(data => {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-right"></i>';
            
            if (data.success) {
                bestellnummerDisplay.value = data.bestellnummer;
                bezeichnungDisplay.value = data.bezeichnung;
                if (einheitDisplay && data.einheit) {
                    einheitDisplay.value = data.einheit;
                }
                if (linkDisplay && data.link) {
                    linkDisplay.value = data.link;
                }
                // Preis und W√§hrung √ºbernehmen, falls vorhanden
                const preisInput = row.querySelector('input[name="preis[]"]');
                const waehrungSelect = row.querySelector('select[name="waehrung[]"]');
                if (preisInput && data.preis) {
                    preisInput.value = data.preis;
                }
                if (waehrungSelect && data.waehrung) {
                    waehrungSelect.value = data.waehrung;
                }
                bestellnummerDisplay.classList.remove('is-invalid');
                bezeichnungDisplay.classList.remove('is-invalid');
                ersatzteilInput.classList.remove('is-invalid');
            } else {
                bestellnummerDisplay.value = '';
                bezeichnungDisplay.value = '';
                bestellnummerDisplay.classList.add('is-invalid');
                bezeichnungDisplay.classList.add('is-invalid');
                ersatzteilInput.classList.add('is-invalid');
                alert(data.message || 'Ersatzteil nicht gefunden.');
            }
        })
        .catch(error => {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-right"></i>';
            console.error('Fehler:', error);
            alert('Fehler beim Laden der Ersatzteil-Daten.');
        });
}

function openErsatzteilModal(lieferantId, targetRow) {
    const modal = new bootstrap.Modal(document.getElementById('ersatzteilModal'));
    const modalBody = document.getElementById('ersatzteilModalList');
    const currentRow = targetRow;
    
    // Modal-Body leeren und Ladeanzeige anzeigen
    modalBody.innerHTML = '<div class="text-center p-4"><div class="spinner-border" role="status"><span class="visually-hidden">L√§dt...</span></div></div>';
    
    // Suchfeld leeren
    const searchInput = document.getElementById('ersatzteilSearch');
    if (searchInput) {
        searchInput.value = '';
    }
    
    // Modal √∂ffnen
    modal.show();
    
    // Ersatzteile laden
    const apiUrl = `{{ url_for('ersatzteile.api_ersatzteile_lieferant', lieferant_id=0) }}`.replace('/0', `/${lieferantId}`);
    console.log('Lade Ersatzteile von:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            console.log('API Response Status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API Response Data:', data);
            if (data.success && data.ersatzteile && data.ersatzteile.length > 0) {
                // Speichere die urspr√ºngliche Liste f√ºr Filterung
                window.ersatzteilList = data.ersatzteile;
                
                // Rendere die Liste
                renderErsatzteilList(data.ersatzteile);
                
                // Suchfeld-Event-Listener hinzuf√ºgen
                const searchInput = document.getElementById('ersatzteilSearch');
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        filterErsatzteilList(this.value);
                    });
                    // Fokus auf Suchfeld setzen
                    searchInput.focus();
                }
            } else {
                modalBody.innerHTML = '<div class="alert alert-info">Keine Ersatzteile f√ºr diesen Lieferanten gefunden.</div>';
            }
        })
        .catch(error => {
            console.error('Fehler beim Laden der Ersatzteile:', error);
            console.error('Error details:', {
                message: error.message,
                stack: error.stack,
                name: error.name
            });
            modalBody.innerHTML = `<div class="alert alert-danger">
                <strong>Fehler beim Laden der Ersatzteile:</strong><br>
                ${error.message || 'Unbekannter Fehler'}
            </div>`;
        });
    
    // Speichere die aktuelle Zeile f√ºr die Auswahl
    document.getElementById('ersatzteilModal').setAttribute('data-target-row-id', currentRow.getAttribute('data-row-id') || '');
}

// Funktion zum Rendern der Ersatzteil-Liste
function renderErsatzteilList(ersatzteile) {
    const modalBody = document.getElementById('ersatzteilModalList');
    if (!modalBody) return;
    
    if (ersatzteile.length === 0) {
        modalBody.innerHTML = '<div class="alert alert-info">Keine Ersatzteile gefunden.</div>';
        return;
    }
    
    let html = '<div class="list-group">';
    ersatzteile.forEach(ersatzteil => {
        const bestandText = `${ersatzteil.bestand || 0} ${ersatzteil.einheit || ''}`.trim();
        // Sicherstellen, dass alle Werte korrekt escaped sind
        const preisValue = (ersatzteil.preis != null && ersatzteil.preis !== undefined) ? ersatzteil.preis : 'null';
        const waehrungValue = (ersatzteil.waehrung || 'EUR').replace(/'/g, "\\'");
        const bestellnummerEscaped = (ersatzteil.bestellnummer || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const bezeichnungEscaped = (ersatzteil.bezeichnung || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        html += `
            <a href="#" class="list-group-item list-group-item-action" onclick="selectErsatzteil(${ersatzteil.id}, '${bestellnummerEscaped}', '${bezeichnungEscaped}', ${preisValue}, '${waehrungValue}', event)">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${ersatzteil.bestellnummer || 'Keine Bestellnummer'}</h6>
                    <small>${bestandText}</small>
                </div>
                <p class="mb-1">${ersatzteil.bezeichnung || 'Keine Bezeichnung'}</p>
                <small>ID: ${ersatzteil.id}</small>
            </a>
        `;
    });
    html += '</div>';
    modalBody.innerHTML = html;
}

// Funktion zum Filtern der Ersatzteil-Liste
function filterErsatzteilList(searchTerm) {
    if (!window.ersatzteilList) return;
    
    const term = searchTerm.toLowerCase().trim();
    
    if (term === '') {
        // Wenn leer, alle anzeigen
        renderErsatzteilList(window.ersatzteilList);
        return;
    }
    
    // Filtere die Liste
    const filtered = window.ersatzteilList.filter(ersatzteil => {
        const bestellnummer = (ersatzteil.bestellnummer || '').toLowerCase();
        const bezeichnung = (ersatzteil.bezeichnung || '').toLowerCase();
        const id = ersatzteil.id.toString();
        
        return bestellnummer.includes(term) || 
               bezeichnung.includes(term) || 
               id.includes(term);
    });
    
    renderErsatzteilList(filtered);
}

function selectErsatzteil(id, bestellnummer, bezeichnung, preis, waehrung, event) {
    try {
        console.log('selectErsatzteil aufgerufen:', {id, bestellnummer, bezeichnung, preis, waehrung});
        
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const modalElement = document.getElementById('ersatzteilModal');
        if (!modalElement) {
            console.error('Modal-Element nicht gefunden!');
            alert('Fehler: Modal-Element nicht gefunden.');
            return;
        }
        
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (!modal) {
            console.error('Modal-Instanz nicht gefunden!');
            alert('Fehler: Modal-Instanz nicht gefunden.');
            return;
        }
        
        const targetRowId = modalElement.getAttribute('data-target-row-id');
        console.log('Target Row ID:', targetRowId);
        
        // Finde die entsprechende Zeile
        let targetRow = null;
        if (targetRowId) {
            targetRow = document.querySelector(`[data-row-id="${targetRowId}"]`);
        } else {
            // Fallback: nehme die erste Positionen-Zeile
            targetRow = document.querySelector('.position-row');
        }
        
        if (!targetRow) {
            console.error('Target Row nicht gefunden!');
            alert('Fehler: Positionen-Zeile nicht gefunden.');
            modal.hide();
            return;
        }
        
        console.log('Target Row gefunden:', targetRow);
        
        const ersatzteilInput = targetRow.querySelector('.ersatzteil-id-input');
        const bestellnummerDisplay = targetRow.querySelector('.bestellnummer-display');
        const bezeichnungDisplay = targetRow.querySelector('.bezeichnung-display');
        const einheitDisplay = targetRow.querySelector('.einheit-display');
        const linkDisplay = targetRow.querySelector('.link-display');
        const preisInput = targetRow.querySelector('input[name="preis[]"]');
        const waehrungSelect = targetRow.querySelector('select[name="waehrung[]"]');
        
        console.log('Gefundene Inputs:', {
            ersatzteilInput: !!ersatzteilInput,
            bestellnummerDisplay: !!bestellnummerDisplay,
            bezeichnungDisplay: !!bezeichnungDisplay,
            einheitDisplay: !!einheitDisplay,
            linkDisplay: !!linkDisplay,
            preisInput: !!preisInput,
            waehrungSelect: !!waehrungSelect
        });
        
        if (ersatzteilInput) ersatzteilInput.value = id || '';
        if (bestellnummerDisplay) bestellnummerDisplay.value = bestellnummer || '';
        if (bezeichnungDisplay) bezeichnungDisplay.value = bezeichnung || '';
        if (preisInput && preis !== null && preis !== undefined && preis !== 'null') {
            preisInput.value = preis;
        }
        if (waehrungSelect && waehrung) {
            waehrungSelect.value = waehrung;
        }
        
        // Einheit und Link aus API laden
        if ((einheitDisplay || linkDisplay) && id) {
            fetch(`{{ url_for('ersatzteile.api_ersatzteil_info', ersatzteil_id=0) }}`.replace('/0', `/${id}`))
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (einheitDisplay && data.einheit) {
                            einheitDisplay.value = data.einheit;
                        }
                        if (linkDisplay && data.link) {
                            linkDisplay.value = data.link;
                        }
                    }
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Einheit/Link:', error);
                });
        }
        
        // Validierung entfernen
        if (bestellnummerDisplay) bestellnummerDisplay.classList.remove('is-invalid');
        if (bezeichnungDisplay) bezeichnungDisplay.classList.remove('is-invalid');
        if (ersatzteilInput) ersatzteilInput.classList.remove('is-invalid');
        
        console.log('Werte gesetzt, Modal wird geschlossen...');
        modal.hide();
        console.log('Modal geschlossen.');
    } catch (error) {
        console.error('Fehler in selectErsatzteil:', error);
        alert('Fehler beim Ausw√§hlen des Artikels: ' + error.message);
    }
}

// Enter-Taste f√ºr ErsatzteilID-Inputs
document.addEventListener('DOMContentLoaded', function() {
    // Event-Delegation f√ºr dynamisch hinzugef√ºgte Positionen
    document.getElementById('positionenContainer').addEventListener('keypress', function(e) {
        if (e.target.classList.contains('ersatzteil-id-input') && e.key === 'Enter') {
            e.preventDefault();
            const button = e.target.closest('.position-row').querySelector('.btn-lookup');
            if (button) {
                lookupErsatzteil(button);
            }
        }
    });
});
</script>

<!-- Modal f√ºr Ersatzteil-Auswahl -->
<div class="modal fade" id="ersatzteilModal" tabindex="-1" aria-labelledby="ersatzteilModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ersatzteilModalLabel">Ersatzteil ausw√§hlen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Suchfeld -->
                <div class="mb-3">
                    <input type="text" class="form-control" id="ersatzteilSearch" placeholder="üîç Suchen nach Bestellnummer, Bezeichnung oder ID..." autocomplete="off">
                </div>
                <div id="ersatzteilModalList">
                    <div class="text-center p-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">L√§dt...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

