{% extends "layout/base.html" %}

{% block styles %}
<style>
    .calculator-container {
        max-width: 400px;
        margin: 0 auto;
        touch-action: manipulation; /* Verhindert Double-Tap-Zoom f√ºr den gesamten Container */
    }
    
    .calculator-display {
        width: 100%;
        font-size: 2rem;
        text-align: right;
        padding: 1rem;
        border: 2px solid #dee2e6;
        border-radius: 0.5rem;
        background-color: #fff;
        margin-bottom: 1rem;
        min-height: 70px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        touch-action: manipulation; /* Verhindert Double-Tap-Zoom auch beim Display */
        user-select: none; /* Verhindert Textauswahl beim schnellen Tippen */
    }
    
    .calculator-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
    }
    
    .calculator-button {
        font-size: 1.5rem;
        padding: 1rem;
        border: 2px solid #dee2e6;
        border-radius: 0.5rem;
        background-color: #fff;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        touch-action: manipulation; /* Verhindert Double-Tap-Zoom */
        -webkit-tap-highlight-color: transparent; /* Entfernt Tap-Highlight */
    }
    
    .calculator-button:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
    }
    
    .calculator-button:active {
        background-color: #dee2e6;
        transform: scale(0.95);
    }
    
    .calculator-button.clear {
        background-color: #dc3545;
        color: white;
        border-color: #dc3545;
    }
    
    .calculator-button.clear:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }
    
    .calculator-button.submit {
        grid-column: span 3;
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
        font-size: 1.2rem;
    }
    
    .calculator-button.submit:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }
    
    .calculator-button.submit:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        cursor: not-allowed;
    }
    
    /* Mobile Optimierung */
    @media (max-width: 576px) {
        .calculator-display {
            font-size: 1.8rem;
            padding: 0.8rem;
            min-height: 60px;
        }
        
        .calculator-button {
            font-size: 1.3rem;
            padding: 0.8rem;
            min-height: 55px;
        }
        
        .calculator-button.submit {
            font-size: 1.1rem;
        }
    }
    
    /* Touch-Optimierung f√ºr mobile Ger√§te - bereits oben definiert */
    
    /* QR-Code Scanner Button */
    .qr-scanner-button {
        width: 100%;
        margin-bottom: 1rem;
        padding: 0.75rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    /* QR-Code Scanner Modal */
    #qrScannerModal .modal-body {
        padding: 1rem;
    }
    
    #qr-reader {
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
    }
    
    #qr-reader__dashboard {
        margin-top: 1rem;
    }
    
    #qr-reader__scan_region {
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    /* Scanner Video */
    #qr-reader video {
        width: 100%;
        height: auto;
        border-radius: 0.5rem;
    }
</style>
<!-- QR-Code Scanner Bibliothek -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
{% endblock %}

{% block content %}
<h1 class="mb-4">üîç Suche Artikel</h1>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="GET" action="{{ url_for('ersatzteile.suche_artikel') }}" id="searchForm">
            <div class="calculator-container">
                <button type="button" class="btn btn-primary qr-scanner-button" data-bs-toggle="modal" data-bs-target="#qrScannerModal">
                    <i class="bi bi-camera-fill"></i> QR-Code scannen
                </button>
                <div class="calculator-display" id="display">0</div>
                
                <div class="calculator-buttons">
                    <button type="button" class="calculator-button" data-number="1">1</button>
                    <button type="button" class="calculator-button" data-number="2">2</button>
                    <button type="button" class="calculator-button" data-number="3">3</button>
                    <button type="button" class="calculator-button" data-number="4">4</button>
                    <button type="button" class="calculator-button" data-number="5">5</button>
                    <button type="button" class="calculator-button" data-number="6">6</button>
                    <button type="button" class="calculator-button" data-number="7">7</button>
                    <button type="button" class="calculator-button" data-number="8">8</button>
                    <button type="button" class="calculator-button" data-number="9">9</button>
                    <button type="button" class="calculator-button clear" id="clearBtn">C</button>
                    <button type="button" class="calculator-button" data-number="0">0</button>
                    <button type="button" class="calculator-button" id="backspaceBtn">‚å´</button>
                    <button type="submit" class="calculator-button submit" id="submitBtn" disabled>Weiter ‚Üí</button>
                </div>
                
                <input type="hidden" name="artikelnummer" id="artikelnummerInput" value="">
            </div>
        </form>
    </div>
</div>

<div class="mb-3">
    <a href="{{ url_for('ersatzteile.ersatzteil_liste') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Zur√ºck zur Liste
    </a>
</div>

<!-- QR-Code Scanner Modal -->
<div class="modal fade" id="qrScannerModal" tabindex="-1" aria-labelledby="qrScannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="qrScannerModalLabel">
                    <i class="bi bi-camera-fill"></i> QR-Code scannen
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schlie√üen" id="closeScannerBtn"></button>
            </div>
            <div class="modal-body">
                <div id="qr-reader"></div>
                <div class="alert alert-info mt-3 mb-0">
                    <i class="bi bi-info-circle"></i> Richten Sie die Kamera auf den QR-Code des Ersatzteiletiketts.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const display = document.getElementById('display');
    const artikelnummerInput = document.getElementById('artikelnummerInput');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const backspaceBtn = document.getElementById('backspaceBtn');
    const numberButtons = document.querySelectorAll('.calculator-button[data-number]');
    
    let currentValue = '';
    
    function updateDisplay() {
        if (currentValue === '') {
            display.textContent = '0';
            submitBtn.disabled = true;
        } else {
            display.textContent = currentValue;
            submitBtn.disabled = false;
        }
        artikelnummerInput.value = currentValue;
    }
    
    // Zahl-Buttons
    numberButtons.forEach(button => {
        button.addEventListener('click', function() {
            const number = this.getAttribute('data-number');
            currentValue += number;
            updateDisplay();
        });
    });
    
    // Clear-Button
    clearBtn.addEventListener('click', function() {
        currentValue = '';
        updateDisplay();
    });
    
    // Backspace-Button
    backspaceBtn.addEventListener('click', function() {
        if (currentValue.length > 0) {
            currentValue = currentValue.slice(0, -1);
            updateDisplay();
        }
    });
    
    // Tastatur-Unterst√ºtzung
    document.addEventListener('keydown', function(e) {
        if (e.key >= '0' && e.key <= '9') {
            currentValue += e.key;
            updateDisplay();
        } else if (e.key === 'Backspace') {
            e.preventDefault();
            if (currentValue.length > 0) {
                currentValue = currentValue.slice(0, -1);
                updateDisplay();
            }
        } else if (e.key === 'Escape' || e.key === 'Delete') {
            currentValue = '';
            updateDisplay();
        } else if (e.key === 'Enter') {
            if (currentValue !== '') {
                document.getElementById('searchForm').submit();
            }
        }
    });
    
    // Initialisierung
    updateDisplay();
    
    // QR-Code Scanner
    let html5QrcodeScanner = null;
    const qrScannerModal = document.getElementById('qrScannerModal');
    const closeScannerBtn = document.getElementById('closeScannerBtn');
    
    // Pr√ºfen ob Html5Qrcode verf√ºgbar ist
    if (typeof Html5Qrcode === 'undefined') {
        console.error("Html5Qrcode Bibliothek nicht geladen");
        const qrButton = document.querySelector('.qr-scanner-button');
        if (qrButton) {
            qrButton.disabled = true;
            qrButton.title = "QR-Code Scanner nicht verf√ºgbar";
        }
    }
    
    // Scanner starten wenn Modal ge√∂ffnet wird
    qrScannerModal.addEventListener('shown.bs.modal', function() {
        if (typeof Html5Qrcode === 'undefined') {
            alert("QR-Code Scanner Bibliothek konnte nicht geladen werden. Bitte Seite neu laden.");
            const modalInstance = bootstrap.Modal.getInstance(qrScannerModal);
            modalInstance.hide();
            return;
        }
        
        if (!html5QrcodeScanner) {
            html5QrcodeScanner = new Html5Qrcode("qr-reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0,
                supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
            };
            
            html5QrcodeScanner.start(
                { facingMode: "environment" }, // R√ºckkamera bevorzugen
                config,
                function(decodedText, decodedResult) {
                    // QR-Code erfolgreich gescannt
                    console.log("QR-Code gescannt:", decodedText);
                    
                    // Nummer aus dem QR-Code extrahieren (kann URL oder nur Nummer sein)
                    let artikelnummer = decodedText.trim();
                    
                    // Falls es eine URL ist, versuche die ID zu extrahieren
                    // z.B. aus "https://example.com/ersatzteile/123" -> "123"
                    const urlMatch = artikelnummer.match(/\/(\d+)(?:\?|$|\/)/);
                    if (urlMatch) {
                        artikelnummer = urlMatch[1];
                    }
                    
                    // Nur Zahlen erlauben
                    artikelnummer = artikelnummer.replace(/\D/g, '');
                    
                    if (artikelnummer) {
                        // Scanner stoppen
                        html5QrcodeScanner.stop().then(() => {
                            html5QrcodeScanner.clear();
                        }).catch(err => {
                            console.error("Fehler beim Stoppen des Scanners:", err);
                        });
                        
                        // Nummer ins Eingabefeld √ºbernehmen
                        currentValue = artikelnummer;
                        updateDisplay();
                        
                        // Modal schlie√üen
                        const modalInstance = bootstrap.Modal.getInstance(qrScannerModal);
                        modalInstance.hide();
                        
                        // Optional: Automatisch suchen
                        // document.getElementById('searchForm').submit();
                    }
                },
                function(errorMessage) {
                    // Fehler ignorieren (wird bei jedem Frame aufgerufen wenn kein Code erkannt wird)
                }
            ).catch(err => {
                console.error("Fehler beim Starten des Scanners:", err);
                alert("Kamera konnte nicht gestartet werden. Bitte erlauben Sie den Zugriff auf die Kamera.");
            });
        }
    });
    
    // Scanner stoppen wenn Modal geschlossen wird
    qrScannerModal.addEventListener('hidden.bs.modal', function() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
            }).catch(err => {
                console.error("Fehler beim Stoppen des Scanners:", err);
                html5QrcodeScanner = null;
            });
        }
    });
    
    // Auch beim Klick auf Schlie√üen-Button
    closeScannerBtn.addEventListener('click', function() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
            }).catch(err => {
                console.error("Fehler beim Stoppen des Scanners:", err);
                html5QrcodeScanner = null;
            });
        }
    });
});
</script>
{% endblock %}

