{% extends "layout/base.html" %}
{% from "components/datei_liste.html" import datei_liste %}
{% from "components/datei_upload.html" import datei_upload %}

{% block content %}
<h1 class="mb-4">üîß Ersatzteil: {{ ersatzteil.Bezeichnung }}</h1>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üìã Ersatzteil-Details</h5>
        <div class="d-flex gap-2">
            {% if ersatzteil.LieferantID %}
            <button type="button" class="btn btn-sm btn-light" onclick="addToAngebotsanfrage({{ ersatzteil.ID }}, event)" title="Zu Angebotsanfrage hinzuf√ºgen">
                <i class="bi bi-cart-plus"></i> <span class="d-none d-sm-inline">Zu Angebotsanfrage</span>
            </button>
            {% endif %}
            <button class="btn btn-sm btn-light" type="button"
                    onclick="openQRCodeModal({{ ersatzteil.ID }})"
                    title="QR-Code anzeigen">
                <i class="bi bi-qr-code"></i> <span class="d-none d-sm-inline">QR-Code</span>
            </button>
            {% if 'admin' in session.get('user_berechtigungen', []) %}
            <a href="{{ url_for('ersatzteile.ersatzteil_neu', vorlage=ersatzteil.ID) }}" class="btn btn-sm btn-light" title="Als Vorlage f√ºr neuen Artikel verwenden">
                <i class="bi bi-copy"></i> <span class="d-none d-sm-inline">Als Vorlage verwenden</span>
            </a>
            <a href="{{ url_for('ersatzteile.ersatzteil_bearbeiten', ersatzteil_id=ersatzteil.ID) }}" class="btn btn-sm btn-light">
                <i class="bi bi-pencil"></i> <span class="d-none d-sm-inline">Bearbeiten</span>
            </a>
            <form method="POST" action="{{ url_for('ersatzteile.ersatzteil_loeschen', ersatzteil_id=ersatzteil.ID) }}" 
                  onsubmit="return confirm('Ersatzteil wirklich l√∂schen?');" class="d-inline">
                <button type="submit" class="btn btn-sm btn-light">
                    <i class="bi bi-trash"></i> <span class="d-none d-sm-inline">L√∂schen</span>
                </button>
            </form>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-sm table-borderless mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted"><strong>Artikelnummer:</strong></td>
                            <td>{% if ersatzteil.Kennzeichen %}
                                <span class="badge bg-info">{{ ersatzteil.Kennzeichen }}</span>
                                {% else %}
                                -
                                {% endif %}
                                <strong class="text-primary">{{ ersatzteil.ID }}</strong></td>
                        </tr>
                        <tr>
                            <td class="text-muted" style="width: 150px;"><strong>Bestellnummer:</strong></td>
                            <td><strong>{{ ersatzteil.Bestellnummer }}</strong></td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Kategorie:</strong></td>
                            <td>{{ ersatzteil.Kategorie or '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Bezeichnung:</strong></td>
                            <td>{{ ersatzteil.Bezeichnung }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Beschreibung:</strong></td>
                            <td>{{ ersatzteil.Beschreibung or '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Hersteller:</strong></td>
                            <td>{{ ersatzteil.Hersteller or '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Hersteller Art.Nr.:</strong></td>
                            <td>{{ ersatzteil.ArtikelnummerHersteller or '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Link:</strong></td>
                            <td>
                                {% if ersatzteil.Link %}
                                <div class="text-truncate" style="max-width: 400px;" title="{{ ersatzteil.Link }}">
                                    <a href="{{ ersatzteil.Link }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                                        <i class="bi bi-box-arrow-up-right"></i> <span class="text-truncate d-inline-block" style="max-width: 350px;">{{ ersatzteil.Link }}</span>
                                    </a>
                                </div>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Lieferant:</strong></td>
                            <td>
                                {% if ersatzteil.Lieferant %}
                                {{ ersatzteil.Lieferant }}
                                {% if ersatzteil.LieferantKontakt %}
                                <br><small class="text-muted">Kontakt: {{ ersatzteil.LieferantKontakt }}</small>
                                {% endif %}
                                {% if ersatzteil.LieferantTelefon %}
                                <br><small class="text-muted">Tel: {{ ersatzteil.LieferantTelefon }}</small>
                                {% endif %}
                                {% if ersatzteil.LieferantEmail %}
                                <br><small class="text-muted">Email: {{ ersatzteil.LieferantEmail }}</small>
                                {% endif %}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-sm table-borderless mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted" style="width: 150px;"><strong>Preis:</strong></td>
                            <td>
                                {% if ersatzteil.Preis %}
                                {{ "%.2f"|format(ersatzteil.Preis) }} {{ ersatzteil.Waehrung }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Lagerort:</strong></td>
                            <td>{{ ersatzteil.LagerortName or '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Lagerplatz:</strong></td>
                            <td>{{ ersatzteil.LagerplatzName or '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Bestand:</strong></td>
                            <td>
                                <span class="badge {% if not ersatzteil.EndOfLife and ersatzteil.Mindestbestand > 0 and ersatzteil.AktuellerBestand < ersatzteil.Mindestbestand %}bg-warning{% elif ersatzteil.AktuellerBestand > 0 %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                                    {{ ersatzteil.AktuellerBestand }} {{ ersatzteil.Einheit }}
                                </span>
                                {% if ersatzteil.Mindestbestand > 0 %}
                                <br><small class="text-muted">Mindestbestand: {{ ersatzteil.Mindestbestand }} {{ ersatzteil.Einheit }}</small>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Status:</strong></td>
                            <td>
                                {% if ersatzteil.Aktiv %}
                                <span class="badge bg-success">Aktiv</span>
                                {% else %}
                                <span class="badge bg-secondary">Inaktiv</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>End of Life:</strong></td>
                            <td>
                                {% if ersatzteil.EndOfLife %}
                                <span class="badge bg-danger">Ja</span>
                                {% else %}
                                <span class="badge bg-success">Nein</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Nachfolgeartikel:</strong></td>
                            <td>
                                {% if ersatzteil.NachfolgeartikelID %}
                                <a href="{{ url_for('ersatzteile.ersatzteil_detail', ersatzteil_id=ersatzteil.NachfolgeartikelID) }}" class="text-decoration-none">
                                    {{ ersatzteil.NachfolgeartikelNummer }} - {{ ersatzteil.NachfolgeartikelBezeichnung }}
                                </a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Erstellt von:</strong></td>
                            <td>{{ ersatzteil.ErstelltVon or '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Erstellt am:</strong></td>
                            <td>{{ ersatzteil.ErstelltAm[:16] if ersatzteil.ErstelltAm else '-' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        {% if zugriffe %}
        <hr>
        <div>
            <strong class="text-muted">Sichtbar f√ºr Abteilungen:</strong>
            {% for z in zugriffe %}
            <span class="badge bg-secondary me-1">{{ z.Bezeichnung }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Lagerbuchung -->
{% if 'artikel_buchen' in session.get('user_berechtigungen', []) or 'admin' in session.get('user_berechtigungen', []) %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">üì¶ Lagerbuchung</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('ersatzteile.lagerbuchung', ersatzteil_id=ersatzteil.ID) }}">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label"><strong>Typ:</strong></label>
                    <select name="typ" class="form-select" required id="buchungstyp">
                        <option value="Eingang">Eingang</option>
                        <option value="Ausgang" selected>Ausgang</option>
                        <option value="Inventur">Inventur</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label"><strong id="menge-label">Menge:</strong></label>
                    <input type="number" name="menge" class="form-control" min="1" required id="menge-input">
                    <small class="text-muted" id="menge-hinweis"></small>
                </div>
                <div class="col-md-3">
                    <label class="form-label"><strong>Kostenstelle:</strong></label>
                    <select name="kostenstelle_id" class="form-select">
                        <option value="">-- Keine --</option>
                        {% for k in kostenstellen %}
                        <option value="{{ k.ID }}">{{ k.Bezeichnung }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label"><strong>Thema ID:</strong></label>
                    <input type="number" name="thema_id" class="form-control" placeholder="z.B. 123" min="1">
                    <small class="text-muted">Optional: Thema-Nummer eingeben</small>
                </div>
                <div class="col-md-3">
                    <label class="form-label"><strong>Grund:</strong></label>
                    <input type="text" name="grund" class="form-control" placeholder="z.B. Manuell, Lieferung">
                </div>
                <div class="col-12">
                    <label class="form-label"><strong>Bemerkung:</strong></label>
                    <textarea name="bemerkung" class="form-control" rows="2"></textarea>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Buchung durchf√ºhren
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- Lagerbuchungen Historie -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">üìä Lagerbuchungen</h5>
    </div>
    <div class="card-body">
        {% if lagerbuchungen %}
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Typ</th>
                        <th>Menge</th>
                        <th>Preis</th>
                        <th>Grund</th>
                        <th>Kostenstelle</th>
                        <th>Thema</th>
                        <th>Von</th>
                        <th>Bemerkung</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lb in lagerbuchungen %}
                    <tr>
                        <td>{{ lb.Buchungsdatum[:16] if lb.Buchungsdatum else '-' }}</td>
                        <td>
                            <span class="badge {% if lb.Typ == 'Eingang' %}bg-success{% elif lb.Typ == 'Inventur' %}bg-info{% else %}bg-danger{% endif %}">
                                {{ lb.Typ }}
                            </span>
                        </td>
                        <td>{{ lb.Menge }}</td>
                        <td>
                            {% if lb.Preis %}
                            {{ "%.2f"|format(lb.Preis) }} {{ lb.Waehrung or 'EUR' }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>{{ lb.Grund or '-' }}</td>
                        <td>{{ lb.Kostenstelle or '-' }}</td>
                        <td>
                            {% if lb.ThemaID %}
                            <a href="{{ url_for('schichtbuch.thema_detail', thema_id=lb.ThemaID) }}" class="text-decoration-none">
                                Thema #{{ lb.ThemaID }}
                            </a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>{{ lb.VerwendetVon }}</td>
                        <td>{{ lb.Bemerkung or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Keine Lagerbuchungen vorhanden.
        </div>
        {% endif %}
    </div>
</div>

<!-- Verkn√ºpfungen mit Themen -->
{% if verknuepfungen %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">üîó Verkn√ºpfungen mit Themen</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Thema</th>
                        <th>Typ</th>
                        <th>Menge</th>
                        <th>Verwendet von</th>
                        <th>Bemerkung</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in verknuepfungen %}
                    <tr>
                        <td>{{ v.VerwendetAm[:16] if v.VerwendetAm else '-' }}</td>
                        <td>
                            <a href="{{ url_for('schichtbuch.thema_detail', thema_id=v.ThemaID) }}" class="text-decoration-none">
                                Thema #{{ v.ThemaID }}
                            </a>
                        </td>
                        <td>
                            {% if v.Typ == 'Eingang' %}
                            <span class="badge bg-success">Eingang</span>
                            {% elif v.Typ == 'Inventur' %}
                            <span class="badge bg-info">Inventur</span>
                            {% else %}
                            <span class="badge bg-danger">Ausgang</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ v.Menge }}</strong></td>
                        <td>{{ v.VerwendetVon or '-' }}</td>
                        <td>{{ v.Bemerkung or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Dateien -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üìÅ Dateien</h5>
        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#dateiUploadCollapse">
            <i class="bi bi-plus-circle"></i> Datei hochladen
        </button>
    </div>
    <div class="collapse" id="dateiUploadCollapse">
        <div class="card-body">
            {{ datei_upload(
                bereich_typ='Ersatzteil',
                bereich_id=ersatzteil.ID,
                erlaubte_dateitypen=['Bild', 'Dokument', 'PDF'],
                upload_route='ersatzteile.ersatzteil_datei_upload',
                import_route=None,
                accept_attr='image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt',
                upload_tab_id='datei-upload-tab',
                import_tab_id='datei-import-tab',
                import_function='ladeImportDateienErsatzteil()'
            ) }}
        </div>
    </div>
    <div class="card-body">
        {{ datei_liste(
            dateien=dateien,
            bereich_typ='Ersatzteil',
            bereich_id=ersatzteil.ID,
            erlaubte_dateitypen=['Bild', 'Dokument', 'PDF'],
            is_admin=is_admin,
            datei_anzeigen_route='ersatzteile.datei_anzeigen',
            datei_loeschen_route='ersatzteile.datei_loeschen',
            nur_bilder=False
        ) }}
    </div>
</div>

<div class="mb-3">
    <a href="{{ url_for('ersatzteile.ersatzteil_liste') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Zur√ºck zur Liste
    </a>
</div>

<!-- Modal: QR-Code anzeigen -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="qrCodeModalLabel">
                    <i class="bi bi-qr-code"></i> QR-Code f√ºr Ersatzteil #<span id="qrErsatzteilId"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schlie√üen"></button>
            </div>
            <div class="modal-body text-center">
                <p class="text-muted mb-3">
                    Scannen Sie diesen QR-Code mit Ihrem Handy, um direkt zu diesem Ersatzteil zu gelangen.
                </p>
                <div id="qrcode" class="d-flex justify-content-center mb-3"></div>
                <div class="input-group">
                    <input type="text" class="form-control" id="qrCodeUrl" readonly>
                    <button class="btn btn-outline-secondary" type="button" onclick="copyQRCodeUrl()" title="Link kopieren">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Schlie√üen
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Dynamische Anpassung des Mengenfelds je nach Buchungstyp
document.addEventListener('DOMContentLoaded', function() {
    const buchungstypSelect = document.getElementById('buchungstyp');
    const mengeInput = document.getElementById('menge-input');
    const mengeLabel = document.getElementById('menge-label');
    const mengeHinweis = document.getElementById('menge-hinweis');
    
    function updateMengeField() {
        const typ = buchungstypSelect.value;
        
        if (typ === 'Inventur') {
            mengeLabel.textContent = 'Lagerstand:';
            mengeInput.min = '0';
            mengeInput.placeholder = 'Aktueller Lagerstand';
            mengeHinweis.textContent = 'Geben Sie den genauen Lagerstand ein';
        } else {
            mengeLabel.textContent = 'Menge:';
            mengeInput.min = '1';
            mengeInput.placeholder = '';
            mengeHinweis.textContent = '';
        }
    }
    
    if (buchungstypSelect) {
        buchungstypSelect.addEventListener('change', updateMengeField);
        updateMengeField(); // Initial aufrufen
    }
});

// QR-Code Modal JavaScript
window.openQRCodeModal = function(ersatzteilId) {
    try {
        // Ersatzteil-ID im Modal anzeigen
        const qrErsatzteilIdEl = document.getElementById('qrErsatzteilId');
        if (!qrErsatzteilIdEl) {
            console.error('qrErsatzteilId element not found');
            return;
        }
        qrErsatzteilIdEl.textContent = ersatzteilId;
        
        // URL zum Ersatzteil generieren (aktuelle URL ohne Query-Parameter)
        const currentUrl = window.location.href.split('?')[0];
        const ersatzteilUrl = currentUrl;
        
        // URL im Input-Feld anzeigen
        const urlInput = document.getElementById('qrCodeUrl');
        if (urlInput) {
            urlInput.value = ersatzteilUrl;
        }
        
        // QR-Code Container leeren
        const qrContainer = document.getElementById('qrcode');
        if (!qrContainer) {
            console.error('qrcode container not found');
            return;
        }
        
        // QR-Code √ºber API generieren (qr-server.com)
        const encodedUrl = encodeURIComponent(ersatzteilUrl);
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodedUrl}`;
        
        // Loading-Spinner anzeigen
        qrContainer.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">L√§dt...</span>
                </div>
            </div>
        `;
        
        // QR-Code-Bild erstellen
        const img = document.createElement('img');
        img.src = qrCodeUrl;
        img.alt = 'QR-Code';
        img.className = 'img-fluid';
        img.style.maxWidth = '256px';
        img.style.height = 'auto';
        
        img.onload = function() {
            qrContainer.innerHTML = '';
            qrContainer.appendChild(img);
        };
        
        img.onerror = function() {
            qrContainer.innerHTML = '<div class="alert alert-danger">Fehler beim Laden des QR-Codes. Bitte versuchen Sie es erneut.</div>';
        };
        
        // Modal √∂ffnen
        const modalElement = document.getElementById('qrCodeModal');
        if (!modalElement) {
            console.error('qrCodeModal element not found');
            return;
        }
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } catch (error) {
        console.error('Fehler beim √ñffnen des QR-Code-Modals:', error);
        alert('Fehler beim √ñffnen des QR-Code-Modals: ' + error.message);
    }
};

function copyQRCodeUrl() {
    const urlInput = document.getElementById('qrCodeUrl');
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // F√ºr mobile Ger√§te
    
    try {
        navigator.clipboard.writeText(urlInput.value).then(() => {
            // Erfolgs-Feedback
            const button = document.querySelector('#qrCodeModal .btn-outline-secondary');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check-lg"></i>';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 2000);
        });
    } catch (err) {
        // Fallback f√ºr √§ltere Browser
        document.execCommand('copy');
        alert('Link wurde in die Zwischenablage kopiert!');
    }
}
</script>
<script>
function addToAngebotsanfrage(ersatzteilId, event) {
    // Button deaktivieren w√§hrend der Anfrage
    const button = event ? event.target.closest('button') : document.querySelector(`button[onclick*="${ersatzteilId}"]`);
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    // AJAX-Anfrage
    fetch(`{{ url_for('ersatzteile.angebotsanfrage_smart_add', ersatzteil_id=0) }}`.replace('/0', `/${ersatzteilId}`))
        .then(response => response.json())
        .then(data => {
            button.disabled = false;
            button.innerHTML = originalContent;
            
            // Toast anzeigen
            const toastType = data.success ? 'success' : 'danger';
            const toastMessage = data.message || 'Unbekannter Fehler';
            
            showToast(toastMessage, toastType);
        })
        .catch(error => {
            button.disabled = false;
            button.innerHTML = originalContent;
            console.error('Fehler:', error);
            showToast('Fehler beim Hinzuf√ºgen zur Angebotsanfrage.', 'danger');
        });
}

function showToast(message, type = 'info') {
    // Toast-Container erstellen falls nicht vorhanden
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Toast erstellen
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-${type === 'success' ? 'success' : type === 'danger' ? 'danger' : 'info'} text-white">
                <strong class="me-auto">
                    ${type === 'success' ? '‚úì Erfolg' : type === 'danger' ? '‚úó Fehler' : '‚Ñπ Info'}
                </strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Toast anzeigen
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 5000
    });
    toast.show();
    
    // Toast nach dem Ausblenden entfernen
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}
</script>

<!-- Import-Funktionalit√§t f√ºr Ersatzteile -->
<script>
async function ladeImportDateienErsatzteil() {
    const listeId = 'datei-import-tab-dateien-liste';
    const liste = document.getElementById(listeId);
    
    if (!liste) return;
    
    liste.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
    
    try {
        const response = await fetch('/api/import/dateien');
        const data = await response.json();
        
        if (!data.success || data.dateien.length === 0) {
            liste.innerHTML = '<div class="alert alert-info">Keine Dateien im Import-Ordner vorhanden.</div>';
            return;
        }
        
        // Alle erlaubten Dateitypen (Bilder und Dokumente)
        const erlaubteEndungen = ['.png', '.jpg', '.jpeg', '.gif', '.webp', '.pdf', '.doc', '.docx', '.xls', '.xlsx', '.txt'];
        
        const gefilterteDateien = data.dateien.filter(datei => {
            const ext = '.' + datei.name.split('.').pop().toLowerCase();
            return erlaubteEndungen.some(e => ext === e);
        });
        
        if (gefilterteDateien.length === 0) {
            liste.innerHTML = '<div class="alert alert-warning">Keine passenden Dateien im Import-Ordner.</div>';
            return;
        }
        
        let html = '<div class="list-group">';
        gefilterteDateien.forEach(datei => {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${datei.name}</strong>
                        <br><small class="text-muted">${datei.size}</small>
                    </div>
                    <button class="btn btn-sm btn-success" onclick="verschiebeAusImportErsatzteil('${datei.name.replace(/'/g, "\\'")}', {{ ersatzteil.ID }})">
                        <i class="bi bi-arrow-right"></i> Verwenden
                    </button>
                </div>
            `;
        });
        html += '</div>';
        liste.innerHTML = html;
    } catch (error) {
        console.error('Fehler beim Laden der Dateien:', error);
        liste.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Dateien.</div>';
    }
}

function getZielOrdnerAusDateiname(filename, ersatzteilId) {
    // Bestimme Zielordner basierend auf Dateiendung
    const ext = '.' + filename.split('.').pop().toLowerCase();
    const bildEndungen = ['.png', '.jpg', '.jpeg', '.gif', '.webp'];
    
    if (bildEndungen.includes(ext)) {
        return `Ersatzteile/${ersatzteilId}/bilder`;
    } else {
        return `Ersatzteile/${ersatzteilId}/dokumente`;
    }
}

async function verschiebeAusImportErsatzteil(filename, ersatzteilId) {
    const zielOrdner = getZielOrdnerAusDateiname(filename, ersatzteilId);
    
    if (!confirm(`M√∂chten Sie die Datei "${filename}" aus dem Import-Ordner verwenden? Die Datei wird verschoben.`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/import/verschieben', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                filename: filename, 
                ziel_ordner: zielOrdner,
                bereich_typ: 'Ersatzteil',
                bereich_id: ersatzteilId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Datei erfolgreich verschoben!');
            location.reload();
        } else {
            alert('Fehler: ' + data.message);
        }
    } catch (error) {
        console.error('Fehler beim Verschieben:', error);
        alert('Fehler beim Verschieben der Datei.');
    }
}
</script>
{% endblock %}

