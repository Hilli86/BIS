{% extends "layout/base.html" %}

{% block content %}
<h1 class="mb-4">üìã Angebotsanfrage #{{ anfrage.ID }}</h1>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Grunddaten</h5>
        <form method="POST" action="{{ url_for('ersatzteile.angebotsanfrage_bearbeiten', angebotsanfrage_id=anfrage.ID) }}" class="d-inline">
            <select name="status" class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="this.form.submit()">
                <option value="Offen" {% if anfrage.Status == 'Offen' %}selected{% endif %}>Offen</option>
                <option value="Versendet" {% if anfrage.Status == 'Versendet' %}selected{% endif %}>Versendet</option>
                <option value="Angebot erhalten" {% if anfrage.Status == 'Angebot erhalten' %}selected{% endif %}>Angebot erhalten</option>
                <option value="Abgeschlossen" {% if anfrage.Status == 'Abgeschlossen' %}selected{% endif %}>Abgeschlossen</option>
            </select>
        </form>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-sm table-borderless mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted" style="width: 150px;"><strong>Lieferant:</strong></td>
                            <td>{{ anfrage.LieferantName or '-' }}</td>
                        </tr>
                        {% if anfrage.LieferantKontakt %}
                        <tr>
                            <td class="text-muted"><strong>Kontakt:</strong></td>
                            <td>{{ anfrage.LieferantKontakt }}</td>
                        </tr>
                        {% endif %}
                        {% if anfrage.LieferantTelefon %}
                        <tr>
                            <td class="text-muted"><strong>Telefon:</strong></td>
                            <td>{{ anfrage.LieferantTelefon }}</td>
                        </tr>
                        {% endif %}
                        {% if anfrage.LieferantEmail %}
                        <tr>
                            <td class="text-muted"><strong>Email:</strong></td>
                            <td><a href="mailto:{{ anfrage.LieferantEmail }}">{{ anfrage.LieferantEmail }}</a></td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-sm table-borderless mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted" style="width: 150px;"><strong>Status:</strong></td>
                            <td>
                                {% if anfrage.Status == 'Offen' %}
                                <span class="badge bg-primary">Offen</span>
                                {% elif anfrage.Status == 'Versendet' %}
                                <span class="badge bg-warning">Versendet</span>
                                {% elif anfrage.Status == 'Angebot erhalten' %}
                                <span class="badge bg-success">Angebot erhalten</span>
                                {% elif anfrage.Status == 'Abgeschlossen' %}
                                <span class="badge bg-secondary">Abgeschlossen</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Erstellt am:</strong></td>
                            <td>{{ anfrage.ErstelltAm[:16] if anfrage.ErstelltAm else '-' }}</td>
                        </tr>
                        {% if anfrage.VersendetAm %}
                        <tr>
                            <td class="text-muted"><strong>Versendet am:</strong></td>
                            <td>{{ anfrage.VersendetAm[:16] }}</td>
                        </tr>
                        {% endif %}
                        {% if anfrage.AngebotErhaltenAm %}
                        <tr>
                            <td class="text-muted"><strong>Angebot erhalten am:</strong></td>
                            <td>{{ anfrage.AngebotErhaltenAm[:16] }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td class="text-muted"><strong>Erstellt von:</strong></td>
                            <td>{{ anfrage.ErstelltVon or '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Abteilung:</strong></td>
                            <td>{{ anfrage.Abteilung or '-' }}</td>
                        </tr>
                        {% if anfrage.Bemerkung %}
                        <tr>
                            <td class="text-muted"><strong>Bemerkung:</strong></td>
                            <td>{{ anfrage.Bemerkung }}</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Positionen -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Positionen</h5>
        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#addPositionCollapse">
            <i class="bi bi-plus-circle"></i> Position hinzuf√ºgen
        </button>
    </div>
    <div class="collapse" id="addPositionCollapse">
        <div class="card-body">
            <form method="POST" action="{{ url_for('ersatzteile.angebotsanfrage_position_hinzufuegen', angebotsanfrage_id=anfrage.ID) }}">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">ErsatzteilID:</label>
                        <div class="input-group">
                            <input type="number" name="ersatzteil_id" class="form-control ersatzteil-id-input" placeholder="Optional">
                            <button type="button" class="btn btn-outline-secondary btn-lookup" onclick="lookupErsatzteilDetail(this)">
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Bestellnummer:</label>
                        <input type="text" name="bestellnummer" class="form-control bestellnummer-display" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Bezeichnung:</label>
                        <input type="text" name="bezeichnung" class="form-control bezeichnung-display" required>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Menge:</label>
                        <input type="number" name="menge" class="form-control" value="1" min="1" required>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Einheit:</label>
                        <input type="text" name="einheit" class="form-control einheit-display" value="St√ºck" placeholder="St√ºck">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Bemerkung:</label>
                        <input type="text" name="bemerkung" class="form-control" placeholder="Optional">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Link:</label>
                        <input type="url" name="link" class="form-control link-display" placeholder="Optional">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="card-body">
        {% if positionen %}
        <div class="table-responsive">
            <table class="table table-sm">
                <colgroup>
                    <col style="width: 8%;">
                    <col style="width: 12%;">
                    <col style="width: 25%;">
                    <col style="width: 6%;">
                    <col style="width: 6%;">
                    <col style="width: 12%;">
                    <col style="width: 12%;">
                    <col style="width: 13%;">
                    {% if anfrage.Status == 'Offen' %}
                    <col style="width: 10%;">
                    {% endif %}
                </colgroup>
                <thead>
                    <tr>
                        <th>Artikelnummer</th>
                        <th>Bestellnummer</th>
                        <th>Bezeichnung</th>
                        <th>Menge</th>
                        <th>Einheit</th>
                        <th>Aktueller Preis</th>
                        <th>Angebotspreis</th>
                        <th>Bemerkung</th>
                        <th>Link</th>
                        {% if anfrage.Status == 'Offen' %}
                        <th>Aktionen</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for p in positionen %}
                    <tr {% if anfrage.Status == 'Offen' %}style="cursor: pointer;" onclick="openEditPositionModal({{ p.ID }}, '{{ p.Bestellnummer|replace("'", "\\'") or '' }}', '{{ p.Bezeichnung|replace("'", "\\'") or '' }}', {{ p.Menge }}, '{{ p.Einheit|replace("'", "\\'") or 'St√ºck' }}', '{{ p.Bemerkung|replace("'", "\\'") or '' }}', {{ p.ErsatzteilID or 'null' }}, '{{ p.Link|replace("'", "\\'") or '' }}')"{% endif %}>
                        <td onclick="event.stopPropagation();">
                            {% if p.ErsatzteilID %}
                            <a href="{{ url_for('ersatzteile.ersatzteil_detail', ersatzteil_id=p.ErsatzteilID) }}" class="text-decoration-none">
                                {{ p.ErsatzteilID }}
                            </a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>{{ p.Bestellnummer or '-' }}</td>
                        <td>{{ p.Bezeichnung or '-' }}</td>
                        <td>{{ p.Menge }}</td>
                        <td>{{ p.Einheit or 'St√ºck' }}</td>
                        <td>
                            {% if p.AktuellerPreis %}
                            {{ "%.2f"|format(p.AktuellerPreis) }} {{ p.AktuelleWaehrung or 'EUR' }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if p.Angebotspreis %}
                            <strong>{{ "%.2f"|format(p.Angebotspreis) }} {{ p.Angebotswaehrung or 'EUR' }}</strong>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>{{ p.Bemerkung or '-' }}</td>
                        <td>
                            {% if p.Link %}
                            <a href="{{ p.Link }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">
                                <i class="bi bi-link-45deg"></i> Link
                            </a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        {% if anfrage.Status == 'Offen' %}
                        <td onclick="event.stopPropagation();">
                            <form method="POST" action="{{ url_for('ersatzteile.angebotsanfrage_position_loeschen', angebotsanfrage_id=anfrage.ID, position_id=p.ID) }}" 
                                  onsubmit="return confirm('Position wirklich l√∂schen?');" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                            {% if not p.ErsatzteilID and p.Bestellnummer and p.Bezeichnung %}
                            <form method="POST" action="{{ url_for('ersatzteile.angebotsanfrage_position_artikel_erstellen', angebotsanfrage_id=anfrage.ID, position_id=p.ID) }}" 
                                  onsubmit="return confirm('Artikel aus dieser Position erstellen?');" class="d-inline me-1">
                                <button type="submit" class="btn btn-sm btn-outline-success" title="Artikel erstellen">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </form>
                            {% endif %}
                        </td>
                        {% elif anfrage.Status == 'Versendet' %}
                        <td onclick="event.stopPropagation();">
                            {% if not p.ErsatzteilID and p.Bestellnummer and p.Bezeichnung %}
                            <form method="POST" action="{{ url_for('ersatzteile.angebotsanfrage_position_artikel_erstellen', angebotsanfrage_id=anfrage.ID, position_id=p.ID) }}" 
                                  onsubmit="return confirm('Artikel aus dieser Position erstellen?');" class="d-inline me-1">
                                <button type="submit" class="btn btn-sm btn-outline-success" title="Artikel erstellen">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </form>
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Keine Positionen vorhanden.
        </div>
        {% endif %}
    </div>
</div>

<!-- PDF-Upload (wenn Status "Angebot erhalten" oder "Abgeschlossen") -->
{% if anfrage.Status == 'Angebot erhalten' or anfrage.Status == 'Abgeschlossen' %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üìÑ Angebots-PDFs</h5>
        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#pdfUploadCollapse">
            <i class="bi bi-plus-circle"></i> PDF hochladen
        </button>
    </div>
    <div class="collapse" id="pdfUploadCollapse">
        <div class="card-body">
            <!-- Tab-Auswahl -->
            <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="aa-upload-tab" data-bs-toggle="tab" data-bs-target="#aa-upload-pane" type="button">
                        <i class="bi bi-cloud-upload"></i> Hochladen
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="aa-import-tab" data-bs-toggle="tab" data-bs-target="#aa-import-pane" type="button" onclick="ladeImportDateienAngebotsanfrage()">
                        <i class="bi bi-folder"></i> Aus Import-Ordner
                    </button>
                </li>
            </ul>
            
            <div class="tab-content">
                <!-- Upload-Tab -->
                <div class="tab-pane fade show active" id="aa-upload-pane" role="tabpanel">
                    <form method="POST" action="{{ url_for('ersatzteile.angebotsanfrage_datei_upload', angebotsanfrage_id=anfrage.ID) }}" enctype="multipart/form-data">
                        <div class="mb-3">
                            <input type="file" name="file" class="form-control" accept=".pdf" required>
                            <small class="text-muted">Nur PDF-Dateien erlaubt</small>
                        </div>
                        <button type="submit" class="btn btn-success">Hochladen</button>
                    </form>
                </div>
                
                <!-- Import-Tab -->
                <div class="tab-pane fade" id="aa-import-pane" role="tabpanel">
                    <div id="aa-import-dateien-liste">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">L√§dt...</span>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success mt-2" onclick="ladeImportDateienAngebotsanfrage()">
                        <i class="bi bi-arrow-clockwise"></i> Aktualisieren
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if dateien %}
        <div class="list-group">
            {% for datei in dateien %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <a href="{{ url_for('ersatzteile.angebotsanfrage_datei_anzeigen', filepath=datei.path) }}" target="_blank" class="text-decoration-none">
                        <i class="bi bi-file-earmark-pdf"></i> {{ datei.name }}
                    </a>
                    <br><small class="text-muted">Ge√§ndert: {{ datei.modified.strftime('%d.%m.%Y %H:%M') }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Keine PDF-Dateien vorhanden.
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Preis-Eingabe (nur wenn Status "Angebot erhalten") -->
{% if anfrage.Status == 'Angebot erhalten' %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">üí∞ Preise eingeben</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('ersatzteile.angebotsanfrage_preise_eingeben', angebotsanfrage_id=anfrage.ID) }}">
            {% if positionen %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <colgroup>
                        <col style="width: 8%;">
                        <col style="width: 12%;">
                        <col style="width: 25%;">
                        <col style="width: 6%;">
                        <col style="width: 12%;">
                        <col style="width: 12%;">
                        <col style="width: 15%;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>Artikelnummer</th>
                            <th>Bestellnummer</th>
                            <th>Bezeichnung</th>
                            <th>Menge</th>
                            <th>Aktueller Preis</th>
                            <th>Angebotspreis</th>
                            <th>W√§hrung</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in positionen %}
                        <tr>
                            <td>{{ p.ErsatzteilID }}</td>
                            <td>{{ p.Bestellnummer }}</td>
                            <td>{{ p.Bezeichnung }}</td>
                            <td>{{ p.Menge }}</td>
                            <td>
                                {% if p.AktuellerPreis %}
                                {{ "%.2f"|format(p.AktuellerPreis) }} {{ p.AktuelleWaehrung or 'EUR' }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                <input type="hidden" name="position_id[]" value="{{ p.ID }}">
                                <input type="number" name="preis[]" class="form-control form-control-sm" 
                                       step="0.01" min="0" 
                                       value="{% if p.Angebotspreis %}{{ p.Angebotspreis }}{% endif %}" 
                                       placeholder="0.00">
                            </td>
                            <td>
                                <select name="waehrung[]" class="form-select form-select-sm">
                                    <option value="EUR" {% if p.Angebotswaehrung == 'EUR' or not p.Angebotswaehrung %}selected{% endif %}>EUR</option>
                                    <option value="USD" {% if p.Angebotswaehrung == 'USD' %}selected{% endif %}>USD</option>
                                    <option value="CHF" {% if p.Angebotswaehrung == 'CHF' %}selected{% endif %}>CHF</option>
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" name="preise_uebernehmen" id="preiseUebernehmen">
                    <label class="form-check-label" for="preiseUebernehmen">
                        <strong>Preise in Ersatzteile √ºbernehmen</strong> (setzt Preisstand auf heute)
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="status_abschliessen" id="statusAbschliessen">
                    <label class="form-check-label" for="statusAbschliessen">
                        Angebotsanfrage als abgeschlossen markieren
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg"></i> Preise speichern
                </button>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Keine Positionen vorhanden.
            </div>
            {% endif %}
        </form>
    </div>
</div>

<!-- Als Bestellung √ºbernehmen (nur wenn Status "Angebot erhalten") -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">üõí Als Bestellung √ºbernehmen</h5>
    </div>
    <div class="card-body">
        <p class="mb-3">Erstellen Sie eine Bestellung aus diesem Angebot. Sie k√∂nnen ausw√§hlen, welche Positionen √ºbernommen werden sollen.</p>
        {% if 'admin' in session.get('user_berechtigungen', []) or 'bestellungen_erstellen' in session.get('user_berechtigungen', []) %}
        <a href="{{ url_for('ersatzteile.bestellung_aus_angebot', angebotsanfrage_id=anfrage.ID) }}" class="btn btn-primary">
            <i class="bi bi-cart-plus"></i> Als Bestellung √ºbernehmen
        </a>
        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Sie haben keine Berechtigung, Bestellungen zu erstellen.
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<div class="mb-3">
    <a href="{{ url_for('ersatzteile.angebotsanfrage_liste') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Zur√ºck zur Liste
    </a>
    <button type="button" class="btn btn-primary" onclick="exportAngebotsanfragePDF({{ anfrage.ID }})">
        <i class="bi bi-file-pdf"></i> Als PDF exportieren
    </button>
    <form method="POST" action="{{ url_for('ersatzteile.angebotsanfrage_loeschen', angebotsanfrage_id=anfrage.ID) }}" 
          onsubmit="return confirm('M√∂chten Sie diese Angebotsanfrage wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.');" class="d-inline">
        <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Angebot l√∂schen
        </button>
    </form>
</div>

<!-- Modal f√ºr Position bearbeiten -->
<div class="modal fade" id="editPositionModal" tabindex="-1" aria-labelledby="editPositionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPositionModalLabel">Position bearbeiten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="editPositionForm" action="">
                <div class="modal-body">
                    <input type="hidden" id="edit_position_id" name="position_id">
                    <div class="mb-3">
                        <label class="form-label">ErsatzteilID:</label>
                        <input type="number" id="edit_ersatzteil_id" name="ersatzteil_id" class="form-control" placeholder="Optional">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bestellnummer: <span class="text-danger">*</span></label>
                        <input type="text" id="edit_bestellnummer" name="bestellnummer" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bezeichnung: <span class="text-danger">*</span></label>
                        <input type="text" id="edit_bezeichnung" name="bezeichnung" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Menge: <span class="text-danger">*</span></label>
                        <input type="number" id="edit_menge" name="menge" class="form-control" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_einheit" class="form-label">Einheit:</label>
                        <input type="text" id="edit_einheit" name="einheit" class="form-control" value="St√ºck" placeholder="St√ºck">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bemerkung:</label>
                        <input type="text" id="edit_bemerkung" name="bemerkung" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Link:</label>
                        <input type="url" id="edit_link" name="link" class="form-control" placeholder="Optional">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Lookup-Funktion f√ºr Detail-Seite
function lookupErsatzteilDetail(button) {
    const form = button.closest('form');
    const ersatzteilInput = form.querySelector('.ersatzteil-id-input');
    const bestellnummerDisplay = form.querySelector('.bestellnummer-display');
    const bezeichnungDisplay = form.querySelector('.bezeichnung-display');
    const einheitDisplay = form.querySelector('.einheit-display');
    
    const ersatzteilId = ersatzteilInput.value.trim();
    
    // Wenn keine ID eingegeben, Modal √∂ffnen
    if (!ersatzteilId) {
        const lieferantId = {{ anfrage.LieferantID }};
        
        if (!lieferantId) {
            alert('Kein Lieferant zugeordnet.');
            return;
        }
        
        // Modal √∂ffnen und Ersatzteile laden
        openErsatzteilModalDetail(lieferantId, form);
        return;
    }
    
    // Button deaktivieren w√§hrend der Suche
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    // AJAX-Anfrage
    fetch(`{{ url_for('ersatzteile.api_ersatzteil_info', ersatzteil_id=0) }}`.replace('/0', `/${ersatzteilId}`))
        .then(response => response.json())
        .then(data => {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-right"></i>';
            
            if (data.success) {
                bestellnummerDisplay.value = data.bestellnummer;
                bezeichnungDisplay.value = data.bezeichnung;
                if (einheitDisplay && data.einheit) {
                    einheitDisplay.value = data.einheit;
                }
                const linkDisplay = form.querySelector('.link-display');
                if (linkDisplay && data.link) {
                    linkDisplay.value = data.link;
                }
                bestellnummerDisplay.classList.remove('is-invalid');
                bezeichnungDisplay.classList.remove('is-invalid');
                ersatzteilInput.classList.remove('is-invalid');
            } else {
                bestellnummerDisplay.value = '';
                bezeichnungDisplay.value = '';
                if (einheitDisplay) {
                    einheitDisplay.value = 'St√ºck';
                }
                bestellnummerDisplay.classList.add('is-invalid');
                bezeichnungDisplay.classList.add('is-invalid');
                ersatzteilInput.classList.add('is-invalid');
                alert(data.message || 'Ersatzteil nicht gefunden.');
            }
        })
        .catch(error => {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-right"></i>';
            console.error('Fehler:', error);
            alert('Fehler beim Laden der Ersatzteil-Daten.');
        });
}

function openErsatzteilModalDetail(lieferantId, targetForm) {
    const modal = new bootstrap.Modal(document.getElementById('ersatzteilModalDetail'));
    const modalBody = document.getElementById('ersatzteilModalListDetail');
    
    // Modal-Body leeren und Ladeanzeige anzeigen
    modalBody.innerHTML = '<div class="text-center p-4"><div class="spinner-border" role="status"><span class="visually-hidden">L√§dt...</span></div></div>';
    
    // Suchfeld leeren
    const searchInput = document.getElementById('ersatzteilSearchDetail');
    if (searchInput) {
        searchInput.value = '';
    }
    
    // Modal √∂ffnen
    modal.show();
    
    // Ersatzteile laden
    const apiUrl = `{{ url_for('ersatzteile.api_ersatzteile_lieferant', lieferant_id=0) }}`.replace('/0', `/${lieferantId}`);
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.ersatzteile && data.ersatzteile.length > 0) {
                // Speichere die urspr√ºngliche Liste f√ºr Filterung
                window.ersatzteilListDetailAngebot = data.ersatzteile;
                
                // Rendere die Liste
                renderErsatzteilListDetailAngebot(data.ersatzteile);
                
                // Suchfeld-Event-Listener hinzuf√ºgen
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        filterErsatzteilListDetailAngebot(this.value);
                    });
                    // Fokus auf Suchfeld setzen
                    searchInput.focus();
                }
            } else {
                modalBody.innerHTML = '<div class="alert alert-info">Keine Ersatzteile f√ºr diesen Lieferanten gefunden.</div>';
            }
        })
        .catch(error => {
            console.error('Fehler beim Laden der Ersatzteile:', error);
            modalBody.innerHTML = `<div class="alert alert-danger">
                <strong>Fehler beim Laden der Ersatzteile:</strong><br>
                ${error.message || 'Unbekannter Fehler'}
            </div>`;
        });
}

// Funktion zum Rendern der Ersatzteil-Liste (Angebot Detail)
function renderErsatzteilListDetailAngebot(ersatzteile) {
    const modalBody = document.getElementById('ersatzteilModalListDetail');
    if (!modalBody) return;
    
    if (ersatzteile.length === 0) {
        modalBody.innerHTML = '<div class="alert alert-info">Keine Ersatzteile gefunden.</div>';
        return;
    }
    
    let html = '<div class="list-group">';
    ersatzteile.forEach(ersatzteil => {
        const bestandText = `${ersatzteil.bestand || 0} ${ersatzteil.einheit || ''}`.trim();
        const bestellnummerEscaped = (ersatzteil.bestellnummer || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const bezeichnungEscaped = (ersatzteil.bezeichnung || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        html += `
            <a href="#" class="list-group-item list-group-item-action" onclick="selectErsatzteilDetail(${ersatzteil.id}, '${bestellnummerEscaped}', '${bezeichnungEscaped}', event)">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${ersatzteil.bestellnummer || 'Keine Bestellnummer'}</h6>
                    <small>${bestandText}</small>
                </div>
                <p class="mb-1">${ersatzteil.bezeichnung || 'Keine Bezeichnung'}</p>
                <small>ID: ${ersatzteil.id}</small>
            </a>
        `;
    });
    html += '</div>';
    modalBody.innerHTML = html;
}

// Funktion zum Filtern der Ersatzteil-Liste (Angebot Detail)
function filterErsatzteilListDetailAngebot(searchTerm) {
    if (!window.ersatzteilListDetailAngebot) return;
    
    const term = searchTerm.toLowerCase().trim();
    
    if (term === '') {
        // Wenn leer, alle anzeigen
        renderErsatzteilListDetailAngebot(window.ersatzteilListDetailAngebot);
        return;
    }
    
    // Filtere die Liste
    const filtered = window.ersatzteilListDetailAngebot.filter(ersatzteil => {
        const bestellnummer = (ersatzteil.bestellnummer || '').toLowerCase();
        const bezeichnung = (ersatzteil.bezeichnung || '').toLowerCase();
        const id = ersatzteil.id.toString();
        
        return bestellnummer.includes(term) || 
               bezeichnung.includes(term) || 
               id.includes(term);
    });
    
    renderErsatzteilListDetailAngebot(filtered);
}

function selectErsatzteilDetail(id, bestellnummer, bezeichnung, event) {
    event.preventDefault();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('ersatzteilModalDetail'));
    const form = document.querySelector('#addPositionCollapse form');
    
    if (form) {
        const ersatzteilInput = form.querySelector('.ersatzteil-id-input');
        const bestellnummerDisplay = form.querySelector('.bestellnummer-display');
        const bezeichnungDisplay = form.querySelector('.bezeichnung-display');
        const einheitDisplay = form.querySelector('.einheit-display');
        const linkDisplay = form.querySelector('.link-display');
        
        if (ersatzteilInput) ersatzteilInput.value = id;
        if (bestellnummerDisplay) bestellnummerDisplay.value = bestellnummer || '';
        if (bezeichnungDisplay) bezeichnungDisplay.value = bezeichnung || '';
        
        // Einheit und Link aus API laden
        if ((einheitDisplay || linkDisplay) && id) {
            fetch(`{{ url_for('ersatzteile.api_ersatzteil_info', ersatzteil_id=0) }}`.replace('/0', `/${id}`))
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (einheitDisplay && data.einheit) {
                            einheitDisplay.value = data.einheit;
                        }
                        if (linkDisplay && data.link) {
                            linkDisplay.value = data.link;
                        }
                    }
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Einheit/Link:', error);
                });
        }
        
        // Validierung entfernen
        if (bestellnummerDisplay) bestellnummerDisplay.classList.remove('is-invalid');
        if (bezeichnungDisplay) bezeichnungDisplay.classList.remove('is-invalid');
        if (ersatzteilInput) ersatzteilInput.classList.remove('is-invalid');
    }
    
    modal.hide();
}

// Position bearbeiten Modal √∂ffnen
function openEditPositionModal(positionId, bestellnummer, bezeichnung, menge, einheit, bemerkung, ersatzteilId, link) {
    document.getElementById('edit_position_id').value = positionId;
    document.getElementById('edit_ersatzteil_id').value = ersatzteilId || '';
    document.getElementById('edit_bestellnummer').value = bestellnummer;
    document.getElementById('edit_bezeichnung').value = bezeichnung;
    document.getElementById('edit_menge').value = menge;
    const einheitInput = document.getElementById('edit_einheit');
    if (einheitInput) {
        einheitInput.value = einheit || 'St√ºck';
    }
    document.getElementById('edit_bemerkung').value = bemerkung || '';
    const linkInput = document.getElementById('edit_link');
    if (linkInput) {
        linkInput.value = link || '';
    }
    
    // Action URL setzen
    const form = document.getElementById('editPositionForm');
    form.action = `/ersatzteile/angebotsanfragen/{{ anfrage.ID }}/position/${positionId}/bearbeiten`;
    
    const modal = new bootstrap.Modal(document.getElementById('editPositionModal'));
    modal.show();
}

// Enter-Taste f√ºr Detail-Seite
document.addEventListener('DOMContentLoaded', function() {
    const detailErsatzteilInput = document.querySelector('#addPositionCollapse .ersatzteil-id-input');
    if (detailErsatzteilInput) {
        detailErsatzteilInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const button = this.closest('form').querySelector('.btn-lookup');
                if (button) {
                    lookupErsatzteilDetail(button);
                }
            }
        });
    }
});
</script>

<!-- Modal f√ºr Ersatzteil-Auswahl (Detail-Seite) -->
<div class="modal fade" id="ersatzteilModalDetail" tabindex="-1" aria-labelledby="ersatzteilModalDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ersatzteilModalDetailLabel">Ersatzteil ausw√§hlen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Suchfeld -->
                <div class="mb-3">
                    <input type="text" class="form-control" id="ersatzteilSearchDetail" placeholder="üîç Suchen nach Bestellnummer, Bezeichnung oder ID..." autocomplete="off">
                </div>
                <div id="ersatzteilModalListDetail">
                    <div class="text-center p-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">L√§dt...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
            </div>
        </div>
    </div>
</div>

<!-- Import-Funktionalit√§t f√ºr Angebotsanfragen -->
<script>
async function ladeImportDateienAngebotsanfrage() {
    const liste = document.getElementById('aa-import-dateien-liste');
    if (!liste) return;
    
    liste.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
    
    try {
        const response = await fetch('/api/import/dateien');
        const data = await response.json();
        
        if (!data.success || data.dateien.length === 0) {
            liste.innerHTML = '<div class="alert alert-info">Keine Dateien im Import-Ordner vorhanden.</div>';
            return;
        }
        
        // Nur PDF-Dateien f√ºr Angebotsanfragen
        const gefilterteDateien = data.dateien.filter(datei => {
            const ext = '.' + datei.name.split('.').pop().toLowerCase();
            return ext === '.pdf';
        });
        
        if (gefilterteDateien.length === 0) {
            liste.innerHTML = '<div class="alert alert-warning">Keine PDF-Dateien im Import-Ordner vorhanden.</div>';
            return;
        }
        
        let html = '<div class="list-group">';
        gefilterteDateien.forEach(datei => {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${datei.name}</strong>
                        <br><small class="text-muted">${datei.size}</small>
                    </div>
                    <button class="btn btn-sm btn-success" onclick="verschiebeAusImportAngebotsanfrage('${datei.name.replace(/'/g, "\\'")}')">
                        <i class="bi bi-arrow-right"></i> Verwenden
                    </button>
                </div>
            `;
        });
        html += '</div>';
        liste.innerHTML = html;
    } catch (error) {
        console.error('Fehler beim Laden der Dateien:', error);
        liste.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Dateien.</div>';
    }
}

async function verschiebeAusImportAngebotsanfrage(filename) {
    const angebotsanfrageId = {{ anfrage.ID }};
    const zielOrdner = `Bestellwesen/Angebote/${angebotsanfrageId}`;
    
    if (!confirm(`M√∂chten Sie die Datei "${filename}" aus dem Import-Ordner verwenden? Die Datei wird verschoben.`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/import/verschieben', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename: filename, ziel_ordner: zielOrdner})
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Datei erfolgreich verschoben!');
            location.reload();
        } else {
            alert('Fehler: ' + data.message);
        }
    } catch (error) {
        console.error('Fehler beim Verschieben:', error);
        alert('Fehler beim Verschieben der Datei.');
    }
}

// PDF-Export mit Ladeanzeige
async function exportAngebotsanfragePDF(angebotsanfrageId) {
    // Modal √∂ffnen
    const modal = new bootstrap.Modal(document.getElementById('pdfExportModal'));
    modal.show();
    
    try {
        const url = '{{ url_for("ersatzteile.angebotsanfrage_pdf_export", angebotsanfrage_id=0) }}'.replace('/0', `/${angebotsanfrageId}`);
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Blob aus Response erstellen
        const blob = await response.blob();
        
        // Dateiname aus Content-Disposition Header extrahieren oder generieren
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `Angebotsanfrage_${angebotsanfrageId}_${new Date().toISOString().split('T')[0]}.pdf`;
        if (contentDisposition) {
            // Regex f√ºr filename="..." oder filename=...
            const filenameMatch = contentDisposition.match(/filename[*]?=['"]?([^'";]+)['"]?/i);
            if (filenameMatch && filenameMatch[1]) {
                filename = filenameMatch[1].trim();
            }
        }
        
        // Download starten
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(downloadUrl);
        
        // Modal schlie√üen
        modal.hide();
        
        // Erfolgs-Toast anzeigen (falls vorhanden)
        if (typeof showToast === 'function') {
            showToast('PDF erfolgreich erstellt und heruntergeladen.', 'success');
        }
    } catch (error) {
        console.error('Fehler beim PDF-Export:', error);
        modal.hide();
        alert('Fehler beim Erstellen des PDFs. Bitte versuchen Sie es erneut.');
    }
}
</script>

<!-- Modal f√ºr PDF-Export -->
<div class="modal fade" id="pdfExportModal" tabindex="-1" aria-labelledby="pdfExportModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">L√§dt...</span>
                </div>
                <h5 class="mb-2">PDF wird erstellt...</h5>
                <p class="text-muted mb-0">Bitte warten Sie, w√§hrend der Bericht generiert wird.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

