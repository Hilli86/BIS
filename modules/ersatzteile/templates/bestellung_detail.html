{% extends "layout/base.html" %}
{% from "components/datei_liste.html" import datei_liste %}
{% from "components/datei_upload.html" import datei_upload %}

{% block content %}
<h1 class="mb-4">üõí Bestellung #{{ bestellung.ID }}</h1>
<div class="mb-3">
    <a href="{{ url_for('ersatzteile.bestellung_liste') }}{% if status_filter_list or lieferant_filter or abteilung_filter %}?{% endif %}{% for status in status_filter_list %}status={{ status|urlencode }}{% if not loop.last %}&{% endif %}{% endfor %}{% if status_filter_list and (lieferant_filter or abteilung_filter) %}&{% endif %}{% if lieferant_filter %}lieferant={{ lieferant_filter|urlencode }}{% endif %}{% if lieferant_filter and abteilung_filter %}&{% endif %}{% if abteilung_filter %}abteilung={{ abteilung_filter|urlencode }}{% endif %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Zur√ºck zur Liste
    </a>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Grunddaten</h5>
        <div class="d-flex gap-2 align-items-center">
            <button class="btn btn-sm btn-light" type="button" onclick="openSichtbarkeitModal({{ bestellung.ID }})" title="Sichtbarkeit bearbeiten">
                <i class="bi bi-eye"></i> Sichtbarkeit
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-sm table-borderless mb-0">
                    <tbody>
                        {% if bestellung.AngebotsanfrageID %}
                        <tr>
                            <td class="text-muted" style="width: 150px;"><strong>AngebotsID:</strong></td>
                            <td>
                                <a href="{{ url_for('ersatzteile.angebotsanfrage_detail', angebotsanfrage_id=bestellung.AngebotsanfrageID) }}" class="text-decoration-none">
                                    #{{ bestellung.AngebotsanfrageID }}
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td class="text-muted" style="width: 150px;"><strong>Lieferant:</strong></td>
                            <td>{{ bestellung.LieferantName or '-' }}</td>
                        </tr>
                        {% if bestellung.LieferantKontakt %}
                        <tr>
                            <td class="text-muted"><strong>Kontakt:</strong></td>
                            <td>{{ bestellung.LieferantKontakt }}</td>
                        </tr>
                        {% endif %}
                        {% if bestellung.LieferantTelefon %}
                        <tr>
                            <td class="text-muted"><strong>Telefon:</strong></td>
                            <td>{{ bestellung.LieferantTelefon }}</td>
                        </tr>
                        {% endif %}
                        {% if bestellung.LieferantEmail %}
                        <tr>
                            <td class="text-muted"><strong>Email:</strong></td>
                            <td><a href="mailto:{{ bestellung.LieferantEmail }}">{{ bestellung.LieferantEmail }}</a></td>
                        </tr>
                        {% endif %}
                        {% if bestellung.Unterschrift %}
                        <tr>
                            <td class="text-muted d-none d-md-table-cell" style="width: 150px;"><strong>Unterschrift:</strong></td>
                            <td class="d-md-none" colspan="2">
                                <img src="{{ bestellung.Unterschrift }}" alt="Unterschrift" style="max-width: 100%; max-width: 300px; border: 1px solid #ddd; padding: 5px; background: white;">
                            </td>
                            <td class="d-none d-md-table-cell">
                                <img src="{{ bestellung.Unterschrift }}" alt="Unterschrift" style="max-width: 100%; max-width: 300px; border: 1px solid #ddd; padding: 5px; background: white;">
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-sm table-borderless mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted" style="width: 150px;"><strong>Status:</strong></td>
                            <td>
                                {% if bestellung.Status == 'Erstellt' %}
                                <span class="badge bg-secondary">Erstellt</span>
                                {% elif bestellung.Status == 'Zur Freigabe' %}
                                <span class="badge bg-warning">Zur Freigabe</span>
                                {% elif bestellung.Status == 'Freigegeben' %}
                                <span class="badge bg-info">Freigegeben</span>
                                {% elif bestellung.Status == 'Bestellt' %}
                                <span class="badge bg-primary">Bestellt</span>
                                {% elif bestellung.Status == 'Teilweise erhalten' %}
                                <span class="badge bg-warning text-dark">Teilweise erhalten</span>
                                {% elif bestellung.Status == 'Erhalten' %}
                                <span class="badge bg-success">Erhalten</span>
                                {% elif bestellung.Status == 'Erledigt' %}
                                <span class="badge bg-dark">Erledigt</span>
                                {% elif bestellung.Status == 'Storniert' %}
                                <span class="badge bg-danger">Storniert</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ bestellung.Status }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Erstellt am:</strong></td>
                            <td>{{ bestellung.ErstelltAm[:16] if bestellung.ErstelltAm else '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Erstellt von:</strong></td>
                            <td>{{ bestellung.ErstelltVon or '-' }}</td>
                        </tr>
                        {% if bestellung.FreigegebenAm %}
                        <tr>
                            <td class="text-muted"><strong>Freigegeben am:</strong></td>
                            <td>{{ bestellung.FreigegebenAm[:16] }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Freigegeben von:</strong></td>
                            <td>{{ bestellung.FreigegebenVon or '-' }}</td>
                        </tr>
                        {% endif %}
                        {% if bestellung.BestelltAm %}
                        <tr>
                            <td class="text-muted"><strong>Bestellt am:</strong></td>
                            <td>{{ bestellung.BestelltAm[:16] }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Bestellt von:</strong></td>
                            <td>{{ bestellung.BestelltVon or '-' }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td class="text-muted"><strong>Abteilung:</strong></td>
                            <td>{{ bestellung.Abteilung or '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Gesamtsumme:</strong></td>
                            <td>
                                <strong class="fs-5">{{ "%.2f"|format(gesamtbetrag) }} {{ waehrung }}</strong>
                            </td>
                        </tr>
                        {% if bestellung.Bemerkung %}
                        <tr>
                            <td class="text-muted"><strong>Bemerkung:</strong></td>
                            <td>{{ bestellung.Bemerkung }}</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Workflow-Aktionen -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">‚öôÔ∏è Aktionen</h5>
    </div>
    <div class="card-body">
        <div class="d-flex flex-wrap gap-2">
            {% if bestellung.Status == 'Erstellt' %}
            <form method="POST" action="{{ url_for('ersatzteile.bestellung_zur_freigabe', bestellung_id=bestellung.ID) }}" class="w-100">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label for="freigabe_bemerkung" class="form-label">Freigabebemerkung:</label>
                        <input type="text" name="freigabe_bemerkung" id="freigabe_bemerkung" class="form-control" 
                               value="{{ bestellung.FreigabeBemerkung or '' }}" 
                               placeholder="Optional: Bemerkung zur Freigabe...">
                    </div>
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-check-circle"></i> Zur Freigabe markieren
                        </button>
                    </div>
                </div>
            </form>
            {% endif %}
            
            {% if bestellung.Status == 'Zur Freigabe' and kann_freigeben %}
            <div class="w-100">
                {% if kann_freigabebemerkung_bearbeiten %}
                <!-- Freigabebemerkung anzeigen und bearbeitbar machen (nur f√ºr Ersteller) -->
                <div class="mb-3 p-3 bg-light border rounded">
                    <strong>Freigabebemerkung:</strong>
                    <p class="mb-0 mt-1">
                        <a href="#" class="text-decoration-none text-primary" onclick="openFreigabebemerkungModal({{ bestellung.ID }}, '{{ (bestellung.FreigabeBemerkung or "")|replace("'", "\\'")|replace('"', '&quot;') }}'); return false;" title="Klicken zum Bearbeiten">
                            <i class="bi bi-pencil"></i> {{ bestellung.FreigabeBemerkung or '(leer - klicken zum Bearbeiten)' }}
                        </a>
                    </p>
                </div>
                {% elif bestellung.FreigabeBemerkung %}
                <!-- Freigabebemerkung nur anzeigen (f√ºr andere Benutzer) -->
                <div class="mb-3 p-3 bg-light border rounded">
                    <strong>Freigabebemerkung:</strong>
                    <p class="mb-0 mt-1">{{ bestellung.FreigabeBemerkung }}</p>
                </div>
                {% endif %}
                <button type="button" class="btn btn-success" onclick="openUnterschriftModal({{ bestellung.ID }})">
                    <i class="bi bi-check-lg"></i> Freigeben
                </button>
            </div>
            {% endif %}
            
            {% if bestellung.Status == 'Freigegeben' %}
            <button type="button" class="btn btn-danger" onclick="exportBestellungPDF({{ bestellung.ID }})">
                <i class="bi bi-file-pdf"></i> PDF generieren
            </button>
            <form method="POST" action="{{ url_for('ersatzteile.bestellung_als_bestellt', bestellung_id=bestellung.ID) }}" class="d-inline">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Als bestellt markieren
                </button>
            </form>
            {% endif %}
            
            {% if bestellung.Status == 'Bestellt' and kann_buchen %}
            <a href="{{ url_for('ersatzteile.wareneingang_bestellung', bestellung_id=bestellung.ID) }}" class="btn btn-success">
                <i class="bi bi-box-arrow-in-down"></i> Wareneingang buchen
            </a>
            {% endif %}
            
            {% if bestellung.Status == 'Erledigt' %}
            <form method="POST" action="{{ url_for('ersatzteile.bestellung_stornieren', bestellung_id=bestellung.ID) }}" class="d-inline" 
                  onsubmit="return confirm('M√∂chten Sie diese Bestellung wirklich stornieren?');">
                <button type="submit" class="btn btn-danger">
                    <i class="bi bi-x-circle"></i> Bestellung stornieren
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<!-- Positionen -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Positionen</h5>
        {% if bestellung.Status in ['Erstellt', 'Zur Freigabe'] %}
        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#addPositionCollapse">
            <i class="bi bi-plus-circle"></i> Position hinzuf√ºgen
        </button>
        {% endif %}
    </div>
    {% if bestellung.Status in ['Erstellt', 'Zur Freigabe'] %}
    <div class="collapse" id="addPositionCollapse">
        <div class="card-body">
            <form method="POST" action="{{ url_for('ersatzteile.bestellung_position_hinzufuegen', bestellung_id=bestellung.ID) }}">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">ErsatzteilID:</label>
                        <div class="input-group">
                            <input type="number" name="ersatzteil_id" class="form-control ersatzteil-id-input" placeholder="Optional">
                            <button type="button" class="btn btn-outline-secondary btn-lookup" onclick="lookupErsatzteilDetail(this)">
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Bestellnummer:</label>
                        <input type="text" name="bestellnummer" class="form-control bestellnummer-display" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Bezeichnung:</label>
                        <input type="text" name="bezeichnung" class="form-control bezeichnung-display" required>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Menge:</label>
                        <input type="number" name="menge" class="form-control" value="1" min="1" required>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Einheit:</label>
                        <input type="text" name="einheit" class="form-control einheit-display" value="St√ºck" placeholder="St√ºck">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Preis:</label>
                        <input type="number" name="preis" class="form-control" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">W√§hrung:</label>
                        <select name="waehrung" class="form-select">
                            <option value="EUR">EUR</option>
                            <option value="USD">USD</option>
                            <option value="CHF">CHF</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Bemerkung:</label>
                        <input type="text" name="bemerkung" class="form-control" placeholder="Optional...">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Link:</label>
                        <input type="url" name="link" class="form-control link-display" placeholder="Optional">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    <div class="card-body">
        {% if positionen %}
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Artikelnummer</th>
                        <th>Bestellnummer</th>
                        <th>Bezeichnung</th>
                        <th>Menge</th>
                        <th>Einheit</th>
                        <th>Erhalten</th>
                        <th>Preis</th>
                        <th>Gesamt</th>
                        <th>Bemerkung</th>
                        <th>Link</th>
                        {% if bestellung.Status in ['Erstellt', 'Zur Freigabe'] %}
                        <th>Aktionen</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for p in positionen %}
                    <tr>
                        <td>
                            {% if p.ErsatzteilID %}
                            <a href="{{ url_for('ersatzteile.ersatzteil_detail', ersatzteil_id=p.ErsatzteilID) }}" class="text-decoration-none">
                                {{ p.ErsatzteilID }}
                            </a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>{{ p.Bestellnummer or '-' }}</td>
                        <td>{{ p.Bezeichnung or '-' }}</td>
                        <td>{{ p.Menge }}</td>
                        <td>{{ p.Einheit or 'St√ºck' }}</td>
                        <td>
                            {% if p.ErhalteneMenge > 0 %}
                            <span class="badge {% if p.ErhalteneMenge < p.Menge %}bg-warning{% else %}bg-success{% endif %}">
                                {{ p.ErhalteneMenge }} von {{ p.Menge }}
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">0 von {{ p.Menge }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if p.Preis %}
                            {{ "%.2f"|format(p.Preis) }} {{ p.Waehrung or 'EUR' }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if p.Preis %}
                            {{ "%.2f"|format(p.Preis * p.Menge) }} {{ p.Waehrung or 'EUR' }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>{{ p.Bemerkung or '-' }}</td>
                        <td>
                            {% if p.Link %}
                            <a href="{{ p.Link }}" target="_blank" rel="noopener noreferrer">
                                <i class="bi bi-link-45deg"></i> Link
                            </a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        {% if bestellung.Status in ['Erstellt', 'Zur Freigabe'] %}
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditPositionModal({{ p.ID }}, '{{ p.Bestellnummer|replace("'", "\\'") or '' }}', '{{ p.Bezeichnung|replace("'", "\\'") or '' }}', {{ p.Menge }}, '{{ p.Einheit|replace("'", "\\'") or 'St√ºck' }}', {{ p.Preis or 0 }}, '{{ p.Waehrung or 'EUR' }}', '{{ p.Bemerkung|replace("'", "\\'") or '' }}', {% if p.Link %}'{{ p.Link|replace("'", "\\'") }}'{% else %}''{% endif %})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form method="POST" action="{{ url_for('ersatzteile.bestellung_position_loeschen', bestellung_id=bestellung.ID, position_id=p.ID) }}" 
                                  onsubmit="return confirm('Position wirklich l√∂schen?');" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Keine Positionen vorhanden.
        </div>
        {% endif %}
    </div>
</div>

<!-- PDF-Dateien -->
{% if dateien %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üìÑ Bestellungs-PDFs</h5>
        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#pdfUploadCollapse">
            <i class="bi bi-plus-circle"></i> PDF hochladen
        </button>
    </div>
    <div class="collapse" id="pdfUploadCollapse">
        <div class="card-body">
            {{ datei_upload(
                bereich_typ='Bestellung',
                bereich_id=bestellung.ID,
                erlaubte_dateitypen=['PDF'],
                upload_route='ersatzteile.bestellung_datei_upload',
                import_route=None,
                accept_attr='.pdf',
                upload_tab_id='pdf-upload-tab',
                import_tab_id='pdf-import-tab',
                import_function='ladeImportDateien("pdf")'
            ) }}
        </div>
    </div>
    <div class="card-body">
        {{ datei_liste(
            dateien=dateien,
            bereich_typ='Bestellung',
            bereich_id=bestellung.ID,
            erlaubte_dateitypen=['PDF'],
            is_admin=is_admin,
            datei_anzeigen_route='ersatzteile.bestellung_datei_anzeigen',
            datei_loeschen_route='ersatzteile.datei_loeschen',
            nur_bilder=False
        ) }}
    </div>
</div>
{% endif %}

<!-- Auftragsbest√§tigungen -->
{% if bestellung.Status in ['Bestellt', 'Teilweise erhalten', 'Erhalten', 'Erledigt'] %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üìã Auftragsbest√§tigungen</h5>
        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#auftragsbest√§tigungUploadCollapse">
            <i class="bi bi-plus-circle"></i> Auftragsbest√§tigung hochladen
        </button>
    </div>
    <div class="collapse" id="auftragsbest√§tigungUploadCollapse">
        <div class="card-body">
            {{ datei_upload(
                bereich_typ='Bestellung',
                bereich_id=bestellung.ID,
                erlaubte_dateitypen=['PDF', 'Bild'],
                upload_route='ersatzteile.bestellung_auftragsbest√§tigung_upload',
                import_route=None,
                accept_attr='.pdf,.jpeg,.jpg,.png',
                upload_tab_id='ab-upload-tab',
                import_tab_id='ab-import-tab',
                import_function='ladeImportDateien("ab")'
            ) }}
        </div>
    </div>
    <div class="card-body">
        {{ datei_liste(
            dateien=auftragsbest√§tigungen,
            bereich_typ='Bestellung',
            bereich_id=bestellung.ID,
            erlaubte_dateitypen=['PDF', 'Bild'],
            is_admin=is_admin,
            datei_anzeigen_route='ersatzteile.auftragsbest√§tigung_anzeigen',
            datei_loeschen_route='ersatzteile.datei_loeschen',
            nur_bilder=False
        ) }}
    </div>
</div>
{% endif %}

<!-- Lieferscheine -->
{% if bestellung.Status in ['Bestellt', 'Teilweise erhalten', 'Erhalten', 'Erledigt'] %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">üì¶ Lieferscheine</h5>
    </div>
    <div class="card-body">
        {{ datei_liste(
            dateien=lieferscheine,
            bereich_typ='Bestellung',
            bereich_id=bestellung.ID,
            erlaubte_dateitypen=['PDF', 'Bild'],
            is_admin=is_admin,
            datei_anzeigen_route='ersatzteile.lieferschein_anzeigen',
            datei_loeschen_route='ersatzteile.datei_loeschen',
            nur_bilder=False
        ) }}
    </div>
</div>
{% endif %}

<!-- Modal f√ºr Position bearbeiten -->
<div class="modal fade" id="editPositionModal" tabindex="-1" aria-labelledby="editPositionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPositionModalLabel">Position bearbeiten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="editPositionForm" action="">
                <div class="modal-body">
                    <input type="hidden" id="edit_position_id" name="position_id">
                    <div class="mb-3">
                        <label class="form-label">Bestellnummer: <span class="text-danger">*</span></label>
                        <input type="text" id="edit_bestellnummer" name="bestellnummer" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bezeichnung: <span class="text-danger">*</span></label>
                        <input type="text" id="edit_bezeichnung" name="bezeichnung" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Menge: <span class="text-danger">*</span></label>
                        <input type="number" id="edit_menge" name="menge" class="form-control" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Einheit:</label>
                        <input type="text" id="edit_einheit" name="einheit" class="form-control" value="St√ºck" placeholder="St√ºck">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Preis:</label>
                        <input type="number" id="edit_preis" name="preis" class="form-control" step="0.01" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">W√§hrung:</label>
                        <select id="edit_waehrung" name="waehrung" class="form-select">
                            <option value="EUR">EUR</option>
                            <option value="USD">USD</option>
                            <option value="CHF">CHF</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bemerkung:</label>
                        <input type="text" id="edit_bemerkung" name="bemerkung" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Link:</label>
                        <input type="url" id="edit_link" name="link" class="form-control" placeholder="Optional">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal f√ºr Sichtbarkeit -->
<div class="modal fade" id="sichtbarkeitModal" tabindex="-1" aria-labelledby="sichtbarkeitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="sichtbarkeitModalLabel">
                    <i class="bi bi-eye"></i> Sichtbarkeit bearbeiten
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="sichtbarkeitForm" method="POST" action="">
                <div class="modal-body">
                    <div id="sichtbarkeitCheckboxen">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">L√§dt...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> Abbrechen
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveSichtbarkeit()">
                        <i class="bi bi-check-lg"></i> Speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Lookup-Funktion f√ºr Detail-Seite
function lookupErsatzteilDetail(button) {
    const form = button.closest('form');
    const ersatzteilInput = form.querySelector('.ersatzteil-id-input');
    const bestellnummerDisplay = form.querySelector('.bestellnummer-display');
    const bezeichnungDisplay = form.querySelector('.bezeichnung-display');
    const einheitDisplay = form.querySelector('.einheit-display');
    const linkDisplay = form.querySelector('.link-display');
    
    const ersatzteilId = ersatzteilInput.value.trim();
    
    // Wenn keine ID eingegeben, Modal √∂ffnen
    if (!ersatzteilId) {
        // LieferantID aus Bestellung ermitteln
        const lieferantId = {{ bestellung.LieferantID }};
        
        if (!lieferantId) {
            alert('Kein Lieferant zugeordnet.');
            return;
        }
        
        // Modal √∂ffnen und Ersatzteile laden
        openErsatzteilModalDetail(lieferantId, form);
        return;
    }
    
    // Button deaktivieren w√§hrend der Suche
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    // AJAX-Anfrage
    fetch(`{{ url_for('ersatzteile.api_ersatzteil_info', ersatzteil_id=0) }}`.replace('/0', `/${ersatzteilId}`))
        .then(response => response.json())
        .then(data => {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-right"></i>';
            
            if (data.success) {
                bestellnummerDisplay.value = data.bestellnummer;
                bezeichnungDisplay.value = data.bezeichnung;
                if (einheitDisplay && data.einheit) {
                    einheitDisplay.value = data.einheit;
                }
                // Preis und W√§hrung √ºbernehmen, falls vorhanden
                const form = button.closest('form');
                const preisInput = form.querySelector('input[name="preis"]');
                const waehrungSelect = form.querySelector('select[name="waehrung"]');
                if (preisInput && data.preis) {
                    preisInput.value = data.preis;
                }
                if (waehrungSelect && data.waehrung) {
                    waehrungSelect.value = data.waehrung;
                }
                if (linkDisplay && data.link) {
                    linkDisplay.value = data.link;
                }
                bestellnummerDisplay.classList.remove('is-invalid');
                bezeichnungDisplay.classList.remove('is-invalid');
                ersatzteilInput.classList.remove('is-invalid');
            } else {
                bestellnummerDisplay.value = '';
                bezeichnungDisplay.value = '';
                if (einheitDisplay) {
                    einheitDisplay.value = 'St√ºck';
                }
                bestellnummerDisplay.classList.add('is-invalid');
                bezeichnungDisplay.classList.add('is-invalid');
                ersatzteilInput.classList.add('is-invalid');
                alert(data.message || 'Ersatzteil nicht gefunden.');
            }
        })
        .catch(error => {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-right"></i>';
            console.error('Fehler:', error);
            alert('Fehler beim Laden der Ersatzteil-Daten.');
        });
}

function openErsatzteilModalDetail(lieferantId, targetForm) {
    const modal = new bootstrap.Modal(document.getElementById('ersatzteilModalDetail'));
    const modalBody = document.getElementById('ersatzteilModalListDetail');
    
    // Modal-Body leeren und Ladeanzeige anzeigen
    modalBody.innerHTML = '<div class="text-center p-4"><div class="spinner-border" role="status"><span class="visually-hidden">L√§dt...</span></div></div>';
    
    // Suchfeld leeren
    const searchInput = document.getElementById('ersatzteilSearchDetail');
    if (searchInput) {
        searchInput.value = '';
    }
    
    // Modal √∂ffnen
    modal.show();
    
    // Ersatzteile laden
    const apiUrl = `{{ url_for('ersatzteile.api_ersatzteile_lieferant', lieferant_id=0) }}`.replace('/0', `/${lieferantId}`);
    console.log('Lade Ersatzteile von:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            console.log('API Response Status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API Response Data:', data);
            if (data.success && data.ersatzteile && data.ersatzteile.length > 0) {
                // Speichere die urspr√ºngliche Liste f√ºr Filterung
                window.ersatzteilListDetail = data.ersatzteile;
                
                // Rendere die Liste
                renderErsatzteilListDetail(data.ersatzteile);
                
                // Suchfeld-Event-Listener hinzuf√ºgen
                const searchInput = document.getElementById('ersatzteilSearchDetail');
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        filterErsatzteilListDetail(this.value);
                    });
                    // Fokus auf Suchfeld setzen
                    searchInput.focus();
                }
            } else {
                modalBody.innerHTML = '<div class="alert alert-info">Keine Ersatzteile f√ºr diesen Lieferanten gefunden.</div>';
            }
        })
        .catch(error => {
            console.error('Fehler beim Laden der Ersatzteile:', error);
            console.error('Error details:', {
                message: error.message,
                stack: error.stack,
                name: error.name
            });
            modalBody.innerHTML = `<div class="alert alert-danger">
                <strong>Fehler beim Laden der Ersatzteile:</strong><br>
                ${error.message || 'Unbekannter Fehler'}
            </div>`;
        });
}

// Funktion zum Rendern der Ersatzteil-Liste
function renderErsatzteilListDetail(ersatzteile) {
    const modalBody = document.getElementById('ersatzteilModalListDetail');
    if (!modalBody) return;
    
    if (ersatzteile.length === 0) {
        modalBody.innerHTML = '<div class="alert alert-info">Keine Ersatzteile gefunden.</div>';
        return;
    }
    
    let html = '<div class="list-group">';
    ersatzteile.forEach(ersatzteil => {
        const bestandText = `${ersatzteil.bestand || 0} ${ersatzteil.einheit || ''}`.trim();
        // Sicherstellen, dass alle Werte korrekt escaped sind
        const preisValue = (ersatzteil.preis != null && ersatzteil.preis !== undefined) ? ersatzteil.preis : 'null';
        const waehrungValue = (ersatzteil.waehrung || 'EUR').replace(/'/g, "\\'");
        const bestellnummerEscaped = (ersatzteil.bestellnummer || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const bezeichnungEscaped = (ersatzteil.bezeichnung || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        html += `
            <a href="#" class="list-group-item list-group-item-action" onclick="selectErsatzteilDetail(${ersatzteil.id}, '${bestellnummerEscaped}', '${bezeichnungEscaped}', ${preisValue}, '${waehrungValue}', event)">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${ersatzteil.bestellnummer || 'Keine Bestellnummer'}</h6>
                    <small>${bestandText}</small>
                </div>
                <p class="mb-1">${ersatzteil.bezeichnung || 'Keine Bezeichnung'}</p>
                <small>ID: ${ersatzteil.id}</small>
            </a>
        `;
    });
    html += '</div>';
    modalBody.innerHTML = html;
}

// Funktion zum Filtern der Ersatzteil-Liste
function filterErsatzteilListDetail(searchTerm) {
    if (!window.ersatzteilListDetail) return;
    
    const term = searchTerm.toLowerCase().trim();
    
    if (term === '') {
        // Wenn leer, alle anzeigen
        renderErsatzteilListDetail(window.ersatzteilListDetail);
        return;
    }
    
    // Filtere die Liste
    const filtered = window.ersatzteilListDetail.filter(ersatzteil => {
        const bestellnummer = (ersatzteil.bestellnummer || '').toLowerCase();
        const bezeichnung = (ersatzteil.bezeichnung || '').toLowerCase();
        const id = ersatzteil.id.toString();
        
        return bestellnummer.includes(term) || 
               bezeichnung.includes(term) || 
               id.includes(term);
    });
    
    renderErsatzteilListDetail(filtered);
}

function selectErsatzteilDetail(id, bestellnummer, bezeichnung, preis, waehrung, event) {
    try {
        console.log('selectErsatzteilDetail aufgerufen:', {id, bestellnummer, bezeichnung, preis, waehrung});
        
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const modalElement = document.getElementById('ersatzteilModalDetail');
        if (!modalElement) {
            console.error('Modal-Element nicht gefunden!');
            alert('Fehler: Modal-Element nicht gefunden.');
            return;
        }
        
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (!modal) {
            console.error('Modal-Instanz nicht gefunden!');
            alert('Fehler: Modal-Instanz nicht gefunden.');
            return;
        }
        
        const form = document.querySelector('#addPositionCollapse form');
        if (!form) {
            console.error('Formular nicht gefunden!');
            alert('Fehler: Formular nicht gefunden.');
            modal.hide();
            return;
        }
        
        const ersatzteilInput = form.querySelector('.ersatzteil-id-input');
        const bestellnummerDisplay = form.querySelector('.bestellnummer-display');
        const bezeichnungDisplay = form.querySelector('.bezeichnung-display');
        const einheitDisplay = form.querySelector('.einheit-display');
        const preisInput = form.querySelector('input[name="preis"]');
        const waehrungSelect = form.querySelector('select[name="waehrung"]');
        
        console.log('Gefundene Inputs:', {
            ersatzteilInput: !!ersatzteilInput,
            bestellnummerDisplay: !!bestellnummerDisplay,
            bezeichnungDisplay: !!bezeichnungDisplay,
            einheitDisplay: !!einheitDisplay,
            preisInput: !!preisInput,
            waehrungSelect: !!waehrungSelect
        });
        
        if (ersatzteilInput) ersatzteilInput.value = id || '';
        if (bestellnummerDisplay) bestellnummerDisplay.value = bestellnummer || '';
        if (bezeichnungDisplay) bezeichnungDisplay.value = bezeichnung || '';
        if (preisInput && preis !== null && preis !== undefined && preis !== 'null') {
            preisInput.value = preis;
        }
        if (waehrungSelect && waehrung) {
            waehrungSelect.value = waehrung;
        }
        
        // Einheit aus API laden
        if (einheitDisplay && id) {
            fetch(`{{ url_for('ersatzteile.api_ersatzteil_info', ersatzteil_id=0) }}`.replace('/0', `/${id}`))
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.einheit) {
                        einheitDisplay.value = data.einheit;
                    }
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Einheit:', error);
                });
        }
        
        // Validierung entfernen
        if (bestellnummerDisplay) bestellnummerDisplay.classList.remove('is-invalid');
        if (bezeichnungDisplay) bezeichnungDisplay.classList.remove('is-invalid');
        if (ersatzteilInput) ersatzteilInput.classList.remove('is-invalid');
        
        console.log('Werte gesetzt, Modal wird geschlossen...');
        modal.hide();
        console.log('Modal geschlossen.');
    } catch (error) {
        console.error('Fehler in selectErsatzteilDetail:', error);
        alert('Fehler beim Ausw√§hlen des Artikels: ' + error.message);
    }
}

// Position bearbeiten Modal √∂ffnen
function openEditPositionModal(positionId, bestellnummer, bezeichnung, menge, einheit, preis, waehrung, bemerkung, link) {
    document.getElementById('edit_position_id').value = positionId;
    document.getElementById('edit_bestellnummer').value = bestellnummer || '';
    document.getElementById('edit_bezeichnung').value = bezeichnung || '';
    document.getElementById('edit_menge').value = menge || 1;
    const einheitInput = document.getElementById('edit_einheit');
    if (einheitInput) {
        einheitInput.value = einheit || 'St√ºck';
    }
    document.getElementById('edit_preis').value = preis || '';
    document.getElementById('edit_waehrung').value = waehrung || 'EUR';
    document.getElementById('edit_bemerkung').value = bemerkung || '';
    const linkInput = document.getElementById('edit_link');
    if (linkInput) {
        // Pr√ºfe ob link "None", "null" oder ein leerer String ist
        if (!link || link === 'None' || link === 'null' || link === 'undefined') {
            linkInput.value = '';
        } else {
            linkInput.value = link;
        }
    }
    
    // Action URL setzen
    const form = document.getElementById('editPositionForm');
    form.action = `/ersatzteile/bestellungen/{{ bestellung.ID }}/position/${positionId}/bearbeiten`;
    
    const modal = new bootstrap.Modal(document.getElementById('editPositionModal'));
    modal.show();
}

// Sichtbarkeits-Modal JavaScript
let currentSichtbarkeitBestellungId = null;

async function openSichtbarkeitModal(bestellungId) {
    currentSichtbarkeitBestellungId = bestellungId;
    const modal = new bootstrap.Modal(document.getElementById('sichtbarkeitModal'));
    const container = document.getElementById('sichtbarkeitCheckboxen');
    
    // Loading-Spinner anzeigen
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">L√§dt...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    try {
        const response = await fetch(`/ersatzteile/bestellungen/${bestellungId}/sichtbarkeit`);
        const data = await response.json();
        
        if (!data.success) {
            container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Daten.</div>';
            return;
        }
        
        // Checkboxen generieren
        let html = '';
        
        // Ausw√§hlbare Abteilungen
        data.auswaehlbare.forEach(gruppe => {
            html += '<div class="mb-3">';
            
            // Parent-Abteilung
            const isChecked = gruppe.parent.is_current ? 'checked' : '';
            const label = gruppe.parent.is_primaer ? '(Prim√§rabteilung)' : '(zus√§tzliche Abteilung)';
            
            html += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           name="sichtbare_abteilungen" 
                           value="${gruppe.parent.id}" 
                           id="modal_abt_${gruppe.parent.id}" 
                           ${isChecked}>
                    <label class="form-check-label fw-bold" for="modal_abt_${gruppe.parent.id}">
                        ${gruppe.parent.name}
                    </label>
                    <small class="text-muted">${label}</small>
                </div>
            `;
            
            // Untergeordnete Abteilungen
            if (gruppe.children && gruppe.children.length > 0) {
                html += '<div class="ms-4 mt-2">';
                gruppe.children.forEach(child => {
                    const childChecked = child.is_current ? 'checked' : '';
                    html += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   name="sichtbare_abteilungen" 
                                   value="${child.id}" 
                                   id="modal_abt_${child.id}" 
                                   ${childChecked}>
                            <label class="form-check-label" for="modal_abt_${child.id}">
                                ‚Ü≥ ${child.name}
                            </label>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
        });
        
        // Zus√§tzliche aktuelle Abteilungen
        if (data.zusaetzliche && data.zusaetzliche.length > 0) {
            html += '<hr class="my-3">';
            html += '<div class="alert alert-info small mb-3">';
            html += '<strong>Weitere zugewiesene Abteilungen:</strong><br>';
            html += 'Diese Abteilungen sind aktuell zugewiesen, k√∂nnen aber nicht bearbeitet werden.';
            html += '</div>';
            
            data.zusaetzliche.forEach(abt => {
                const parentLabel = abt.parent ? ` (${abt.parent.name})` : '';
                html += `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" 
                               name="sichtbare_abteilungen" 
                               value="${abt.id}" 
                               id="modal_abt_${abt.id}" 
                               checked disabled>
                        <label class="form-check-label text-muted" for="modal_abt_${abt.id}">
                            ${abt.name}${parentLabel}
                        </label>
                        <small class="text-muted">(gesch√ºtzt)</small>
                    </div>
                `;
            });
        }
        
        container.innerHTML = html;
        
        // Form-Action setzen
        document.getElementById('sichtbarkeitForm').action = `/ersatzteile/bestellungen/${bestellungId}/sichtbarkeit`;
        
    } catch (error) {
        console.error('Fehler beim Laden der Sichtbarkeiten:', error);
        container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Daten.</div>';
    }
}

async function saveSichtbarkeit() {
    const form = document.getElementById('sichtbarkeitForm');
    const bestellungId = currentSichtbarkeitBestellungId;
    const saveButton = document.querySelector('#sichtbarkeitModal .btn-primary');
    
    // Alle Checkboxen sammeln (auch disabled!)
    const allCheckboxes = form.querySelectorAll('input[name="sichtbare_abteilungen"]');
    const selectedIds = [];
    
    allCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedIds.push(checkbox.value);
        }
    });
    
    // FormData manuell erstellen (auch wenn keine ausgew√§hlt - Route verwendet dann Prim√§rabteilung)
    const formData = new FormData();
    selectedIds.forEach(id => {
        formData.append('sichtbare_abteilungen', id);
    });
    
    // Button deaktivieren
    saveButton.disabled = true;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Speichern...';
    
    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Modal schlie√üen
            const modal = bootstrap.Modal.getInstance(document.getElementById('sichtbarkeitModal'));
            modal.hide();
            
            // Erfolgs-Toast anzeigen
            showToast(data.message || 'Sichtbarkeit erfolgreich aktualisiert.', 'success');
        } else {
            alert(data.message || 'Fehler beim Speichern.');
            saveButton.disabled = false;
            saveButton.innerHTML = '<i class="bi bi-check-lg"></i> Speichern';
        }
    } catch (error) {
        console.error('Fehler:', error);
        alert('Fehler beim Speichern.');
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="bi bi-check-lg"></i> Speichern';
    }
}

function showToast(message, type = 'info') {
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-${type === 'success' ? 'success' : type === 'danger' ? 'danger' : 'info'} text-white">
                <strong class="me-auto">
                    ${type === 'success' ? '‚úì Erfolg' : type === 'danger' ? '‚úó Fehler' : '‚Ñπ Info'}
                </strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 5000
    });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// Enter-Taste f√ºr Detail-Seite
document.addEventListener('DOMContentLoaded', function() {
    const detailErsatzteilInput = document.querySelector('#addPositionCollapse .ersatzteil-id-input');
    if (detailErsatzteilInput) {
        detailErsatzteilInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const button = this.closest('form').querySelector('.btn-lookup');
                if (button) {
                    lookupErsatzteilDetail(button);
                }
            }
        });
    }
});

// Unterschrifts-Modal JavaScript
let signatureCanvas = null;
let signatureCtx = null;
let isDrawing = false;
let currentBestellungId = null;
let hasSignature = false;

function openUnterschriftModal(bestellungId) {
    currentBestellungId = bestellungId;
    const modal = new bootstrap.Modal(document.getElementById('unterschriftModal'));
    
    // Canvas initialisieren
    signatureCanvas = document.getElementById('signatureCanvas');
    signatureCtx = signatureCanvas.getContext('2d');
    
    // Canvas leeren und konfigurieren
    signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    signatureCtx.strokeStyle = '#000000';
    signatureCtx.lineWidth = 2;
    signatureCtx.lineCap = 'round';
    signatureCtx.lineJoin = 'round';
    hasSignature = false;
    
    // Form-URL setzen
    document.getElementById('unterschriftForm').action = `/ersatzteile/bestellungen/${bestellungId}/freigeben`;
    document.getElementById('bestellungId').value = bestellungId;
    document.getElementById('unterschriftData').value = '';
    document.getElementById('submitUnterschriftBtn').disabled = true;
    
    // Event-Listener hinzuf√ºgen
    signatureCanvas.removeEventListener('mousedown', startDrawing);
    signatureCanvas.removeEventListener('mousemove', draw);
    signatureCanvas.removeEventListener('mouseup', stopDrawing);
    signatureCanvas.removeEventListener('mouseout', stopDrawing);
    signatureCanvas.removeEventListener('touchstart', handleTouch);
    signatureCanvas.removeEventListener('touchmove', handleTouch);
    signatureCanvas.removeEventListener('touchend', stopDrawing);
    
    signatureCanvas.addEventListener('mousedown', startDrawing);
    signatureCanvas.addEventListener('mousemove', draw);
    signatureCanvas.addEventListener('mouseup', stopDrawing);
    signatureCanvas.addEventListener('mouseout', stopDrawing);
    
    // Touch-Events f√ºr mobile Ger√§te
    signatureCanvas.addEventListener('touchstart', handleTouch, { passive: false });
    signatureCanvas.addEventListener('touchmove', handleTouch, { passive: false });
    signatureCanvas.addEventListener('touchend', stopDrawing);
    
    // File-Input Event-Listener initialisieren
    const fileInput = document.getElementById('signatureFileInput');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                loadSignatureFromFileInput(file);
            }
            // Input zur√ºcksetzen, damit derselbe Datei wieder ausgew√§hlt werden kann
            e.target.value = '';
        });
    }
    
    modal.show();
}

function startDrawing(e) {
    isDrawing = true;
    const rect = signatureCanvas.getBoundingClientRect();
    const scaleX = signatureCanvas.width / rect.width;
    const scaleY = signatureCanvas.height / rect.height;
    const x = (e.clientX - rect.left) * scaleX;
    const y = (e.clientY - rect.top) * scaleY;
    signatureCtx.beginPath();
    signatureCtx.moveTo(x, y);
}

function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    const rect = signatureCanvas.getBoundingClientRect();
    const scaleX = signatureCanvas.width / rect.width;
    const scaleY = signatureCanvas.height / rect.height;
    const x = (e.clientX - rect.left) * scaleX;
    const y = (e.clientY - rect.top) * scaleY;
    signatureCtx.lineTo(x, y);
    signatureCtx.stroke();
    hasSignature = true;
    document.getElementById('submitUnterschriftBtn').disabled = false;
}

function stopDrawing() {
    if (isDrawing) {
        isDrawing = false;
        // Submit-Button aktivieren, wenn gezeichnet wurde
        if (hasSignature) {
            document.getElementById('submitUnterschriftBtn').disabled = false;
        }
    }
}

function handleTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = signatureCanvas.getBoundingClientRect();
    const mouseEvent = new MouseEvent(
        e.type === 'touchstart' ? 'mousedown' : 
        e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY,
        bubbles: true,
        cancelable: true
    });
    signatureCanvas.dispatchEvent(mouseEvent);
}

function clearSignature() {
    signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    document.getElementById('unterschriftData').value = '';
    document.getElementById('submitUnterschriftBtn').disabled = true;
    hasSignature = false;
}

// Unterschrift aus Datei laden
function loadSignatureFromFile() {
    const fileInput = document.getElementById('signatureFileInput');
    if (fileInput) {
        fileInput.click();
    }
}

function loadSignatureFromFileInput(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            // Canvas leeren
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            
            // Bild auf Canvas zeichnen (skaliert)
            const scale = Math.min(
                signatureCanvas.width / img.width,
                signatureCanvas.height / img.height
            );
            const x = (signatureCanvas.width - img.width * scale) / 2;
            const y = (signatureCanvas.height - img.height * scale) / 2;
            
            signatureCtx.drawImage(img, x, y, img.width * scale, img.height * scale);
            hasSignature = true;
            document.getElementById('submitUnterschriftBtn').disabled = false;
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// Unterschrift in Dateisystem speichern
function saveSignatureToFile() {
    if (!hasSignature) {
        alert('Keine Unterschrift vorhanden zum Speichern.');
        return;
    }
    
    // Canvas als Data URL exportieren
    const dataURL = signatureCanvas.toDataURL('image/png');
    
    // Download-Link erstellen
    const link = document.createElement('a');
    link.download = `Unterschrift_${new Date().toISOString().split('T')[0]}.png`;
    link.href = dataURL;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Form-Submit: Unterschrift als Base64 speichern
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('unterschriftForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!hasSignature) {
                e.preventDefault();
                alert('Bitte unterschreiben Sie die Bestellung.');
                return false;
            }
            const dataURL = signatureCanvas.toDataURL('image/png');
            document.getElementById('unterschriftData').value = dataURL;
        });
    }
});
</script>

<!-- Modal f√ºr Ersatzteil-Auswahl (Detail-Seite) -->
<div class="modal fade" id="ersatzteilModalDetail" tabindex="-1" aria-labelledby="ersatzteilModalDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ersatzteilModalDetailLabel">Ersatzteil ausw√§hlen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Suchfeld -->
                <div class="mb-3">
                    <input type="text" class="form-control" id="ersatzteilSearchDetail" placeholder="üîç Suchen nach Bestellnummer, Bezeichnung oder ID..." autocomplete="off">
                </div>
                <div id="ersatzteilModalListDetail">
                    <div class="text-center p-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">L√§dt...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal f√ºr Unterschrift -->
<div class="modal fade" id="unterschriftModal" tabindex="-1" aria-labelledby="unterschriftModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="unterschriftModalLabel">
                    <i class="bi bi-pen"></i> Bestellung freigeben - Unterschrift erforderlich
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="unterschriftForm" method="POST" action="">
                <div class="modal-body">
                    <p class="mb-3">Bitte unterschreiben Sie, um die Bestellung freizugeben:</p>
                    
                    <!-- Canvas f√ºr Unterschrift -->
                    <div class="signature-container mb-3" style="border: 2px solid #ddd; border-radius: 4px; background-color: #fff; position: relative;">
                        <canvas id="signatureCanvas" width="600" height="200" style="display: block; width: 100%; height: 200px; cursor: crosshair;"></canvas>
                        <!-- Versteckter File-Input f√ºr Laden -->
                        <input type="file" id="signatureFileInput" accept="image/png,image/jpeg" style="display: none;">
                    </div>
                    
                    <!-- Buttons f√ºr Canvas -->
                    <div class="d-flex gap-2 mb-3 flex-wrap">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignature()">
                            <i class="bi bi-arrow-counterclockwise"></i> L√∂schen
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadSignatureFromFile()">
                            <i class="bi bi-folder-open"></i>Unterschrift laden
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="saveSignatureToFile()">
                            <i class="bi bi-save"></i> Unterschrift speichern
                        </button>
                        <small class="text-muted align-self-center ms-auto">Unterschrift mit Maus oder Touch zeichnen</small>
                    </div>
                    
                    <input type="hidden" id="unterschriftData" name="unterschrift" value="">
                    <input type="hidden" id="bestellungId" name="bestellung_id" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-success" id="submitUnterschriftBtn" disabled>
                        <i class="bi bi-check-lg"></i> Best√§tigen und Freigeben
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import-Funktionalit√§t JavaScript -->
<script>
async function ladeImportDateien(typ) {
    const listeId = typ === 'pdf' ? 'pdf-import-dateien-liste' : 'ab-import-dateien-liste';
    const liste = document.getElementById(listeId);
    
    if (!liste) return;
    
    liste.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
    
    try {
        const response = await fetch('/api/import/dateien');
        const data = await response.json();
        
        if (!data.success || data.dateien.length === 0) {
            liste.innerHTML = '<div class="alert alert-info">Keine Dateien im Import-Ordner vorhanden.</div>';
            return;
        }
        
        // Filtere nach Dateityp
        let erlaubteEndungen = [];
        if (typ === 'pdf') {
            erlaubteEndungen = ['.pdf'];
        } else if (typ === 'ab') {
            erlaubteEndungen = ['.pdf', '.jpeg', '.jpg', '.png'];
        }
        
        const gefilterteDateien = data.dateien.filter(datei => {
            const ext = '.' + datei.name.split('.').pop().toLowerCase();
            return erlaubteEndungen.some(e => ext === e);
        });
        
        if (gefilterteDateien.length === 0) {
            liste.innerHTML = '<div class="alert alert-warning">Keine passenden Dateien im Import-Ordner (erlaubt: ' + erlaubteEndungen.join(', ') + ').</div>';
            return;
        }
        
        let html = '<div class="list-group">';
        gefilterteDateien.forEach(datei => {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${datei.name}</strong>
                        <br><small class="text-muted">${datei.size}</small>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="verschiebeAusImport('${datei.name.replace(/'/g, "\\'")}', '${typ}', {{ bestellung.ID }})">
                        <i class="bi bi-arrow-right"></i> Verwenden
                    </button>
                </div>
            `;
        });
        html += '</div>';
        liste.innerHTML = html;
    } catch (error) {
        console.error('Fehler beim Laden der Dateien:', error);
        liste.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Dateien.</div>';
    }
}

async function verschiebeAusImport(filename, typ, bestellungId) {
    let zielOrdner = '';
    if (typ === 'pdf') {
        // ANGEBOTE_UPLOAD_FOLDER ist bereits "Angebote", daher nur "Bestellungen/{id}"
        zielOrdner = `Angebote/Bestellungen/${bestellungId}`;
    } else if (typ === 'ab') {
        zielOrdner = `Bestellwesen/Auftragsbest√§tigungen/${bestellungId}`;
    }
    
    if (!zielOrdner) {
        alert('Ung√ºltiger Typ');
        return;
    }
    
    if (!confirm(`M√∂chten Sie die Datei "${filename}" aus dem Import-Ordner verwenden? Die Datei wird verschoben.`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/import/verschieben', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                filename: filename, 
                ziel_ordner: zielOrdner,
                bereich_typ: 'Bestellung',
                bereich_id: bestellungId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Datei erfolgreich verschoben!');
            location.reload();
        } else {
            alert('Fehler: ' + data.message);
        }
    } catch (error) {
        console.error('Fehler beim Verschieben:', error);
        alert('Fehler beim Verschieben der Datei.');
    }
}

// PDF-Export mit Ladeanzeige
async function exportBestellungPDF(bestellungId) {
    // Modal √∂ffnen
    const modal = new bootstrap.Modal(document.getElementById('pdfExportModal'));
    modal.show();
    
    try {
        const url = '{{ url_for("ersatzteile.bestellung_pdf_export", bestellung_id=0) }}'.replace('/0', `/${bestellungId}`);
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Blob aus Response erstellen
        const blob = await response.blob();
        
        // Dateiname aus Content-Disposition Header extrahieren oder generieren
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `Bestellung_${bestellungId}_${new Date().toISOString().split('T')[0]}.pdf`;
        if (contentDisposition) {
            // Regex f√ºr filename="..." oder filename=...
            const filenameMatch = contentDisposition.match(/filename[*]?=['"]?([^'";]+)['"]?/i);
            if (filenameMatch && filenameMatch[1]) {
                filename = filenameMatch[1].trim();
            }
        }
        
        // Download starten
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(downloadUrl);
        
        // Modal schlie√üen
        modal.hide();
        
        // Erfolgs-Toast anzeigen (falls vorhanden)
        if (typeof showToast === 'function') {
            showToast('PDF erfolgreich erstellt und heruntergeladen.', 'success');
        }
    } catch (error) {
        console.error('Fehler beim PDF-Export:', error);
        modal.hide();
        alert('Fehler beim Erstellen des PDFs. Bitte versuchen Sie es erneut.');
    }
}
</script>

<!-- Modal f√ºr PDF-Export -->
<div class="modal fade" id="pdfExportModal" tabindex="-1" aria-labelledby="pdfExportModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">L√§dt...</span>
                </div>
                <h5 class="mb-2">PDF wird erstellt...</h5>
                <p class="text-muted mb-0">Bitte warten Sie, w√§hrend der Bericht generiert wird.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal f√ºr Freigabebemerkung bearbeiten -->
<div class="modal fade" id="freigabebemerkungModal" tabindex="-1" aria-labelledby="freigabebemerkungModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="freigabebemerkungModalLabel">
                    <i class="bi bi-pencil"></i> Freigabebemerkung bearbeiten
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="freigabebemerkungForm" method="POST" action="">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="freigabebemerkung_text" class="form-label">Freigabebemerkung:</label>
                        <input type="text" name="freigabe_bemerkung" id="freigabebemerkung_text" class="form-control" 
                               placeholder="Optional: Bemerkung zur Freigabe...">
                        <small class="form-text text-muted">Diese Bemerkung wird bei der Freigabe angezeigt.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Funktion zum √ñffnen des Freigabebemerkung-Modals
function openFreigabebemerkungModal(bestellungId, aktuellerText) {
    const modal = new bootstrap.Modal(document.getElementById('freigabebemerkungModal'));
    const form = document.getElementById('freigabebemerkungForm');
    const input = document.getElementById('freigabebemerkung_text');
    
    // Aktuellen Text setzen (entschl√ºsseln von HTML-Entities)
    const textField = document.createElement('textarea');
    textField.innerHTML = aktuellerText || '';
    const decodedText = textField.value;
    
    input.value = decodedText;
    
    // Form-Action setzen
    form.action = `{{ url_for('ersatzteile.bestellung_freigabebemerkung_bearbeiten', bestellung_id=0) }}`.replace('/0', `/${bestellungId}`);
    
    // Modal √∂ffnen
    modal.show();
    
    // Fokus auf Eingabefeld setzen
    setTimeout(() => {
        input.focus();
        input.select();
    }, 500);
}
</script>
{% endblock %}

