{% extends "layout/base.html" %}

{% block content %}
<h1 class="mb-4">üìã Lagerbuchungen</h1>

<!-- Schnelle Buchung -->
{% if 'artikel_buchen' in session.get('user_berechtigungen', []) or 'admin' in session.get('user_berechtigungen', []) %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">‚ö° Schnelle Buchung</h5>
        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#buchungCollapse">
            Anzeigen / Ausblenden
        </button>
    </div>
    <div class="collapse show" id="buchungCollapse">
        <div class="card-body">
            <form method="POST" action="{{ url_for('ersatzteile.schnellbuchung') }}">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label"><strong>Ersatzteil-ID:</strong> <span class="text-danger">*</span></label>
                        <input type="number" name="ersatzteil_id" class="form-control" placeholder="z.B. 123" min="1" required>
                        <small class="text-muted">ID des Ersatzteils</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label"><strong>Typ:</strong> <span class="text-danger">*</span></label>
                        <select name="typ" class="form-select" required id="buchungstyp">
                            <option value="Eingang">Eingang</option>
                            <option value="Ausgang" selected>Ausgang</option>
                            <option value="Inventur">Inventur</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label"><strong id="menge-label">Menge:</strong> <span class="text-danger">*</span></label>
                        <input type="number" name="menge" class="form-control" min="1" required id="menge-input">
                        <small class="text-muted" id="menge-hinweis"></small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label"><strong>Kostenstelle:</strong></label>
                        <select name="kostenstelle_id" class="form-select">
                            <option value="">-- Keine --</option>
                            {% for k in kostenstellen %}
                            <option value="{{ k.ID }}">{{ k.Bezeichnung }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label"><strong>Thema ID:</strong></label>
                        <input type="number" name="thema_id" class="form-control" placeholder="z.B. 123" min="1">
                        <small class="text-muted">Optional</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label"><strong>Grund:</strong></label>
                        <input type="text" name="grund" class="form-control" placeholder="z.B. Manuell">
                    </div>
                    <div class="col-12">
                        <label class="form-label"><strong>Bemerkung:</strong></label>
                        <textarea name="bemerkung" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> Buchung durchf√ºhren
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Filter -->
<div class="card mb-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
        <strong>Filter</strong>
        <span class="btn btn-sm btn-outline-primary">
            Anzeigen / Ausblenden
        </span>
    </div>
    <div class="collapse" id="filterCollapse">
        <div class="card-body">
            <form method="get" id="filterForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Ersatzteil</label>
                        <select name="ersatzteil" class="form-select">
                            <option value="">-- Alle Ersatzteile --</option>
                            {% for e in ersatzteile %}
                            <option value="{{ e.ID }}" {% if e.ID|string == ersatzteil_filter %}selected{% endif %}>
                                {{ e.Bestellnummer }} - {{ e.Bezeichnung }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Typ</label>
                        <select name="typ" class="form-select">
                            <option value="">-- Alle Typen --</option>
                            <option value="Eingang" {% if typ_filter == 'Eingang' %}selected{% endif %}>Eingang</option>
                            <option value="Ausgang" {% if typ_filter == 'Ausgang' %}selected{% endif %}>Ausgang</option>
                            <option value="Inventur" {% if typ_filter == 'Inventur' %}selected{% endif %}>Inventur</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Kostenstelle</label>
                        <select name="kostenstelle" class="form-select">
                            <option value="">-- Alle Kostenstellen --</option>
                            {% for k in kostenstellen %}
                            <option value="{{ k.ID }}" {% if k.ID|string == kostenstelle_filter %}selected{% endif %}>{{ k.Bezeichnung }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Datum von</label>
                        <input type="date" name="datum_von" class="form-control" value="{{ datum_von or '' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Datum bis</label>
                        <input type="date" name="datum_bis" class="form-control" value="{{ datum_bis or '' }}">
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="limit_aktiv" id="limitAktiv" value="1" {% if limit_aktiv %}checked{% endif %}>
                            <label class="form-check-label" for="limitAktiv">
                                Limit aktivieren
                            </label>
                        </div>
                        <input type="number" name="limit_wert" id="limitWert" class="form-control" value="{{ limit_wert or 200 }}" min="1" max="10000" {% if not limit_aktiv %}disabled{% endif %}>
                        <small class="text-muted">Anzahl der Eintr√§ge</small>
                    </div>
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">Filter anwenden</button>
                        <a href="{{ url_for('ersatzteile.lagerbuchungen_liste') }}" class="btn btn-secondary">Zur√ºcksetzen</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Lagerbuchungen-Liste -->
<div class="card shadow-sm">
    <div class="card-body">
        {% if lagerbuchungen %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Artikel-ID</th>
                        <th>Ersatzteil</th>
                        <th>Typ</th>
                        <th>Menge</th>
                        <th>Preis</th>
                        <th>Kostenstelle</th>
                        <th>Thema</th>
                        <th>Grund</th>
                        <th>Von</th>
                        <th>Bemerkung</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lb in lagerbuchungen %}
                    <tr>
                        <td>{{ lb.Buchungsdatum[:16] if lb.Buchungsdatum else '-' }}</td>
                        <td>
                            <a href="{{ url_for('ersatzteile.ersatzteil_detail', ersatzteil_id=lb.ErsatzteilID) }}" class="text-decoration-none fw-bold">
                                {{ lb.ErsatzteilID }}
                            </a>
                        </td>
                        <td>
                            <strong>{{ lb.Bestellnummer }}</strong><br>
                            <small class="text-muted">{{ lb.ErsatzteilBezeichnung }}</small>
                        </td>
                        <td>
                            {% if lb.Typ == 'Eingang' %}
                            <span class="badge bg-success">Eingang</span>
                            {% elif lb.Typ == 'Inventur' %}
                            <span class="badge bg-info">Inventur</span>
                            {% else %}
                            <span class="badge bg-danger">Ausgang</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ lb.Menge }}</strong></td>
                        <td>
                            {% if lb.Preis %}
                            {{ "%.2f"|format(lb.Preis) }} {{ lb.Waehrung or 'EUR' }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>{{ lb.Kostenstelle or '-' }}</td>
                        <td>
                            {% if lb.ThemaID %}
                            <a href="{{ url_for('schichtbuch.thema_detail', thema_id=lb.ThemaID) }}" class="text-decoration-none">
                                Thema #{{ lb.ThemaID }}
                            </a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>{{ lb.Grund or '-' }}</td>
                        <td>{{ lb.VerwendetVon or '-' }}</td>
                        <td>{{ lb.Bemerkung or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Keine Lagerbuchungen gefunden.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

<script>
// Dynamische Anpassung des Mengenfelds je nach Buchungstyp
document.addEventListener('DOMContentLoaded', function() {
    const buchungstypSelect = document.getElementById('buchungstyp');
    const mengeInput = document.getElementById('menge-input');
    const mengeLabel = document.getElementById('menge-label');
    const mengeHinweis = document.getElementById('menge-hinweis');
    
    if (buchungstypSelect && mengeInput) {
        function updateMengeField() {
            const typ = buchungstypSelect.value;
            
            if (typ === 'Inventur') {
                mengeLabel.textContent = 'Lagerstand:';
                mengeInput.min = '0';
                mengeInput.placeholder = 'Aktueller Lagerstand';
                mengeHinweis.textContent = 'Geben Sie den genauen Lagerstand ein';
            } else {
                mengeLabel.textContent = 'Menge:';
                mengeInput.min = '1';
                mengeInput.placeholder = '';
                mengeHinweis.textContent = '';
            }
        }
        
        buchungstypSelect.addEventListener('change', updateMengeField);
        updateMengeField(); // Initial aufrufen
    }
    
    // Limit-Checkbox aktivieren/deaktivieren
    const limitAktiv = document.getElementById('limitAktiv');
    const limitWert = document.getElementById('limitWert');
    
    if (limitAktiv && limitWert) {
        limitAktiv.addEventListener('change', function() {
            limitWert.disabled = !this.checked;
            if (!this.checked) {
                limitWert.value = 200; // Standardwert zur√ºcksetzen
            }
        });
    }
});
</script>

