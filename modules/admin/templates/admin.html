{% extends "layout/base.html" %}

{% block content %}
<h1>Admin – Stammdaten</h1>

<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-mitarbeiter">Mitarbeiter</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-berechtigungen">Berechtigungen</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-abteilung">Abteilungen</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-bereich">Bereiche</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-gewerk">Gewerke</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-taetigkeit">Tätigkeiten</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-status">Status</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-kategorie">Ersatzteil-Kategorien</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-kostenstelle">Kostenstellen</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-lagerort">Lagerorte</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-lagerplatz">Lagerplätze</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-lieferant">Lieferanten</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-firmendaten">Firmendaten</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-datenbank">Datenbank</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-etiketten">Etiketten</a></li>
  <li class="nav-item ms-auto"><a class="nav-link" href="{{ url_for('admin.login_logs') }}">Login-Logs</a></li>
  <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard.dashboard') }}">Zurück zum Dashboard</a></li>
  </ul>

<div class="tab-content">
  <!-- Mitarbeiter -->
  <div class="tab-pane fade show active" id="tab-mitarbeiter">
    <div class="card mb-3">
      <div class="card-header">Neuen Mitarbeiter anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.mitarbeiter_add') }}" method="post" class="row g-2">
          <div class="col-md-2"><input name="personalnummer" class="form-control" placeholder="Personalnr." required></div>
          <div class="col-md-2"><input name="vorname" class="form-control" placeholder="Vorname" required></div>
          <div class="col-md-2"><input name="nachname" class="form-control" placeholder="Nachname" required></div>
          <div class="col-md-2"><input type="email" name="email" class="form-control" placeholder="E-Mail"></div>
          <div class="col-md-2"><input type="tel" name="handynummer" class="form-control" placeholder="Handynummer"></div>
          <div class="col-md-2"><input type="password" name="passwort" class="form-control" placeholder="Passwort (optional)"></div>
          <div class="col-md-1 form-check d-flex align-items-center">
            <input class="form-check-input" type="checkbox" name="aktiv" id="maAktiv" checked>
            <label class="form-check-label ms-1" for="maAktiv">Aktiv</label>
          </div>
          <div class="col-12"><button class="btn btn-success">Anlegen</button></div>
        </form>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead class="table-dark">
          <tr><th>Personalnr.</th><th>Name</th><th>E-Mail</th><th>Handynummer</th><th>Primärabteilung</th><th>Aktiv</th><th>Aktionen</th></tr>
        </thead>
        <tbody>
          {% for m in mitarbeiter %}
          <tr>
            <td>{{ m.Personalnummer }}</td>
            <td>{{ m.Nachname }}, {{ m.Vorname }}</td>
            <td>{{ m.Email or '—' }}</td>
            <td>{{ m.Handynummer or '—' }}</td>
            <td>
              {% if m.PrimaerAbteilung %}
                <span class="badge bg-info">{{ m.PrimaerAbteilung }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>{% if m.Aktiv %}<span class="badge bg-success">aktiv</span>{% else %}<span class="badge bg-secondary">inaktiv</span>{% endif %}</td>
            <td>
              <div id="accordion{{ m.ID }}">
                <!-- Stammdaten -->
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#stamm{{ m.ID }}">
                  <i class="bi bi-person-fill"></i> Stammdaten
                </button>
                <div class="collapse mt-2" id="stamm{{ m.ID }}" data-bs-parent="#accordion{{ m.ID }}">
                  <form action="{{ url_for('admin.mitarbeiter_update', mid=m.ID) }}" method="post" class="border p-2 rounded bg-light">
                    <div class="row g-2">
                      <div class="col-md-6">
                        <label class="form-label fw-bold">Vorname:</label>
                        <input name="vorname" class="form-control form-control-sm" value="{{ m.Vorname }}">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold">Nachname:</label>
                        <input name="nachname" class="form-control form-control-sm" value="{{ m.Nachname }}">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold">E-Mail:</label>
                        <input type="email" name="email" class="form-control form-control-sm" value="{{ m.Email or '' }}" placeholder="E-Mail">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold">Handynummer:</label>
                        <input type="tel" name="handynummer" class="form-control form-control-sm" value="{{ m.Handynummer or '' }}" placeholder="Handynummer">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold">Neues Passwort:</label>
                        <input type="password" name="passwort" class="form-control form-control-sm" placeholder="Nur ausfüllen um zu ändern">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold">Status:</label>
                        <div class="form-check mt-2">
                          <input class="form-check-input" type="checkbox" name="aktiv" id="aktiv{{ m.ID }}" {% if m.Aktiv %}checked{% endif %}>
                          <label class="form-check-label" for="aktiv{{ m.ID }}">Aktiv</label>
                        </div>
                      </div>
                      <div class="col-12">
                        <button type="submit" class="btn btn-sm btn-success"><i class="bi bi-save"></i> Speichern</button>
                      </div>
                    </div>
                  </form>
                </div>
                
                <!-- Abteilungszuweisung -->
                <button class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#abt{{ m.ID }}">
                  <i class="bi bi-building"></i> Abteilungen
                </button>
                <div class="collapse mt-2" id="abt{{ m.ID }}" data-bs-parent="#accordion{{ m.ID }}">
                  <form action="{{ url_for('admin.mitarbeiter_abteilungen', mid=m.ID) }}" method="post" class="border p-2 rounded bg-light">
                    <div class="mb-2">
                      <label class="form-label fw-bold">Primärabteilung:</label>
                      <select name="primaer_abteilung_id" class="form-select form-select-sm">
                        <option value="">-- Keine --</option>
                        {% for a in abteilungen %}
                          <option value="{{ a.ID }}" {% if m.PrimaerAbteilungID == a.ID %}selected{% endif %}>
                            {{ a.Bezeichnung }}{% if a.ParentBezeichnung %} ({{ a.ParentBezeichnung }}){% endif %}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="mb-2">
                      <label class="form-label fw-bold">Zusätzliche Abteilungen:</label>
                      {% for a in abteilungen %}
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="zusaetzliche_abteilungen" value="{{ a.ID }}" id="zusatz{{ m.ID }}_{{ a.ID }}" 
                          {% if mitarbeiter_abteilungen[m.ID] and a.ID in mitarbeiter_abteilungen[m.ID] %}checked{% endif %}>
                        <label class="form-check-label" for="zusatz{{ m.ID }}_{{ a.ID }}">
                          {{ a.Bezeichnung }}{% if a.ParentBezeichnung %} ({{ a.ParentBezeichnung }}){% endif %}
                        </label>
                      </div>
                      {% endfor %}
                    </div>
                    <button class="btn btn-sm btn-success"><i class="bi bi-save"></i> Abteilungen speichern</button>
                  </form>
                </div>
                
                <!-- Berechtigungszuweisung -->
                <button class="btn btn-sm btn-outline-warning" data-bs-toggle="collapse" data-bs-target="#ber{{ m.ID }}">
                  <i class="bi bi-shield-check"></i> Berechtigungen
                </button>
                <div class="collapse mt-2" id="ber{{ m.ID }}" data-bs-parent="#accordion{{ m.ID }}">
                  <form action="{{ url_for('admin.mitarbeiter_berechtigungen', mid=m.ID) }}" method="post" class="border p-2 rounded bg-light">
                    <label class="form-label fw-bold">Berechtigungen:</label>
                    {% for b in berechtigungen %}
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" 
                             name="berechtigungen" 
                             value="{{ b.ID }}"
                             id="ber{{ m.ID }}_{{ b.ID }}"
                             {% if b.ID in mitarbeiter_berechtigungen[m.ID] %}checked{% endif %}>
                      <label class="form-check-label" for="ber{{ m.ID }}_{{ b.ID }}">
                        {{ b.Bezeichnung }}
                        {% if b.Beschreibung %}<small class="text-muted">({{ b.Beschreibung }})</small>{% endif %}
                      </label>
                    </div>
                    {% endfor %}
                    <button class="btn btn-sm btn-success mt-2"><i class="bi bi-save"></i> Berechtigungen speichern</button>
                  </form>
                </div>
                
                <button class="btn btn-sm btn-outline-danger mt-1" onclick="resetPassword({{ m.ID }}, '{{ m.Vorname }}', '{{ m.Nachname }}')">
                  <i class="bi bi-key-fill"></i> Passwort zurücksetzen
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Berechtigungen -->
  <div class="tab-pane fade" id="tab-berechtigungen">
    <div class="card mb-3">
      <div class="card-header">Neue Berechtigung anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.berechtigung_add') }}" method="post" class="row g-2">
          <div class="col-md-3"><input name="schluessel" class="form-control" placeholder="Schlüssel (z.B. artikel_buchen)" required></div>
          <div class="col-md-3"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung" required></div>
          <div class="col-md-5"><input name="beschreibung" class="form-control" placeholder="Beschreibung"></div>
          <div class="col-md-1 form-check d-flex align-items-center">
            <input class="form-check-input" type="checkbox" name="aktiv" id="berAktiv" checked>
            <label class="form-check-label ms-1" for="berAktiv">Aktiv</label>
          </div>
          <div class="col-12"><button class="btn btn-success">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark">
        <tr><th>Schlüssel</th><th>Bezeichnung</th><th>Beschreibung</th><th>Aktiv</th><th>Aktionen</th></tr>
      </thead>
      <tbody>
        {% for b in berechtigungen %}
        <tr>
          <td><code>{{ b.Schluessel }}</code></td>
          <td>{{ b.Bezeichnung }}</td>
          <td>{{ b.Beschreibung or '—' }}</td>
          <td>{% if b.Aktiv %}<span class="badge bg-success">aktiv</span>{% else %}<span class="badge bg-secondary">inaktiv</span>{% endif %}</td>
          <td>
            <form action="{{ url_for('admin.berechtigung_update', bid=b.ID) }}" method="post" class="row g-1 mb-1">
              <div class="col-md-4"><input name="bezeichnung" class="form-control form-control-sm" value="{{ b.Bezeichnung }}"></div>
              <div class="col-md-5"><input name="beschreibung" class="form-control form-control-sm" value="{{ b.Beschreibung or '' }}" placeholder="Beschreibung"></div>
              <div class="col-md-2 form-check d-flex align-items-center">
                <input class="form-check-input" type="checkbox" name="aktiv" id="berAktiv{{ b.ID }}" {% if b.Aktiv %}checked{% endif %}>
                <label class="form-check-label ms-1" for="berAktiv{{ b.ID }}">Aktiv</label>
              </div>
              <div class="col-md-1"><button class="btn btn-sm btn-primary w-100"><i class="bi bi-save"></i></button></div>
            </form>
            <form action="{{ url_for('admin.berechtigung_toggle', bid=b.ID) }}" method="post" class="d-inline">
              <button class="btn btn-sm btn-outline-secondary">{% if b.Aktiv %}Deaktivieren{% else %}Aktivieren{% endif %}</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Abteilungen -->
  <div class="tab-pane fade" id="tab-abteilung">
    <div class="card mb-3">
      <div class="card-header">Neue Abteilung anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.abteilung_add') }}" method="post" class="row g-2">
          <div class="col-md-5"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung" required></div>
          <div class="col-md-4">
            <select name="parent_abteilung_id" class="form-select">
              <option value="">-- Hauptabteilung (keine Überabteilung) --</option>
              {% for a in abteilungen %}
                {% if a.Aktiv %}
                  <option value="{{ a.ID }}">{{ a.Bezeichnung }}{% if a.ParentBezeichnung %} ({{ a.ParentBezeichnung }}){% endif %}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2"><input type="number" name="sortierung" class="form-control" placeholder="Sortierung" value="0"></div>
          <div class="col-md-1"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark">
        <tr><th>Bezeichnung</th><th>Überabteilung</th><th>Sortierung</th><th>Aktiv</th><th>Aktionen</th></tr>
      </thead>
      <tbody>
        {% for a in abteilungen %}
        <tr>
          <td>{{ a.Bezeichnung }}</td>
          <td>
            {% if a.ParentBezeichnung %}
              <span class="badge bg-secondary">{{ a.ParentBezeichnung }}</span>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
          <td>{{ a.Sortierung }}</td>
          <td>{% if a.Aktiv %}<span class="badge bg-success">aktiv</span>{% else %}<span class="badge bg-secondary">inaktiv</span>{% endif %}</td>
          <td>
            <form action="{{ url_for('admin.abteilung_update', aid=a.ID) }}" method="post" class="row g-1 align-items-center">
              <div class="col-md-4"><input name="bezeichnung" class="form-control form-control-sm" value="{{ a.Bezeichnung }}"></div>
              <div class="col-md-4">
                <select name="parent_abteilung_id" class="form-select form-select-sm">
                  <option value="">-- Hauptabteilung --</option>
                  {% for p in abteilungen %}
                    {% if p.ID != a.ID %}
                      <option value="{{ p.ID }}" {% if p.ID == a.ParentAbteilungID %}selected{% endif %}>
                        {{ p.Bezeichnung }}{% if p.ParentBezeichnung %} ({{ p.ParentBezeichnung }}){% endif %}
                      </option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-1"><input type="number" name="sortierung" class="form-control form-control-sm" value="{{ a.Sortierung }}"></div>
              <div class="col-md-2 form-check d-flex align-items-center">
                <input class="form-check-input" type="checkbox" name="aktiv" id="abtAktiv{{ a.ID }}" {% if a.Aktiv %}checked{% endif %}>
                <label class="form-check-label ms-1" for="abtAktiv{{ a.ID }}">Aktiv</label>
              </div>
              <div class="col-md-1"><button class="btn btn-sm btn-primary w-100"><i class="bi bi-save"></i> Speichern</button></div>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Bereiche -->
  <div class="tab-pane fade" id="tab-bereich">
    <div class="card mb-3">
      <div class="card-header">Neuen Bereich anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.bereich_add') }}" method="post" class="row g-2">
          <div class="col-md-6"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung" required></div>
          <div class="col-md-12"><button class="btn btn-success">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>Bezeichnung</th><th style="width: 120px;">Aktiv</th><th style="width: 120px;">Aktionen</th></tr></thead>
      <tbody>
        {% for b in bereiche %}
        <tr>
          <td>
            <form action="{{ url_for('admin.bereich_update', bid=b.ID) }}" method="post" class="d-flex align-items-center gap-2">
              <input name="bezeichnung" class="form-control form-control-sm" value="{{ b.Bezeichnung }}">
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="bereichAktiv{{ b.ID }}" {% if b.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="bereichAktiv{{ b.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary"><i class="bi bi-save"></i> Speichern</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Gewerke -->
  <div class="tab-pane fade" id="tab-gewerk">
    <div class="card mb-3">
      <div class="card-header">Neues Gewerk anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.gewerk_add') }}" method="post" class="row g-2">
          <div class="col-md-5"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung" required></div>
          <div class="col-md-5">
            <select name="bereich_id" class="form-select" required>
              <option value="">-- Bereich wählen --</option>
              {% for b in bereiche %}
                <option value="{{ b.ID }}">{{ b.Bezeichnung }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>Gewerk-Bezeichnung</th><th style="width: 200px;">Bereich</th><th style="width: 120px;">Aktiv</th><th style="width: 120px;">Aktionen</th></tr></thead>
      <tbody>
        {% for g in gewerke %}
        <tr>
          <td>
            <form action="{{ url_for('admin.gewerk_update', gid=g.ID) }}" method="post" class="d-flex align-items-center gap-2">
              <input name="bezeichnung" class="form-control form-control-sm" value="{{ g.Bezeichnung }}">
          </td>
          <td>
              <select name="bereich_id" class="form-select form-select-sm">
                {% for b in bereiche %}
                  <option value="{{ b.ID }}" {% if b.ID == g.BereichID %}selected{% endif %}>{{ b.Bezeichnung }}</option>
                {% endfor %}
              </select>
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="gewerkAktiv{{ g.ID }}" {% if g.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="gewerkAktiv{{ g.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary"><i class="bi bi-save"></i> Speichern</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Tätigkeiten -->
  <div class="tab-pane fade" id="tab-taetigkeit">
    <div class="card mb-3">
      <div class="card-header">Neue Tätigkeit anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.taetigkeit_add') }}" method="post" class="row g-2">
          <div class="col-md-6"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung" required></div>
          <div class="col-md-3"><input type="number" name="sortierung" class="form-control" placeholder="Sortierung" value="0"></div>
          <div class="col-md-3"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>Bezeichnung</th><th style="width: 150px;">Sortierung</th><th style="width: 120px;">Aktiv</th><th style="width: 120px;">Aktionen</th></tr></thead>
      <tbody>
        {% for t in taetigkeiten %}
        <tr>
          <td>
            <form action="{{ url_for('admin.taetigkeit_update', tid=t.ID) }}" method="post" class="d-flex align-items-center gap-2">
              <input name="bezeichnung" class="form-control form-control-sm" value="{{ t.Bezeichnung }}">
          </td>
          <td>
              <input type="number" name="sortierung" class="form-control form-control-sm" value="{{ t.Sortierung }}">
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="taetAktiv{{ t.ID }}" {% if t.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="taetAktiv{{ t.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary"><i class="bi bi-save"></i> Speichern</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Status -->
  <div class="tab-pane fade" id="tab-status">
    <div class="card mb-3">
      <div class="card-header">Neuen Status anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.status_add') }}" method="post" class="row g-2">
          <div class="col-md-4"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung" required></div>
          <div class="col-md-4">
            <div class="input-group">
              <input type="color" class="form-control form-control-color" value="#6c757d" title="Farbe wählen" data-color-picker>
              <input type="text" name="farbe" class="form-control" placeholder="#RRGGBB" value="#6c757d" pattern="^#[0-9A-Fa-f]{6}$" data-color-text>
            </div>
          </div>
          <div class="col-md-3"><input type="number" name="sortierung" class="form-control" placeholder="Sortierung" value="0"></div>
          <div class="col-md-1"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>Bezeichnung</th><th style="width: 200px;">Farbe</th><th style="width: 150px;">Sortierung</th><th style="width: 120px;">Aktiv</th><th style="width: 120px;">Aktionen</th></tr></thead>
      <tbody>
        {% for s in status %}
        <tr>
          <td>
            <form action="{{ url_for('admin.status_update', sid=s.ID) }}" method="post" class="d-flex align-items-center gap-2" data-status-form>
              <input name="bezeichnung" class="form-control form-control-sm" value="{{ s.Bezeichnung }}">
          </td>
          <td>
              <div class="input-group input-group-sm">
                <input type="color" class="form-control form-control-color form-control-sm" value="{{ s.Farbe }}" title="Farbe wählen" data-color-picker>
                <input type="text" name="farbe" class="form-control form-control-sm" value="{{ s.Farbe }}" pattern="^#[0-9A-Fa-f]{6}$" data-color-text>
              </div>
          </td>
          <td>
              <input type="number" name="sortierung" class="form-control form-control-sm" value="{{ s.Sortierung }}">
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="statusAktiv{{ s.ID }}" {% if s.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="statusAktiv{{ s.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary"><i class="bi bi-save"></i> Speichern</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Ersatzteil-Kategorien -->
  <div class="tab-pane fade" id="tab-kategorie">
    <div class="card mb-3">
      <div class="card-header">Neue Ersatzteil-Kategorie anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.ersatzteil_kategorie_add') }}" method="post" class="row g-2">
          <div class="col-md-5"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung" required></div>
          <div class="col-md-4"><input name="beschreibung" class="form-control" placeholder="Beschreibung (optional)"></div>
          <div class="col-md-2"><input type="number" name="sortierung" class="form-control" placeholder="Sortierung" value="0"></div>
          <div class="col-md-1"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>Bezeichnung</th><th>Beschreibung</th><th style="width: 150px;">Sortierung</th><th style="width: 120px;">Aktiv</th><th style="width: 120px;">Aktionen</th></tr></thead>
      <tbody>
        {% for k in ersatzteil_kategorien %}
        <tr>
          <td>
            <form action="{{ url_for('admin.ersatzteil_kategorie_update', kid=k.ID) }}" method="post" class="d-flex align-items-center gap-2">
              <input name="bezeichnung" class="form-control form-control-sm" value="{{ k.Bezeichnung }}" required>
          </td>
          <td>
              <input name="beschreibung" class="form-control form-control-sm" value="{{ k.Beschreibung or '' }}">
          </td>
          <td>
              <input type="number" name="sortierung" class="form-control form-control-sm" value="{{ k.Sortierung }}">
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="katAktiv{{ k.ID }}" {% if k.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="katAktiv{{ k.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary"><i class="bi bi-save"></i> Speichern</button>
            </form>
            <form action="{{ url_for('admin.ersatzteil_kategorie_delete', kid=k.ID) }}" method="post" class="d-inline mt-1">
              <button class="btn btn-sm btn-danger" onclick="return confirm('Kategorie wirklich deaktivieren?')"><i class="bi bi-trash"></i> Löschen</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Kostenstellen -->
  <div class="tab-pane fade" id="tab-kostenstelle">
    <div class="card mb-3">
      <div class="card-header">Neue Kostenstelle anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.kostenstelle_add') }}" method="post" class="row g-2">
          <div class="col-md-4"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung *" required></div>
          <div class="col-md-5"><input name="beschreibung" class="form-control" placeholder="Beschreibung"></div>
          <div class="col-md-2"><input type="number" name="sortierung" class="form-control" placeholder="Sortierung" value="0"></div>
          <div class="col-md-1"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>Bezeichnung</th><th>Beschreibung</th><th style="width: 150px;">Sortierung</th><th style="width: 120px;">Aktiv</th><th style="width: 120px;">Aktionen</th></tr></thead>
      <tbody>
        {% for k in kostenstellen %}
        <tr>
          <td>
            <form action="{{ url_for('admin.kostenstelle_update', kid=k.ID) }}" method="post" class="d-flex align-items-center gap-2">
              <input name="bezeichnung" class="form-control form-control-sm" value="{{ k.Bezeichnung }}" required>
          </td>
          <td>
              <input name="beschreibung" class="form-control form-control-sm" value="{{ k.Beschreibung or '' }}">
          </td>
          <td>
              <input type="number" name="sortierung" class="form-control form-control-sm" value="{{ k.Sortierung }}">
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="kostenstelleAktiv{{ k.ID }}" {% if k.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="kostenstelleAktiv{{ k.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary"><i class="bi bi-save"></i> Speichern</button>
            </form>
            <form action="{{ url_for('admin.kostenstelle_delete', kid=k.ID) }}" method="post" class="d-inline mt-1">
              <button class="btn btn-sm btn-danger" onclick="return confirm('Kostenstelle wirklich deaktivieren?')"><i class="bi bi-trash"></i> Löschen</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Lagerorte -->
  <div class="tab-pane fade" id="tab-lagerort">
    <div class="card mb-3">
      <div class="card-header">Neuen Lagerort anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.lagerort_add') }}" method="post" class="row g-2">
          <div class="col-md-4"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung *" required></div>
          <div class="col-md-5"><input name="beschreibung" class="form-control" placeholder="Beschreibung"></div>
          <div class="col-md-2"><input type="number" name="sortierung" class="form-control" placeholder="Sortierung" value="0"></div>
          <div class="col-md-1"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>Bezeichnung</th><th>Beschreibung</th><th style="width: 150px;">Sortierung</th><th style="width: 120px;">Aktiv</th><th style="width: 120px;">Aktionen</th></tr></thead>
      <tbody>
        {% for l in lagerorte %}
        <tr>
          <td>
            <form action="{{ url_for('admin.lagerort_update', lid=l.ID) }}" method="post" class="d-flex align-items-center gap-2">
              <input name="bezeichnung" class="form-control form-control-sm" value="{{ l.Bezeichnung }}" required>
          </td>
          <td>
              <input name="beschreibung" class="form-control form-control-sm" value="{{ l.Beschreibung or '' }}">
          </td>
          <td>
              <input type="number" name="sortierung" class="form-control form-control-sm" value="{{ l.Sortierung }}">
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="lagerortAktiv{{ l.ID }}" {% if l.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="lagerortAktiv{{ l.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary"><i class="bi bi-save"></i> Speichern</button>
            </form>
            <form action="{{ url_for('admin.lagerort_delete', lid=l.ID) }}" method="post" class="d-inline mt-1">
              <button class="btn btn-sm btn-danger" onclick="return confirm('Lagerort wirklich deaktivieren?')"><i class="bi bi-trash"></i> Löschen</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Lagerplätze -->
  <div class="tab-pane fade" id="tab-lagerplatz">
    <div class="card mb-3">
      <div class="card-header">Neuen Lagerplatz anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.lagerplatz_add') }}" method="post" class="row g-2">
          <div class="col-md-4"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung *" required></div>
          <div class="col-md-5"><input name="beschreibung" class="form-control" placeholder="Beschreibung"></div>
          <div class="col-md-2"><input type="number" name="sortierung" class="form-control" placeholder="Sortierung" value="0"></div>
          <div class="col-md-1"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>Bezeichnung</th><th>Beschreibung</th><th style="width: 150px;">Sortierung</th><th style="width: 120px;">Aktiv</th><th style="width: 120px;">Aktionen</th></tr></thead>
      <tbody>
        {% for l in lagerplaetze %}
        <tr>
          <td>
            <form action="{{ url_for('admin.lagerplatz_update', lid=l.ID) }}" method="post" class="d-flex align-items-center gap-2">
              <input name="bezeichnung" class="form-control form-control-sm" value="{{ l.Bezeichnung }}" required>
          </td>
          <td>
              <input name="beschreibung" class="form-control form-control-sm" value="{{ l.Beschreibung or '' }}">
          </td>
          <td>
              <input type="number" name="sortierung" class="form-control form-control-sm" value="{{ l.Sortierung }}">
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="lagerplatzAktiv{{ l.ID }}" {% if l.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="lagerplatzAktiv{{ l.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary"><i class="bi bi-save"></i> Speichern</button>
            </form>
            <form action="{{ url_for('admin.lagerplatz_delete', lid=l.ID) }}" method="post" class="d-inline mt-1">
              <button class="btn btn-sm btn-danger" onclick="return confirm('Lagerplatz wirklich deaktivieren?')"><i class="bi bi-trash"></i> Löschen</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Lieferanten -->
  <div class="tab-pane fade" id="tab-lieferant">
    <div class="card mb-3">
      <div class="card-header">Neuen Lieferanten anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.lieferant_add') }}" method="post" class="row g-2">
          <div class="col-md-2"><input name="name" class="form-control" placeholder="Name *" required></div>
          <div class="col-md-2"><input name="kontaktperson" class="form-control" placeholder="Kontaktperson"></div>
          <div class="col-md-2"><input name="telefon" class="form-control" placeholder="Telefon"></div>
          <div class="col-md-2"><input type="email" name="email" class="form-control" placeholder="Email"></div>
          <div class="col-md-2"><input name="strasse" class="form-control" placeholder="Straße"></div>
          <div class="col-md-1"><input name="plz" class="form-control" placeholder="PLZ"></div>
          <div class="col-md-1"><input name="ort" class="form-control" placeholder="Ort"></div>
          <div class="col-md-1"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark">
        <tr>
          <th>Name</th>
          <th>Kontaktperson</th>
          <th>Telefon</th>
          <th>Email</th>
          <th>Straße</th>
          <th>PLZ</th>
          <th>Ort</th>
          <th style="width: 120px;">Aktiv</th>
          <th style="width: 200px;">Aktionen</th>
        </tr>
      </thead>
      <tbody>
        {% for l in lieferanten %}
        <tr>
          <td>
            <form action="{{ url_for('admin.lieferant_update', lid=l.ID) }}" method="post">
              <input name="name" class="form-control form-control-sm" value="{{ l.Name }}" required>
          </td>
          <td>
              <input name="kontaktperson" class="form-control form-control-sm" value="{{ l.Kontaktperson or '' }}">
          </td>
          <td>
              <input name="telefon" class="form-control form-control-sm" value="{{ l.Telefon or '' }}">
          </td>
          <td>
              <input type="email" name="email" class="form-control form-control-sm" value="{{ l.Email or '' }}">
          </td>
          <td>
              <input name="strasse" class="form-control form-control-sm" value="{{ l.Strasse or '' }}">
          </td>
          <td>
              <input name="plz" class="form-control form-control-sm" value="{{ l.PLZ or '' }}">
          </td>
          <td>
              <input name="ort" class="form-control form-control-sm" value="{{ l.Ort or '' }}">
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="lieferantAktiv{{ l.ID }}" {% if l.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="lieferantAktiv{{ l.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary"><i class="bi bi-save"></i> Speichern</button>
            </form>
            <form action="{{ url_for('admin.lieferant_delete', lid=l.ID) }}" method="post" class="d-inline mt-1">
              <button class="btn btn-sm btn-danger" onclick="return confirm('Lieferant wirklich löschen?')"><i class="bi bi-trash"></i> Löschen</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Firmendaten -->
  <div class="tab-pane fade" id="tab-firmendaten">
    <div class="card">
      <div class="card-header">Firmendaten bearbeiten</div>
      <div class="card-body">
        <form action="{{ url_for('admin.firmendaten') }}" method="post">
          <div class="row g-3">
            <div class="col-md-12">
              <h5>Grunddaten</h5>
            </div>
            <div class="col-md-6">
              <label class="form-label">Firmenname <span class="text-danger">*</span></label>
              <input type="text" name="firmenname" class="form-control" value="{{ firmendaten.Firmenname if firmendaten else '' }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Geschäftsführer</label>
              <input type="text" name="geschaeftsfuehrer" class="form-control" value="{{ firmendaten.Geschaeftsfuehrer if firmendaten else '' }}">
            </div>
            <div class="col-md-12">
              <label class="form-label">Straße</label>
              <input type="text" name="strasse" class="form-control" value="{{ firmendaten.Strasse if firmendaten else '' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">PLZ</label>
              <input type="text" name="plz" class="form-control" value="{{ firmendaten.PLZ if firmendaten else '' }}">
            </div>
            <div class="col-md-8">
              <label class="form-label">Ort</label>
              <input type="text" name="ort" class="form-control" value="{{ firmendaten.Ort if firmendaten else '' }}">
            </div>
            <div class="col-md-12">
              <h5 class="mt-4">Lieferanschrift (falls abweichend)</h5>
            </div>
            <div class="col-md-12">
              <label class="form-label">Straße</label>
              <input type="text" name="lieferstrasse" class="form-control" value="{{ firmendaten.LieferStrasse if firmendaten else '' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">PLZ</label>
              <input type="text" name="lieferplz" class="form-control" value="{{ firmendaten.LieferPLZ if firmendaten else '' }}">
            </div>
            <div class="col-md-8">
              <label class="form-label">Ort</label>
              <input type="text" name="lieferort" class="form-control" value="{{ firmendaten.LieferOrt if firmendaten else '' }}">
            </div>
            <div class="col-md-12">
              <h5 class="mt-4">Kontaktdaten</h5>
            </div>
            <div class="col-md-6">
              <label class="form-label">Telefon</label>
              <input type="text" name="telefon" class="form-control" value="{{ firmendaten.Telefon if firmendaten else '' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Fax</label>
              <input type="text" name="fax" class="form-control" value="{{ firmendaten.Fax if firmendaten else '' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">E-Mail</label>
              <input type="email" name="email" class="form-control" value="{{ firmendaten.Email if firmendaten else '' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Website</label>
              <input type="url" name="website" class="form-control" value="{{ firmendaten.Website if firmendaten else '' }}" placeholder="https://...">
            </div>
            <div class="col-md-12">
              <h5 class="mt-4">Steuerdaten</h5>
            </div>
            <div class="col-md-6">
              <label class="form-label">Steuernummer</label>
              <input type="text" name="steuernummer" class="form-control" value="{{ firmendaten.Steuernummer if firmendaten else '' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">USt-IdNr.</label>
              <input type="text" name="ust_idnr" class="form-control" value="{{ firmendaten.UStIdNr if firmendaten else '' }}">
            </div>
            <div class="col-md-12">
              <h5 class="mt-4">Bankverbindung</h5>
            </div>
            <div class="col-md-6">
              <label class="form-label">Bankname</label>
              <input type="text" name="bankname" class="form-control" value="{{ firmendaten.BankName if firmendaten else '' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">IBAN</label>
              <input type="text" name="iban" class="form-control" value="{{ firmendaten.IBAN if firmendaten else '' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">BIC</label>
              <input type="text" name="bic" class="form-control" value="{{ firmendaten.BIC if firmendaten else '' }}">
            </div>
            <div class="col-md-12">
              <h5 class="mt-4">Logo</h5>
            </div>
            <div class="col-md-12">
              <label class="form-label">Logo-Pfad</label>
              <input type="text" name="logopfad" class="form-control" value="{{ firmendaten.LogoPfad if firmendaten else '' }}" placeholder="z.B. static/logo.png">
              <small class="form-text text-muted">Pfad zum Logo-Bild (relativ zum Projektverzeichnis)</small>
            </div>
            <div class="col-12 mt-3">
              <button type="submit" class="btn btn-primary">Speichern</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Datenbank -->
  <div class="tab-pane fade" id="tab-datenbank">
    <div class="alert alert-info">
      <h5><i class="bi bi-info-circle"></i> Datenbank-Verwaltung</h5>
      <p class="mb-0">Hier können Sie die Datenbankstruktur überprüfen und fehlende Tabellen oder Spalten automatisch hinzufügen lassen.</p>
    </div>

    <div class="card mb-3">
      <div class="card-header">Datenbankstruktur überprüfen</div>
      <div class="card-body">
        <p>Überprüfen Sie, ob alle erforderlichen Tabellen und Spalten in der Datenbank vorhanden sind.</p>
        <button id="btnCheckDatabase" class="btn btn-primary" onclick="checkDatabase()">
          <i class="bi bi-search"></i> Struktur überprüfen
        </button>
      </div>
    </div>

    <div id="dbCheckResult" class="card mb-3" style="display: none;">
      <div class="card-header">Prüfergebnis</div>
      <div class="card-body" id="dbCheckResultBody">
        <!-- Ergebnis wird hier eingefügt -->
      </div>
    </div>

    <div id="dbRepairSection" class="card mb-3" style="display: none;">
      <div class="card-header bg-warning">Fehlende Strukturen reparieren</div>
      <div class="card-body">
        <div class="alert alert-warning mb-3">
          <strong><i class="bi bi-exclamation-triangle"></i> Warnung:</strong> Diese Aktion fügt fehlende Tabellen und Spalten zur Datenbank hinzu. 
          Bestehende Daten werden nicht verändert. Es wird empfohlen, vorher ein Backup der Datenbank anzulegen.
        </div>
        <button id="btnRepairDatabase" class="btn btn-warning" onclick="repairDatabase()">
          <i class="bi bi-wrench"></i> Fehlende Strukturen hinzufügen
        </button>
      </div>
    </div>

    <div id="dbRepairResult" class="card mb-3" style="display: none;">
      <div class="card-header bg-success text-white">Reparaturergebnis</div>
      <div class="card-body" id="dbRepairResultBody">
        <!-- Ergebnis wird hier eingefügt -->
      </div>
    </div>
  </div>

  <!-- Etiketten -->
  <div class="tab-pane fade" id="tab-etiketten">
    <div class="row">
      <div class="col-12">
        <div class="card mb-3">
          <div class="card-header">Zebradrucker</div>
          <div class="card-body">
            <form action="{{ url_for('admin.zebra_printer_save') }}" method="post" class="row g-2 mb-3">
              <input type="hidden" name="id" value="">
              <div class="col-md-4">
                <input name="name" class="form-control" placeholder="Name" required>
              </div>
              <div class="col-md-4">
                <input name="ip_address" class="form-control" placeholder="IP-Adresse" required>
              </div>
              <div class="col-md-3">
                <input name="description" class="form-control" placeholder="Beschreibung">
              </div>
              <div class="col-md-1 d-flex align-items-center">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="active" id="zebraActiveNew" checked>
                  <label class="form-check-label" for="zebraActiveNew">Aktiv</label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-success btn-sm">Neuen Drucker anlegen</button>
                <a href="{{ url_for('admin.zebra_test') }}" class="btn btn-outline-primary btn-sm ms-2">Testetikett drucken</a>
              </div>
            </form>

            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle">
                <thead class="table-dark">
                  <tr>
                    <th>Name</th>
                    <th>IP-Adresse</th>
                    <th>Beschreibung</th>
                    <th>Aktiv</th>
                    <th>Aktionen</th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in zebra_printers %}
                  <tr>
                    <td>{{ p.name }}</td>
                    <td>{{ p.ip_address }}</td>
                    <td>{{ p.description or '—' }}</td>
                    <td>
                      {% if p.active %}
                        <span class="badge bg-success">aktiv</span>
                      {% else %}
                        <span class="badge bg-secondary">inaktiv</span>
                      {% endif %}
                    </td>
                    <td>
                      <form action="{{ url_for('admin.zebra_printer_save') }}" method="post" class="row g-1 mb-1">
                        <input type="hidden" name="id" value="{{ p.id }}">
                        <div class="col-md-3">
                          <input name="name" class="form-control form-control-sm" value="{{ p.name }}">
                        </div>
                        <div class="col-md-3">
                          <input name="ip_address" class="form-control form-control-sm" value="{{ p.ip_address }}">
                        </div>
                        <div class="col-md-4">
                          <input name="description" class="form-control form-control-sm" value="{{ p.description or '' }}">
                        </div>
                        <div class="col-md-1 d-flex align-items-center">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="active" id="zebraActive{{ p.id }}" {% if p.active %}checked{% endif %}>
                            <label class="form-check-label" for="zebraActive{{ p.id }}">Aktiv</label>
                          </div>
                        </div>
                        <div class="col-md-1">
                          <button class="btn btn-sm btn-primary w-100"><i class="bi bi-save"></i></button>
                        </div>
                      </form>
                      <form action="{{ url_for('admin.zebra_printer_toggle', pid=p.id) }}" method="post" class="d-inline">
                        <button class="btn btn-sm btn-outline-secondary">
                          {% if p.active %}Deaktivieren{% else %}Aktivieren{% endif %}
                        </button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <div class="card mb-3">
          <div class="card-header">Etikettenformate</div>
          <div class="card-body">
            <form action="{{ url_for('admin.zebra_label_save') }}" method="post" class="row g-2 mb-3">
              <input type="hidden" name="id" value="">
              <div class="col-md-4">
                <input name="name" class="form-control" placeholder="Name (z.B. 30x30 mm)" required>
              </div>
              <div class="col-md-4">
                <input name="description" class="form-control" placeholder="Beschreibung">
              </div>
              <div class="col-md-2">
                <input type="number" name="width_mm" class="form-control" placeholder="Breite mm" required>
              </div>
              <div class="col-md-2">
                <input type="number" name="height_mm" class="form-control" placeholder="Höhe mm" required>
              </div>
              <div class="col-md-4">
                <select name="orientation" class="form-select">
                  <option value="portrait">Portrait</option>
                  <option value="landscape">Landscape</option>
                </select>
              </div>
              <div class="col-md-8">
                <textarea name="zpl_header" class="form-control" rows="2" placeholder="ZPL-Header (^PW, ^LL, ^LS ...)" required></textarea>
              </div>
              <div class="col-12">
                <button class="btn btn-success btn-sm">Neues Etikettenformat anlegen</button>
              </div>
            </form>

            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle">
                <thead class="table-dark">
                  <tr>
                    <th>Name</th>
                    <th>Maße (mm)</th>
                    <th>Ausrichtung</th>
                    <th>Aktionen</th>
                  </tr>
                </thead>
                <tbody>
                  {% for l in label_formats %}
                  <tr>
                    <td>{{ l.name }}</td>
                    <td>{{ l.width_mm }} x {{ l.height_mm }}</td>
                    <td>{{ l.orientation }}</td>
                    <td>
                      <form action="{{ url_for('admin.zebra_label_save') }}" method="post" class="row g-1">
                        <input type="hidden" name="id" value="{{ l.id }}">
                        <div class="col-md-3">
                          <input name="name" class="form-control form-control-sm" value="{{ l.name }}">
                        </div>
                        <div class="col-md-3">
                          <input name="description" class="form-control form-control-sm" value="{{ l.description or '' }}">
                        </div>
                        <div class="col-md-2">
                          <input type="number" name="width_mm" class="form-control form-control-sm" value="{{ l.width_mm }}">
                        </div>
                        <div class="col-md-2">
                          <input type="number" name="height_mm" class="form-control form-control-sm" value="{{ l.height_mm }}">
                        </div>
                        <div class="col-md-2">
                          <select name="orientation" class="form-select form-select-sm">
                            <option value="portrait" {% if l.orientation == 'portrait' %}selected{% endif %}>Portrait</option>
                            <option value="landscape" {% if l.orientation == 'landscape' %}selected{% endif %}>Landscape</option>
                          </select>
                        </div>
                        <div class="col-md-10 mt-1">
                          <textarea name="zpl_header" class="form-control form-control-sm" rows="2">{{ l.zpl_header }}</textarea>
                        </div>
                        <div class="col-md-2 mt-1">
                          <button class="btn btn-sm btn-primary w-100"><i class="bi bi-save"></i></button>
                        </div>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Etiketten (vorkonfigurierte Templates) -->
    <div class="row mt-3">
      <div class="col-12">
        <div class="card mb-3">
          <div class="card-header">Etiketten</div>
          <div class="card-body">
            <form action="{{ url_for('admin.zebra_etikett_save') }}" method="post" class="row g-2 mb-3" id="etikettForm">
              <input type="hidden" name="id" value="" id="etikettId">
              <div class="col-md-3">
                <input name="bezeichnung" class="form-control" placeholder="Bezeichnung (z.B. ErsatzteilLabel)" required id="etikettBezeichnung">
              </div>
              <div class="col-md-3">
                <select name="drucker_id" class="form-select" required id="etikettDrucker">
                  <option value="">-- Drucker wählen --</option>
                  {% for p in zebra_printers %}
                    {% if p.active %}
                      <option value="{{ p.id }}">{{ p.name }} ({{ p.ip_address }})</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <select name="etikettformat_id" class="form-select" required id="etikettFormat">
                  <option value="">-- Etikettenformat wählen --</option>
                  {% for l in label_formats %}
                    <option value="{{ l.id }}">{{ l.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <button type="submit" class="btn btn-success btn-sm">Neues Etikett anlegen</button>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="vorschauEtikett()">Vorschau</button>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold">Druckbefehle (ZPL-Template mit Platzhaltern):</label>
                <textarea name="druckbefehle" class="form-control font-monospace" rows="15" placeholder="ZPL-Template mit Platzhaltern wie {artnr}, {line1}, {line2}, {line3}, {lagerort}, {lagerplatz}, {zpl_header}" required id="etikettDruckbefehle"></textarea>
                <small class="text-muted">Verfügbare Platzhalter: {artnr}, {line1}, {line2}, {line3}, {lagerort}, {lagerplatz}, {zpl_header}</small>
              </div>
            </form>

            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle">
                <thead class="table-dark">
                  <tr>
                    <th>Bezeichnung</th>
                    <th>Drucker</th>
                    <th>Etikettenformat</th>
                    <th>Aktionen</th>
                  </tr>
                </thead>
                <tbody>
                  {% for e in etiketten %}
                  <tr>
                    <td>{{ e.bezeichnung }}</td>
                    <td>
                      {% for p in zebra_printers %}
                        {% if p.id == e.drucker_id %}{{ p.name }} ({{ p.ip_address }}){% endif %}
                      {% endfor %}
                    </td>
                    <td>
                      {% for l in label_formats %}
                        {% if l.id == e.etikettformat_id %}{{ l.name }}{% endif %}
                      {% endfor %}
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" 
                              data-etikett-id="{{ e.id }}"
                              data-etikett-bezeichnung="{{ e.bezeichnung|e }}"
                              data-etikett-drucker="{{ e.drucker_id }}"
                              data-etikett-format="{{ e.etikettformat_id }}"
                              data-etikett-druckbefehle="{{ e.druckbefehle|e|replace('\n', '&#10;')|replace('\r', '') }}"
                              onclick="bearbeiteEtikettAusButton(this)">
                        <i class="bi bi-pencil"></i> Bearbeiten
                      </button>
                      <button class="btn btn-sm btn-outline-info" 
                              data-etikett-id="{{ e.id }}"
                              data-etikett-druckbefehle="{{ e.druckbefehle|e|replace('\n', '&#10;')|replace('\r', '') }}"
                              onclick="vorschauEtikettAusButton(this)">
                        <i class="bi bi-eye"></i> Vorschau
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Toast-Benachrichtigung anzeigen
function showToast(message, type = 'success') {
  // Toast-Container erstellen falls nicht vorhanden
  let toastContainer = document.getElementById('toastContainer');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.id = 'toastContainer';
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = '9999';
    document.body.appendChild(toastContainer);
  }

  // Toast erstellen
  const toastId = 'toast-' + Date.now();
  const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
  const toastHtml = `
    <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  const toastElement = document.getElementById(toastId);
  const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
  toast.show();
  
  // Toast nach dem Ausblenden entfernen
  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}

// AJAX-Formular-Handling
function handleFormSubmit(event) {
  event.preventDefault();
  
  const form = event.target;
  const formData = new FormData(form);
  const submitButton = form.querySelector('button[type="submit"]');
  
  // Button deaktivieren während der Anfrage
  if (submitButton) {
    submitButton.disabled = true;
    submitButton.dataset.originalText = submitButton.textContent;
    submitButton.textContent = 'Lädt...';
  }
  
  fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
      
      // Bei Anlegen-Formularen: Seite neu laden
      if (form.closest('.card-body')) {
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      }
      // Bei Update-Formularen in der Tabelle: nichts tun (Daten bleiben erhalten)
    } else {
      showToast(data.message, 'error');
    }
  })
  .catch(error => {
    showToast('Ein Fehler ist aufgetreten: ' + error.message, 'error');
  })
  .finally(() => {
    // Button wieder aktivieren
    if (submitButton) {
      submitButton.disabled = false;
      submitButton.textContent = submitButton.dataset.originalText;
    }
  });
}

// Color Picker Synchronisation
function setupColorPickers() {
  // Alle Color Picker mit Textfeldern synchronisieren
  document.querySelectorAll('[data-color-picker]').forEach(colorPicker => {
    const textInput = colorPicker.parentElement.querySelector('[data-color-text]');
    
    if (textInput) {
      // Color Picker -> Textfeld (Farbe wird ins Textfeld übertragen)
      colorPicker.addEventListener('input', function() {
        textInput.value = this.value.toUpperCase();
      });
      
      // Textfeld -> Color Picker (bei gültiger Eingabe)
      textInput.addEventListener('input', function() {
        const value = this.value.trim();
        if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
          colorPicker.value = value;
        }
      });
    }
  });
}

// Passwort zurücksetzen
function resetPassword(mitarbeiterId, vorname, nachname) {
  const confirmMessage = `Möchten Sie das Passwort für ${vorname} ${nachname} wirklich auf "${vorname}" zurücksetzen?`;
  
  if (!confirm(confirmMessage)) {
    return;
  }
  
  fetch(`{{ url_for('admin.mitarbeiter_reset_password', mid=0) }}`.replace('/0', `/${mitarbeiterId}`), {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
    } else {
      showToast(data.message, 'error');
    }
  })
  .catch(error => {
    showToast('Ein Fehler ist aufgetreten: ' + error.message, 'error');
  });
}

// Datenbank-Prüfung
function checkDatabase() {
  const btn = document.getElementById('btnCheckDatabase');
  const resultCard = document.getElementById('dbCheckResult');
  const resultBody = document.getElementById('dbCheckResultBody');
  const repairSection = document.getElementById('dbRepairSection');
  
  // Button deaktivieren
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Prüfe...';
  
  // Vorherige Ergebnisse ausblenden
  repairSection.style.display = 'none';
  document.getElementById('dbRepairResult').style.display = 'none';
  
  fetch('{{ url_for("admin.database_check") }}', {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    resultBody.innerHTML = formatCheckResult(data);
    resultCard.style.display = 'block';
    
    // Zeige Reparatur-Sektion nur, wenn Probleme gefunden wurden
    if (data.has_issues) {
      repairSection.style.display = 'block';
    }
    
    // Button wieder aktivieren
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-search"></i> Struktur überprüfen';
  })
  .catch(error => {
    showToast('Fehler bei der Datenbankprüfung: ' + error.message, 'error');
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-search"></i> Struktur überprüfen';
  });
}

// Datenbank-Reparatur
function repairDatabase() {
  const btn = document.getElementById('btnRepairDatabase');
  const resultCard = document.getElementById('dbRepairResult');
  const resultBody = document.getElementById('dbRepairResultBody');
  
  if (!confirm('Möchten Sie die fehlenden Strukturen wirklich zur Datenbank hinzufügen?')) {
    return;
  }
  
  // Button deaktivieren
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Repariere...';
  
  fetch('{{ url_for("admin.database_repair") }}', {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    resultBody.innerHTML = formatRepairResult(data);
    resultCard.style.display = 'block';
    
    if (data.success) {
      showToast('Datenbank erfolgreich repariert!', 'success');
      // Nach erfolgreicher Reparatur erneut prüfen
      setTimeout(() => checkDatabase(), 2000);
    } else {
      showToast('Fehler bei der Reparatur: ' + data.message, 'error');
    }
    
    // Button wieder aktivieren
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-wrench"></i> Fehlende Strukturen hinzufügen';
  })
  .catch(error => {
    showToast('Fehler bei der Datenbankreparatur: ' + error.message, 'error');
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-wrench"></i> Fehlende Strukturen hinzufügen';
  });
}

// Formatiert das Prüfergebnis
function formatCheckResult(data) {
  let html = '';
  
  if (!data.has_issues) {
    html = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> <strong>Perfekt!</strong> Alle erforderlichen Tabellen und Spalten sind vorhanden.</div>';
    return html;
  }
  
  // Fehlende Tabellen
  if (data.missing_tables && data.missing_tables.length > 0) {
    html += '<div class="alert alert-danger"><strong><i class="bi bi-exclamation-triangle"></i> Fehlende Tabellen:</strong><ul class="mb-0 mt-2">';
    data.missing_tables.forEach(table => {
      html += `<li><code>${table}</code></li>`;
    });
    html += '</ul></div>';
  }
  
  // Fehlende Spalten
  if (data.missing_columns && Object.keys(data.missing_columns).length > 0) {
    html += '<div class="alert alert-warning"><strong><i class="bi bi-exclamation-triangle"></i> Fehlende Spalten:</strong>';
    for (const [table, columns] of Object.entries(data.missing_columns)) {
      html += `<div class="mt-2"><strong>Tabelle <code>${table}</code>:</strong><ul class="mb-0">`;
      columns.forEach(column => {
        html += `<li><code>${column}</code></li>`;
      });
      html += '</ul></div>';
    }
    html += '</div>';
  }
  
  // Fehlende Indizes
  if (data.missing_indexes && data.missing_indexes.length > 0) {
    html += '<div class="alert alert-info"><strong><i class="bi bi-info-circle"></i> Fehlende Indizes:</strong><ul class="mb-0 mt-2">';
    data.missing_indexes.forEach(index => {
      html += `<li><code>${index}</code></li>`;
    });
    html += '</ul></div>';
  }
  
  return html;
}

// Formatiert das Reparaturergebnis
function formatRepairResult(data) {
  let html = '';
  
  if (!data.success) {
    html = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> <strong>Fehler:</strong> ${data.message}</div>`;
    if (data.errors && data.errors.length > 0) {
      html += '<div class="alert alert-danger"><strong>Details:</strong><ul class="mb-0">';
      data.errors.forEach(error => {
        html += `<li>${error}</li>`;
      });
      html += '</ul></div>';
    }
    return html;
  }
  
  html += '<div class="alert alert-success"><i class="bi bi-check-circle"></i> <strong>Erfolg!</strong> Die Datenbank wurde erfolgreich repariert.</div>';
  
  // Hinzugefügte Tabellen
  if (data.added_tables && data.added_tables.length > 0) {
    html += '<div class="alert alert-success"><strong>Hinzugefügte Tabellen:</strong><ul class="mb-0">';
    data.added_tables.forEach(table => {
      html += `<li><code>${table}</code></li>`;
    });
    html += '</ul></div>';
  }
  
  // Hinzugefügte Spalten
  if (data.added_columns && Object.keys(data.added_columns).length > 0) {
    html += '<div class="alert alert-success"><strong>Hinzugefügte Spalten:</strong>';
    for (const [table, columns] of Object.entries(data.added_columns)) {
      html += `<div class="mt-2"><strong>Tabelle <code>${table}</code>:</strong><ul class="mb-0">`;
      columns.forEach(column => {
        html += `<li><code>${column}</code></li>`;
      });
      html += '</ul></div>';
    }
    html += '</div>';
  }
  
  // Hinzugefügte Indizes
  if (data.added_indexes && data.added_indexes.length > 0) {
    html += '<div class="alert alert-info"><strong>Hinzugefügte Indizes:</strong><ul class="mb-0">';
    data.added_indexes.forEach(index => {
      html += `<li><code>${index}</code></li>`;
    });
    html += '</ul></div>';
  }
  
  return html;
}

// Event Listener für alle Formulare hinzufügen
document.addEventListener('DOMContentLoaded', function() {
  // Alle Formulare im Admin-Bereich
  document.querySelectorAll('form[action*="/admin/"]').forEach(form => {
    form.addEventListener('submit', handleFormSubmit);
  });
  
  // Color Picker Setup
  setupColorPickers();
  
  // Aktiven Tab speichern und wiederherstellen
  const tabs = document.querySelectorAll('a[data-bs-toggle="tab"]');
  
  // Gespeicherten Tab wiederherstellen
  const savedTab = localStorage.getItem('adminActiveTab');
  if (savedTab) {
    const tabToActivate = document.querySelector(`a[data-bs-toggle="tab"][href="${savedTab}"]`);
    if (tabToActivate) {
      const tab = new bootstrap.Tab(tabToActivate);
      tab.show();
    }
  }
  
  // Tab-Wechsel speichern
  tabs.forEach(tab => {
    tab.addEventListener('shown.bs.tab', function(event) {
      localStorage.setItem('adminActiveTab', event.target.getAttribute('href'));
    });
  });
});


// Hilfsfunktion für Alerts
function showAlert(type, message) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  // Alert am Anfang der Seite einfügen
  const content = document.querySelector('.tab-content');
  content.insertBefore(alertDiv, content.firstChild);
  
  // Alert nach 3 Sekunden automatisch ausblenden
  setTimeout(() => {
    alertDiv.remove();
  }, 3000);
}

// Etikett-Funktionen
function bearbeiteEtikettAusButton(button) {
  const id = button.getAttribute('data-etikett-id');
  const bezeichnung = button.getAttribute('data-etikett-bezeichnung');
  const druckerId = button.getAttribute('data-etikett-drucker');
  const formatId = button.getAttribute('data-etikett-format');
  let druckbefehle = button.getAttribute('data-etikett-druckbefehle');
  
  // HTML-Entities und Escape-Sequenzen zurückkonvertieren
  druckbefehle = druckbefehle.replace(/&#10;/g, '\n').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
  
  document.getElementById('etikettId').value = id;
  document.getElementById('etikettBezeichnung').value = bezeichnung;
  document.getElementById('etikettDrucker').value = druckerId;
  document.getElementById('etikettFormat').value = formatId;
  document.getElementById('etikettDruckbefehle').value = druckbefehle;
  
  // Formular-Button-Text ändern
  const submitBtn = document.querySelector('#etikettForm button[type="submit"]');
  if (submitBtn) {
    submitBtn.textContent = 'Etikett aktualisieren';
  }
  
  // Zum Formular scrollen
  document.getElementById('etikettForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function bearbeiteEtikett(id, bezeichnung, druckerId, formatId, druckbefehle) {
  document.getElementById('etikettId').value = id;
  document.getElementById('etikettBezeichnung').value = bezeichnung;
  document.getElementById('etikettDrucker').value = druckerId;
  document.getElementById('etikettFormat').value = formatId;
  document.getElementById('etikettDruckbefehle').value = druckbefehle;
  
  // Formular-Button-Text ändern
  const submitBtn = document.querySelector('#etikettForm button[type="submit"]');
  if (submitBtn) {
    submitBtn.textContent = 'Etikett aktualisieren';
  }
  
  // Zum Formular scrollen
  document.getElementById('etikettForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function vorschauEtikett() {
  const template = document.getElementById('etikettDruckbefehle').value;
  if (!template) {
    alert('Bitte geben Sie zuerst ein ZPL-Template ein.');
    return;
  }
  
  // Dummy-Daten für Vorschau
  const dummyData = {
    artnr: '123',
    line1: 'Beispiel-Artikel',
    line2: 'Beschreibung Zeile 2',
    line3: 'Beschreibung Zeile 3',
    lagerort: 'Werkstatt',
    lagerplatz: 'B10-B1',
    zpl_header: '^PW240\n^LL240\n^LS0'
  };
  
  let zpl = template;
  for (const [key, value] of Object.entries(dummyData)) {
    zpl = zpl.replace(new RegExp(`\\{${key}\\}`, 'g'), value);
  }
  
  zeigeVorschauModal(zpl);
}

function vorschauEtikettAusButton(button) {
  const id = button.getAttribute('data-etikett-id');
  let druckbefehle = button.getAttribute('data-etikett-druckbefehle');
  
  // HTML-Entities und Escape-Sequenzen zurückkonvertieren
  druckbefehle = druckbefehle.replace(/&#10;/g, '\n').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
  
  vorschauEtikettMitDaten(id, druckbefehle);
}

function vorschauEtikettMitDaten(id, druckbefehle) {
  // Dummy-Daten für Vorschau
  const dummyData = {
    artnr: '123',
    line1: 'Beispiel-Artikel',
    line2: 'Beschreibung Zeile 2',
    line3: 'Beschreibung Zeile 3',
    lagerort: 'Werkstatt',
    lagerplatz: 'B10-B1',
    zpl_header: '^PW240\n^LL240\n^LS0'
  };
  
  let zpl = druckbefehle;
  for (const [key, value] of Object.entries(dummyData)) {
    zpl = zpl.replace(new RegExp(`\\{${key}\\}`, 'g'), value);
  }
  
  zeigeVorschauModal(zpl);
}

function zeigeVorschauModal(zpl) {
  // Modal erstellen oder aktualisieren
  let modal = document.getElementById('etikettVorschauModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'etikettVorschauModal';
    modal.className = 'modal fade';
    modal.innerHTML = `
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ZPL-Vorschau</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <pre id="etikettVorschauZpl" class="bg-light p-3" style="max-height: 500px; overflow-y: auto; font-size: 0.85em;"></pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            <button type="button" class="btn btn-primary" onclick="kopiereZplVorschau()">ZPL kopieren</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  document.getElementById('etikettVorschauZpl').textContent = zpl;
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
}

function kopiereZplVorschau() {
  const zplText = document.getElementById('etikettVorschauZpl').textContent;
  navigator.clipboard.writeText(zplText).then(() => {
    showToast('ZPL in Zwischenablage kopiert', 'success');
  }).catch(() => {
    showToast('Fehler beim Kopieren', 'error');
  });
}

// Formular zurücksetzen nach erfolgreichem Speichern
const etikettForm = document.getElementById('etikettForm');
if (etikettForm) {
  etikettForm.addEventListener('submit', function(e) {
    const form = this;
    const formData = new FormData(form);
    const submitButton = form.querySelector('button[type="submit"]');
    
    if (submitButton) {
      submitButton.disabled = true;
      submitButton.textContent = 'Speichere...';
    }
    
    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast(data.message, 'success');
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else {
        showToast(data.message, 'error');
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = submitButton.dataset.originalText || 'Neues Etikett anlegen';
        }
      }
    })
    .catch(error => {
      showToast('Fehler: ' + error.message, 'error');
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = submitButton.dataset.originalText || 'Neues Etikett anlegen';
      }
    });
    
    e.preventDefault();
  });
}
</script>
{% endblock %}

