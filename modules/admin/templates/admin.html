{% extends "layout/base.html" %}

{% block content %}
<h1>Admin – Stammdaten</h1>

<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-mitarbeiter">Mitarbeiter</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-abteilung">Abteilungen</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-bereich">Bereiche</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-gewerk">Gewerke</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-taetigkeit">Tätigkeiten</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-status">Status</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-datenbank">Datenbank</a></li>
  <li class="nav-item ms-auto"><a class="nav-link" href="{{ url_for('dashboard') }}">Zurück zum Dashboard</a></li>
  </ul>

<div class="tab-content">
  <!-- Mitarbeiter -->
  <div class="tab-pane fade show active" id="tab-mitarbeiter">
    <div class="card mb-3">
      <div class="card-header">Neuen Mitarbeiter anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.mitarbeiter_add') }}" method="post" class="row g-2">
          <div class="col-md-2"><input name="personalnummer" class="form-control" placeholder="Personalnr." required></div>
          <div class="col-md-3"><input name="vorname" class="form-control" placeholder="Vorname" required></div>
          <div class="col-md-3"><input name="nachname" class="form-control" placeholder="Nachname" required></div>
          <div class="col-md-3"><input type="password" name="passwort" class="form-control" placeholder="Passwort (optional)"></div>
          <div class="col-md-1 form-check d-flex align-items-center">
            <input class="form-check-input" type="checkbox" name="aktiv" id="maAktiv" checked>
            <label class="form-check-label ms-1" for="maAktiv">Aktiv</label>
          </div>
          <div class="col-12"><button class="btn btn-success">Anlegen</button></div>
        </form>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead class="table-dark">
          <tr><th>Personalnr.</th><th>Name</th><th>Primärabteilung</th><th>Aktiv</th><th>Aktionen</th></tr>
        </thead>
        <tbody>
          {% for m in mitarbeiter %}
          <tr>
            <td>{{ m.Personalnummer }}</td>
            <td>{{ m.Nachname }}, {{ m.Vorname }}</td>
            <td>
              {% if m.PrimaerAbteilung %}
                <span class="badge bg-info">{{ m.PrimaerAbteilung }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>{% if m.Aktiv %}<span class="badge bg-success">aktiv</span>{% else %}<span class="badge bg-secondary">inaktiv</span>{% endif %}</td>
            <td>
              <form action="{{ url_for('admin.mitarbeiter_update', mid=m.ID) }}" method="post" class="row g-1 mb-2">
                <div class="col-md-3"><input name="vorname" class="form-control form-control-sm" value="{{ m.Vorname }}"></div>
                <div class="col-md-3"><input name="nachname" class="form-control form-control-sm" value="{{ m.Nachname }}"></div>
                <div class="col-md-3"><input type="password" name="passwort" class="form-control form-control-sm" placeholder="Neues Passwort"></div>
                <div class="col-md-2 form-check d-flex align-items-center">
                  <input class="form-check-input" type="checkbox" name="aktiv" id="aktiv{{ m.ID }}" {% if m.Aktiv %}checked{% endif %}>
                  <label class="form-check-label ms-1" for="aktiv{{ m.ID }}">Aktiv</label>
                </div>
                <div class="col-md-1"><button class="btn btn-sm btn-primary w-100">Speichern</button></div>
              </form>
              
              <!-- Abteilungszuweisung -->
              <button class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#abt{{ m.ID }}">
                Abteilungen
              </button>
              <div class="collapse mt-2" id="abt{{ m.ID }}">
                <form action="{{ url_for('admin.mitarbeiter_abteilungen', mid=m.ID) }}" method="post" class="border p-2 rounded bg-light">
                  <div class="mb-2">
                    <label class="form-label fw-bold">Primärabteilung:</label>
                    <select name="primaer_abteilung_id" class="form-select form-select-sm">
                      <option value="">-- Keine --</option>
                      {% for a in abteilungen %}
                        <option value="{{ a.ID }}" {% if m.PrimaerAbteilungID == a.ID %}selected{% endif %}>
                          {{ a.Bezeichnung }}{% if a.ParentBezeichnung %} ({{ a.ParentBezeichnung }}){% endif %}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label fw-bold">Zusätzliche Abteilungen:</label>
                    {% for a in abteilungen %}
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="zusaetzliche_abteilungen" value="{{ a.ID }}" id="zusatz{{ m.ID }}_{{ a.ID }}" 
                        {% if mitarbeiter_abteilungen[m.ID] and a.ID in mitarbeiter_abteilungen[m.ID] %}checked{% endif %}>
                      <label class="form-check-label" for="zusatz{{ m.ID }}_{{ a.ID }}">
                        {{ a.Bezeichnung }}{% if a.ParentBezeichnung %} ({{ a.ParentBezeichnung }}){% endif %}
                      </label>
                    </div>
                    {% endfor %}
                  </div>
                  <button class="btn btn-sm btn-success">Abteilungen speichern</button>
                </form>
              </div>
              
              {% if m.Aktiv %}
              <form action="{{ url_for('admin.mitarbeiter_deactivate', mid=m.ID) }}" method="post" class="d-inline">
                <button class="btn btn-sm btn-outline-warning mt-1">Deaktivieren</button>
              </form>
              {% endif %}
              
              <button class="btn btn-sm btn-outline-danger mt-1" onclick="resetPassword({{ m.ID }}, '{{ m.Vorname }}', '{{ m.Nachname }}')">
                <i class="bi bi-key-fill"></i> Passwort zurücksetzen
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Abteilungen -->
  <div class="tab-pane fade" id="tab-abteilung">
    <div class="card mb-3">
      <div class="card-header">Neue Abteilung anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.abteilung_add') }}" method="post" class="row g-2">
          <div class="col-md-5"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung" required></div>
          <div class="col-md-4">
            <select name="parent_abteilung_id" class="form-select">
              <option value="">-- Hauptabteilung (keine Überabteilung) --</option>
              {% for a in abteilungen %}
                {% if a.Aktiv %}
                  <option value="{{ a.ID }}">{{ a.Bezeichnung }}{% if a.ParentBezeichnung %} ({{ a.ParentBezeichnung }}){% endif %}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2"><input type="number" name="sortierung" class="form-control" placeholder="Sortierung" value="0"></div>
          <div class="col-md-1"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark">
        <tr><th>Bezeichnung</th><th>Überabteilung</th><th>Sortierung</th><th>Aktiv</th><th>Aktionen</th></tr>
      </thead>
      <tbody>
        {% for a in abteilungen %}
        <tr>
          <td>{{ a.Bezeichnung }}</td>
          <td>
            {% if a.ParentBezeichnung %}
              <span class="badge bg-secondary">{{ a.ParentBezeichnung }}</span>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
          <td>{{ a.Sortierung }}</td>
          <td>{% if a.Aktiv %}<span class="badge bg-success">aktiv</span>{% else %}<span class="badge bg-secondary">inaktiv</span>{% endif %}</td>
          <td>
            <form action="{{ url_for('admin.abteilung_update', aid=a.ID) }}" method="post" class="row g-1 align-items-center">
              <div class="col-md-4"><input name="bezeichnung" class="form-control form-control-sm" value="{{ a.Bezeichnung }}"></div>
              <div class="col-md-4">
                <select name="parent_abteilung_id" class="form-select form-select-sm">
                  <option value="">-- Hauptabteilung --</option>
                  {% for p in abteilungen %}
                    {% if p.ID != a.ID %}
                      <option value="{{ p.ID }}" {% if p.ID == a.ParentAbteilungID %}selected{% endif %}>
                        {{ p.Bezeichnung }}{% if p.ParentBezeichnung %} ({{ p.ParentBezeichnung }}){% endif %}
                      </option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-1"><input type="number" name="sortierung" class="form-control form-control-sm" value="{{ a.Sortierung }}"></div>
              <div class="col-md-2 form-check d-flex align-items-center">
                <input class="form-check-input" type="checkbox" name="aktiv" id="abtAktiv{{ a.ID }}" {% if a.Aktiv %}checked{% endif %}>
                <label class="form-check-label ms-1" for="abtAktiv{{ a.ID }}">Aktiv</label>
              </div>
              <div class="col-md-1"><button class="btn btn-sm btn-primary w-100">Speichern</button></div>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Bereiche -->
  <div class="tab-pane fade" id="tab-bereich">
    <div class="card mb-3">
      <div class="card-header">Neuen Bereich anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.bereich_add') }}" method="post" class="row g-2">
          <div class="col-md-6"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung" required></div>
          <div class="col-md-12"><button class="btn btn-success">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>Bezeichnung</th><th style="width: 120px;">Aktiv</th><th style="width: 120px;">Aktionen</th></tr></thead>
      <tbody>
        {% for b in bereiche %}
        <tr>
          <td>
            <form action="{{ url_for('admin.bereich_update', bid=b.ID) }}" method="post" class="d-flex align-items-center gap-2">
              <input name="bezeichnung" class="form-control form-control-sm" value="{{ b.Bezeichnung }}">
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="bereichAktiv{{ b.ID }}" {% if b.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="bereichAktiv{{ b.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary">Speichern</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Gewerke -->
  <div class="tab-pane fade" id="tab-gewerk">
    <div class="card mb-3">
      <div class="card-header">Neues Gewerk anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.gewerk_add') }}" method="post" class="row g-2">
          <div class="col-md-5"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung" required></div>
          <div class="col-md-5">
            <select name="bereich_id" class="form-select" required>
              <option value="">-- Bereich wählen --</option>
              {% for b in bereiche %}
                <option value="{{ b.ID }}">{{ b.Bezeichnung }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>Gewerk-Bezeichnung</th><th style="width: 200px;">Bereich</th><th style="width: 120px;">Aktiv</th><th style="width: 120px;">Aktionen</th></tr></thead>
      <tbody>
        {% for g in gewerke %}
        <tr>
          <td>
            <form action="{{ url_for('admin.gewerk_update', gid=g.ID) }}" method="post" class="d-flex align-items-center gap-2">
              <input name="bezeichnung" class="form-control form-control-sm" value="{{ g.Bezeichnung }}">
          </td>
          <td>
              <select name="bereich_id" class="form-select form-select-sm">
                {% for b in bereiche %}
                  <option value="{{ b.ID }}" {% if b.ID == g.BereichID %}selected{% endif %}>{{ b.Bezeichnung }}</option>
                {% endfor %}
              </select>
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="gewerkAktiv{{ g.ID }}" {% if g.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="gewerkAktiv{{ g.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary">Speichern</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Tätigkeiten -->
  <div class="tab-pane fade" id="tab-taetigkeit">
    <div class="card mb-3">
      <div class="card-header">Neue Tätigkeit anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.taetigkeit_add') }}" method="post" class="row g-2">
          <div class="col-md-6"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung" required></div>
          <div class="col-md-3"><input type="number" name="sortierung" class="form-control" placeholder="Sortierung" value="0"></div>
          <div class="col-md-3"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>Bezeichnung</th><th style="width: 150px;">Sortierung</th><th style="width: 120px;">Aktiv</th><th style="width: 120px;">Aktionen</th></tr></thead>
      <tbody>
        {% for t in taetigkeiten %}
        <tr>
          <td>
            <form action="{{ url_for('admin.taetigkeit_update', tid=t.ID) }}" method="post" class="d-flex align-items-center gap-2">
              <input name="bezeichnung" class="form-control form-control-sm" value="{{ t.Bezeichnung }}">
          </td>
          <td>
              <input type="number" name="sortierung" class="form-control form-control-sm" value="{{ t.Sortierung }}">
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="taetAktiv{{ t.ID }}" {% if t.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="taetAktiv{{ t.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary">Speichern</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Status -->
  <div class="tab-pane fade" id="tab-status">
    <div class="card mb-3">
      <div class="card-header">Neuen Status anlegen</div>
      <div class="card-body">
        <form action="{{ url_for('admin.status_add') }}" method="post" class="row g-2">
          <div class="col-md-4"><input name="bezeichnung" class="form-control" placeholder="Bezeichnung" required></div>
          <div class="col-md-4">
            <div class="input-group">
              <input type="color" class="form-control form-control-color" value="#6c757d" title="Farbe wählen" data-color-picker>
              <input type="text" name="farbe" class="form-control" placeholder="#RRGGBB" value="#6c757d" pattern="^#[0-9A-Fa-f]{6}$" data-color-text>
            </div>
          </div>
          <div class="col-md-3"><input type="number" name="sortierung" class="form-control" placeholder="Sortierung" value="0"></div>
          <div class="col-md-1"><button class="btn btn-success w-100">Anlegen</button></div>
        </form>
      </div>
    </div>

    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>Bezeichnung</th><th style="width: 200px;">Farbe</th><th style="width: 150px;">Sortierung</th><th style="width: 120px;">Aktiv</th><th style="width: 120px;">Aktionen</th></tr></thead>
      <tbody>
        {% for s in status %}
        <tr>
          <td>
            <form action="{{ url_for('admin.status_update', sid=s.ID) }}" method="post" class="d-flex align-items-center gap-2" data-status-form>
              <input name="bezeichnung" class="form-control form-control-sm" value="{{ s.Bezeichnung }}">
          </td>
          <td>
              <div class="input-group input-group-sm">
                <input type="color" class="form-control form-control-color form-control-sm" value="{{ s.Farbe }}" title="Farbe wählen" data-color-picker>
                <input type="text" name="farbe" class="form-control form-control-sm" value="{{ s.Farbe }}" pattern="^#[0-9A-Fa-f]{6}$" data-color-text>
              </div>
          </td>
          <td>
              <input type="number" name="sortierung" class="form-control form-control-sm" value="{{ s.Sortierung }}">
          </td>
          <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="aktiv" id="statusAktiv{{ s.ID }}" {% if s.Aktiv %}checked{% endif %}>
                <label class="form-check-label" for="statusAktiv{{ s.ID }}">Aktiv</label>
              </div>
          </td>
          <td>
              <button class="btn btn-sm btn-primary">Speichern</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Datenbank -->
  <div class="tab-pane fade" id="tab-datenbank">
    <div class="alert alert-info">
      <h5><i class="bi bi-info-circle"></i> Datenbank-Verwaltung</h5>
      <p class="mb-0">Hier können Sie die Datenbankstruktur überprüfen und fehlende Tabellen oder Spalten automatisch hinzufügen lassen.</p>
    </div>

    <div class="card mb-3">
      <div class="card-header">Datenbankstruktur überprüfen</div>
      <div class="card-body">
        <p>Überprüfen Sie, ob alle erforderlichen Tabellen und Spalten in der Datenbank vorhanden sind.</p>
        <button id="btnCheckDatabase" class="btn btn-primary" onclick="checkDatabase()">
          <i class="bi bi-search"></i> Struktur überprüfen
        </button>
      </div>
    </div>

    <div id="dbCheckResult" class="card mb-3" style="display: none;">
      <div class="card-header">Prüfergebnis</div>
      <div class="card-body" id="dbCheckResultBody">
        <!-- Ergebnis wird hier eingefügt -->
      </div>
    </div>

    <div id="dbRepairSection" class="card mb-3" style="display: none;">
      <div class="card-header bg-warning">Fehlende Strukturen reparieren</div>
      <div class="card-body">
        <div class="alert alert-warning mb-3">
          <strong><i class="bi bi-exclamation-triangle"></i> Warnung:</strong> Diese Aktion fügt fehlende Tabellen und Spalten zur Datenbank hinzu. 
          Bestehende Daten werden nicht verändert. Es wird empfohlen, vorher ein Backup der Datenbank anzulegen.
        </div>
        <button id="btnRepairDatabase" class="btn btn-warning" onclick="repairDatabase()">
          <i class="bi bi-wrench"></i> Fehlende Strukturen hinzufügen
        </button>
      </div>
    </div>

    <div id="dbRepairResult" class="card mb-3" style="display: none;">
      <div class="card-header bg-success text-white">Reparaturergebnis</div>
      <div class="card-body" id="dbRepairResultBody">
        <!-- Ergebnis wird hier eingefügt -->
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Toast-Benachrichtigung anzeigen
function showToast(message, type = 'success') {
  // Toast-Container erstellen falls nicht vorhanden
  let toastContainer = document.getElementById('toastContainer');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.id = 'toastContainer';
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = '9999';
    document.body.appendChild(toastContainer);
  }

  // Toast erstellen
  const toastId = 'toast-' + Date.now();
  const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
  const toastHtml = `
    <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  const toastElement = document.getElementById(toastId);
  const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
  toast.show();
  
  // Toast nach dem Ausblenden entfernen
  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}

// AJAX-Formular-Handling
function handleFormSubmit(event) {
  event.preventDefault();
  
  const form = event.target;
  const formData = new FormData(form);
  const submitButton = form.querySelector('button[type="submit"]');
  
  // Button deaktivieren während der Anfrage
  if (submitButton) {
    submitButton.disabled = true;
    submitButton.dataset.originalText = submitButton.textContent;
    submitButton.textContent = 'Lädt...';
  }
  
  fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
      
      // Bei Anlegen-Formularen: Seite neu laden
      if (form.closest('.card-body')) {
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      }
      // Bei Update-Formularen in der Tabelle: nichts tun (Daten bleiben erhalten)
    } else {
      showToast(data.message, 'error');
    }
  })
  .catch(error => {
    showToast('Ein Fehler ist aufgetreten: ' + error.message, 'error');
  })
  .finally(() => {
    // Button wieder aktivieren
    if (submitButton) {
      submitButton.disabled = false;
      submitButton.textContent = submitButton.dataset.originalText;
    }
  });
}

// Color Picker Synchronisation
function setupColorPickers() {
  // Alle Color Picker mit Textfeldern synchronisieren
  document.querySelectorAll('[data-color-picker]').forEach(colorPicker => {
    const textInput = colorPicker.parentElement.querySelector('[data-color-text]');
    
    if (textInput) {
      // Color Picker -> Textfeld (Farbe wird ins Textfeld übertragen)
      colorPicker.addEventListener('input', function() {
        textInput.value = this.value.toUpperCase();
      });
      
      // Textfeld -> Color Picker (bei gültiger Eingabe)
      textInput.addEventListener('input', function() {
        const value = this.value.trim();
        if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
          colorPicker.value = value;
        }
      });
    }
  });
}

// Passwort zurücksetzen
function resetPassword(mitarbeiterId, vorname, nachname) {
  const confirmMessage = `Möchten Sie das Passwort für ${vorname} ${nachname} wirklich auf "${vorname}" zurücksetzen?`;
  
  if (!confirm(confirmMessage)) {
    return;
  }
  
  fetch(`{{ url_for('admin.mitarbeiter_reset_password', mid=0) }}`.replace('/0', `/${mitarbeiterId}`), {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
    } else {
      showToast(data.message, 'error');
    }
  })
  .catch(error => {
    showToast('Ein Fehler ist aufgetreten: ' + error.message, 'error');
  });
}

// Datenbank-Prüfung
function checkDatabase() {
  const btn = document.getElementById('btnCheckDatabase');
  const resultCard = document.getElementById('dbCheckResult');
  const resultBody = document.getElementById('dbCheckResultBody');
  const repairSection = document.getElementById('dbRepairSection');
  
  // Button deaktivieren
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Prüfe...';
  
  // Vorherige Ergebnisse ausblenden
  repairSection.style.display = 'none';
  document.getElementById('dbRepairResult').style.display = 'none';
  
  fetch('{{ url_for("admin.database_check") }}', {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    resultBody.innerHTML = formatCheckResult(data);
    resultCard.style.display = 'block';
    
    // Zeige Reparatur-Sektion nur, wenn Probleme gefunden wurden
    if (data.has_issues) {
      repairSection.style.display = 'block';
    }
    
    // Button wieder aktivieren
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-search"></i> Struktur überprüfen';
  })
  .catch(error => {
    showToast('Fehler bei der Datenbankprüfung: ' + error.message, 'error');
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-search"></i> Struktur überprüfen';
  });
}

// Datenbank-Reparatur
function repairDatabase() {
  const btn = document.getElementById('btnRepairDatabase');
  const resultCard = document.getElementById('dbRepairResult');
  const resultBody = document.getElementById('dbRepairResultBody');
  
  if (!confirm('Möchten Sie die fehlenden Strukturen wirklich zur Datenbank hinzufügen?')) {
    return;
  }
  
  // Button deaktivieren
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Repariere...';
  
  fetch('{{ url_for("admin.database_repair") }}', {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    resultBody.innerHTML = formatRepairResult(data);
    resultCard.style.display = 'block';
    
    if (data.success) {
      showToast('Datenbank erfolgreich repariert!', 'success');
      // Nach erfolgreicher Reparatur erneut prüfen
      setTimeout(() => checkDatabase(), 2000);
    } else {
      showToast('Fehler bei der Reparatur: ' + data.message, 'error');
    }
    
    // Button wieder aktivieren
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-wrench"></i> Fehlende Strukturen hinzufügen';
  })
  .catch(error => {
    showToast('Fehler bei der Datenbankreparatur: ' + error.message, 'error');
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-wrench"></i> Fehlende Strukturen hinzufügen';
  });
}

// Formatiert das Prüfergebnis
function formatCheckResult(data) {
  let html = '';
  
  if (!data.has_issues) {
    html = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> <strong>Perfekt!</strong> Alle erforderlichen Tabellen und Spalten sind vorhanden.</div>';
    return html;
  }
  
  // Fehlende Tabellen
  if (data.missing_tables && data.missing_tables.length > 0) {
    html += '<div class="alert alert-danger"><strong><i class="bi bi-exclamation-triangle"></i> Fehlende Tabellen:</strong><ul class="mb-0 mt-2">';
    data.missing_tables.forEach(table => {
      html += `<li><code>${table}</code></li>`;
    });
    html += '</ul></div>';
  }
  
  // Fehlende Spalten
  if (data.missing_columns && Object.keys(data.missing_columns).length > 0) {
    html += '<div class="alert alert-warning"><strong><i class="bi bi-exclamation-triangle"></i> Fehlende Spalten:</strong>';
    for (const [table, columns] of Object.entries(data.missing_columns)) {
      html += `<div class="mt-2"><strong>Tabelle <code>${table}</code>:</strong><ul class="mb-0">`;
      columns.forEach(column => {
        html += `<li><code>${column}</code></li>`;
      });
      html += '</ul></div>';
    }
    html += '</div>';
  }
  
  // Fehlende Indizes
  if (data.missing_indexes && data.missing_indexes.length > 0) {
    html += '<div class="alert alert-info"><strong><i class="bi bi-info-circle"></i> Fehlende Indizes:</strong><ul class="mb-0 mt-2">';
    data.missing_indexes.forEach(index => {
      html += `<li><code>${index}</code></li>`;
    });
    html += '</ul></div>';
  }
  
  return html;
}

// Formatiert das Reparaturergebnis
function formatRepairResult(data) {
  let html = '';
  
  if (!data.success) {
    html = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> <strong>Fehler:</strong> ${data.message}</div>`;
    if (data.errors && data.errors.length > 0) {
      html += '<div class="alert alert-danger"><strong>Details:</strong><ul class="mb-0">';
      data.errors.forEach(error => {
        html += `<li>${error}</li>`;
      });
      html += '</ul></div>';
    }
    return html;
  }
  
  html += '<div class="alert alert-success"><i class="bi bi-check-circle"></i> <strong>Erfolg!</strong> Die Datenbank wurde erfolgreich repariert.</div>';
  
  // Hinzugefügte Tabellen
  if (data.added_tables && data.added_tables.length > 0) {
    html += '<div class="alert alert-success"><strong>Hinzugefügte Tabellen:</strong><ul class="mb-0">';
    data.added_tables.forEach(table => {
      html += `<li><code>${table}</code></li>`;
    });
    html += '</ul></div>';
  }
  
  // Hinzugefügte Spalten
  if (data.added_columns && Object.keys(data.added_columns).length > 0) {
    html += '<div class="alert alert-success"><strong>Hinzugefügte Spalten:</strong>';
    for (const [table, columns] of Object.entries(data.added_columns)) {
      html += `<div class="mt-2"><strong>Tabelle <code>${table}</code>:</strong><ul class="mb-0">`;
      columns.forEach(column => {
        html += `<li><code>${column}</code></li>`;
      });
      html += '</ul></div>';
    }
    html += '</div>';
  }
  
  // Hinzugefügte Indizes
  if (data.added_indexes && data.added_indexes.length > 0) {
    html += '<div class="alert alert-info"><strong>Hinzugefügte Indizes:</strong><ul class="mb-0">';
    data.added_indexes.forEach(index => {
      html += `<li><code>${index}</code></li>`;
    });
    html += '</ul></div>';
  }
  
  return html;
}

// Event Listener für alle Formulare hinzufügen
document.addEventListener('DOMContentLoaded', function() {
  // Alle Formulare im Admin-Bereich
  document.querySelectorAll('form[action*="/admin/"]').forEach(form => {
    form.addEventListener('submit', handleFormSubmit);
  });
  
  // Color Picker Setup
  setupColorPickers();
  
  // Aktiven Tab speichern und wiederherstellen
  const tabs = document.querySelectorAll('a[data-bs-toggle="tab"]');
  
  // Gespeicherten Tab wiederherstellen
  const savedTab = localStorage.getItem('adminActiveTab');
  if (savedTab) {
    const tabToActivate = document.querySelector(`a[data-bs-toggle="tab"][href="${savedTab}"]`);
    if (tabToActivate) {
      const tab = new bootstrap.Tab(tabToActivate);
      tab.show();
    }
  }
  
  // Tab-Wechsel speichern
  tabs.forEach(tab => {
    tab.addEventListener('shown.bs.tab', function(event) {
      localStorage.setItem('adminActiveTab', event.target.getAttribute('href'));
    });
  });
});
</script>
{% endblock %}

