{% extends "layout/base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">üë§ Mein Profil</h1>

    <div class="row">
        <!-- Profil-Informationen -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üìã Profil-Informationen</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('auth.profil') }}">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="personalnummer" class="form-label">
                                    <strong>Personalnummer:</strong>
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="personalnummer" 
                                       value="{{ user.Personalnummer }}" 
                                       disabled
                                       readonly>
                                <small class="text-muted">Die Personalnummer kann nicht ge√§ndert werden.</small>
                            </div>
                            <div class="col-md-6">
                                <label for="aktiv" class="form-label">
                                    <strong>Status:</strong>
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="aktiv" 
                                       value="{% if user.Aktiv %}Aktiv{% else %}Inaktiv{% endif %}" 
                                       disabled
                                       readonly>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="vorname" class="form-label">
                                    <strong>Vorname:</strong> <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="vorname" 
                                       name="vorname" 
                                       value="{{ user.Vorname or '' }}" 
                                       required>
                            </div>
                            <div class="col-md-6">
                                <label for="nachname" class="form-label">
                                    <strong>Nachname:</strong> <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="nachname" 
                                       name="nachname" 
                                       value="{{ user.Nachname }}" 
                                       required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="email" class="form-label">
                                    <strong>E-Mail:</strong>
                                </label>
                                <input type="email" 
                                       class="form-control" 
                                       id="email" 
                                       name="email" 
                                       value="{{ user.Email or '' }}" 
                                       placeholder="beispiel@firma.de">
                            </div>
                            <div class="col-md-6">
                                <label for="handynummer" class="form-label">
                                    <strong>Handynummer:</strong>
                                </label>
                                <input type="tel" 
                                       class="form-control" 
                                       id="handynummer" 
                                       name="handynummer" 
                                       value="{{ user.Handynummer or '' }}" 
                                       placeholder="+49 123 456789">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                <strong>Prim√§rabteilung:</strong>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   value="{{ user.PrimaerAbteilung or 'Keine Abteilung zugewiesen' }}" 
                                   disabled
                                   readonly>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> √Ñnderungen speichern
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Zur√ºck
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Abteilungen -->
            {% if alle_abteilungen %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">üè¢ Zugeordnete Abteilungen</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        {% for abt in alle_abteilungen %}
                        <span class="badge bg-secondary fs-6">
                            {% if abt.ParentAbteilungID %}‚Ü≥{% endif %} {{ abt.Bezeichnung }}
                        </span>
                        {% endfor %}
                    </div>
                    <small class="text-muted d-block mt-2">
                        Die Abteilungszuordnungen k√∂nnen nur von einem Administrator ge√§ndert werden.
                    </small>
                </div>
            </div>
            {% endif %}

            <!-- Benachrichtigungseinstellungen -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üîî Benachrichtigungseinstellungen</h5>
                </div>
                <div class="card-body">
                    <form id="benachrichtigungenForm">
                        <!-- Benachrichtigungsarten -->
                        <div class="mb-4">
                            <h6 class="mb-3">Benachrichtigungsarten</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input kanal-checkbox" type="checkbox" id="kanal_app" value="app" checked>
                                <label class="form-check-label" for="kanal_app">
                                    In der App
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input kanal-checkbox" type="checkbox" id="kanal_mail" value="mail">
                                <label class="form-check-label" for="kanal_mail">
                                    E-Mail
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input kanal-checkbox" type="checkbox" id="kanal_push" value="push">
                                <label class="form-check-label" for="kanal_push">
                                    Push-Benachrichtigungen
                                </label>
                            </div>
                            <div id="push-status" class="mt-2" style="display: none;">
                                <small class="text-muted">Push-Benachrichtigungen werden automatisch aktiviert, wenn Sie die Berechtigung erteilen.</small>
                            </div>
                        </div>

                        <hr>

                        <!-- Schichtbuch -->
                        <div class="mb-4">
                            <h6 class="mb-3">üìã Schichtbuch</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Aktionen:</label>
                                <div class="form-check">
                                    <input class="form-check-input einstellung-checkbox" type="checkbox" 
                                           id="schichtbuch_neues_thema" 
                                           data-modul="schichtbuch" 
                                           data-aktion="neues_thema">
                                    <label class="form-check-label" for="schichtbuch_neues_thema">
                                        Neues Thema
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input einstellung-checkbox" type="checkbox" 
                                           id="schichtbuch_neue_bemerkung" 
                                           data-modul="schichtbuch" 
                                           data-aktion="neue_bemerkung">
                                    <label class="form-check-label" for="schichtbuch_neue_bemerkung">
                                        Neue Bemerkung
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Abteilungen:</label>
                                <select class="form-select" id="schichtbuch_abteilungen" multiple size="5">
                                    <option value="">Alle Abteilungen</option>
                                    {% for abt in alle_abteilungen_fuer_auswahl %}
                                    <option value="{{ abt.ID }}">{{ abt.Bezeichnung }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Halten Sie Strg/Cmd gedr√ºckt, um mehrere Abteilungen auszuw√§hlen.</small>
                            </div>
                        </div>

                        <hr>

                        <!-- Bestellwesen -->
                        <div class="mb-4">
                            <h6 class="mb-3">üõí Bestellwesen</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Aktionen:</label>
                                <div class="form-check">
                                    <input class="form-check-input einstellung-checkbox" type="checkbox" 
                                           id="bestellwesen_neue_angebotsanfrage" 
                                           data-modul="bestellwesen" 
                                           data-aktion="neue_angebotsanfrage">
                                    <label class="form-check-label" for="bestellwesen_neue_angebotsanfrage">
                                        Neue Angebotsanfrage
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input einstellung-checkbox" type="checkbox" 
                                           id="bestellwesen_neue_bestellung" 
                                           data-modul="bestellwesen" 
                                           data-aktion="neue_bestellung">
                                    <label class="form-check-label" for="bestellwesen_neue_bestellung">
                                        Neue Bestellung
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input einstellung-checkbox" type="checkbox" 
                                           id="bestellwesen_bestellung_zur_freigabe" 
                                           data-modul="bestellwesen" 
                                           data-aktion="bestellung_zur_freigabe">
                                    <label class="form-check-label" for="bestellwesen_bestellung_zur_freigabe">
                                        Bestellung zur Freigabe
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input einstellung-checkbox" type="checkbox" 
                                           id="bestellwesen_wareneingang" 
                                           data-modul="bestellwesen" 
                                           data-aktion="wareneingang">
                                    <label class="form-check-label" for="bestellwesen_wareneingang">
                                        Wareneingang
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Abteilungen:</label>
                                <select class="form-select" id="bestellwesen_abteilungen" multiple size="5">
                                    <option value="">Alle Abteilungen</option>
                                    {% for abt in alle_abteilungen_fuer_auswahl %}
                                    <option value="{{ abt.ID }}">{{ abt.Bezeichnung }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Halten Sie Strg/Cmd gedr√ºckt, um mehrere Abteilungen auszuw√§hlen.</small>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Einstellungen speichern
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Seitenleiste: Statistiken & Aktionen -->
        <div class="col-lg-4">
            <!-- Statistiken -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üìä Statistiken</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Bemerkungen erstellt:</span>
                            <strong class="fs-5">{{ bemerkung_anzahl }}</strong>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Themen bearbeitet:</span>
                            <strong class="fs-5">{{ thema_anzahl }}</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Passwort √§ndern -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üîë Passwort √§ndern</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('auth.passwort_aendern') }}">
                        <div class="mb-3">
                            <label for="altes_passwort" class="form-label">
                                <i class="bi bi-lock"></i> Aktuelles Passwort
                            </label>
                            <input type="password" 
                                   name="altes_passwort" 
                                   id="altes_passwort" 
                                   class="form-control" 
                                   required 
                                   autocomplete="current-password">
                        </div>
                        
                        <div class="mb-3">
                            <label for="neues_passwort" class="form-label">
                                <i class="bi bi-lock-fill"></i> Neues Passwort
                            </label>
                            <input type="password" 
                                   name="neues_passwort" 
                                   id="neues_passwort" 
                                   class="form-control" 
                                   required 
                                   minlength="6" 
                                   autocomplete="new-password">
                            <small class="form-text text-muted">Mindestens 6 Zeichen</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="neues_passwort_wdh" class="form-label">
                                <i class="bi bi-lock-fill"></i> Neues Passwort wiederholen
                            </label>
                            <input type="password" 
                                   name="neues_passwort_wdh" 
                                   id="neues_passwort_wdh" 
                                   class="form-control" 
                                   required 
                                   minlength="6" 
                                   autocomplete="new-password">
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-check-circle"></i> Passwort √§ndern
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Schnellzugriff -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">‚ö° Schnellzugriff</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-speedometer2"></i> Zum Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  // Passwort-√úbereinstimmung pr√ºfen
  const neuesPasswort = document.getElementById('neues_passwort');
  const neuesPasswortWdh = document.getElementById('neues_passwort_wdh');
  
  if (neuesPasswort && neuesPasswortWdh) {
    neuesPasswortWdh.addEventListener('input', function() {
      if (neuesPasswort.value !== neuesPasswortWdh.value) {
        neuesPasswortWdh.setCustomValidity('Passw√∂rter stimmen nicht √ºberein');
      } else {
        neuesPasswortWdh.setCustomValidity('');
      }
    });
    
    neuesPasswort.addEventListener('input', function() {
      if (neuesPasswort.value !== neuesPasswortWdh.value) {
        neuesPasswortWdh.setCustomValidity('Passw√∂rter stimmen nicht √ºberein');
      } else {
        neuesPasswortWdh.setCustomValidity('');
      }
    });
  }

  // Benachrichtigungseinstellungen laden und speichern
  (function() {
    const form = document.getElementById('benachrichtigungenForm');
    if (!form) return;

    // Einstellungen laden
    fetch('{{ url_for("auth.benachrichtigungen_get") }}')
      .then(response => response.json())
      .then(data => {
        // Kan√§le setzen
        if (data.kanale) {
          data.kanale.forEach(kanal => {
            const checkbox = document.getElementById(`kanal_${kanal}`);
            if (checkbox) checkbox.checked = true;
          });
        }

        // Einstellungen setzen
        if (data.einstellungen) {
          data.einstellungen.forEach(einstellung => {
            const checkbox = document.querySelector(
              `input[data-modul="${einstellung.modul}"][data-aktion="${einstellung.aktion}"]`
            );
            if (checkbox) checkbox.checked = einstellung.aktiv;

            // Abteilungen setzen
            if (einstellung.abteilung_id) {
              const select = document.getElementById(`${einstellung.modul}_abteilungen`);
              if (select) {
                const option = Array.from(select.options).find(opt => opt.value == einstellung.abteilung_id);
                if (option) option.selected = true;
              }
            }
          });
        }
      })
      .catch(error => {
        console.error('Fehler beim Laden der Einstellungen:', error);
      });

    // Formular speichern
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      // Sammle Kan√§le
      const kanale = Array.from(document.querySelectorAll('.kanal-checkbox:checked'))
        .map(cb => cb.value);

      // Sammle Einstellungen
      const einstellungen = [];
      document.querySelectorAll('.einstellung-checkbox').forEach(checkbox => {
        const modul = checkbox.dataset.modul;
        const aktion = checkbox.dataset.aktion;
        const aktiv = checkbox.checked;

        if (aktiv) {
          // Abteilungen f√ºr dieses Modul
          const select = document.getElementById(`${modul}_abteilungen`);
          const abteilungen = Array.from(select.selectedOptions).map(opt => opt.value);

          if (abteilungen.length === 0 || abteilungen.includes('')) {
            // Alle Abteilungen
            einstellungen.push({ modul, aktion, abteilung_id: null, aktiv: true });
          } else {
            // Spezifische Abteilungen
            abteilungen.forEach(abt_id => {
              if (abt_id) {
                einstellungen.push({ modul, aktion, abteilung_id: parseInt(abt_id), aktiv: true });
              }
            });
          }
        }
      });

      // Sende Daten
      fetch('{{ url_for("auth.benachrichtigungen_save") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          kanale: kanale,
          einstellungen: einstellungen
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Einstellungen erfolgreich gespeichert!');
        } else {
          alert('Fehler beim Speichern: ' + (data.message || 'Unbekannter Fehler'));
        }
      })
      .catch(error => {
        console.error('Fehler beim Speichern:', error);
        alert('Fehler beim Speichern der Einstellungen.');
      });
    });

    // Push-Benachrichtigungen aktivieren
    const pushCheckbox = document.getElementById('kanal_push');
    if (pushCheckbox) {
      pushCheckbox.addEventListener('change', function() {
        if (this.checked && 'serviceWorker' in navigator && 'PushManager' in window) {
          // Frage nach Berechtigung
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              // Service Worker registrieren und Subscription erstellen
              navigator.serviceWorker.register('/static/service-worker.js')
                .then(registration => {
                  return registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: '{{ vapid_public_key|default("") }}'
                  });
                })
                .then(subscription => {
                  // Subscription speichern
                  fetch('{{ url_for("auth.push_subscription_save") }}', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(subscription.toJSON())
                  })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                      document.getElementById('push-status').style.display = 'block';
                    }
                  });
                })
                .catch(error => {
                  console.error('Fehler bei Push-Subscription:', error);
                  this.checked = false;
                });
            } else {
              this.checked = false;
            }
          });
        }
      });
    }
  })();
</script>
{% endblock %}

