{% extends "layout/base.html" %}

{% block content %}
<h1 class="mb-4">Neues Thema anlegen</h1>

{% if message %}
<div class="alert alert-success">{{ message }}</div>
{% endif %}

<form id="themaForm" method="POST" class="bg-white p-4 rounded shadow-sm">

    <div class="mb-3">
        <label for="bereich" class="form-label">Bereich</label>
        <select class="form-select" id="bereich" required>
            <option value="">-- bitte w√§hlen --</option>
            {% for b in bereiche %}
            <option value="{{ b.ID }}">{{ b.Bezeichnung }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="gewerk" class="form-label">Gewerk</label>
        <select class="form-select" id="gewerk" name="gewerk" required disabled>
            <option value="">-- zuerst Bereich w√§hlen --</option>
            {% for g in gewerke %}
            <option value="{{ g.ID }}" data-bereich="{{ g.BereichID }}">{{ g.Bezeichnung }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="taetigkeit" class="form-label">T√§tigkeit</label>
        <select class="form-select" id="taetigkeit" name="taetigkeit" required>
            <option value="">-- bitte w√§hlen --</option>
            {% for t in taetigkeiten %}
            <option value="{{ t.ID }}">{{ t.Bezeichnung }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="status" class="form-label">Status</label>
        <select class="form-select" id="status" name="status" required>
            <option value="">-- bitte w√§hlen --</option>
            {% for s in status %}
            <option value="{{ s.ID }}">{{ s.Bezeichnung }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="bemerkung" class="form-label">Erste Bemerkung</label>
        <textarea class="form-control" id="bemerkung" name="bemerkung" rows="4" required></textarea>
    </div>

    {% if auswaehlbare_abteilungen %}
    <div class="mb-3">
        <label class="form-label fw-bold">
            <i class="bi bi-eye"></i> Sichtbarkeit - Welche Abteilungen sollen dieses Thema sehen?
        </label>
        <div class="form-text text-muted mb-2">
            W√§hlen Sie aus, welche Abteilungen Zugriff auf dieses Thema haben sollen.
        </div>
        
        <div class="card">
            <div class="card-body">
                {% for gruppe in auswaehlbare_abteilungen %}
                    <div class="mb-3">
                        <!-- Eigene Abteilung (Parent) -->
                        <div class="form-check">
                            <input class="form-check-input abteilung-checkbox" 
                                   type="checkbox" 
                                   name="sichtbare_abteilungen" 
                                   value="{{ gruppe.parent.ID }}" 
                                   id="abt_{{ gruppe.parent.ID }}" 
                                   data-abt-id="{{ gruppe.parent.ID }}"
                                   data-parent-id="root"
                                   {% if gruppe.parent.ID == primaer_abteilung_id %}checked{% endif %}>
                            <label class="form-check-label fw-bold" for="abt_{{ gruppe.parent.ID }}">
                                {{ gruppe.parent.Bezeichnung }}
                            </label>
                            {% if gruppe.parent.ID == primaer_abteilung_id %}
                            <small class="text-muted">(Prim√§rabteilung)</small>
                            {% else %}
                            <small class="text-muted">(zus√§tzliche Abteilung)</small>
                            {% endif %}
                        </div>
                        
                        <!-- ALLE untergeordneten Abteilungen (rekursiv) -->
                        {% if gruppe.children %}
                        <div class="mt-2">
                            {% for child in gruppe.children %}
                            <div class="form-check" style="margin-left: {{ (child.level + 1) * 1.5 }}rem;">
                                <input class="form-check-input abteilung-checkbox" 
                                       type="checkbox" 
                                       name="sichtbare_abteilungen" 
                                       value="{{ child.ID }}" 
                                       id="abt_{{ child.ID }}"
                                       data-abt-id="{{ child.ID }}"
                                       data-parent-id="{{ child.ParentAbteilungID }}">
                                <label class="form-check-label" for="abt_{{ child.ID }}">
                                    {% for i in range(child.level + 1) %}‚Ü≥{% endfor %} {{ child.Bezeichnung }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <button type="submit" class="btn btn-success">
            <i class="bi bi-save"></i> Speichern
    </button>
    <a href="/" class="btn btn-secondary">Abbrechen</a>
</form>

<hr class="my-4">
<h3>Zuletzt erstellte Themen</h3>
<table class="table table-striped" id="themenTabelle">
    <thead>
        <tr>
            <th>ID</th>
            <th>Bereich</th>
            <th>Gewerk</th>
            <th>Status</th>
            <th>Letzte Bemerkung</th>
        </tr>
    </thead>
    <tbody>
        <!-- wird dynamisch gef√ºllt -->
    </tbody>
</table>

<script>
    const bereichSelect = document.getElementById('bereich');
    const gewerkSelect = document.getElementById('gewerk');

    // üî∏ Gewerke nach Bereich filtern
    bereichSelect.addEventListener('change', function() {
        const selectedBereich = this.value;
        gewerkSelect.disabled = !selectedBereich;
        Array.from(gewerkSelect.options).forEach(opt => {
            if(opt.value === "") return;
            opt.style.display = (opt.dataset.bereich === selectedBereich) ? "block" : "none";
        });
        gewerkSelect.value = "";
    });

    // üî∏ Tabelle initial laden
    function ladeThemen() {
        fetch('/schichtbuch/themaneu/aktuelle_themen')
            .then(res => res.json())
            .then(data => {
                const tbody = document.querySelector('#themenTabelle tbody');
                tbody.innerHTML = "";
                data.themen.forEach(t => tbody.appendChild(baueZeile(t)));
            });
    }

    // üî∏ Zeile bauen
    function baueZeile(t) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${t.ID}</td>
            <td>${t.Bereich}</td>
            <td>${t.Gewerk}</td>
            <td>${t.Status}</td>
            <td>${t.LetzteBemerkung ? t.LetzteBemerkung + '<br><small class="text-muted">' + t.LetzteBemerkungDatum + '</small>' : '-'}</td>
        `;
        return row;
    }

    // üî∏ Formular absenden
    document.getElementById('themaForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const submitButton = this.querySelector('button[type="submit"]');
        
        // Button deaktivieren w√§hrend der Anfrage
        submitButton.disabled = true;
        submitButton.textContent = 'Speichert...';

        fetch('/schichtbuch/themaneu', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Server-Fehler: ' + response.status);
            }
            return response.json();
        })
        .then(neuesThema => {
            // Formular leeren
            this.reset();
            gewerkSelect.disabled = true;

            // Neue Zeile an den Anfang der Tabelle setzen
            const tbody = document.querySelector('#themenTabelle tbody');
            const neueZeile = baueZeile(neuesThema);
            tbody.prepend(neueZeile);
        })
        .catch(err => {
            console.error('Fehler beim Speichern:', err);
        })
        .finally(() => {
            // Button wieder aktivieren
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="bi bi-save"></i> Speichern';
        });
    });

    // üî∏ Hierarchische Checkboxen - Kinder mit√§ndern
    function getAllChildCheckboxes(parentId) {
        // Findet alle Checkboxen, die direkt oder indirekt von parentId abh√§ngen
        const children = [];
        const directChildren = document.querySelectorAll(`.abteilung-checkbox[data-parent-id="${parentId}"]`);
        
        directChildren.forEach(child => {
            children.push(child);
            // Rekursiv alle weiteren Kinder hinzuf√ºgen
            const childId = child.dataset.abtId;
            children.push(...getAllChildCheckboxes(childId));
        });
        
        return children;
    }
    
    // Event Listener f√ºr alle Abteilungs-Checkboxen
    document.addEventListener('DOMContentLoaded', function() {
        const abteilungCheckboxes = document.querySelectorAll('.abteilung-checkbox');
        
        abteilungCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const abtId = this.dataset.abtId;
                const isChecked = this.checked;
                
                // Alle Kinder auf denselben Zustand setzen
                const children = getAllChildCheckboxes(abtId);
                children.forEach(child => {
                    child.checked = isChecked;
                });
            });
        });
    });

    // üî∏ Beim Laden Tabelle einmal f√ºllen
    window.addEventListener('load', ladeThemen);
</script>

{% endblock %}
