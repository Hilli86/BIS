{% extends "layout/base.html" %}

{% block content %}
<h1 class="mb-4">Neues Thema anlegen</h1>

{% if message %}
<div class="alert alert-success">{{ message }}</div>
{% endif %}

<form id="themaForm" method="POST" class="bg-white p-4 rounded shadow-sm">

    <div class="mb-3">
        <label for="bereich" class="form-label">Bereich</label>
        <select class="form-select" id="bereich" required>
            <option value="">-- bitte w√§hlen --</option>
            {% for b in bereiche %}
            <option value="{{ b.ID }}">{{ b.Bezeichnung }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="gewerk" class="form-label">Gewerk</label>
        <select class="form-select" id="gewerk" name="gewerk" required disabled>
            <option value="">-- zuerst Bereich w√§hlen --</option>
            {% for g in gewerke %}
            <option value="{{ g.ID }}" data-bereich="{{ g.BereichID }}">{{ g.Bezeichnung }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="taetigkeit" class="form-label">T√§tigkeit</label>
        <select class="form-select" id="taetigkeit" name="taetigkeit" required>
            <option value="">-- bitte w√§hlen --</option>
            {% for t in taetigkeiten %}
            <option value="{{ t.ID }}">{{ t.Bezeichnung }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="status" class="form-label">Status</label>
        <select class="form-select" id="status" name="status" required>
            <option value="">-- bitte w√§hlen --</option>
            {% for s in status %}
            <option value="{{ s.ID }}">{{ s.Bezeichnung }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="bemerkung" class="form-label">Erste Bemerkung</label>
        <textarea class="form-control" id="bemerkung" name="bemerkung" rows="4" required></textarea>
    </div>

    {% if auswaehlbare_abteilungen %}
    <div class="mb-3">
        <label class="form-label fw-bold">
            <i class="bi bi-eye"></i> Sichtbarkeit - Welche Abteilungen sollen dieses Thema sehen?
        </label>
        <div class="form-text text-muted mb-2">
            W√§hlen Sie aus, welche Abteilungen Zugriff auf dieses Thema haben sollen.
        </div>
        
        <div class="card">
            <div class="card-body">
                {% for gruppe in auswaehlbare_abteilungen %}
                    <div class="mb-3">
                        <!-- Eigene Abteilung (Parent) -->
                        <div class="form-check">
                            <input class="form-check-input abteilung-checkbox" 
                                   type="checkbox" 
                                   name="sichtbare_abteilungen" 
                                   value="{{ gruppe.parent.ID }}" 
                                   id="abt_{{ gruppe.parent.ID }}" 
                                   data-abt-id="{{ gruppe.parent.ID }}"
                                   data-parent-id="root"
                                   {% if gruppe.parent.ID == primaer_abteilung_id %}checked{% endif %}>
                            <label class="form-check-label fw-bold" for="abt_{{ gruppe.parent.ID }}">
                                {{ gruppe.parent.Bezeichnung }}
                            </label>
                            {% if gruppe.parent.ID == primaer_abteilung_id %}
                            <small class="text-muted">(Prim√§rabteilung)</small>
                            {% else %}
                            <small class="text-muted">(zus√§tzliche Abteilung)</small>
                            {% endif %}
                        </div>
                        
                        <!-- ALLE untergeordneten Abteilungen (rekursiv) -->
                        {% if gruppe.children %}
                        <div class="mt-2">
                            {% for child in gruppe.children %}
                            <div class="form-check" style="margin-left: {{ (child.level + 1) * 1.5 }}rem;">
                                <input class="form-check-input abteilung-checkbox" 
                                       type="checkbox" 
                                       name="sichtbare_abteilungen" 
                                       value="{{ child.ID }}" 
                                       id="abt_{{ child.ID }}"
                                       data-abt-id="{{ child.ID }}"
                                       data-parent-id="{{ child.ParentAbteilungID }}">
                                <label class="form-check-label" for="abt_{{ child.ID }}">
                                    {% for i in range(child.level + 1) %}‚Ü≥{% endfor %} {{ child.Bezeichnung }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Ersatzteile -->
    <div class="mb-3">
        <label class="form-label fw-bold">
            <i class="bi bi-box-seam"></i> Ersatzteile (optional)
        </label>
        <div class="form-text text-muted mb-2">
            W√§hlen Sie Ersatzteile aus, die f√ºr dieses Thema verwendet werden sollen. Diese werden automatisch als Ausgang gebucht.
        </div>
        <div class="card">
            <div class="card-body">
                <div id="ersatzteileContainer">
                    <!-- Ersatzteile werden hier dynamisch hinzugef√ºgt -->
                </div>
                <div id="ersatzteileEmptyMessage" class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Keine Ersatzteile hinzugef√ºgt. Klicken Sie auf "Ersatzteil hinzuf√ºgen" um eines hinzuzuf√ºgen.
                </div>
                <button type="button" class="btn btn-sm btn-success mt-2" onclick="addErsatzteil()">
                    <i class="bi bi-plus-circle"></i> Ersatzteil hinzuf√ºgen
                </button>
            </div>
        </div>
    </div>

    <button type="submit" class="btn btn-success">
            <i class="bi bi-save"></i> Speichern
    </button>
    <a href="{{ url_for('schichtbuch.themaliste') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Zur√ºck zur Liste
    </a>
</form>

<hr class="my-4">
<h3>Zuletzt erstellte Themen</h3>
<table class="table table-striped" id="themenTabelle">
    <thead>
        <tr>
            <th>ID</th>
            <th>Bereich</th>
            <th>Gewerk</th>
            <th>Status</th>
            <th>Letzte Bemerkung</th>
        </tr>
    </thead>
    <tbody>
        <!-- wird dynamisch gef√ºllt -->
    </tbody>
</table>

<script>
    const bereichSelect = document.getElementById('bereich');
    const gewerkSelect = document.getElementById('gewerk');

    // üî∏ Gewerke nach Bereich filtern
    bereichSelect.addEventListener('change', function() {
        const selectedBereich = this.value;
        gewerkSelect.disabled = !selectedBereich;
        Array.from(gewerkSelect.options).forEach(opt => {
            if(opt.value === "") return;
            opt.style.display = (opt.dataset.bereich === selectedBereich) ? "block" : "none";
        });
        gewerkSelect.value = "";
    });

    // üî∏ Tabelle initial laden
    function ladeThemen() {
        fetch('/schichtbuch/themaneu/aktuelle_themen')
            .then(res => res.json())
            .then(data => {
                const tbody = document.querySelector('#themenTabelle tbody');
                tbody.innerHTML = "";
                data.themen.forEach(t => tbody.appendChild(baueZeile(t)));
            });
    }

    // üî∏ Zeile bauen
    function baueZeile(t) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${t.ID}</td>
            <td>${t.Bereich}</td>
            <td>${t.Gewerk}</td>
            <td>${t.Status}</td>
            <td>${t.LetzteBemerkung ? t.LetzteBemerkung + '<br><small class="text-muted">' + t.LetzteBemerkungDatum + '</small>' : '-'}</td>
        `;
        return row;
    }

    // üî∏ Ersatzteil hinzuf√ºgen
    let ersatzteilCounter = 0;
    function addErsatzteil() {
        const container = document.getElementById('ersatzteileContainer');
        const emptyMessage = document.getElementById('ersatzteileEmptyMessage');
        ersatzteilCounter++;
        
        const row = document.createElement('div');
        row.className = 'row g-2 mb-2 ersatzteil-row';
        row.setAttribute('data-row-id', ersatzteilCounter);
        row.innerHTML = `
            <div class="col-md-2">
                <label class="form-label small">Ersatzteil-ID:</label>
                <div class="input-group input-group-sm">
                    <input type="number" name="ersatzteil_id[]" class="form-control form-control-sm ersatzteil-id-input" placeholder="ID" min="1">
                    <button type="button" class="btn btn-outline-secondary btn-lookup" onclick="lookupErsatzteilForThemaButton(this)">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label small">Bestellnummer:</label>
                <input type="text" name="ersatzteil_bestellnummer[]" class="form-control form-control-sm ersatzteil-bestellnummer" readonly>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Bezeichnung:</label>
                <input type="text" name="ersatzteil_bezeichnung[]" class="form-control form-control-sm ersatzteil-bezeichnung" readonly>
            </div>
            <div class="col-md-2">
                <label class="form-label small">Menge:</label>
                <input type="number" name="ersatzteil_menge[]" class="form-control form-control-sm" value="1" min="1" required>
            </div>
            <div class="col-md-1">
                <label class="form-label small">&nbsp;</label>
                <button type="button" class="btn btn-sm btn-danger w-100" onclick="removeErsatzteil(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(row);
        emptyMessage.style.display = 'none';
        
        // Event-Listener f√ºr Ersatzteil-ID-Input
        const ersatzteilInput = row.querySelector('.ersatzteil-id-input');
        ersatzteilInput.addEventListener('blur', function() {
            if (this.value.trim()) {
                lookupErsatzteilForThema(this);
            }
        });
        
        // Event-Listener f√ºr Enter-Taste
        ersatzteilInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const button = row.querySelector('.btn-lookup');
                if (button) {
                    lookupErsatzteilForThemaButton(button);
                }
            }
        });
    }
    
    // üî∏ Ersatzteil entfernen
    function removeErsatzteil(button) {
        const row = button.closest('.ersatzteil-row');
        row.remove();
        
        const container = document.getElementById('ersatzteileContainer');
        if (container.children.length === 0) {
            document.getElementById('ersatzteileEmptyMessage').style.display = 'block';
        }
    }
    
    // üî∏ Ersatzteil-Informationen laden (von Input-Feld)
    function lookupErsatzteilForThema(input) {
        const row = input.closest('.ersatzteil-row');
        const bestellnummerInput = row.querySelector('.ersatzteil-bestellnummer');
        const bezeichnungInput = row.querySelector('.ersatzteil-bezeichnung');
        const ersatzteilId = input.value.trim();
        
        if (!ersatzteilId) {
            bestellnummerInput.value = '';
            bezeichnungInput.value = '';
            return;
        }
        
        input.disabled = true;
        
        fetch(`/ersatzteile/api/ersatzteil/${ersatzteilId}`)
            .then(response => response.json())
            .then(data => {
                input.disabled = false;
                if (data.success) {
                    bestellnummerInput.value = data.bestellnummer || '';
                    bezeichnungInput.value = data.bezeichnung || '';
                    input.classList.remove('is-invalid');
                } else {
                    bestellnummerInput.value = '';
                    bezeichnungInput.value = '';
                    input.classList.add('is-invalid');
                    alert(data.message || 'Ersatzteil nicht gefunden.');
                }
            })
            .catch(error => {
                input.disabled = false;
                console.error('Fehler:', error);
                alert('Fehler beim Laden der Ersatzteil-Daten.');
            });
    }
    
    // üî∏ Ersatzteil-Informationen laden (von Button)
    function lookupErsatzteilForThemaButton(button) {
        const row = button.closest('.ersatzteil-row');
        const ersatzteilInput = row.querySelector('.ersatzteil-id-input');
        const bestellnummerInput = row.querySelector('.ersatzteil-bestellnummer');
        const bezeichnungInput = row.querySelector('.ersatzteil-bezeichnung');
        const ersatzteilId = ersatzteilInput.value.trim();
        
        // Wenn keine ID eingegeben, Modal √∂ffnen
        if (!ersatzteilId) {
            openErsatzteilModalThema(row);
            return;
        }
        
        // Button deaktivieren w√§hrend der Suche
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        ersatzteilInput.disabled = true;
        
        fetch(`/ersatzteile/api/ersatzteil/${ersatzteilId}`)
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-arrow-right"></i>';
                ersatzteilInput.disabled = false;
                
                if (data.success) {
                    bestellnummerInput.value = data.bestellnummer || '';
                    bezeichnungInput.value = data.bezeichnung || '';
                    bestellnummerInput.classList.remove('is-invalid');
                    bezeichnungInput.classList.remove('is-invalid');
                    ersatzteilInput.classList.remove('is-invalid');
                } else {
                    bestellnummerInput.value = '';
                    bezeichnungInput.value = '';
                    bestellnummerInput.classList.add('is-invalid');
                    bezeichnungInput.classList.add('is-invalid');
                    ersatzteilInput.classList.add('is-invalid');
                    alert(data.message || 'Ersatzteil nicht gefunden.');
                }
            })
            .catch(error => {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-arrow-right"></i>';
                ersatzteilInput.disabled = false;
                console.error('Fehler:', error);
                alert('Fehler beim Laden der Ersatzteil-Daten.');
            });
    }
    
    // üî∏ Modal f√ºr Ersatzteil-Auswahl √∂ffnen
    function openErsatzteilModalThema(targetRow) {
        const modal = new bootstrap.Modal(document.getElementById('ersatzteilModalThema'));
        const modalBody = document.getElementById('ersatzteilModalListThema');
        const currentRow = targetRow;
        
        // Modal-Body leeren und Ladeanzeige anzeigen
        modalBody.innerHTML = '<div class="text-center p-4"><div class="spinner-border" role="status"><span class="visually-hidden">L√§dt...</span></div></div>';
        
        // Suchfeld leeren
        const searchInput = document.getElementById('ersatzteilSearchThema');
        if (searchInput) {
            searchInput.value = '';
        }
        
        // Modal √∂ffnen
        modal.show();
        
        // Ersatzteile laden
        fetch('/ersatzteile/api/ersatzteile/alle')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.ersatzteile && data.ersatzteile.length > 0) {
                    // Speichere die urspr√ºngliche Liste f√ºr Filterung
                    window.ersatzteilListThema = data.ersatzteile;
                    
                    // Rendere die Liste
                    renderErsatzteilListThema(data.ersatzteile);
                    
                    // Fokus auf Suchfeld setzen
                    if (searchInput) {
                        setTimeout(() => searchInput.focus(), 100);
                    }
                } else {
                    modalBody.innerHTML = '<div class="alert alert-info">Keine Ersatzteile gefunden.</div>';
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Ersatzteile:', error);
                modalBody.innerHTML = `<div class="alert alert-danger">
                    <strong>Fehler beim Laden der Ersatzteile:</strong><br>
                    ${error.message || 'Unbekannter Fehler'}
                </div>`;
            });
        
        // Speichere die aktuelle Zeile f√ºr die Auswahl
        document.getElementById('ersatzteilModalThema').setAttribute('data-target-row-id', '');
        if (currentRow) {
            document.getElementById('ersatzteilModalThema').setAttribute('data-target-row-id', currentRow.getAttribute('data-row-id') || '');
        }
    }
    
    // üî∏ Funktion zum Rendern der Ersatzteil-Liste (Thema Neu)
    function renderErsatzteilListThema(ersatzteile) {
        const modalBody = document.getElementById('ersatzteilModalListThema');
        if (!modalBody) return;
        
        if (ersatzteile.length === 0) {
            modalBody.innerHTML = '<div class="alert alert-info">Keine Ersatzteile gefunden.</div>';
            return;
        }
        
        let html = '<div class="list-group">';
        ersatzteile.forEach(ersatzteil => {
            const bestandText = `${ersatzteil.bestand || 0} ${ersatzteil.einheit || ''}`.trim();
            const bestellnummerEscaped = (ersatzteil.bestellnummer || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const bezeichnungEscaped = (ersatzteil.bezeichnung || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
            html += `
                <a href="#" class="list-group-item list-group-item-action" onclick="selectErsatzteilThema(${ersatzteil.id}, '${bestellnummerEscaped}', '${bezeichnungEscaped}', event)">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${ersatzteil.bestellnummer || 'Keine Bestellnummer'}</h6>
                        <small>${bestandText}</small>
                    </div>
                    <p class="mb-1">${ersatzteil.bezeichnung || 'Keine Bezeichnung'}</p>
                    <small>ID: ${ersatzteil.id}</small>
                </a>
            `;
        });
        html += '</div>';
        modalBody.innerHTML = html;
    }
    
    // üî∏ Funktion zum Filtern der Ersatzteil-Liste (Thema Neu)
    function filterErsatzteilListThema(searchTerm) {
        if (!window.ersatzteilListThema) return;
        
        const term = searchTerm.toLowerCase().trim();
        
        if (term === '') {
            // Wenn leer, alle anzeigen
            renderErsatzteilListThema(window.ersatzteilListThema);
            return;
        }
        
        // Filtere die Liste
        const filtered = window.ersatzteilListThema.filter(ersatzteil => {
            const bestellnummer = (ersatzteil.bestellnummer || '').toLowerCase();
            const bezeichnung = (ersatzteil.bezeichnung || '').toLowerCase();
            const id = ersatzteil.id.toString();
            
            return bestellnummer.includes(term) || 
                   bezeichnung.includes(term) || 
                   id.includes(term);
        });
        
        renderErsatzteilListThema(filtered);
    }
    
    // üî∏ Ersatzteil aus Modal ausw√§hlen
    function selectErsatzteilThema(id, bestellnummer, bezeichnung, event) {
        event.preventDefault();
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('ersatzteilModalThema'));
        const targetRowId = document.getElementById('ersatzteilModalThema').getAttribute('data-target-row-id');
        
        // Finde die entsprechende Zeile
        let targetRow = null;
        if (targetRowId) {
            targetRow = document.querySelector(`[data-row-id="${targetRowId}"]`);
        } else {
            // Fallback: nehme die erste Ersatzteil-Zeile
            targetRow = document.querySelector('.ersatzteil-row');
        }
        
        if (targetRow) {
            const ersatzteilInput = targetRow.querySelector('.ersatzteil-id-input');
            const bestellnummerDisplay = targetRow.querySelector('.ersatzteil-bestellnummer');
            const bezeichnungDisplay = targetRow.querySelector('.ersatzteil-bezeichnung');
            
            if (ersatzteilInput) ersatzteilInput.value = id;
            if (bestellnummerDisplay) bestellnummerDisplay.value = bestellnummer || '';
            if (bezeichnungDisplay) bezeichnungDisplay.value = bezeichnung || '';
            
            // Validierung entfernen
            if (bestellnummerDisplay) bestellnummerDisplay.classList.remove('is-invalid');
            if (bezeichnungDisplay) bezeichnungDisplay.classList.remove('is-invalid');
            if (ersatzteilInput) ersatzteilInput.classList.remove('is-invalid');
        }
        
        modal.hide();
    }

    // üî∏ Formular absenden
    document.getElementById('themaForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const submitButton = this.querySelector('button[type="submit"]');
        
        // Button deaktivieren w√§hrend der Anfrage
        submitButton.disabled = true;
        submitButton.textContent = 'Speichert...';

        fetch('/schichtbuch/themaneu', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Server-Fehler: ' + response.status);
            }
            return response.json();
        })
        .then(neuesThema => {
            // Formular leeren
            this.reset();
            gewerkSelect.disabled = true;

            // Neue Zeile an den Anfang der Tabelle setzen
            const tbody = document.querySelector('#themenTabelle tbody');
            const neueZeile = baueZeile(neuesThema);
            tbody.prepend(neueZeile);
        })
        .catch(err => {
            console.error('Fehler beim Speichern:', err);
        })
        .finally(() => {
            // Button wieder aktivieren
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="bi bi-save"></i> Speichern';
        });
    });

    // üî∏ Hierarchische Checkboxen - Kinder mit√§ndern
    function getAllChildCheckboxes(parentId) {
        // Findet alle Checkboxen, die direkt oder indirekt von parentId abh√§ngen
        const children = [];
        const directChildren = document.querySelectorAll(`.abteilung-checkbox[data-parent-id="${parentId}"]`);
        
        directChildren.forEach(child => {
            children.push(child);
            // Rekursiv alle weiteren Kinder hinzuf√ºgen
            const childId = child.dataset.abtId;
            children.push(...getAllChildCheckboxes(childId));
        });
        
        return children;
    }
    
    // Event Listener f√ºr alle Abteilungs-Checkboxen
    document.addEventListener('DOMContentLoaded', function() {
        const abteilungCheckboxes = document.querySelectorAll('.abteilung-checkbox');
        
        abteilungCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const abtId = this.dataset.abtId;
                const isChecked = this.checked;
                
                // Alle Kinder auf denselben Zustand setzen
                const children = getAllChildCheckboxes(abtId);
                children.forEach(child => {
                    child.checked = isChecked;
                });
            });
        });
        
        // Event-Listener f√ºr Suchfeld im Modal
        const searchInput = document.getElementById('ersatzteilSearchThema');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                filterErsatzteilListThema(this.value);
            });
        }
    });

    // üî∏ Beim Laden Tabelle einmal f√ºllen
    window.addEventListener('load', ladeThemen);
</script>

<!-- Modal f√ºr Ersatzteil-Auswahl -->
<div class="modal fade" id="ersatzteilModalThema" tabindex="-1" aria-labelledby="ersatzteilModalThemaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ersatzteilModalThemaLabel">Ersatzteil ausw√§hlen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Suchfeld -->
                <div class="mb-3">
                    <input type="text" class="form-control" id="ersatzteilSearchThema" placeholder="üîç Suchen nach Bestellnummer, Bezeichnung oder ID..." autocomplete="off">
                </div>
                <div id="ersatzteilModalListThema">
                    <div class="text-center p-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">L√§dt...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
