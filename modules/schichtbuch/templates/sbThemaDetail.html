{% extends "layout/base.html" %}

{% block content %}
    <h1 class="mb-4">Thema #{{ thema.ID }}</h1>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üìã Thema-Details</h5>
            <div class="d-flex gap-2">
                <a href="{{ url_for('schichtbuch.thema_pdf_export', thema_id=thema.ID) }}" 
                   class="btn btn-sm btn-light" 
                   title="Als PDF exportieren"
                   target="_blank">
                    <i class="bi bi-file-pdf"></i> <span class="d-none d-sm-inline">PDF</span>
                </a>
                <button class="btn btn-sm btn-light" type="button"
                        onclick="openSichtbarkeitModal({{ thema.ID }})"
                        title="Sichtbarkeit bearbeiten">
                    <i class="bi bi-eye"></i> <span class="d-none d-sm-inline">Sichtbarkeit</span>
                </button>
                <button class="btn btn-sm btn-light" type="button"
                        onclick="openQRCodeModal({{ thema.ID }})"
                        title="QR-Code anzeigen">
                    <i class="bi bi-qr-code"></i> <span class="d-none d-sm-inline">QR-Code</span>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <table class="table table-sm table-borderless mb-0">
                        <tbody>
                            <tr>
                                <td class="text-muted" style="width: 150px;"><strong>Bereich:</strong></td>
                                <td>{{ thema.Bereich }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted"><strong>Gewerk:</strong></td>
                                <td>{{ thema.Gewerk }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted"><strong>Abteilung:</strong></td>
                                <td>
                                    {% if thema.Abteilung %}
                                        {{ thema.Abteilung }}
                                    {% else %}
                                        <span class="text-muted fst-italic">Keine Abteilung zugewiesen</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted"><strong>Sichtbar f√ºr:</strong></td>
                                <td>
                                    {% if sichtbarkeiten %}
                                        {% for sicht in sichtbarkeiten %}
                                            <span class="badge bg-secondary me-1 mb-1">
                                                {% if sicht.ParentAbteilungID %}‚Ü≥{% endif %} {{ sicht.Bezeichnung }}
                                            </span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted fst-italic">Keine Sichtbarkeit definiert</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted"><strong>Status:</strong></td>
                                <td>
                                    <span class="badge" style="background-color: {{ thema.StatusFarbe }}">{{ thema.Status }}</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <h4 class="mb-3">Bemerkungen</h4>
    
    <!-- Card-Ansicht f√ºr alle Bildschirmgr√∂√üen -->
    <div>
        {% for b in bemerkungen %}
        <div class="card mb-3 shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="text-muted">
                        <i class="bi bi-calendar3"></i> {{ b.Datum }}
                    </div>
                    {% if session.get('user_id') == b.MitarbeiterID %}
                    <button type="button" class="btn btn-sm btn-outline-primary btn-edit" data-bemerkung-id="{{ b.BemerkungID }}">
                        <i class="bi bi-pencil"></i> Bearbeiten
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div>
                    <div class="mb-2">
                        <strong class="text-muted">Mitarbeiter:</strong> {{ b.Vorname }} {{ b.Nachname }}
                    </div>
                    
                    {% if b.Taetigkeit %}
                    <div class="mb-2">
                        <strong class="text-muted">T√§tigkeit:</strong> {{ b.Taetigkeit }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="mt-2">
                    <strong class="text-muted">Bemerkung:</strong>
                    <div class="bemerkung-view mt-1 p-2" data-bemerkung-id="{{ b.BemerkungID }}">{{ b.Bemerkung }}</div>
                    {% if session.get('user_id') == b.MitarbeiterID %}
                    <form class="bemerkung-edit d-none mt-2" data-bemerkung-id="{{ b.BemerkungID }}">
                        <div class="mb-2">
                            <textarea class="form-control" name="bemerkung" rows="3">{{ b.Bemerkung }}</textarea>
                        </div>
                        <div class="mb-2">
                            <select name="taetigkeit_id" class="form-select">
                                <option value="">-- T√§tigkeit w√§hlen --</option>
                                {% for t in taetigkeiten %}
                                    <option value="{{ t.ID }}" {% if b.TaetigkeitID == t.ID %}selected{% endif %}>{{ t.Bezeichnung }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-sm btn-success me-2">
                                <i class="bi bi-check-lg"></i> Speichern
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary btn-cancel-edit">
                                <i class="bi bi-x-lg"></i> Abbrechen
                            </button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Keine Bemerkungen vorhanden.
        </div>
        {% endfor %}
    </div>

    <!-- Verkn√ºpfungen mit Ersatzteilen -->
    {% if ersatzteil_verknuepfungen %}
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">üîó Verwendete Ersatzteile</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Ersatzteil</th>
                            <th>Typ</th>
                            <th>Menge</th>
                            <th>Preis</th>
                            <th>Kostenstelle</th>
                            <th>Grund</th>
                            <th>Von</th>
                            <th>Bemerkung</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in ersatzteil_verknuepfungen %}
                        <tr>
                            <td>{{ v.Buchungsdatum[:16] if v.Buchungsdatum else '-' }}</td>
                            <td>
                                <a href="{{ url_for('ersatzteile.ersatzteil_detail', ersatzteil_id=v.ErsatzteilID) }}" class="text-decoration-none">
                                    {{ v.Bestellnummer }} - {{ v.ErsatzteilBezeichnung }}
                                </a>
                            </td>
                            <td>
                                {% if v.Typ == 'Eingang' %}
                                <span class="badge bg-success">Eingang</span>
                                {% elif v.Typ == 'Inventur' %}
                                <span class="badge bg-info">Inventur</span>
                                {% else %}
                                <span class="badge bg-danger">Ausgang</span>
                                {% endif %}
                            </td>
                            <td><strong>{{ v.Menge }}</strong></td>
                            <td>
                                {% if v.Preis %}
                                {{ "%.2f"|format(v.Preis) }} {{ v.Waehrung or 'EUR' }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ v.Kostenstelle or '-' }}</td>
                            <td>{{ v.Grund or '-' }}</td>
                            <td>{{ v.VerwendetVon or '-' }}</td>
                            <td>{{ v.Bemerkung or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Ersatzteil zuordnen -->
    {% if verfuegbare_ersatzteile %}
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">üîß Ersatzteil zuordnen</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('ersatzteile.thema_verknuepfen', thema_id=thema.ID) }}">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label"><strong>Ersatzteil:</strong></label>
                        <select name="ersatzteil_id" class="form-select" required>
                            <option value="">-- Ersatzteil w√§hlen --</option>
                            {% for e in verfuegbare_ersatzteile %}
                            <option value="{{ e.ID }}" data-bestand="{{ e.AktuellerBestand }}">
                                {{ e.Bestellnummer }} - {{ e.Bezeichnung }} (Bestand: {{ e.AktuellerBestand }} {{ e.Einheit }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label"><strong>Menge:</strong></label>
                        <input type="number" name="menge" class="form-control" min="1" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><strong>Kostenstelle:</strong></label>
                        <select name="kostenstelle_id" class="form-select">
                            <option value="">-- Keine --</option>
                            {% for k in kostenstellen %}
                            <option value="{{ k.ID }}">{{ k.Bezeichnung }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><strong>Bemerkung:</strong></label>
                        <input type="text" name="bemerkung" class="form-control">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> Zuordnen
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Dateien-Bereich -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üìÑ Dateien & Bilder</h5>
            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#dateienUploadCollapse">
                <i class="bi bi-plus-circle"></i> Datei hochladen
            </button>
        </div>
        <div class="collapse" id="dateienUploadCollapse">
            <div class="card-body">
                <!-- Tab-Auswahl -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="thema-upload-tab" data-bs-toggle="tab" data-bs-target="#thema-upload-pane" type="button">
                            <i class="bi bi-cloud-upload"></i> Hochladen
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="thema-import-tab" data-bs-toggle="tab" data-bs-target="#thema-import-pane" type="button" onclick="ladeImportDateienThema()">
                            <i class="bi bi-folder"></i> Aus Import-Ordner
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Upload-Tab -->
                    <div class="tab-pane fade show active" id="thema-upload-pane" role="tabpanel">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="fileInput" name="files" 
                                       accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" multiple>
                                <div class="form-text">
                                    Max. 16 MB pro Datei - Mehrfachauswahl m√∂glich - Erlaubt: Bilder, PDF, Word, Excel, Text
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm" id="uploadButton">
                                <i class="bi bi-upload"></i> Hochladen
                            </button>
                        </form>
                        <div id="uploadProgress" class="mt-2 d-none">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                        </div>
                        <div id="uploadMessage" class="mt-2"></div>
                    </div>
                    
                    <!-- Import-Tab -->
                    <div class="tab-pane fade" id="thema-import-pane" role="tabpanel">
                        <div id="thema-import-dateien-liste">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">L√§dt...</span>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary mt-2" onclick="ladeImportDateienThema()">
                            <i class="bi bi-arrow-clockwise"></i> Aktualisieren
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="dateienListe">
                <div class="text-center">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">L√§dt...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">üí¨ Neue Bemerkung hinzuf√ºgen / Status √§ndern</h5>
        </div>
        <div class="card-body">
            <form method="POST">
                <div class="mb-3">
                    <label for="bemerkung" class="form-label fw-bold">Bemerkung</label>
                    <textarea class="form-control" id="bemerkung" name="bemerkung" rows="4" required></textarea>
                    <div class="form-text text-muted">
                        Eine Bemerkung ist immer erforderlich ‚Äì auch bei Status√§nderung.
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="taetigkeit_id" class="form-label fw-bold">T√§tigkeit</label>
                        <select name="taetigkeit_id" id="taetigkeit_id" class="form-select" required>
                            <option value="">-- T√§tigkeit w√§hlen --</option>
                            {% for t in taetigkeiten %}
                                <option value="{{ t.ID }}">{{ t.Bezeichnung }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="status" class="form-label fw-bold">Status √§ndern (optional)</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">-- keine √Ñnderung --</option>
                            {% for s in status_liste %}
                            <option value="{{ s.ID }}" {% if s.ID == thema.StatusID %}selected{% endif %}>
                                {{ s.Bezeichnung }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-save"></i> Speichern
                    </button>
                    <a href="{{ previous_page }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Zur√ºck
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Sichtbarkeit bearbeiten -->
    <div class="modal fade" id="sichtbarkeitModal" tabindex="-1" aria-labelledby="sichtbarkeitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="sichtbarkeitModalLabel">
                        <i class="bi bi-eye"></i> Sichtbarkeit bearbeiten
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schlie√üen"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">
                        W√§hlen Sie aus, welche Abteilungen dieses Thema sehen d√ºrfen.
                    </p>
                    
                    <form id="sichtbarkeitForm">
                        <input type="hidden" id="sichtbarkeit_thema_id" name="thema_id">
                        <div id="sichtbarkeitCheckboxen">
                            <!-- Wird dynamisch mit JavaScript gef√ºllt -->
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">L√§dt...</span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> <span class="d-none d-sm-inline">Abbrechen</span>
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveSichtbarkeit()">
                        <i class="bi bi-check-lg"></i> <span class="d-none d-sm-inline">Speichern</span>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal: QR-Code anzeigen -->
    <div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="qrCodeModalLabel">
                        <i class="bi bi-qr-code"></i> QR-Code f√ºr Thema #<span id="qrThemaId"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schlie√üen"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-muted mb-3">
                        Scannen Sie diesen QR-Code mit Ihrem Handy, um direkt zu diesem Thema zu gelangen.
                    </p>
                    <div id="qrcode" class="d-flex justify-content-center mb-3"></div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="qrCodeUrl" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyQRCodeUrl()" title="Link kopieren">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> Schlie√üen
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('click', (e) => {
    const editBtn = e.target.closest('.btn-edit');
    if (!editBtn) return;
    const id = editBtn.getAttribute('data-bemerkung-id');
    const view = document.querySelector(`.bemerkung-view[data-bemerkung-id="${id}"]`);
    const form = document.querySelector(`.bemerkung-edit[data-bemerkung-id="${id}"]`);
    if (view && form) {
        view.classList.add('d-none');
        form.classList.remove('d-none');
    }
});

document.addEventListener('click', (e) => {
    const cancelBtn = e.target.closest('.btn-cancel-edit');
    if (!cancelBtn) return;
    const form = cancelBtn.closest('.bemerkung-edit');
    const id = form.getAttribute('data-bemerkung-id');
    const view = document.querySelector(`.bemerkung-view[data-bemerkung-id="${id}"]`);
    if (view && form) {
        form.classList.add('d-none');
        view.classList.remove('d-none');
    }
});

document.addEventListener('submit', async (e) => {
    const form = e.target.closest('.bemerkung-edit');
    if (!form) return;
    e.preventDefault();
    const id = form.getAttribute('data-bemerkung-id');
    const formData = new FormData(form);
    try {
        const res = await fetch(`/schichtbuch/edit_bemerkung/${id}`, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await res.json();
        if (!data.success) {
            alert(data.error || 'Speichern fehlgeschlagen');
            return;
        }
        const view = document.querySelector(`.bemerkung-view[data-bemerkung-id="${id}"]`);
        if (view) view.textContent = data.bemerkung;
        
        // T√§tigkeitstext in der Card aktualisieren
        const card = form.closest('.card');
        const taetigkeitContainer = card.querySelector('.card-body > div > div:nth-child(2)');
        if (taetigkeitContainer && data.taetigkeit) {
            const taetigkeitDiv = taetigkeitContainer.querySelector('div:last-child');
            if (taetigkeitDiv) taetigkeitDiv.textContent = data.taetigkeit;
        }
        
        form.classList.add('d-none');
        if (view) view.classList.remove('d-none');
    } catch (err) {
        console.error(err);
        alert('Fehler beim Speichern.');
    }
});
</script>

<!-- Sichtbarkeits-Modal JavaScript -->
<script>
let currentSichtbarkeitThemaId = null;

async function openSichtbarkeitModal(themaId) {
    currentSichtbarkeitThemaId = themaId;
    const modal = new bootstrap.Modal(document.getElementById('sichtbarkeitModal'));
    const container = document.getElementById('sichtbarkeitCheckboxen');
    
    // Loading-Spinner anzeigen
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">L√§dt...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    try {
        const response = await fetch(`/schichtbuch/thema/${themaId}/sichtbarkeit`);
        const data = await response.json();
        
        if (!data.success) {
            container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Daten.</div>';
            return;
        }
        
        // Checkboxen generieren
        let html = '';
        
        // Ausw√§hlbare Abteilungen (eigene + untergeordnete)
        data.auswaehlbare.forEach(gruppe => {
            html += '<div class="mb-3">';
            
            // Parent-Abteilung
            const isChecked = gruppe.parent.is_current ? 'checked' : '';
            const label = gruppe.parent.is_primaer ? '(Prim√§rabteilung)' : '(zus√§tzliche Abteilung)';
            
            html += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           name="sichtbare_abteilungen" 
                           value="${gruppe.parent.id}" 
                           id="modal_abt_${gruppe.parent.id}" 
                           ${isChecked}>
                    <label class="form-check-label fw-bold" for="modal_abt_${gruppe.parent.id}">
                        ${gruppe.parent.name}
                    </label>
                    <small class="text-muted">${label}</small>
                </div>
            `;
            
            // Untergeordnete Abteilungen
            if (gruppe.children && gruppe.children.length > 0) {
                html += '<div class="ms-4 mt-2">';
                gruppe.children.forEach(child => {
                    const childChecked = child.is_current ? 'checked' : '';
                    html += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   name="sichtbare_abteilungen" 
                                   value="${child.id}" 
                                   id="modal_abt_${child.id}" 
                                   ${childChecked}>
                            <label class="form-check-label" for="modal_abt_${child.id}">
                                ‚Ü≥ ${child.name}
                            </label>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
        });
        
        // Zus√§tzliche aktuell zugewiesene Abteilungen (nicht in eigenen)
        if (data.zusaetzliche && data.zusaetzliche.length > 0) {
            html += '<hr class="my-3">';
            html += '<div class="alert alert-info small mb-3">';
            html += '<strong>Weitere zugewiesene Abteilungen:</strong><br>';
            html += 'Diese Abteilungen sind aktuell zugewiesen, k√∂nnen aber nicht bearbeitet werden.';
            html += '</div>';
            
            data.zusaetzliche.forEach(abt => {
                const parentLabel = abt.parent ? ` (${abt.parent.name})` : '';
                html += `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" 
                               name="sichtbare_abteilungen" 
                               value="${abt.id}" 
                               id="modal_abt_${abt.id}" 
                               checked disabled>
                        <label class="form-check-label text-muted" for="modal_abt_${abt.id}">
                            ${abt.name}${parentLabel}
                        </label>
                        <small class="text-muted">(gesch√ºtzt)</small>
                    </div>
                `;
            });
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Fehler beim Laden der Sichtbarkeiten:', error);
        container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Daten.</div>';
    }
}

async function saveSichtbarkeit() {
    const form = document.getElementById('sichtbarkeitForm');
    const themaId = currentSichtbarkeitThemaId;
    const saveButton = document.querySelector('#sichtbarkeitModal .btn-primary');
    
    // Alle Checkboxen sammeln (auch disabled!)
    const allCheckboxes = form.querySelectorAll('input[name="sichtbare_abteilungen"]');
    const selectedIds = [];
    
    allCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedIds.push(checkbox.value);
        }
    });
    
    // Validierung: Mindestens eine Abteilung muss ausgew√§hlt sein
    if (selectedIds.length === 0) {
        alert('Bitte w√§hlen Sie mindestens eine Abteilung aus.');
        return;
    }
    
    // FormData manuell erstellen, da disabled Felder nicht automatisch mitgesendet werden
    const formData = new FormData();
    selectedIds.forEach(id => {
        formData.append('sichtbare_abteilungen', id);
    });
    
    // Button deaktivieren
    saveButton.disabled = true;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Speichert...';
    
    try {
        const response = await fetch(`/schichtbuch/thema/${themaId}/sichtbarkeit`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Modal schlie√üen
            const modal = bootstrap.Modal.getInstance(document.getElementById('sichtbarkeitModal'));
            modal.hide();
            
            // Seite neu laden, um aktualisierte Sichtbarkeiten anzuzeigen
            window.location.reload();
        } else {
            alert('Fehler: ' + data.message);
        }
    } catch (error) {
        console.error('Fehler beim Speichern:', error);
        alert('Fehler beim Speichern der Sichtbarkeit.');
    } finally {
        // Button wieder aktivieren
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="bi bi-check-lg"></i> <span class="d-none d-sm-inline">Speichern</span>';
    }
}
</script>

<!-- QR-Code Modal JavaScript -->
<script>
// Funktion im globalen Scope verf√ºgbar machen
window.openQRCodeModal = function(themaId) {
    try {
        // Thema-ID im Modal anzeigen
        const qrThemaIdEl = document.getElementById('qrThemaId');
        if (!qrThemaIdEl) {
            console.error('qrThemaId element not found');
            return;
        }
        qrThemaIdEl.textContent = themaId;
        
        // URL zum Thema generieren (aktuelle URL ohne Query-Parameter)
        const currentUrl = window.location.href.split('?')[0];
        const themaUrl = currentUrl;
        
        // URL im Input-Feld anzeigen
        const urlInput = document.getElementById('qrCodeUrl');
        if (urlInput) {
            urlInput.value = themaUrl;
        }
        
        // QR-Code Container leeren
        const qrContainer = document.getElementById('qrcode');
        if (!qrContainer) {
            console.error('qrcode container not found');
            return;
        }
        
        // QR-Code √ºber API generieren (qr-server.com)
        const encodedUrl = encodeURIComponent(themaUrl);
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodedUrl}`;
        
        // Loading-Spinner anzeigen
        qrContainer.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">L√§dt...</span>
                </div>
            </div>
        `;
        
        // QR-Code-Bild erstellen
        const img = document.createElement('img');
        img.src = qrCodeUrl;
        img.alt = 'QR-Code';
        img.className = 'img-fluid';
        img.style.maxWidth = '256px';
        img.style.height = 'auto';
        
        img.onload = function() {
            qrContainer.innerHTML = '';
            qrContainer.appendChild(img);
        };
        
        img.onerror = function() {
            qrContainer.innerHTML = '<div class="alert alert-danger">Fehler beim Laden des QR-Codes. Bitte versuchen Sie es erneut.</div>';
        };
        
        // Modal √∂ffnen
        const modalElement = document.getElementById('qrCodeModal');
        if (!modalElement) {
            console.error('qrCodeModal element not found');
            return;
        }
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } catch (error) {
        console.error('Fehler beim √ñffnen des QR-Code-Modals:', error);
        alert('Fehler beim √ñffnen des QR-Code-Modals: ' + error.message);
    }
};

function copyQRCodeUrl() {
    const urlInput = document.getElementById('qrCodeUrl');
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // F√ºr mobile Ger√§te
    
    try {
        navigator.clipboard.writeText(urlInput.value).then(() => {
            // Erfolgs-Feedback
            const button = document.querySelector('#qrCodeModal .btn-outline-secondary');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check-lg"></i>';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 2000);
        });
    } catch (err) {
        // Fallback f√ºr √§ltere Browser
        document.execCommand('copy');
        alert('Link wurde in die Zwischenablage kopiert!');
    }
}
</script>

<!-- Dateien JavaScript -->
<script>
let currentThemaId = {{ thema.ID }};

// Dateien beim Laden der Seite anzeigen
document.addEventListener('DOMContentLoaded', function() {
    loadDateienListe(currentThemaId);
});

async function loadDateienListe(themaId) {
    const dateienListe = document.getElementById('dateienListe');
    dateienListe.innerHTML = `
        <div class="text-center">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">L√§dt...</span>
            </div>
        </div>
    `;
    
    try {
        const response = await fetch(`/schichtbuch/thema/${themaId}/dateien`);
        const data = await response.json();
    
    if (!data.success) {
        dateienListe.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Dateien.</div>';
        return;
    }
    
    if (data.dateien.length === 0) {
        dateienListe.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> Keine Dateien vorhanden.</div>';
        return;
    }
    
    // Dateien anzeigen
    let html = '<div class="row g-3">';
    
    data.dateien.forEach(datei => {
        if (datei.type === 'image') {
            // Bilder als Vorschau anzeigen
            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100">
                        <img src="${datei.url}" class="card-img-top" alt="${datei.name}" style="object-fit: cover; height: 200px; cursor: pointer;" onclick="window.open('${datei.url}', '_blank')">
                        <div class="card-body p-2">
                            <p class="card-text small mb-1">
                                <strong>${datei.name}</strong>
                            </p>
                            <p class="card-text small text-muted mb-0">${datei.size}</p>
                        </div>
                        <div class="card-footer p-2">
                            <a href="${datei.url}" target="_blank" class="btn btn-sm btn-primary w-100">
                                <i class="bi bi-download"></i> Herunterladen
                            </a>
                        </div>
                    </div>
                </div>
            `;
        } else if (datei.type === 'pdf') {
            // PDF-Dateien
            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-center" style="height: 200px; background-color: #f8f9fa;">
                            <i class="bi bi-file-pdf" style="font-size: 4rem; color: #dc3545;"></i>
                            <p class="mt-2 mb-0"><strong>${datei.name}</strong></p>
                            <p class="text-muted small">${datei.size}</p>
                        </div>
                        <div class="card-footer p-2">
                            <a href="${datei.url}" target="_blank" class="btn btn-sm btn-primary w-100">
                                <i class="bi bi-eye"></i> √ñffnen
                            </a>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // Andere Dokumente
            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-center" style="height: 200px; background-color: #f8f9fa;">
                            <i class="bi bi-file-earmark-text" style="font-size: 4rem; color: #0d6efd;"></i>
                            <p class="mt-2 mb-0"><strong>${datei.name}</strong></p>
                            <p class="text-muted small">${datei.size}</p>
                        </div>
                        <div class="card-footer p-2">
                            <a href="${datei.url}" target="_blank" class="btn btn-sm btn-primary w-100">
                                <i class="bi bi-download"></i> Herunterladen
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    html += '</div>';
    dateienListe.innerHTML = html;
    
    } catch (error) {
        console.error('Fehler beim Laden der Dateien:', error);
        dateienListe.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Dateien.</div>';
    }
}

// Upload-Formular Handler
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const uploadButton = document.getElementById('uploadButton');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadMessage = document.getElementById('uploadMessage');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                uploadMessage.innerHTML = '<div class="alert alert-warning alert-dismissible fade show" role="alert">Bitte w√§hlen Sie mindestens eine Datei aus.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
                return;
            }
            
            const files = fileInput.files;
            const totalFiles = files.length;
            let successCount = 0;
            let errorCount = 0;
            let errorMessages = [];
            
            // Button deaktivieren und Progress anzeigen
            uploadButton.disabled = true;
            uploadProgress.classList.remove('d-none');
            uploadMessage.innerHTML = `<div class="alert alert-info">üì§ Lade ${totalFiles} Datei(en) hoch...</div>`;
            
            // Dateien nacheinander hochladen
            for (let i = 0; i < totalFiles; i++) {
                const formData = new FormData();
                formData.append('file', files[i]);
                
                try {
                    const response = await fetch(`/schichtbuch/thema/${currentThemaId}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        successCount++;
                    } else {
                        errorCount++;
                        errorMessages.push(`${files[i].name}: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Upload-Fehler:', error);
                    errorCount++;
                    errorMessages.push(`${files[i].name}: Netzwerkfehler`);
                }
            }
            
            // Ergebnis anzeigen
            uploadProgress.classList.add('d-none');
            uploadButton.disabled = false;
            
            if (errorCount === 0) {
                uploadMessage.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">‚úÖ ${successCount} Datei(en) erfolgreich hochgeladen<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
                uploadForm.reset();
                
                // Dateiliste neu laden
                setTimeout(() => {
                    loadDateienListe(currentThemaId);
                }, 500);
            } else if (successCount > 0) {
                let errorList = errorMessages.map(msg => `<li>${msg}</li>`).join('');
                uploadMessage.innerHTML = `<div class="alert alert-warning alert-dismissible fade show" role="alert">‚ö†Ô∏è ${successCount} erfolgreich, ${errorCount} fehlgeschlagen<ul class="mb-0 mt-2">${errorList}</ul><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
                uploadForm.reset();
                
                // Dateiliste neu laden
                setTimeout(() => {
                    loadDateienListe(currentThemaId);
                }, 500);
            } else {
                let errorList = errorMessages.map(msg => `<li>${msg}</li>`).join('');
                uploadMessage.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">‚ùå Alle Uploads fehlgeschlagen<ul class="mb-0 mt-2">${errorList}</ul><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
            }
        });
    }
    
    // Collapse-Event: Dateien neu laden wenn Upload-Bereich ge√∂ffnet wird
    const dateienCollapse = document.getElementById('dateienUploadCollapse');
    if (dateienCollapse) {
        dateienCollapse.addEventListener('show.bs.collapse', function() {
            // Dateien neu laden wenn Upload-Bereich ge√∂ffnet wird
            loadDateienListe(currentThemaId);
        });
    }
});

// Import-Funktionalit√§t f√ºr Themen
async function ladeImportDateienThema() {
    const liste = document.getElementById('thema-import-dateien-liste');
    if (!liste) return;
    
    liste.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
    
    try {
        const response = await fetch('/api/import/dateien');
        const data = await response.json();
        
        if (!data.success || data.dateien.length === 0) {
            liste.innerHTML = '<div class="alert alert-info">Keine Dateien im Import-Ordner vorhanden.</div>';
            return;
        }
        
        // Alle erlaubten Dateitypen f√ºr Themen
        const erlaubteEndungen = ['.pdf', '.jpg', '.jpeg', '.png', '.gif', '.webp', '.doc', '.docx', '.xls', '.xlsx', '.txt'];
        const gefilterteDateien = data.dateien.filter(datei => {
            const ext = '.' + datei.name.split('.').pop().toLowerCase();
            return erlaubteEndungen.includes(ext);
        });
        
        if (gefilterteDateien.length === 0) {
            liste.innerHTML = '<div class="alert alert-warning">Keine passenden Dateien im Import-Ordner vorhanden.</div>';
            return;
        }
        
        let html = '<div class="list-group">';
        gefilterteDateien.forEach(datei => {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${datei.name}</strong>
                        <br><small class="text-muted">${datei.size}</small>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="verschiebeAusImportThema('${datei.name.replace(/'/g, "\\'")}')">
                        <i class="bi bi-arrow-right"></i> Verwenden
                    </button>
                </div>
            `;
        });
        html += '</div>';
        liste.innerHTML = html;
    } catch (error) {
        console.error('Fehler beim Laden der Dateien:', error);
        liste.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Dateien.</div>';
    }
}

async function verschiebeAusImportThema(filename) {
    const themaId = {{ thema.ID }};
    const zielOrdner = `Schichtbuch/Themen/${themaId}`;
    
    if (!confirm(`M√∂chten Sie die Datei "${filename}" aus dem Import-Ordner verwenden? Die Datei wird verschoben.`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/import/verschieben', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename: filename, ziel_ordner: zielOrdner})
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Datei erfolgreich verschoben!');
            // Dateiliste neu laden
            loadDateienListe(themaId);
            // Import-Liste aktualisieren
            ladeImportDateienThema();
        } else {
            alert('Fehler: ' + data.message);
        }
    } catch (error) {
        console.error('Fehler beim Verschieben:', error);
        alert('Fehler beim Verschieben der Datei.');
    }
}
</script>
{% endblock %}