
{% extends "layout/base.html" %}

{% block styles %}
  <style>
  /* 1) Themenzeile: alle TDs dieser TR immer hellgrau */
  .table tbody tr.thema-row > td {
    background-color: #e9ecef !important;
  }

  /* 2) Bemerkungszeile & Collapse-Zeile: TDs immer wei√ü */
  .table tbody tr.bemerkung-row > td,
  .table tbody tr.collapse-row > td {
    background-color: #ffffff !important;
  }

  /* 3) Falls List-Group-Items verwendet werden, sicherstellen, dass sie wei√ü sind */
  .table .list-group-item {
    background-color: #ffffff !important;
    border-left: 3px solid #dee2e6; /* optional: dezenter linker Balken */
  }

  /* 4) Verhindern, dass .table-striped wieder einf√§rbt (falls irgendwo noch gesetzt) */
  .table.table-striped tbody tr:nth-of-type(odd) > td {
    background-color: transparent !important;
  }

  /* 5) Optional: etwas Abstand / Padding f√ºr die Bemerkungsbox */
  .table tbody tr.bemerkung-row td .list-group {
    margin: 0;
    padding: 0;
  }

  /* Themenzeilen grau */
  .thema-row {
    background-color: #f2f2f2 !important;
  }

  /* Bemerkungen immer wei√ü */
  .bemerkung-row,
  .collapse-row {
    background-color: #ffffff !important;
  }

  /* Dezent abgesetzte Bemerkungen */
  .bemerkung-list li {
    border-left: 3px solid #dee2e6;
    margin-bottom: 4px;
  }
</style>
{% endblock %}

{% block content %}
<h1>Themenliste mit allen Bemerkungen</h1>

<!-- üîπ Filter (einklappbar) -->
<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Filter</strong>
    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false">Anzeigen / Ausblenden</button>
  </div>
  <div class="collapse" id="filterCollapse">
    <div class="card-body">
      <form method="get" id="filterForm">
        <!-- Zeile 1: Bereich + Gewerk -->
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label">Bereich</label>
            <select name="bereich" id="filterBereich" class="form-select">
              <option value="">-- Bereich w√§hlen --</option>
              {% for b in bereich_liste %}
                <option value="{{ b.Bezeichnung }}" {% if b.Bezeichnung == bereich_filter %}selected{% endif %}>{{ b.Bezeichnung }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Gewerk</label>
            <select name="gewerk" id="filterGewerk" class="form-select">
              <option value="">-- alle Gewerke --</option>
              {% for g in gewerke_liste %}
                <option value="{{ g.Bezeichnung }}" {% if gewerk_filter == g.Bezeichnung %}selected{% endif %}>{{ g.Bezeichnung }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Zeile 2: Status (Mehrfach) -->
        <div class="row g-3 mt-1">
          <div class="col-12">
            <label class="form-label">Status (Mehrfachauswahl)</label>
            <select name="status" id="filterStatus" class="form-select" multiple>
              {% for s in status_liste %}
                <option value="{{ s.Bezeichnung }}" {% if status_filter_list and (s.Bezeichnung in status_filter_list) %}selected{% endif %}>{{ s.Bezeichnung }}</option>
              {% endfor %}
            </select>
            <div class="form-text">STRG/CMD halten f√ºr Mehrfachauswahl</div>
          </div>
        </div>

        <!-- Zeile 3: Suchtext -->
        <div class="row g-3 mt-1">
          <div class="col-12">
            <label class="form-label">Text in Bemerkungen</label>
            <input type="text" name="q" id="filterQ" value="{{ q_filter or '' }}" class="form-control" placeholder="z. B. Pumpe, Fehlercode ..." />
          </div>
        </div>

        <!-- Zeile 4: Buttons -->
        <div class="row g-3 mt-2">
          <div class="col-12 d-flex">
            <button type="submit" class="btn btn-primary me-2">Filtern</button>
            <a href="{{ url_for('schichtbuch.themaliste') }}" class="btn btn-secondary">Alle anzeigen</a>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<table class="table align-middle">
  <thead class="table-dark">
    <tr>
      <th>ID</th>
      <th>Bereich ‚Äì Gewerk</th>
      <th>Status</th>
      <th>Aktionen</th>
    </tr>
  </thead>
  <tbody>
    {% for thema in themen %}
    <!-- üî∏ Themen-Zeile -->
    <tr class="thema-row" style="color: {{ thema.Farbe or 'inherit' }};">
      <td>
        <a href="{{ url_for('schichtbuch.thema_detail', thema_id=thema.ID, next=request.full_path) }}" class="text-decoration-none">
          #{{ thema.ID }}
        </a>
      </td>
      <td>{{ thema.Bereich }} ‚Äì {{ thema.Gewerk }}</td>
      <td>
        <span class="badge rounded-pill" style="background-color: {{ thema.Farbe|default('#ccc')|trim }}; color: #fff;">
          {{ thema.Status }}
        </span>
      </td>
      <td class="text-center">
        <div class="d-flex flex-column flex-sm-row justify-content-center gap-1">
          <!-- üî∏ Neue Bemerkung Button -->
          <button class="btn btn-sm btn-outline-success" type="button"
                  data-bs-toggle="collapse" data-bs-target="#newBemerkung{{ thema.ID }}" aria-expanded="false"
                  title="Neue Bemerkung">
            <i class="bi bi-plus-lg"></i>
          </button>
          
          <!-- üî∏ Dateien anzeigen Button -->
          <button class="btn btn-sm btn-outline-secondary" type="button"
                  onclick="openDateienModal({{ thema.ID }})"
                  title="Dateien & Bilder">
            <i class="bi bi-paperclip"></i>
          </button>
          
          <!-- üî∏ Sichtbarkeit bearbeiten Button -->
          <button class="btn btn-sm btn-outline-info" type="button"
                  onclick="openSichtbarkeitModal({{ thema.ID }})"
                  title="Sichtbarkeit bearbeiten">
            <i class="bi bi-eye"></i>
          </button>
          
          <!-- üî∏ L√∂schen Button -->
          <form action="{{ url_for('schichtbuch.delete_thema', thema_id=thema.ID) }}" method="post" class="m-0 p-0">
            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Thema wirklich l√∂schen?');"
                    title="Thema l√∂schen">
                <i class="bi bi-trash"></i>
            </button>
          </form>
        </div>
      </td>
    </tr>

    <!-- üîπ Bemerkungen -->
    <tr class="bemerkung-row">
      <td colspan="5">
        {% if bemerk_dict.get(thema.ID) %}
          <ul class="list-group list-group-flush bemerkung-list">
            {% for b in bemerk_dict[thema.ID] %}
            <li class="list-group-item bg-white">
              <div class="d-flex">
                <small class="text-muted">
                  {{ b.Datum }} - <strong>{{ b.Vorname }} {{ b.Nachname }}</strong>
                  {% if b.Taetigkeit %}
                    <span class="text-secondary">({{ b.Taetigkeit }})</span>
                  {% endif %}
                </small>
              </div>
              <div>{{ b.Bemerkung }}</div>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted fst-italic mb-0">Keine Bemerkungen vorhanden.</p>
        {% endif %}
      </td>
    </tr>

    <!-- üî∏ Eingeklappter Bereich -->
    <tr class="collapse collapse-row" id="newBemerkung{{ thema.ID }}">
      <td colspan="5">
        <form action="{{ url_for('schichtbuch.add_bemerkung') }}" method="post" class="mt-2">
          <input type="hidden" name="thema_id" value="{{ thema.ID }}">
          <input type="hidden" name="next" value="{{ request.full_path }}">
          
          <!-- üî∏ Status -->
          <div class="mb-1">
            <label for="status{{ thema.ID }}" class="form-label fw-bold">Status √§ndern:</label>
            <select name="status_id" id="status{{ thema.ID }}" class="form-select">
              <option value="">-- unver√§ndert --</option>
              {% for s in status_liste %}
                <option value="{{ s.ID }}" {% if s.Bezeichnung == thema.Status %}selected{% endif %}>
                  {{ s.Bezeichnung }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- üî∏ T√§tigkeit -->
          <div class="mb-1">
            <label for="taetigkeit{{ thema.ID }}" class="form-label fw-bold">T√§tigkeit:</label>
            <select name="taetigkeit_id" id="taetigkeit{{ thema.ID }}" class="form-select" required>
              <option value="">-- T√§tigkeit w√§hlen --</option>
              {% for t in taetigkeiten_liste %}
                <option value="{{ t.ID }}">{{ t.Bezeichnung }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- üî∏ Bemerkung -->
          <div class="mb-1">
            <label for="bemerkung{{ thema.ID }}" class="form-label fw-bold">Neue Bemerkung:</label>
            <textarea
              name="bemerkung"
              id="bemerkung{{ thema.ID }}"
              class="form-control"
              rows="3"
              placeholder="Neue Bemerkung eingeben..."
              required
            ></textarea>
          </div>

          <!-- üî∏ Speichern -->
          <div class="mb-0">
            <button type="submit" class="btn btn-success">
              <i class="bi bi-save"></i> Speichern
            </button>
          </div>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="text-center my-4" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Laden...</span>
  </div>
  <p class="mt-2">Weitere Eintr√§ge werden geladen...</p>
</div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("submit", async (e) => {
  const form = e.target.closest("form[action='/schichtbuch/themaliste/add']");
  if (!form) return;
  e.preventDefault();
  console.log("Formular abgefangen");
  
  const formData = new FormData(form);
  const themaId = formData.get("thema_id");
  const submitBtn = form.querySelector("button[type='submit']");
  submitBtn.disabled = true;

  try {
    const response = await fetch(form.action, {
      method: "POST",
      body: formData,
      headers: { "X-Requested-With": "XMLHttpRequest" }
    });
    const data = await response.json();

    if (!data.success) {
      alert("Fehler beim Speichern.");
      return;
    }

    // Rest: Bemerkung hinzuf√ºgen, Collapse schlie√üen, Toast anzeigen
    const collapseRow = form.closest("tr.collapse-row");
    const bemerkungsRow = collapseRow.previousElementSibling;
    const themaRow = bemerkungsRow.previousElementSibling;

    let bemerkungsList = bemerkungsRow.querySelector(".list-group");
    if (!bemerkungsList) {
      bemerkungsList = document.createElement("ul");
      bemerkungsList.className = "list-group list-group-flush bemerkung-list";
      bemerkungsRow.querySelector("td").innerHTML = "";
      bemerkungsRow.querySelector("td").appendChild(bemerkungsList);
    }

    const newItem = document.createElement("li");
    newItem.className = "list-group-item bg-white";
    newItem.innerHTML = `
      <div class="d-flex">
        <small class="text-muted">
          ${data.datum} ‚Äì <strong>${data.vorname} ${data.nachname}</strong>
          ${data.taetigkeit ? `<span class="text-secondary">(${data.taetigkeit})</span>` : ""}
        </small>
      </div>
      <div>${data.bemerkung}</div>
    `;
    bemerkungsList.prepend(newItem);

    if (data.neuer_status && data.neue_farbe) {
      const badge = themaRow.querySelector(".badge");
      if (badge) {
        badge.textContent = data.neuer_status;
        badge.style.backgroundColor = data.neue_farbe;
      }
    }

    const scrollY = window.scrollY;
    form.reset();
    bootstrap.Collapse.getOrCreateInstance(document.querySelector(`#newBemerkung${themaId}`)).hide();
    window.scrollTo(0, scrollY);

    const toast = document.createElement("div");
    toast.className = "alert alert-success position-fixed top-0 end-0 m-3 shadow";
    toast.style.zIndex = "2000";
    toast.textContent = "Bemerkung erfolgreich gespeichert.";
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);

  } catch (err) {
    console.error(err);
    alert("Fehler beim Speichern.");
  } finally {
    submitBtn.disabled = false;
  }
});

// Infinite Scroll
let isLoading = false;
let currentOffset = {{ themen|length }};
const statusFilters = {{ (status_filter_list or []) | tojson }};
let bereichFilter = '{{ bereich_filter or '' }}';
let gewerkFilter = '{{ gewerk_filter or '' }}';
let qFilter = '{{ q_filter or '' }}';

async function loadMoreThemen() {
  if (isLoading) return;
  isLoading = true;

  const loadingIndicator = document.getElementById('loadingIndicator');
  const tbody = document.querySelector('table tbody');
  
  loadingIndicator.style.display = 'block';

  try {
    const url = new URL('/schichtbuch/themaliste/load_more', window.location.origin);
    url.searchParams.append('offset', currentOffset);
    url.searchParams.append('limit', 50);
    if (statusFilters && statusFilters.length) {
      statusFilters.forEach(s => url.searchParams.append('status', s));
    }
    if (bereichFilter) url.searchParams.append('bereich', bereichFilter);
    if (gewerkFilter) url.searchParams.append('gewerk', gewerkFilter);
    if (qFilter) url.searchParams.append('q', qFilter);

    const response = await fetch(url);
    const data = await response.json();

    if (data.themen && data.themen.length > 0) {
      data.themen.forEach(thema => {
        // Themen-Zeile
        const themaRow = document.createElement('tr');
        themaRow.className = 'thema-row';
        themaRow.style.color = thema.Farbe || 'inherit';
        themaRow.innerHTML = `
          <td>
            <a href="/thema/${thema.ID}?next=${encodeURIComponent(window.location.pathname + window.location.search)}" class="text-decoration-none">
              #${thema.ID}
            </a>
          </td>
          <td>${thema.Bereich} ‚Äì ${thema.Gewerk}</td>
          <td>
            <span class="badge rounded-pill" style="background-color: ${thema.Farbe || '#ccc'}; color: #fff;">
              ${thema.Status}
            </span>
          </td>
          <td class="text-center">
            <div class="d-flex flex-column flex-sm-row justify-content-center gap-1">
              <button class="btn btn-sm btn-outline-success" type="button"
                      data-bs-toggle="collapse" data-bs-target="#newBemerkung${thema.ID}" aria-expanded="false"
                      title="Neue Bemerkung">
                <i class="bi bi-plus-lg"></i>
              </button>
              <button class="btn btn-sm btn-outline-secondary" type="button"
                      onclick="openDateienModal(${thema.ID})"
                      title="Dateien & Bilder">
                <i class="bi bi-paperclip"></i>
              </button>
              <button class="btn btn-sm btn-outline-info" type="button"
                      onclick="openSichtbarkeitModal(${thema.ID})"
                      title="Sichtbarkeit bearbeiten">
                <i class="bi bi-eye"></i>
              </button>
              <form action="/schichtbuch/delete_thema/${thema.ID}" method="post" class="m-0 p-0">
                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Thema wirklich l√∂schen?');"
                        title="Thema l√∂schen">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </div>
          </td>
        `;

        // Bemerkungen-Zeile
        const bemerkungRow = document.createElement('tr');
        bemerkungRow.className = 'bemerkung-row';
        const bemerkungen = data.bemerk_dict[thema.ID] || [];
        if (bemerkungen.length > 0) {
          let bemerkHtml = '<ul class="list-group list-group-flush bemerkung-list">';
          bemerkungen.forEach(b => {
            bemerkHtml += `
              <li class="list-group-item bg-white">
                <div class="d-flex">
                  <small class="text-muted">
                    ${b.Datum} - <strong>${b.Vorname} ${b.Nachname}</strong>
                    ${b.Taetigkeit ? `<span class="text-secondary">(${b.Taetigkeit})</span>` : ''}
                  </small>
                </div>
                <div>${b.Bemerkung}</div>
              </li>
            `;
          });
          bemerkHtml += '</ul>';
          bemerkungRow.innerHTML = `<td colspan="5">${bemerkHtml}</td>`;
        } else {
          bemerkungRow.innerHTML = '<td colspan="5"><p class="text-muted fst-italic mb-0">Keine Bemerkungen vorhanden.</p></td>';
        }

        // Collapse-Zeile
        const collapseRow = document.createElement('tr');
        collapseRow.className = 'collapse collapse-row';
        collapseRow.id = `newBemerkung${thema.ID}`;
        collapseRow.innerHTML = `
          <td colspan="5">
            <form action="/schichtbuch/themaliste/add" method="post" class="mt-2">
              <input type="hidden" name="thema_id" value="${thema.ID}">
              <input type="hidden" name="next" value="${window.location.pathname}${window.location.search}">
              
              <div class="mb-1">
                <label for="status${thema.ID}" class="form-label fw-bold">Status √§ndern:</label>
                <select name="status_id" id="status${thema.ID}" class="form-select">
                  <option value="">-- unver√§ndert --</option>
                  {% for s in status_liste %}
                    <option value="{{ s.ID }}">{{ s.Bezeichnung }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="mb-1">
                <label for="taetigkeit${thema.ID}" class="form-label fw-bold">T√§tigkeit:</label>
                <select name="taetigkeit_id" id="taetigkeit${thema.ID}" class="form-select" required>
                  <option value="">-- T√§tigkeit w√§hlen --</option>
                  {% for t in taetigkeiten_liste %}
                    <option value="{{ t.ID }}">{{ t.Bezeichnung }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="mb-1">
                <label for="bemerkung${thema.ID}" class="form-label fw-bold">Neue Bemerkung:</label>
                <textarea name="bemerkung" id="bemerkung${thema.ID}" class="form-control" rows="3" placeholder="Neue Bemerkung eingeben..." required></textarea>
              </div>

              <div class="mb-0">
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-save"></i> Speichern
                </button>
              </div>
            </form>
          </td>
        `;

        tbody.appendChild(themaRow);
        tbody.appendChild(bemerkungRow);
        tbody.appendChild(collapseRow);
      });

      currentOffset += data.themen.length;
    } else {
      loadingIndicator.innerHTML = '<p class="text-muted">Alle Eintr√§ge geladen.</p>';
    }
  } catch (error) {
    console.error('Fehler beim Laden:', error);
    loadingIndicator.innerHTML = '<p class="text-danger">Fehler beim Laden weiterer Eintr√§ge.</p>';
  } finally {
    isLoading = false;
    loadingIndicator.style.display = 'none';
  }
}

// Scroll-Listener
window.addEventListener('scroll', () => {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  const windowHeight = window.innerHeight;
  const documentHeight = document.documentElement.scrollHeight;

  // Wenn der Benutzer 200px vor dem Ende ist, lade mehr
  if (scrollTop + windowHeight >= documentHeight - 200) {
    loadMoreThemen();
  }
});

// Initial pr√ºfen, ob bereits mehr geladen werden soll
if (currentOffset < 50) {
  document.getElementById('loadingIndicator').innerHTML = '<p class="text-muted">Alle Eintr√§ge geladen.</p>';
}

// Dynamische Gewerke nach Bereich
const bereichSelect = document.getElementById('filterBereich');
const gewerkSelect = document.getElementById('filterGewerk');
if (bereichSelect && gewerkSelect) {
  bereichSelect.addEventListener('change', async () => {
    const val = bereichSelect.value;
    const url = new URL('/schichtbuch/api/gewerke', window.location.origin);
    if (val) url.searchParams.append('bereich', val);
    const res = await fetch(url);
    const data = await res.json();
    const current = gewerkSelect.value;
    gewerkSelect.innerHTML = '<option value="">-- alle Gewerke --</option>';
    (data.gewerke || []).forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.Bezeichnung;
      opt.textContent = g.Bezeichnung;
      if (current && current === g.Bezeichnung) opt.selected = true;
      gewerkSelect.appendChild(opt);
    });
  });
}

// ========== Sichtbarkeits-Modal ==========

let currentSichtbarkeitThemaId = null;

async function openSichtbarkeitModal(themaId) {
  currentSichtbarkeitThemaId = themaId;
  const modal = new bootstrap.Modal(document.getElementById('sichtbarkeitModal'));
  const container = document.getElementById('sichtbarkeitCheckboxen');
  
  // Loading-Spinner anzeigen
  container.innerHTML = `
    <div class="text-center">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">L√§dt...</span>
      </div>
    </div>
  `;
  
  modal.show();
  
  try {
    const response = await fetch(`/schichtbuch/thema/${themaId}/sichtbarkeit`);
    const data = await response.json();
    
    if (!data.success) {
      container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Daten.</div>';
      return;
    }
    
    // Checkboxen generieren
    let html = '';
    
    // Ausw√§hlbare Abteilungen (eigene + untergeordnete)
    data.auswaehlbare.forEach(gruppe => {
      html += '<div class="mb-3">';
      
      // Parent-Abteilung
      const isChecked = gruppe.parent.is_current ? 'checked' : '';
      const label = gruppe.parent.is_primaer ? '(Prim√§rabteilung)' : '(zus√§tzliche Abteilung)';
      
      html += `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" 
                 name="sichtbare_abteilungen" 
                 value="${gruppe.parent.id}" 
                 id="modal_abt_${gruppe.parent.id}" 
                 ${isChecked}>
          <label class="form-check-label fw-bold" for="modal_abt_${gruppe.parent.id}">
            ${gruppe.parent.name}
          </label>
          <small class="text-muted">${label}</small>
        </div>
      `;
      
      // Untergeordnete Abteilungen
      if (gruppe.children && gruppe.children.length > 0) {
        html += '<div class="ms-4 mt-2">';
        gruppe.children.forEach(child => {
          const childChecked = child.is_current ? 'checked' : '';
          html += `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" 
                     name="sichtbare_abteilungen" 
                     value="${child.id}" 
                     id="modal_abt_${child.id}" 
                     ${childChecked}>
              <label class="form-check-label" for="modal_abt_${child.id}">
                ‚Ü≥ ${child.name}
              </label>
            </div>
          `;
        });
        html += '</div>';
      }
      
      html += '</div>';
    });
    
    // Zus√§tzliche aktuell zugewiesene Abteilungen (nicht in eigenen)
    if (data.zusaetzliche && data.zusaetzliche.length > 0) {
      html += '<hr class="my-3">';
      html += '<div class="alert alert-info small mb-3">';
      html += '<strong>Weitere zugewiesene Abteilungen:</strong><br>';
      html += 'Diese Abteilungen sind aktuell zugewiesen, k√∂nnen aber nicht bearbeitet werden.';
      html += '</div>';
      
      data.zusaetzliche.forEach(abt => {
        const parentLabel = abt.parent ? ` (${abt.parent.name})` : '';
        html += `
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" 
                   name="sichtbare_abteilungen" 
                   value="${abt.id}" 
                   id="modal_abt_${abt.id}" 
                   checked disabled>
            <label class="form-check-label text-muted" for="modal_abt_${abt.id}">
              ${abt.name}${parentLabel}
            </label>
            <small class="text-muted">(gesch√ºtzt)</small>
          </div>
        `;
      });
    }
    
    container.innerHTML = html;
    
  } catch (error) {
    console.error('Fehler beim Laden der Sichtbarkeiten:', error);
    container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Daten.</div>';
  }
}

async function saveSichtbarkeit() {
  const form = document.getElementById('sichtbarkeitForm');
  const themaId = currentSichtbarkeitThemaId;
  const saveButton = document.querySelector('#sichtbarkeitModal .btn-primary');
  
  // Alle Checkboxen sammeln (auch disabled!)
  const allCheckboxes = form.querySelectorAll('input[name="sichtbare_abteilungen"]');
  const selectedIds = [];
  
  allCheckboxes.forEach(checkbox => {
    if (checkbox.checked) {
      selectedIds.push(checkbox.value);
    }
  });
  
  // Validierung: Mindestens eine Abteilung muss ausgew√§hlt sein
  if (selectedIds.length === 0) {
    alert('Bitte w√§hlen Sie mindestens eine Abteilung aus.');
    return;
  }
  
  // FormData manuell erstellen, da disabled Felder nicht automatisch mitgesendet werden
  const formData = new FormData();
  selectedIds.forEach(id => {
    formData.append('sichtbare_abteilungen', id);
  });
  
  // Button deaktivieren
  saveButton.disabled = true;
  saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Speichert...';
  
  try {
    const response = await fetch(`/schichtbuch/thema/${themaId}/sichtbarkeit`, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Modal schlie√üen
      const modal = bootstrap.Modal.getInstance(document.getElementById('sichtbarkeitModal'));
      modal.hide();
      
      // Erfolgsbenachrichtigung
      alert('Sichtbarkeit erfolgreich aktualisiert!');
    } else {
      alert('Fehler: ' + data.message);
    }
  } catch (error) {
    console.error('Fehler beim Speichern:', error);
    alert('Fehler beim Speichern der Sichtbarkeit.');
  } finally {
    // Button wieder aktivieren
    saveButton.disabled = false;
    saveButton.innerHTML = '<i class="bi bi-check-lg"></i> Speichern';
  }
}
</script>

<!-- Modal: Dateien & Bilder anzeigen -->
<div class="modal fade" id="dateienModal" tabindex="-1" aria-labelledby="dateienModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="dateienModalLabel">
          <i class="bi bi-paperclip"></i> Dateien & Bilder - Thema #<span id="dateienThemaId"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schlie√üen"></button>
      </div>
      <div class="modal-body">
        <!-- Upload-Bereich -->
        <div class="card mb-3 bg-light">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-cloud-upload"></i> Datei hochladen</h6>
            <form id="uploadFormListe" enctype="multipart/form-data">
              <div class="mb-2">
                <input type="file" class="form-control" id="fileInputListe" name="file" 
                       accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" 
                       capture="environment">
                <div class="form-text">
                  Max. 16 MB - Erlaubt: Bilder, PDF, Word, Excel, Text
                </div>
              </div>
              <button type="submit" class="btn btn-primary btn-sm" id="uploadButtonListe">
                <i class="bi bi-upload"></i> Hochladen
              </button>
            </form>
            <div id="uploadProgressListe" class="mt-2 d-none">
              <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
              </div>
            </div>
            <div id="uploadMessageListe" class="mt-2"></div>
          </div>
        </div>
        
        <!-- Dateiliste -->
        <h6><i class="bi bi-folder"></i> Gespeicherte Dateien</h6>
        <div id="dateienListe">
          <div class="text-center">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">L√§dt...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-lg"></i> Schlie√üen
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Sichtbarkeit bearbeiten -->
<div class="modal fade" id="sichtbarkeitModal" tabindex="-1" aria-labelledby="sichtbarkeitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="sichtbarkeitModalLabel">
          <i class="bi bi-eye"></i> Sichtbarkeit bearbeiten
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schlie√üen"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small">
          W√§hlen Sie aus, welche Abteilungen dieses Thema sehen d√ºrfen.
        </p>
        
        <form id="sichtbarkeitForm">
          <input type="hidden" id="sichtbarkeit_thema_id" name="thema_id">
          <div id="sichtbarkeitCheckboxen">
            <!-- Wird dynamisch mit JavaScript gef√ºllt -->
            <div class="text-center">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">L√§dt...</span>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-lg"></i> <span class="d-none d-sm-inline">Abbrechen</span>
        </button>
        <button type="button" class="btn btn-primary" onclick="saveSichtbarkeit()">
          <i class="bi bi-check-lg"></i> <span class="d-none d-sm-inline">Speichern</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Dateien Modal JavaScript -->
<script>
let currentThemaIdListe = null;

async function loadDateienListeInListe(themaId) {
  const dateienListe = document.getElementById('dateienListe');
  dateienListe.innerHTML = `
    <div class="text-center">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">L√§dt...</span>
      </div>
    </div>
  `;
  
  try {
    const response = await fetch(`/schichtbuch/thema/${themaId}/dateien`);
    const data = await response.json();
  
  if (!data.success) {
    dateienListe.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Dateien.</div>';
    return;
  }
  
  if (data.dateien.length === 0) {
    dateienListe.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> Keine Dateien vorhanden.</div>';
    return;
  }
  
  // Dateien anzeigen
  let html = '<div class="row g-3">';
  
  data.dateien.forEach(datei => {
    if (datei.type === 'image') {
      // Bilder als Vorschau anzeigen
      html += `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <img src="${datei.url}" class="card-img-top" alt="${datei.name}" style="object-fit: cover; height: 200px; cursor: pointer;" onclick="window.open('${datei.url}', '_blank')">
            <div class="card-body p-2">
              <p class="card-text small mb-1">
                <strong>${datei.name}</strong>
              </p>
              <p class="card-text small text-muted mb-0">${datei.size}</p>
            </div>
            <div class="card-footer p-2">
              <a href="${datei.url}" target="_blank" class="btn btn-sm btn-primary w-100">
                <i class="bi bi-download"></i> Herunterladen
              </a>
            </div>
          </div>
        </div>
      `;
    } else if (datei.type === 'pdf') {
      // PDF-Dateien
      html += `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="card-body text-center d-flex flex-column justify-content-center" style="height: 200px; background-color: #f8f9fa;">
              <i class="bi bi-file-pdf" style="font-size: 4rem; color: #dc3545;"></i>
              <p class="mt-2 mb-0"><strong>${datei.name}</strong></p>
              <p class="text-muted small">${datei.size}</p>
            </div>
            <div class="card-footer p-2">
              <a href="${datei.url}" target="_blank" class="btn btn-sm btn-primary w-100">
                <i class="bi bi-eye"></i> √ñffnen
              </a>
            </div>
          </div>
        </div>
      `;
    } else {
      // Andere Dokumente
      html += `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="card-body text-center d-flex flex-column justify-content-center" style="height: 200px; background-color: #f8f9fa;">
              <i class="bi bi-file-earmark-text" style="font-size: 4rem; color: #0d6efd;"></i>
              <p class="mt-2 mb-0"><strong>${datei.name}</strong></p>
              <p class="text-muted small">${datei.size}</p>
            </div>
            <div class="card-footer p-2">
              <a href="${datei.url}" target="_blank" class="btn btn-sm btn-primary w-100">
                <i class="bi bi-download"></i> Herunterladen
              </a>
            </div>
          </div>
        </div>
      `;
    }
  });
  
  html += '</div>';
  dateienListe.innerHTML = html;
  
  } catch (error) {
    console.error('Fehler beim Laden der Dateien:', error);
    dateienListe.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Dateien.</div>';
  }
}

window.openDateienModal = function(themaId) {
  currentThemaIdListe = themaId;
  
  // Thema-ID im Modal anzeigen
  document.getElementById('dateienThemaId').textContent = themaId;
  
  // Modal √∂ffnen
  const modalElement = document.getElementById('dateienModal');
  const modal = new bootstrap.Modal(modalElement);
  modal.show();
  
  // Upload-Form zur√ºcksetzen
  document.getElementById('uploadFormListe').reset();
  document.getElementById('uploadMessageListe').innerHTML = '';
  document.getElementById('uploadProgressListe').classList.add('d-none');
  
  // Dateien laden
  loadDateienListeInListe(themaId);
};

// Upload-Formular Handler
document.addEventListener('DOMContentLoaded', function() {
  const uploadFormListe = document.getElementById('uploadFormListe');
  if (uploadFormListe) {
    uploadFormListe.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const fileInput = document.getElementById('fileInputListe');
      const uploadButton = document.getElementById('uploadButtonListe');
      const uploadProgress = document.getElementById('uploadProgressListe');
      const uploadMessage = document.getElementById('uploadMessageListe');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        uploadMessage.innerHTML = '<div class="alert alert-warning alert-dismissible fade show" role="alert">Bitte w√§hlen Sie eine Datei aus.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
        return;
      }
      
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      
      // Button deaktivieren und Progress anzeigen
      uploadButton.disabled = true;
      uploadProgress.classList.remove('d-none');
      uploadMessage.innerHTML = '';
      
      try {
        const response = await fetch(`/schichtbuch/thema/${currentThemaIdListe}/upload`, {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          uploadMessage.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">${data.message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
          uploadFormListe.reset();
          
          // Dateiliste neu laden
          setTimeout(() => {
            loadDateienListeInListe(currentThemaIdListe);
          }, 500);
        } else {
          uploadMessage.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">${data.message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
        }
      } catch (error) {
        console.error('Upload-Fehler:', error);
        uploadMessage.innerHTML = '<div class="alert alert-danger alert-dismissible fade show" role="alert">Fehler beim Hochladen der Datei.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
      } finally {
        uploadButton.disabled = false;
        uploadProgress.classList.add('d-none');
      }
    });
  }
});
</script>

{% endblock %}
