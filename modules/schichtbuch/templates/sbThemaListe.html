
{% extends "layout/base.html" %}

{% block styles %}
  <style>
  /* 1) Themenzeile: alle TDs dieser TR immer hellgrau */
  .table tbody tr.thema-row > td {
    background-color: #e9ecef !important;
  }

  /* 2) Bemerkungszeile & Collapse-Zeile: TDs immer wei√ü */
  .table tbody tr.bemerkung-row > td,
  .table tbody tr.collapse-row > td {
    background-color: #ffffff !important;
  }

  /* 3) Falls List-Group-Items verwendet werden, sicherstellen, dass sie wei√ü sind */
  .table .list-group-item {
    background-color: #ffffff !important;
    border-left: 3px solid #dee2e6; /* optional: dezenter linker Balken */
  }

  /* 4) Verhindern, dass .table-striped wieder einf√§rbt (falls irgendwo noch gesetzt) */
  .table.table-striped tbody tr:nth-of-type(odd) > td {
    background-color: transparent !important;
  }

  /* 5) Optional: etwas Abstand / Padding f√ºr die Bemerkungsbox */
  .table tbody tr.bemerkung-row td .list-group {
    margin: 0;
    padding: 0;
  }

  /* Themenzeilen grau */
  .thema-row {
    background-color: #f2f2f2 !important;
  }

  /* Bemerkungen immer wei√ü */
  .bemerkung-row,
  .collapse-row {
    background-color: #ffffff !important;
  }

  /* Dezent abgesetzte Bemerkungen */
  .bemerkung-list li {
    border-left: 3px solid #dee2e6;
    margin-bottom: 4px;
  }

  /* Hover-Effekt nur f√ºr Themen-Zeilen, nicht f√ºr Bemerkungen */
  .table tbody tr.thema-row:hover > td {
    background-color: #dee2e6 !important;
  }

  /* Bemerkungs- und Collapse-Zeilen sollen niemals einen Hover-Effekt haben */
  .table tbody tr.bemerkung-row:hover,
  .table tbody tr.collapse-row:hover,
  .table tbody tr.bemerkung-row:hover > td,
  .table tbody tr.collapse-row:hover > td {
    background-color: #ffffff !important;
  }

  /* Alle inneren Elemente in Bemerkungszeilen sollen auch bei Hover wei√ü bleiben */
  .table tbody tr.bemerkung-row:hover td *:not(.btn),
  .table tbody tr.collapse-row:hover td *:not(.btn) {
    background-color: transparent !important;
  }

  /* Buttons sollen ihre Bootstrap-Farben behalten */
  .table tbody tr.bemerkung-row:hover td .btn-success,
  .table tbody tr.collapse-row:hover td .btn-success {
    background-color: #198754 !important;
    border-color: #198754 !important;
  }
  .table tbody tr.bemerkung-row:hover td .btn-success:hover,
  .table tbody tr.collapse-row:hover td .btn-success:hover {
    background-color: #157347 !important;
    border-color: #146c43 !important;
  }

  .table tbody tr.bemerkung-row:hover .list-group-item,
  .table tbody tr.bemerkung-row:hover .list-group-item:hover {
    background-color: #ffffff !important;
  }

  /* Action-Buttons in kleiner Ansicht - alle gleich breit */
  @media (max-width: 575.98px) {
    .d-flex.flex-column > button,
    .d-flex.flex-column > form {
      width: 100%;
    }
    .d-flex.flex-column > form > button {
      width: 100%;
    }
  }

  /* Mobile Card-Styles */
  @media (max-width: 767.98px) {
    .thema-card-mobile {
      margin-bottom: 1rem;
    }

    .thema-card-clickable {
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .thema-card-clickable:active {
      transform: scale(0.98);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .thema-card-mobile .card-header {
      padding: 0.75rem 1rem;
      font-size: 1rem;
    }

    .thema-card-mobile .card-body {
      padding: 1rem;
    }

    .thema-card-mobile .card-title {
      font-size: 1rem;
      line-height: 1.4;
      word-break: break-word;
    }

    .thema-card-mobile .card-footer {
      padding: 0.75rem;
    }

    .thema-card-mobile .btn {
      min-height: 44px; /* Touch-Target Mindestgr√∂√üe */
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
    }

    .bemerkung-preview {
      font-size: 0.875rem;
      line-height: 1.5;
    }

    .bemerkung-preview .text-truncate {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Bemerkungen innerhalb der Card */
    .thema-card-mobile .card-body.border-top {
      padding-top: 0.75rem;
      margin-top: 0;
    }

    .thema-card-mobile .bemerkung-list {
      margin-top: 0.5rem;
    }

    .thema-card-mobile .bemerkung-list .list-group-item {
      padding-left: 0;
      padding-right: 0;
      border-left: none;
      border-right: none;
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }

    .thema-card-mobile .bemerkung-list .list-group-item:first-child {
      padding-top: 0;
    }

    .thema-card-mobile .bemerkung-list .list-group-item:last-child {
      padding-bottom: 0;
      border-bottom: none;
    }

    /* Filter-Optimierungen f√ºr Mobile */
    #filterCollapse {
      /* Filter standardm√§√üig eingeklappt auf Mobile */
    }

    #filterCollapse .form-select,
    #filterCollapse .form-control {
      min-height: 44px; /* Gr√∂√üere Touch-Targets */
      font-size: 1rem; /* Verhindert Zoom auf iOS */
    }

    #filterCollapse .btn {
      min-height: 44px;
      width: 100%;
      margin-bottom: 0.5rem;
    }

    #filterCollapse .btn:last-child {
      margin-bottom: 0;
    }

  }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">üìã Themenliste</h1>

<div class="mb-3">
    <a href="{{ url_for('schichtbuch.themaneu') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Neues Thema
    </a>
</div>

<!-- üîπ Filter (einklappbar) -->
<div class="card mb-4 shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
    <strong>Filter</strong>
    <span class="btn btn-sm btn-outline-primary">Anzeigen / Ausblenden</span>
  </div>
  <div class="collapse" id="filterCollapse">
    <div class="card-body">
      <form method="get" id="filterForm">
        <!-- Zeile 1: Bereich + Gewerk -->
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label">Bereich</label>
            <select name="bereich" id="filterBereich" class="form-select">
              <option value="">-- Bereich w√§hlen --</option>
              {% for b in bereich_liste %}
                <option value="{{ b.Bezeichnung }}" {% if b.Bezeichnung == bereich_filter %}selected{% endif %}>{{ b.Bezeichnung }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Gewerk</label>
            <select name="gewerk" id="filterGewerk" class="form-select">
              <option value="">-- alle Gewerke --</option>
              {% for g in gewerke_liste %}
                <option value="{{ g.Bezeichnung }}" {% if gewerk_filter == g.Bezeichnung %}selected{% endif %}>{{ g.Bezeichnung }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Zeile 2: Status (Mehrfach) -->
        <div class="row g-3 mt-1">
          <div class="col-12">
            <label class="form-label"><strong>Status</strong> (mehrere w√§hlbar)</label>
            <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa;">
              {% for s in status_liste %}
                <div class="form-check">
                  <input class="form-check-input status-filter-cb" type="checkbox" name="status" value="{{ s.Bezeichnung }}" 
                         id="statusCheck{{ loop.index }}" 
                         {% if status_filter_list and (s.Bezeichnung in status_filter_list) %}checked{% endif %}>
                  <label class="form-check-label" for="statusCheck{{ loop.index }}">
                    {{ s.Bezeichnung }}
                  </label>
                </div>
              {% endfor %}
            </div>
            <div class="mt-2">
              <button type="button" class="btn btn-sm btn-outline-secondary" id="btnAlleNichtErledigt" title="Alle Status au√üer ‚ÄûErledigt‚Äú ausw√§hlen">
                <i class="bi bi-check2-square"></i> Alle nicht erledigten ausw√§hlen
              </button>
            </div>
          </div>
        </div>

        <!-- Zeile 3: Suchtext -->
        <div class="row g-3 mt-1">
          <div class="col-12">
            <label class="form-label">Text in Bemerkungen</label>
            <input type="text" name="q" id="filterQ" value="{{ q_filter or '' }}" class="form-control" placeholder="z. B. Pumpe, Fehlercode ..." />
          </div>
        </div>

        <!-- Zeile 4: Buttons -->
        <div class="row g-3 mt-2">
          <div class="col-12">
            <!-- Desktop: Buttons nebeneinander -->
            <div class="d-none d-md-flex">
              <button type="submit" class="btn btn-primary me-2">Filtern</button>
              <a href="{{ url_for('schichtbuch.themaliste') }}" class="btn btn-secondary">Alle anzeigen</a>
            </div>
            <!-- Mobile: Buttons untereinander -->
            <div class="d-md-none">
              <button type="submit" class="btn btn-primary w-100 mb-2">Filtern</button>
              <a href="{{ url_for('schichtbuch.themaliste') }}" class="btn btn-secondary w-100">Alle anzeigen</a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Themen-Liste -->
<div class="card shadow-sm">
    <div class="card-body">
        {% if themen %}
        <!-- Desktop: Tabelle (ab md-Breakpoint) -->
        <div class="d-none d-md-block">
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Bereich ‚Äì Gewerk</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
        {% for thema in themen %}
    <!-- üî∏ Themen-Zeile -->
    <tr class="thema-row" style="color: {{ thema.Farbe or 'inherit' }}; cursor: pointer;" onclick="window.location.href='{{ url_for('schichtbuch.thema_detail', thema_id=thema.ID, next=request.full_path) }}'">
      <td>
        <a href="{{ url_for('schichtbuch.thema_detail', thema_id=thema.ID, next=request.full_path) }}" class="text-decoration-none" onclick="event.stopPropagation();">
          #{{ thema.ID }}
        </a>
      </td>
      <td>{{ thema.Bereich }} ‚Äì {{ thema.Gewerk }}</td>
      <td>
        <span class="badge rounded-pill" style="background-color: {{ thema.Farbe|default('#ccc')|trim }}; color: #fff;">
          {{ thema.Status }}
        </span>
      </td>
      <td class="text-center" onclick="event.stopPropagation();">
        <div class="d-flex flex-column flex-sm-row justify-content-center gap-1">
          <!-- üî∏ Neue Bemerkung Button -->
          <button class="btn btn-sm btn-outline-success" type="button"
                  data-bs-toggle="collapse" data-bs-target="#newBemerkung{{ thema.ID }}" aria-expanded="false"
                  title="Neue Bemerkung">
            <i class="bi bi-plus-lg"></i>
          </button>
          
          <!-- üî∏ Dateien anzeigen Button -->
          <button class="btn btn-sm btn-outline-secondary" type="button"
                  onclick="openDateienModal({{ thema.ID }})"
                  title="Dateien & Bilder">
            <i class="bi bi-paperclip"></i>
          </button>
          
          <!-- üî∏ L√∂schen Button -->
          <form action="{{ url_for('schichtbuch.delete_thema', thema_id=thema.ID) }}" method="post" class="m-0 p-0">
            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Thema wirklich l√∂schen?');"
                    title="Thema l√∂schen">
                <i class="bi bi-trash"></i>
            </button>
          </form>
        </div>
      </td>
    </tr>

    <!-- üîπ Bemerkungen -->
    <tr class="bemerkung-row">
      <td colspan="4">
        {% if bemerk_dict.get(thema.ID) %}
          <ul class="list-group list-group-flush bemerkung-list">
            {% for b in bemerk_dict[thema.ID] %}
            <li class="list-group-item bg-white">
              <div class="d-flex">
                <small class="text-muted">
                  {{ b.Datum }} - <strong>{{ b.Vorname }} {{ b.Nachname }}</strong>
                  {% if b.Taetigkeit %}
                    <span class="text-secondary">({{ b.Taetigkeit }})</span>
                  {% endif %}
                </small>
              </div>
              <div>{{ b.Bemerkung }}</div>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted fst-italic mb-0">Keine Bemerkungen vorhanden.</p>
        {% endif %}
      </td>
    </tr>

    <!-- üî∏ Eingeklappter Bereich -->
    <tr class="collapse collapse-row" id="newBemerkung{{ thema.ID }}">
      <td colspan="4">
        <form action="{{ url_for('schichtbuch.add_bemerkung') }}" method="post" class="mt-2">
          <input type="hidden" name="thema_id" value="{{ thema.ID }}">
          <input type="hidden" name="next" value="{{ request.full_path }}">
          
          <!-- üî∏ Status -->
          <div class="mb-1">
            <label for="status{{ thema.ID }}" class="form-label fw-bold">Status √§ndern:</label>
            <select name="status_id" id="status{{ thema.ID }}" class="form-select">
              <option value="">-- unver√§ndert --</option>
              {% for s in status_liste %}
                <option value="{{ s.ID }}" {% if s.Bezeichnung == thema.Status %}selected{% endif %}>
                  {{ s.Bezeichnung }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- üî∏ T√§tigkeit -->
          <div class="mb-1">
            <label for="taetigkeit{{ thema.ID }}" class="form-label fw-bold">T√§tigkeit:</label>
            <select name="taetigkeit_id" id="taetigkeit{{ thema.ID }}" class="form-select" required>
              <option value="">-- T√§tigkeit w√§hlen --</option>
              {% for t in taetigkeiten_liste %}
                <option value="{{ t.ID }}">{{ t.Bezeichnung }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- üî∏ Bemerkung -->
          <div class="mb-1">
            <label for="bemerkung{{ thema.ID }}" class="form-label fw-bold">Neue Bemerkung:</label>
            <textarea
              name="bemerkung"
              id="bemerkung{{ thema.ID }}"
              class="form-control"
              rows="3"
              placeholder="Neue Bemerkung eingeben..."
              required
            ></textarea>
          </div>

          <!-- üî∏ Speichern -->
          <div class="mb-0">
            <button type="submit" class="btn btn-success">
              <i class="bi bi-save"></i> Speichern
            </button>
          </div>
        </form>
      </td>
    </tr>
        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mobile: Cards (nur auf sm und kleiner) -->
        <div class="d-md-none">
            <div id="themenCardsContainer">
                {% for thema in themen %}
                <div class="thema-card-mobile mb-3" data-thema-id="{{ thema.ID }}" style="color: {{ thema.Farbe or 'inherit' }};">
                    <div class="card shadow-sm thema-card-clickable" onclick="window.location.href='{{ url_for('schichtbuch.thema_detail', thema_id=thema.ID, next=request.full_path) }}'">
                        <!-- Card Header: ID + Status -->
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <a href="{{ url_for('schichtbuch.thema_detail', thema_id=thema.ID, next=request.full_path) }}" class="text-decoration-none fw-bold" onclick="event.stopPropagation();">
                                #{{ thema.ID }}
                            </a>
                            <span class="badge rounded-pill" style="background-color: {{ thema.Farbe|default('#ccc')|trim }}; color: #fff;">
                                {{ thema.Status }}
                            </span>
                        </div>
                        
                        <!-- Card Body: Bereich ‚Äì Gewerk + Alle Bemerkungen -->
                        <div class="card-body">
                            <h6 class="card-title mb-2 fw-bold">{{ thema.Bereich }} ‚Äì {{ thema.Gewerk }}</h6>
                            
                            <!-- Alle Bemerkungen -->
                            {% if bemerk_dict.get(thema.ID) %}
                                <ul class="list-group list-group-flush bemerkung-list mb-3">
                                    {% for b in bemerk_dict[thema.ID] %}
                                    <li class="list-group-item bg-white px-0">
                                        <div class="d-flex">
                                            <small class="text-muted">
                                                {{ b.Datum }} - <strong>{{ b.Vorname }} {{ b.Nachname }}</strong>
                                                {% if b.Taetigkeit %}
                                                    <span class="text-secondary">({{ b.Taetigkeit }})</span>
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="mt-1">{{ b.Bemerkung }}</div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted fst-italic mb-3 small">Keine Bemerkungen vorhanden.</p>
                            {% endif %}
                        </div>
                        
                        <!-- Card Footer: Action-Buttons -->
                        <div class="card-footer bg-white" onclick="event.stopPropagation();">
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-sm btn-outline-success flex-fill" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#newBemerkungMobile{{ thema.ID }}" aria-expanded="false"
                                        title="Neue Bemerkung">
                                    <i class="bi bi-plus-lg"></i> <span class="d-none d-sm-inline">Bemerkung</span>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary flex-fill" type="button"
                                        onclick="openDateienModal({{ thema.ID }})"
                                        title="Dateien & Bilder">
                                    <i class="bi bi-paperclip"></i> <span class="d-none d-sm-inline">Dateien</span>
                                </button>
                                <form action="{{ url_for('schichtbuch.delete_thema', thema_id=thema.ID) }}" method="post" class="m-0 p-0 flex-fill">
                                    <button type="submit" class="btn btn-sm btn-outline-danger w-100" onclick="return confirm('Thema wirklich l√∂schen?');"
                                            title="Thema l√∂schen">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Eingeklappter Bereich f√ºr neue Bemerkung (Mobile) -->
                    <div class="collapse mt-2" id="newBemerkungMobile{{ thema.ID }}" onclick="event.stopPropagation();">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <form action="{{ url_for('schichtbuch.add_bemerkung') }}" method="post" class="mt-2" onclick="event.stopPropagation();">
                                    <input type="hidden" name="thema_id" value="{{ thema.ID }}">
                                    <input type="hidden" name="next" value="{{ request.full_path }}">
                                    
                                    <!-- Status -->
                                    <div class="mb-2">
                                        <label for="statusMobile{{ thema.ID }}" class="form-label fw-bold">Status √§ndern:</label>
                                        <select name="status_id" id="statusMobile{{ thema.ID }}" class="form-select" onclick="event.stopPropagation();">
                                            <option value="">-- unver√§ndert --</option>
                                            {% for s in status_liste %}
                                                <option value="{{ s.ID }}" {% if s.Bezeichnung == thema.Status %}selected{% endif %}>
                                                    {{ s.Bezeichnung }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- T√§tigkeit -->
                                    <div class="mb-2">
                                        <label for="taetigkeitMobile{{ thema.ID }}" class="form-label fw-bold">T√§tigkeit:</label>
                                        <select name="taetigkeit_id" id="taetigkeitMobile{{ thema.ID }}" class="form-select" required onclick="event.stopPropagation();">
                                            <option value="">-- T√§tigkeit w√§hlen --</option>
                                            {% for t in taetigkeiten_liste %}
                                                <option value="{{ t.ID }}">{{ t.Bezeichnung }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- Bemerkung -->
                                    <div class="mb-2">
                                        <label for="bemerkungMobile{{ thema.ID }}" class="form-label fw-bold">Neue Bemerkung:</label>
                                        <textarea
                                            name="bemerkung"
                                            id="bemerkungMobile{{ thema.ID }}"
                                            class="form-control"
                                            rows="3"
                                            placeholder="Neue Bemerkung eingeben..."
                                            required
                                            onclick="event.stopPropagation();"
                                            onfocus="event.stopPropagation();"
                                        ></textarea>
                                    </div>

                                    <!-- Speichern -->
                                    <div class="mb-0">
                                        <button type="submit" class="btn btn-success w-100">
                                            <i class="bi bi-save"></i> Speichern
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Keine Themen gefunden.
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="text-center my-4" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Laden...</span>
  </div>
  <p class="mt-2">Weitere Eintr√§ge werden geladen...</p>
</div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("submit", async (e) => {
  // Pr√ºfe ob es ein Formular zum Hinzuf√ºgen einer Bemerkung ist
  const form = e.target.closest("form");
  if (!form) return;
  
  const formAction = form.getAttribute("action");
  const isAddBemerkungForm = formAction && (
    formAction.includes("/schichtbuch/themaliste/add") || 
    formAction.includes("/schichtbuch/add_bemerkung")
  );
  
  if (!isAddBemerkungForm) return;
  
  e.preventDefault();
  
  const formData = new FormData(form);
  const themaId = formData.get("thema_id");
  const submitBtn = form.querySelector("button[type='submit']");
  submitBtn.disabled = true;

  try {
    const response = await fetch(form.action, {
      method: "POST",
      body: formData,
      headers: { "X-Requested-With": "XMLHttpRequest" }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();

    if (!data.success) {
      alert("Fehler beim Speichern: " + (data.message || "Unbekannter Fehler"));
      submitBtn.disabled = false;
      return;
    }

    const scrollY = window.scrollY;
    const isMobile = window.innerWidth < 768;
    
    if (isMobile) {
      // Mobile: Card-Struktur aktualisieren
      const themaCard = form.closest(".thema-card-mobile");
      if (themaCard) {
        // Bemerkungsliste finden oder erstellen
        let bemerkungsList = themaCard.querySelector(".bemerkung-list");
        const cardBody = themaCard.querySelector(".card-body");
        
        if (!bemerkungsList && cardBody) {
          // Wenn keine Bemerkungen vorhanden waren, erstelle die Liste
          const titleElement = cardBody.querySelector(".card-title");
          if (titleElement) {
            const bemerkungenContainer = document.createElement("ul");
            bemerkungenContainer.className = "list-group list-group-flush bemerkung-list mb-3";
            titleElement.insertAdjacentElement("afterend", bemerkungenContainer);
            bemerkungsList = bemerkungenContainer;
          }
        }
        
        if (bemerkungsList) {
          // Entferne "Keine Bemerkungen"-Text falls vorhanden
          const noBemerkungen = cardBody.querySelector("p.text-muted.fst-italic");
          if (noBemerkungen) {
            noBemerkungen.remove();
          }
          
          const newItem = document.createElement("li");
          newItem.className = "list-group-item bg-white px-0";
          newItem.innerHTML = `
            <div class="d-flex">
              <small class="text-muted">
                ${data.datum} - <strong>${data.vorname} ${data.nachname}</strong>
                ${data.taetigkeit ? `<span class="text-secondary">(${data.taetigkeit})</span>` : ""}
              </small>
            </div>
            <div class="mt-1">${data.bemerkung}</div>
          `;
          bemerkungsList.insertBefore(newItem, bemerkungsList.firstChild);
        }
        
        // Status-Badge aktualisieren
        if (data.neuer_status && data.neue_farbe) {
          const badge = themaCard.querySelector(".badge");
          if (badge) {
            badge.textContent = data.neuer_status;
            badge.style.backgroundColor = data.neue_farbe;
          }
        }
      }
      
      // Collapse schlie√üen
      const collapseId = `newBemerkungMobile${themaId}`;
      const collapseElement = document.getElementById(collapseId);
      if (collapseElement) {
        const collapseInstance = bootstrap.Collapse.getOrCreateInstance(collapseElement);
        collapseInstance.hide();
      }
    } else {
      // Desktop: Tabellenstruktur aktualisieren
      const collapseRow = form.closest("tr.collapse-row");
      if (collapseRow) {
        const bemerkungsRow = collapseRow.previousElementSibling;
        const themaRow = bemerkungsRow ? bemerkungsRow.previousElementSibling : null;

        let bemerkungsList = bemerkungsRow ? bemerkungsRow.querySelector(".list-group") : null;
        if (!bemerkungsList && bemerkungsRow) {
          bemerkungsList = document.createElement("ul");
          bemerkungsList.className = "list-group list-group-flush bemerkung-list";
          bemerkungsRow.querySelector("td").innerHTML = "";
          bemerkungsRow.querySelector("td").appendChild(bemerkungsList);
        }

        if (bemerkungsList) {
          const newItem = document.createElement("li");
          newItem.className = "list-group-item bg-white";
          newItem.innerHTML = `
            <div class="d-flex">
              <small class="text-muted">
                ${data.datum} ‚Äì <strong>${data.vorname} ${data.nachname}</strong>
                ${data.taetigkeit ? `<span class="text-secondary">(${data.taetigkeit})</span>` : ""}
              </small>
            </div>
            <div>${data.bemerkung}</div>
          `;
          bemerkungsList.prepend(newItem);
        }

        if (data.neuer_status && data.neue_farbe && themaRow) {
          const badge = themaRow.querySelector(".badge");
          if (badge) {
            badge.textContent = data.neuer_status;
            badge.style.backgroundColor = data.neue_farbe;
          }
        }
        
        // Collapse schlie√üen
        const collapseId = `newBemerkung${themaId}`;
        const collapseElement = document.getElementById(collapseId);
        if (collapseElement) {
          const collapseInstance = bootstrap.Collapse.getOrCreateInstance(collapseElement);
          collapseInstance.hide();
        }
      }
    }

    form.reset();
    window.scrollTo(0, scrollY);

    const toast = document.createElement("div");
    toast.className = "alert alert-success position-fixed top-0 end-0 m-3 shadow";
    toast.style.zIndex = "2000";
    toast.textContent = "Bemerkung erfolgreich gespeichert.";
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);

  } catch (err) {
    console.error("Fehler beim Speichern:", err);
    alert("Fehler beim Speichern: " + err.message);
  } finally {
    submitBtn.disabled = false;
  }
});

// Infinite Scroll
let isLoading = false;
let allLoaded = false;
let currentOffset = {{ themen|length }};
const statusFilters = {{ (status_filter_list or []) | tojson }};
let bereichFilter = '{{ bereich_filter or '' }}';
let gewerkFilter = '{{ gewerk_filter or '' }}';
let qFilter = '{{ q_filter or '' }}';
let scrollTimeout = null;

async function loadMoreThemen() {
  // Pr√ºfen ob bereits alle geladen sind oder gerade geladen wird
  if (isLoading || allLoaded) return;
  isLoading = true;

  const loadingIndicator = document.getElementById('loadingIndicator');
  const tbody = document.querySelector('table tbody');
  const cardsContainer = document.getElementById('themenCardsContainer');
  const isMobile = window.innerWidth < 768;
  
  loadingIndicator.style.display = 'block';

  try {
    const url = new URL('/schichtbuch/themaliste/load_more', window.location.origin);
    url.searchParams.append('offset', currentOffset);
    url.searchParams.append('limit', 50);
    if (statusFilters && statusFilters.length) {
      statusFilters.forEach(s => url.searchParams.append('status', s));
    }
    if (bereichFilter) url.searchParams.append('bereich', bereichFilter);
    if (gewerkFilter) url.searchParams.append('gewerk', gewerkFilter);
    if (qFilter) url.searchParams.append('q', qFilter);

    const response = await fetch(url);
    const data = await response.json();

    if (data.themen && data.themen.length > 0) {
      data.themen.forEach(thema => {
        const detailUrl = `/schichtbuch/thema/${thema.ID}?next=${encodeURIComponent(window.location.pathname + window.location.search)}`;
        const bemerkungen = data.bemerk_dict[thema.ID] || [];
        
        if (isMobile && cardsContainer) {
          // Mobile: Card erstellen
          let cardHtml = `
            <div class="thema-card-mobile mb-3" data-thema-id="${thema.ID}" style="color: ${thema.Farbe || 'inherit'};">
              <div class="card shadow-sm thema-card-clickable" onclick="window.location.href='${detailUrl}'">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <a href="${detailUrl}" class="text-decoration-none fw-bold" onclick="event.stopPropagation();">
                    #${thema.ID}
                  </a>
                  <span class="badge rounded-pill" style="background-color: ${thema.Farbe || '#ccc'}; color: #fff;">
                    ${thema.Status}
                  </span>
                </div>
                <div class="card-body">
                  <h6 class="card-title mb-2 fw-bold">${thema.Bereich} ‚Äì ${thema.Gewerk}</h6>`;
          
          // Alle Bemerkungen
          if (bemerkungen.length > 0) {
            cardHtml += `
                  <ul class="list-group list-group-flush bemerkung-list mb-3">`;
            bemerkungen.forEach(b => {
              cardHtml += `
                    <li class="list-group-item bg-white px-0">
                      <div class="d-flex">
                        <small class="text-muted">
                          ${b.Datum} - <strong>${b.Vorname} ${b.Nachname}</strong>
                          ${b.Taetigkeit ? `<span class="text-secondary">(${b.Taetigkeit})</span>` : ''}
                        </small>
                      </div>
                      <div class="mt-1">${b.Bemerkung}</div>
                    </li>`;
            });
            cardHtml += '</ul>';
          } else {
            cardHtml += `<p class="text-muted fst-italic mb-3 small">Keine Bemerkungen vorhanden.</p>`;
          }
          
          cardHtml += `
                </div>
                <div class="card-footer bg-white" onclick="event.stopPropagation();">
                  <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-sm btn-outline-success flex-fill" type="button"
                            data-bs-toggle="collapse" data-bs-target="#newBemerkungMobile${thema.ID}" aria-expanded="false"
                            title="Neue Bemerkung">
                      <i class="bi bi-plus-lg"></i> <span class="d-none d-sm-inline">Bemerkung</span>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary flex-fill" type="button"
                            onclick="openDateienModal(${thema.ID})"
                            title="Dateien & Bilder">
                      <i class="bi bi-paperclip"></i> <span class="d-none d-sm-inline">Dateien</span>
                    </button>
                    <form action="/schichtbuch/delete_thema/${thema.ID}" method="post" class="m-0 p-0 flex-fill">
                      <button type="submit" class="btn btn-sm btn-outline-danger w-100" onclick="return confirm('Thema wirklich l√∂schen?');"
                              title="Thema l√∂schen">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                </div>
              </div>`;
          
          // Collapse f√ºr neue Bemerkung
          cardHtml += `
              <div class="collapse mt-2" id="newBemerkungMobile${thema.ID}" onclick="event.stopPropagation();">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <form action="/schichtbuch/themaliste/add" method="post" class="mt-2" onclick="event.stopPropagation();">
                      <input type="hidden" name="thema_id" value="${thema.ID}">
                      <input type="hidden" name="next" value="${window.location.pathname}${window.location.search}">
                      <div class="mb-2">
                        <label for="statusMobile${thema.ID}" class="form-label fw-bold">Status √§ndern:</label>
                        <select name="status_id" id="statusMobile${thema.ID}" class="form-select" onclick="event.stopPropagation();">
                          <option value="">-- unver√§ndert --</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <label for="taetigkeitMobile${thema.ID}" class="form-label fw-bold">T√§tigkeit:</label>
                        <select name="taetigkeit_id" id="taetigkeitMobile${thema.ID}" class="form-select" required onclick="event.stopPropagation();">
                          <option value="">-- T√§tigkeit w√§hlen --</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <label for="bemerkungMobile${thema.ID}" class="form-label fw-bold">Neue Bemerkung:</label>
                        <textarea name="bemerkung" id="bemerkungMobile${thema.ID}" class="form-control" rows="3" placeholder="Neue Bemerkung eingeben..." required onclick="event.stopPropagation();" onfocus="event.stopPropagation();"></textarea>
                      </div>
                      <div class="mb-0">
                        <button type="submit" class="btn btn-success w-100">
                          <i class="bi bi-save"></i> Speichern
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>`;
          
          cardsContainer.insertAdjacentHTML('beforeend', cardHtml);
        } else if (tbody) {
          // Desktop: Tabellenzeilen erstellen
          const themaRow = document.createElement('tr');
          themaRow.className = 'thema-row';
          themaRow.style.color = thema.Farbe || 'inherit';
          themaRow.style.cursor = 'pointer';
          themaRow.onclick = () => { window.location.href = detailUrl; };
          themaRow.innerHTML = `
            <td>
              <a href="${detailUrl}" class="text-decoration-none" onclick="event.stopPropagation();">
                #${thema.ID}
              </a>
            </td>
            <td>${thema.Bereich} ‚Äì ${thema.Gewerk}</td>
            <td>
              <span class="badge rounded-pill" style="background-color: ${thema.Farbe || '#ccc'}; color: #fff;">
                ${thema.Status}
              </span>
            </td>
            <td class="text-center" onclick="event.stopPropagation();">
              <div class="d-flex flex-column flex-sm-row justify-content-center gap-1">
                <button class="btn btn-sm btn-outline-success" type="button"
                        data-bs-toggle="collapse" data-bs-target="#newBemerkung${thema.ID}" aria-expanded="false"
                        title="Neue Bemerkung">
                  <i class="bi bi-plus-lg"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" type="button"
                        onclick="openDateienModal(${thema.ID})"
                        title="Dateien & Bilder">
                  <i class="bi bi-paperclip"></i>
                </button>
                <form action="/schichtbuch/delete_thema/${thema.ID}" method="post" class="m-0 p-0">
                  <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Thema wirklich l√∂schen?');"
                          title="Thema l√∂schen">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          `;

          // Bemerkungen-Zeile
          const bemerkungRow = document.createElement('tr');
          bemerkungRow.className = 'bemerkung-row';
          if (bemerkungen.length > 0) {
            let bemerkHtml = '<ul class="list-group list-group-flush bemerkung-list">';
            bemerkungen.forEach(b => {
              bemerkHtml += `
                <li class="list-group-item bg-white">
                  <div class="d-flex">
                    <small class="text-muted">
                      ${b.Datum} - <strong>${b.Vorname} ${b.Nachname}</strong>
                      ${b.Taetigkeit ? `<span class="text-secondary">(${b.Taetigkeit})</span>` : ''}
                    </small>
                  </div>
                  <div>${b.Bemerkung}</div>
                </li>
              `;
            });
            bemerkHtml += '</ul>';
            bemerkungRow.innerHTML = `<td colspan="4">${bemerkHtml}</td>`;
          } else {
            bemerkungRow.innerHTML = '<td colspan="4"><p class="text-muted fst-italic mb-0">Keine Bemerkungen vorhanden.</p></td>';
          }

          // Collapse-Zeile
          const collapseRow = document.createElement('tr');
          collapseRow.className = 'collapse collapse-row';
          collapseRow.id = `newBemerkung${thema.ID}`;
          collapseRow.innerHTML = `
            <td colspan="4">
              <form action="/schichtbuch/themaliste/add" method="post" class="mt-2">
                <input type="hidden" name="thema_id" value="${thema.ID}">
                <input type="hidden" name="next" value="${window.location.pathname}${window.location.search}">
                
                <div class="mb-1">
                  <label for="status${thema.ID}" class="form-label fw-bold">Status √§ndern:</label>
                  <select name="status_id" id="status${thema.ID}" class="form-select">
                    <option value="">-- unver√§ndert --</option>
                    {% for s in status_liste %}
                      <option value="{{ s.ID }}">{{ s.Bezeichnung }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-1">
                  <label for="taetigkeit${thema.ID}" class="form-label fw-bold">T√§tigkeit:</label>
                  <select name="taetigkeit_id" id="taetigkeit${thema.ID}" class="form-select" required>
                    <option value="">-- T√§tigkeit w√§hlen --</option>
                    {% for t in taetigkeiten_liste %}
                      <option value="{{ t.ID }}">{{ t.Bezeichnung }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-1">
                  <label for="bemerkung${thema.ID}" class="form-label fw-bold">Neue Bemerkung:</label>
                  <textarea name="bemerkung" id="bemerkung${thema.ID}" class="form-control" rows="3" placeholder="Neue Bemerkung eingeben..." required></textarea>
                </div>

                <div class="mb-0">
                  <button type="submit" class="btn btn-success">
                    <i class="bi bi-save"></i> Speichern
                  </button>
                </div>
              </form>
            </td>
          `;

          tbody.appendChild(themaRow);
          tbody.appendChild(bemerkungRow);
          tbody.appendChild(collapseRow);
        }
      });

      currentOffset += data.themen.length;
      
      // Wenn weniger als 50 Themen geladen wurden, sind alle geladen
      if (data.themen.length < 50) {
        allLoaded = true;
        loadingIndicator.innerHTML = '<p class="text-muted">Alle Eintr√§ge geladen.</p>';
      }
    } else {
      allLoaded = true;
      loadingIndicator.innerHTML = '<p class="text-muted">Alle Eintr√§ge geladen.</p>';
    }
  } catch (error) {
    console.error('Fehler beim Laden:', error);
    loadingIndicator.innerHTML = '<p class="text-danger">Fehler beim Laden weiterer Eintr√§ge.</p>';
    // Bei Fehler nicht als "alle geladen" markieren, damit es sp√§ter nochmal versucht werden kann
  } finally {
    isLoading = false;
    loadingIndicator.style.display = 'none';
  }
}

// Scroll-Listener mit Debouncing
window.addEventListener('scroll', () => {
  // Debouncing: Warte 100ms nach dem letzten Scroll-Event
  if (scrollTimeout) {
    clearTimeout(scrollTimeout);
  }
  
  scrollTimeout = setTimeout(() => {
    // Pr√ºfen ob bereits alle geladen sind
    if (allLoaded || isLoading) return;
    
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;

    // Wenn der Benutzer 300px vor dem Ende ist, lade mehr (erh√∂ht von 200px auf 300px f√ºr besseren Puffer)
    if (scrollTop + windowHeight >= documentHeight - 300) {
      loadMoreThemen();
    }
  }, 100);
});

// Initial pr√ºfen, ob bereits mehr geladen werden soll
if (currentOffset < 50) {
  allLoaded = true;
  document.getElementById('loadingIndicator').innerHTML = '<p class="text-muted">Alle Eintr√§ge geladen.</p>';
}

// Dynamische Gewerke nach Bereich
const bereichSelect = document.getElementById('filterBereich');
const gewerkSelect = document.getElementById('filterGewerk');
if (bereichSelect && gewerkSelect) {
  bereichSelect.addEventListener('change', async () => {
    const val = bereichSelect.value;
    const url = new URL('/schichtbuch/api/gewerke', window.location.origin);
    if (val) url.searchParams.append('bereich', val);
    const res = await fetch(url);
    const data = await res.json();
    const current = gewerkSelect.value;
    gewerkSelect.innerHTML = '<option value="">-- alle Gewerke --</option>';
    (data.gewerke || []).forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.Bezeichnung;
      opt.textContent = g.Bezeichnung;
      if (current && current === g.Bezeichnung) opt.selected = true;
      gewerkSelect.appendChild(opt);
    });
  });
}

// Schnellauswahl: Alle nicht erledigten Status anw√§hlen
const btnAlleNichtErledigt = document.getElementById('btnAlleNichtErledigt');
if (btnAlleNichtErledigt) {
  btnAlleNichtErledigt.addEventListener('click', function() {
    const erledigtStatus = 'erledigt';
    document.querySelectorAll('.status-filter-cb').forEach(cb => {
      cb.checked = (cb.value !== erledigtStatus);
    });
  });
}

// ========== Sichtbarkeits-Modal ==========

let currentSichtbarkeitThemaId = null;

async function openSichtbarkeitModal(themaId) {
  currentSichtbarkeitThemaId = themaId;
  const modal = new bootstrap.Modal(document.getElementById('sichtbarkeitModal'));
  const container = document.getElementById('sichtbarkeitCheckboxen');
  
  // Loading-Spinner anzeigen
  container.innerHTML = `
    <div class="text-center">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">L√§dt...</span>
      </div>
    </div>
  `;
  
  modal.show();
  
  try {
    const response = await fetch(`/schichtbuch/thema/${themaId}/sichtbarkeit`);
    const data = await response.json();
    
    if (!data.success) {
      container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Daten.</div>';
      return;
    }
    
    // Checkboxen generieren
    let html = '';
    
    // Ausw√§hlbare Abteilungen (eigene + untergeordnete)
    data.auswaehlbare.forEach(gruppe => {
      html += '<div class="mb-3">';
      
      // Parent-Abteilung
      const isChecked = gruppe.parent.is_current ? 'checked' : '';
      const label = gruppe.parent.is_primaer ? '(Prim√§rabteilung)' : '(zus√§tzliche Abteilung)';
      
      html += `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" 
                 name="sichtbare_abteilungen" 
                 value="${gruppe.parent.id}" 
                 id="modal_abt_${gruppe.parent.id}" 
                 ${isChecked}>
          <label class="form-check-label fw-bold" for="modal_abt_${gruppe.parent.id}">
            ${gruppe.parent.name}
          </label>
          <small class="text-muted">${label}</small>
        </div>
      `;
      
      // Untergeordnete Abteilungen
      if (gruppe.children && gruppe.children.length > 0) {
        html += '<div class="ms-4 mt-2">';
        gruppe.children.forEach(child => {
          const childChecked = child.is_current ? 'checked' : '';
          html += `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" 
                     name="sichtbare_abteilungen" 
                     value="${child.id}" 
                     id="modal_abt_${child.id}" 
                     ${childChecked}>
              <label class="form-check-label" for="modal_abt_${child.id}">
                ‚Ü≥ ${child.name}
              </label>
            </div>
          `;
        });
        html += '</div>';
      }
      
      html += '</div>';
    });
    
    // Zus√§tzliche aktuell zugewiesene Abteilungen (nicht in eigenen)
    if (data.zusaetzliche && data.zusaetzliche.length > 0) {
      html += '<hr class="my-3">';
      html += '<div class="alert alert-info small mb-3">';
      html += '<strong>Weitere zugewiesene Abteilungen:</strong><br>';
      html += 'Diese Abteilungen sind aktuell zugewiesen, k√∂nnen aber nicht bearbeitet werden.';
      html += '</div>';
      
      data.zusaetzliche.forEach(abt => {
        const parentLabel = abt.parent ? ` (${abt.parent.name})` : '';
        html += `
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" 
                   name="sichtbare_abteilungen" 
                   value="${abt.id}" 
                   id="modal_abt_${abt.id}" 
                   checked disabled>
            <label class="form-check-label text-muted" for="modal_abt_${abt.id}">
              ${abt.name}${parentLabel}
            </label>
            <small class="text-muted">(gesch√ºtzt)</small>
          </div>
        `;
      });
    }
    
    container.innerHTML = html;
    
  } catch (error) {
    console.error('Fehler beim Laden der Sichtbarkeiten:', error);
    container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Daten.</div>';
  }
}

async function saveSichtbarkeit() {
  const form = document.getElementById('sichtbarkeitForm');
  const themaId = currentSichtbarkeitThemaId;
  const saveButton = document.querySelector('#sichtbarkeitModal .btn-primary');
  
  // Alle Checkboxen sammeln (auch disabled!)
  const allCheckboxes = form.querySelectorAll('input[name="sichtbare_abteilungen"]');
  const selectedIds = [];
  
  allCheckboxes.forEach(checkbox => {
    if (checkbox.checked) {
      selectedIds.push(checkbox.value);
    }
  });
  
  // Validierung: Mindestens eine Abteilung muss ausgew√§hlt sein
  if (selectedIds.length === 0) {
    alert('Bitte w√§hlen Sie mindestens eine Abteilung aus.');
    return;
  }
  
  // FormData manuell erstellen, da disabled Felder nicht automatisch mitgesendet werden
  const formData = new FormData();
  selectedIds.forEach(id => {
    formData.append('sichtbare_abteilungen', id);
  });
  
  // Button deaktivieren
  saveButton.disabled = true;
  saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Speichert...';
  
  try {
    const response = await fetch(`/schichtbuch/thema/${themaId}/sichtbarkeit`, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Modal schlie√üen
      const modal = bootstrap.Modal.getInstance(document.getElementById('sichtbarkeitModal'));
      modal.hide();
      
      // Erfolgsbenachrichtigung
      alert('Sichtbarkeit erfolgreich aktualisiert!');
    } else {
      alert('Fehler: ' + data.message);
    }
  } catch (error) {
    console.error('Fehler beim Speichern:', error);
    alert('Fehler beim Speichern der Sichtbarkeit.');
  } finally {
    // Button wieder aktivieren
    saveButton.disabled = false;
    saveButton.innerHTML = '<i class="bi bi-check-lg"></i> Speichern';
  }
}
</script>

<!-- Modal: Dateien & Bilder anzeigen -->
<div class="modal fade" id="dateienModal" tabindex="-1" aria-labelledby="dateienModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="dateienModalLabel">
          <i class="bi bi-paperclip"></i> Dateien & Bilder - Thema #<span id="dateienThemaId"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schlie√üen"></button>
      </div>
      <div class="modal-body">
        <!-- Upload-Bereich -->
        <div class="card mb-3 bg-light">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-cloud-upload"></i> Datei hochladen</h6>
            
            <!-- Tab-Auswahl -->
            <ul class="nav nav-tabs mb-3" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="sb-upload-tab" data-bs-toggle="tab" data-bs-target="#sb-upload-pane" type="button">
                  <i class="bi bi-cloud-upload"></i> Hochladen
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="sb-import-tab" data-bs-toggle="tab" data-bs-target="#sb-import-pane" type="button" onclick="ladeImportDateienSchichtbuch()">
                  <i class="bi bi-folder"></i> Aus Import-Ordner
                </button>
              </li>
            </ul>
            
            <div class="tab-content">
              <!-- Upload-Tab -->
              <div class="tab-pane fade show active" id="sb-upload-pane" role="tabpanel">
                <form id="uploadFormListe" enctype="multipart/form-data">
                  <div class="mb-2">
                    <input type="file" class="form-control" id="fileInputListe" name="files" 
                           accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" multiple>
                    <div class="form-text">
                      Max. 16 MB pro Datei - Mehrfachauswahl m√∂glich - Erlaubt: Bilder, PDF, Word, Excel, Text
                    </div>
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm" id="uploadButtonListe">
                    <i class="bi bi-upload"></i> Hochladen
                  </button>
                </form>
                <div id="uploadProgressListe" class="mt-2 d-none">
                  <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                  </div>
                </div>
                <div id="uploadMessageListe" class="mt-2"></div>
              </div>
              
              <!-- Import-Tab -->
              <div class="tab-pane fade" id="sb-import-pane" role="tabpanel">
                <div id="sb-import-dateien-liste">
                  <div class="text-center">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">L√§dt...</span>
                    </div>
                  </div>
                </div>
                <button type="button" class="btn btn-primary btn-sm mt-2" onclick="ladeImportDateienSchichtbuch()">
                  <i class="bi bi-arrow-clockwise"></i> Aktualisieren
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Dateiliste -->
        <h6><i class="bi bi-folder"></i> Gespeicherte Dateien</h6>
        <div id="dateienListe">
          <div class="text-center">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">L√§dt...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-lg"></i> Schlie√üen
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Sichtbarkeit bearbeiten -->
<div class="modal fade" id="sichtbarkeitModal" tabindex="-1" aria-labelledby="sichtbarkeitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="sichtbarkeitModalLabel">
          <i class="bi bi-eye"></i> Sichtbarkeit bearbeiten
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schlie√üen"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small">
          W√§hlen Sie aus, welche Abteilungen dieses Thema sehen d√ºrfen.
        </p>
        
        <form id="sichtbarkeitForm">
          <input type="hidden" id="sichtbarkeit_thema_id" name="thema_id">
          <div id="sichtbarkeitCheckboxen">
            <!-- Wird dynamisch mit JavaScript gef√ºllt -->
            <div class="text-center">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">L√§dt...</span>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-lg"></i> <span class="d-none d-sm-inline">Abbrechen</span>
        </button>
        <button type="button" class="btn btn-primary" onclick="saveSichtbarkeit()">
          <i class="bi bi-check-lg"></i> <span class="d-none d-sm-inline">Speichern</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Dateien Modal JavaScript -->
<script>
let currentThemaIdListe = null;

async function loadDateienListeInListe(themaId) {
  const dateienListe = document.getElementById('dateienListe');
  dateienListe.innerHTML = `
    <div class="text-center">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">L√§dt...</span>
      </div>
    </div>
  `;
  
  try {
    const response = await fetch(`/schichtbuch/thema/${themaId}/dateien`);
    const data = await response.json();
  
  if (!data.success) {
    dateienListe.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Dateien.</div>';
    return;
  }
  
  if (data.dateien.length === 0) {
    dateienListe.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> Keine Dateien vorhanden.</div>';
    return;
  }
  
  // Dateien anzeigen
  let html = '<div class="row g-3">';
  
  data.dateien.forEach(datei => {
    if (datei.type === 'image') {
      // Bilder als Vorschau anzeigen
      html += `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <img src="${datei.url}" class="card-img-top" alt="${datei.name}" style="object-fit: cover; height: 200px; cursor: pointer;" onclick="window.open('${datei.url}', '_blank')">
            <div class="card-body p-2">
              <p class="card-text small mb-1">
                <strong>${datei.name}</strong>
              </p>
              <p class="card-text small text-muted mb-0">${datei.size}</p>
            </div>
            <div class="card-footer p-2">
              <a href="${datei.url}" target="_blank" class="btn btn-sm btn-primary w-100">
                <i class="bi bi-download"></i> Herunterladen
              </a>
            </div>
          </div>
        </div>
      `;
    } else if (datei.type === 'pdf') {
      // PDF-Dateien
      html += `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="card-body text-center d-flex flex-column justify-content-center" style="height: 200px; background-color: #f8f9fa;">
              <i class="bi bi-file-pdf" style="font-size: 4rem; color: #dc3545;"></i>
              <p class="mt-2 mb-0"><strong>${datei.name}</strong></p>
              <p class="text-muted small">${datei.size}</p>
            </div>
            <div class="card-footer p-2">
              <a href="${datei.url}" target="_blank" class="btn btn-sm btn-primary w-100">
                <i class="bi bi-eye"></i> √ñffnen
              </a>
            </div>
          </div>
        </div>
      `;
    } else {
      // Andere Dokumente
      html += `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="card-body text-center d-flex flex-column justify-content-center" style="height: 200px; background-color: #f8f9fa;">
              <i class="bi bi-file-earmark-text" style="font-size: 4rem; color: #0d6efd;"></i>
              <p class="mt-2 mb-0"><strong>${datei.name}</strong></p>
              <p class="text-muted small">${datei.size}</p>
            </div>
            <div class="card-footer p-2">
              <a href="${datei.url}" target="_blank" class="btn btn-sm btn-primary w-100">
                <i class="bi bi-download"></i> Herunterladen
              </a>
            </div>
          </div>
        </div>
      `;
    }
  });
  
  html += '</div>';
  dateienListe.innerHTML = html;
  
  } catch (error) {
    console.error('Fehler beim Laden der Dateien:', error);
    dateienListe.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Dateien.</div>';
  }
}

window.openDateienModal = function(themaId) {
  currentThemaIdListe = themaId;
  
  // Thema-ID im Modal anzeigen
  document.getElementById('dateienThemaId').textContent = themaId;
  
  // Modal √∂ffnen
  const modalElement = document.getElementById('dateienModal');
  const modal = new bootstrap.Modal(modalElement);
  modal.show();
  
  // Upload-Form zur√ºcksetzen
  document.getElementById('uploadFormListe').reset();
  document.getElementById('uploadMessageListe').innerHTML = '';
  document.getElementById('uploadProgressListe').classList.add('d-none');
  
  // Dateien laden
  loadDateienListeInListe(themaId);
};

// Upload-Formular Handler
document.addEventListener('DOMContentLoaded', function() {
  const uploadFormListe = document.getElementById('uploadFormListe');
  if (uploadFormListe) {
    uploadFormListe.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const fileInput = document.getElementById('fileInputListe');
      const uploadButton = document.getElementById('uploadButtonListe');
      const uploadProgress = document.getElementById('uploadProgressListe');
      const uploadMessage = document.getElementById('uploadMessageListe');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        uploadMessage.innerHTML = '<div class="alert alert-warning alert-dismissible fade show" role="alert">Bitte w√§hlen Sie mindestens eine Datei aus.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
        return;
      }
      
      const files = fileInput.files;
      const totalFiles = files.length;
      let successCount = 0;
      let errorCount = 0;
      let errorMessages = [];
      
      // Button deaktivieren und Progress anzeigen
      uploadButton.disabled = true;
      uploadProgress.classList.remove('d-none');
      uploadMessage.innerHTML = `<div class="alert alert-info">üì§ Lade ${totalFiles} Datei(en) hoch...</div>`;
      
      // Dateien nacheinander hochladen
      for (let i = 0; i < totalFiles; i++) {
        const formData = new FormData();
        formData.append('file', files[i]);
        
        try {
          const response = await fetch(`/schichtbuch/thema/${currentThemaIdListe}/upload`, {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          
          if (data.success) {
            successCount++;
          } else {
            errorCount++;
            errorMessages.push(`${files[i].name}: ${data.message}`);
          }
        } catch (error) {
          console.error('Upload-Fehler:', error);
          errorCount++;
          errorMessages.push(`${files[i].name}: Netzwerkfehler`);
        }
      }
      
      // Ergebnis anzeigen
      uploadProgress.classList.add('d-none');
      uploadButton.disabled = false;
      
      if (errorCount === 0) {
        uploadMessage.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">‚úÖ ${successCount} Datei(en) erfolgreich hochgeladen<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
        uploadFormListe.reset();
        
        // Dateiliste neu laden
        setTimeout(() => {
          loadDateienListeInListe(currentThemaIdListe);
        }, 500);
      } else if (successCount > 0) {
        let errorList = errorMessages.map(msg => `<li>${msg}</li>`).join('');
        uploadMessage.innerHTML = `<div class="alert alert-warning alert-dismissible fade show" role="alert">‚ö†Ô∏è ${successCount} erfolgreich, ${errorCount} fehlgeschlagen<ul class="mb-0 mt-2">${errorList}</ul><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
        uploadFormListe.reset();
        
        // Dateiliste neu laden
        setTimeout(() => {
          loadDateienListeInListe(currentThemaIdListe);
        }, 500);
      } else {
        let errorList = errorMessages.map(msg => `<li>${msg}</li>`).join('');
        uploadMessage.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">‚ùå Alle Uploads fehlgeschlagen<ul class="mb-0 mt-2">${errorList}</ul><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
      }
    });
  }
});

// Import-Funktionalit√§t f√ºr Schichtbuch
async function ladeImportDateienSchichtbuch() {
  const liste = document.getElementById('sb-import-dateien-liste');
  if (!liste || !currentThemaIdListe) return;
  
  liste.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
  
  try {
    const response = await fetch('/api/import/dateien');
    const data = await response.json();
    
    if (!data.success || data.dateien.length === 0) {
      liste.innerHTML = '<div class="alert alert-info">Keine Dateien im Import-Ordner vorhanden.</div>';
      return;
    }
    
    // Erlaubte Dateitypen f√ºr Schichtbuch
    const erlaubteEndungen = ['.png', '.jpg', '.jpeg', '.gif', '.pdf', '.doc', '.docx', '.xls', '.xlsx', '.txt'];
    
    const gefilterteDateien = data.dateien.filter(datei => {
      const ext = '.' + datei.name.split('.').pop().toLowerCase();
      return erlaubteEndungen.some(e => ext === e);
    });
    
    if (gefilterteDateien.length === 0) {
      liste.innerHTML = '<div class="alert alert-warning">Keine passenden Dateien im Import-Ordner.</div>';
      return;
    }
    
    let html = '<div class="list-group">';
    gefilterteDateien.forEach(datei => {
      html += `
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>${datei.name}</strong>
            <br><small class="text-muted">${datei.size}</small>
          </div>
          <button class="btn btn-sm btn-primary" onclick="verschiebeAusImportSchichtbuch('${datei.name.replace(/'/g, "\\'")}')">
            <i class="bi bi-arrow-right"></i> Verwenden
          </button>
        </div>
      `;
    });
    html += '</div>';
    liste.innerHTML = html;
  } catch (error) {
    console.error('Fehler beim Laden der Dateien:', error);
    liste.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Dateien.</div>';
  }
}

async function verschiebeAusImportSchichtbuch(filename) {
  if (!currentThemaIdListe) {
    alert('Kein Thema ausgew√§hlt');
    return;
  }
  
  if (!confirm(`M√∂chten Sie die Datei "${filename}" aus dem Import-Ordner verwenden? Die Datei wird verschoben.`)) {
    return;
  }
  
  const zielOrdner = `Schichtbuch/Themen/${currentThemaIdListe}`;
  
  try {
    const response = await fetch('/api/import/verschieben', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({filename: filename, ziel_ordner: zielOrdner})
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('Datei erfolgreich verschoben!');
      // Dateiliste neu laden
      loadDateienListeInListe(currentThemaIdListe);
      // Import-Liste aktualisieren
      ladeImportDateienSchichtbuch();
    } else {
      alert('Fehler: ' + data.message);
    }
  } catch (error) {
    console.error('Fehler beim Verschieben:', error);
    alert('Fehler beim Verschieben der Datei.');
  }
}
</script>

{% endblock %}
