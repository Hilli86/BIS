{% extends "layout/base.html" %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">ðŸ“Š Dashboard</h2>
    <div class="text-muted">
      <i class="bi bi-calendar3"></i> {{ "Heute" }}
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="bi bi-lightning-charge"></i> Schnellzugriff
          </h5>
          <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('schichtbuch.themaneu') }}" class="btn btn-primary">
              <i class="bi bi-plus-circle"></i> Neues Thema
            </a>
            <a href="{{ url_for('schichtbuch.themaliste') }}" class="btn btn-outline-primary">
              <i class="bi bi-list-ul"></i> Alle Themen
            </a>
            {% if ersatzteil_stats and ersatzteil_stats.gesamt > 0 %}
            <a href="{{ url_for('ersatzteile.ersatzteil_liste') }}" class="btn btn-outline-success">
              <i class="bi bi-tools"></i> Ersatzteile
            </a>
            <a href="{{ url_for('ersatzteile.ersatzteil_liste', bestandswarnung='1') }}" class="btn btn-outline-warning">
              <i class="bi bi-exclamation-triangle"></i> Bestandswarnungen
              {% if ersatzteil_stats.warnungen > 0 %}
              <span class="badge bg-warning text-dark ms-1">{{ ersatzteil_stats.warnungen }}</span>
              {% endif %}
            </a>
            {% endif %}
            {% if session.user_abteilungen and 'BIS-Admin' in session.user_abteilungen %}
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
              <i class="bi bi-gear"></i> Adminbereich
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status-Statistiken -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-bar-chart"></i> Status-Ãœbersicht
          </h5>
          <span class="badge bg-secondary">Gesamt: {{ gesamt }} Themen</span>
        </div>
        <div class="card-body">
          {% if status_daten|length == 0 %}
            <div class="alert alert-info mb-0">
              <i class="bi bi-info-circle"></i> Es sind noch keine Themen im System vorhanden.
            </div>
          {% else %}
            <div class="row g-3">
              {% for status in status_daten %}
              <div class="col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm" style="border-left: 4px solid {{ status.Farbe or '#6c757d' }} !important;">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h6 class="card-subtitle mb-2 text-muted">{{ status.Status }}</h6>
                        <h3 class="mb-0">{{ status.Anzahl }}</h3>
                      </div>
                      <div class="badge rounded-pill" style="background-color: {{ status.Farbe or '#6c757d' }}; color: white; opacity: 0.8;">
                        {{ ((status.Anzahl / gesamt * 100) if gesamt > 0 else 0)|round(1) }}%
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Ersatzteile-Statistiken -->
  {% if ersatzteil_stats and ersatzteil_stats.gesamt > 0 %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-tools"></i> Ersatzteile-Ãœbersicht
          </h5>
          <div class="d-flex gap-2">
            <a href="{{ url_for('ersatzteile.ersatzteil_liste') }}" class="btn btn-sm btn-outline-primary">
              Alle anzeigen <i class="bi bi-arrow-right"></i>
            </a>
            <a href="{{ url_for('ersatzteile.ersatzteil_liste', bestandswarnung='1') }}" class="btn btn-sm btn-outline-warning">
              Bestandswarnungen
              {% if ersatzteil_stats.warnungen > 0 %}
              <span class="badge bg-warning text-dark ms-1">{{ ersatzteil_stats.warnungen }}</span>
              {% endif %}
            </a>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <div class="card border-0 shadow-sm bg-light">
                <div class="card-body text-center">
                  <h6 class="card-subtitle mb-2 text-muted">Gesamt Ersatzteile</h6>
                  <h3 class="mb-0">{{ ersatzteil_stats.gesamt }}</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 shadow-sm" style="border-left: 4px solid #ffc107 !important;">
                <div class="card-body text-center">
                  <h6 class="card-subtitle mb-2 text-muted">Bestandswarnungen</h6>
                  <h3 class="mb-0 text-warning">{{ ersatzteil_stats.warnungen }}</h3>
                </div>
              </div>
            </div>
            {% if ersatzteil_stats.kategorien %}
            <div class="col-md-6">
              <h6 class="mb-2">Top Kategorien</h6>
              <div class="d-flex flex-wrap gap-2">
                {% for kat in ersatzteil_stats.kategorien %}
                <span class="badge bg-secondary">
                  {{ kat.Kategorie or 'Ohne Kategorie' }}: {{ kat.Anzahl }}
                </span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
          
          {% if ersatzteil_warnungen|length > 0 %}
          <div class="mt-3">
            <h6 class="mb-2">
              <i class="bi bi-exclamation-triangle text-warning"></i> Ersatzteile mit niedrigem Bestand
            </h6>
            <div class="list-group list-group-flush">
              {% for ersatzteil in ersatzteil_warnungen %}
              <a href="{{ url_for('ersatzteile.ersatzteil_detail', ersatzteil_id=ersatzteil.ID) }}" 
                 class="list-group-item list-group-item-action">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-1">
                      <strong>{{ ersatzteil.Bezeichnung }}</strong>
                      {% if ersatzteil.Kategorie %}
                      <span class="badge bg-secondary">{{ ersatzteil.Kategorie }}</span>
                      {% endif %}
                    </div>
                    <small class="text-muted">
                      <i class="bi bi-upc"></i> {{ ersatzteil.Bestellnummer }}
                    </small>
                  </div>
                  <div class="text-end">
                    <div class="text-warning fw-bold">
                      <i class="bi bi-box"></i> {{ ersatzteil.AktuellerBestand }} {{ ersatzteil.Einheit or '' }}
                    </div>
                    <small class="text-muted">
                      Mindest: {{ ersatzteil.Mindestbestand }} {{ ersatzteil.Einheit or '' }}
                    </small>
                  </div>
                </div>
              </a>
              {% endfor %}
            </div>
          </div>
          {% else %}
          <div class="alert alert-success mb-0">
            <i class="bi bi-check-circle"></i> Keine Bestandswarnungen - alle Ersatzteile sind ausreichend vorhanden.
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row">
    <!-- Aktuelle Themen -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-clock-history"></i> Aktuelle Themen
          </h5>
          <a href="{{ url_for('schichtbuch.themaliste') }}" class="btn btn-sm btn-outline-primary">
            Alle anzeigen <i class="bi bi-arrow-right"></i>
          </a>
        </div>
        <div class="card-body">
          {% if aktuelle_themen|length == 0 %}
            <div class="text-center text-muted py-4">
              <i class="bi bi-inbox" style="font-size: 3rem;"></i>
              <p class="mt-2 mb-0">Keine Themen vorhanden</p>
            </div>
          {% else %}
            <div class="list-group list-group-flush">
              {% for thema in aktuelle_themen %}
              <a href="{{ url_for('schichtbuch.thema_detail', thema_id=thema.ID) }}" 
                 class="list-group-item list-group-item-action">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-1">
                      <span class="badge" style="background-color: {{ thema.StatusFarbe or '#6c757d' }}; color: white;">
                        {{ thema.Status }}
                      </span>
                      <small class="text-muted">{{ thema.Bereich }} / {{ thema.Gewerk }}</small>
                    </div>
                    <div class="small text-muted">
                      {% if thema.Abteilung %}
                        <i class="bi bi-building"></i> {{ thema.Abteilung }}
                      {% endif %}
                      {% if thema.LetzterMitarbeiter %}
                        <span class="ms-2">
                          <i class="bi bi-person"></i> {{ thema.LetzterMitarbeiter }}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                  <div class="text-end">
                    <small class="text-muted d-block">
                      {{ thema.LetzteAktivitaet[:10] if thema.LetzteAktivitaet else '' }}
                    </small>
                    <small class="text-muted">
                      #{{ thema.ID }}
                    </small>
                  </div>
                </div>
              </a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Meine Themen -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-person-check"></i> Meine Themen
          </h5>
          <span class="badge bg-primary">{{ meine_themen|length }}</span>
        </div>
        <div class="card-body">
          {% if meine_themen|length == 0 %}
            <div class="text-center text-muted py-4">
              <i class="bi bi-inbox" style="font-size: 3rem;"></i>
              <p class="mt-2 mb-0">Sie haben noch keine Themen bearbeitet</p>
              <a href="{{ url_for('schichtbuch.themaneu') }}" class="btn btn-sm btn-primary mt-3">
                <i class="bi bi-plus-circle"></i> Erstes Thema erstellen
              </a>
            </div>
          {% else %}
            <div class="list-group list-group-flush">
              {% for thema in meine_themen %}
              <a href="{{ url_for('schichtbuch.thema_detail', thema_id=thema.ID) }}" 
                 class="list-group-item list-group-item-action">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-1">
                      <span class="badge" style="background-color: {{ thema.StatusFarbe or '#6c757d' }}; color: white;">
                        {{ thema.Status }}
                      </span>
                      <small class="text-muted">{{ thema.Bereich }} / {{ thema.Gewerk }}</small>
                    </div>
                    <div class="small text-muted">
                      {% if thema.Abteilung %}
                        <i class="bi bi-building"></i> {{ thema.Abteilung }}
                      {% endif %}
                    </div>
                  </div>
                  <div class="text-end">
                    <small class="text-muted d-block">
                      {{ thema.LetzteBemerkung[:10] if thema.LetzteBemerkung else '' }}
                    </small>
                    <small class="text-muted">
                      #{{ thema.ID }}
                    </small>
                  </div>
                </div>
              </a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- AktivitÃ¤tsÃ¼bersicht -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-activity"></i> Letzte AktivitÃ¤ten
          </h5>
        </div>
        <div class="card-body">
          {% if aktivitaeten|length == 0 %}
            <div class="text-center text-muted py-4">
              <i class="bi bi-inbox" style="font-size: 3rem;"></i>
              <p class="mt-2 mb-0">Noch keine AktivitÃ¤ten vorhanden</p>
            </div>
          {% else %}
            <div class="timeline">
              {% for aktivitaet in aktivitaeten %}
              <div class="timeline-item mb-3">
                <div class="d-flex">
                  <div class="flex-shrink-0">
                    <div class="timeline-marker" style="background-color: #0066cc;"></div>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <strong>{{ aktivitaet.Mitarbeiter }}</strong>
                        {% if aktivitaet.Taetigkeit %}
                          <span class="badge bg-secondary ms-2">{{ aktivitaet.Taetigkeit }}</span>
                        {% endif %}
                        <p class="mb-1 mt-1">{{ aktivitaet.Bemerkung[:150] }}{% if aktivitaet.Bemerkung|length > 150 %}...{% endif %}</p>
                        <small class="text-muted">
                          <a href="{{ url_for('schichtbuch.thema_detail', thema_id=aktivitaet.ThemaID) }}" class="text-decoration-none">
                            <i class="bi bi-link-45deg"></i> {{ aktivitaet.Bereich }} / {{ aktivitaet.Gewerk }} (#{{ aktivitaet.ThemaID }})
                          </a>
                        </small>
                      </div>
                      <small class="text-muted ms-3">
                        {{ aktivitaet.Datum[:16] if aktivitaet.Datum else '' }}
                      </small>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .timeline {
    position: relative;
  }

  .timeline-item {
    position: relative;
  }

  .timeline-marker {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 0 2px #0066cc;
  }

  .card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
  }

  .list-group-item {
    border-left: none;
    border-right: none;
    transition: background-color 0.2s ease-in-out;
  }

  .list-group-item:hover {
    background-color: #f8f9fa;
  }

  .list-group-item:first-child {
    border-top: none;
  }

  .list-group-item:last-child {
    border-bottom: none;
  }
</style>
{% endblock %}
