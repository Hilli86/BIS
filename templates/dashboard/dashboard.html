{% extends "layout/base.html" %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">ðŸ“Š Dashboard</h2>
    <div class="text-muted">
      <i class="bi bi-calendar3"></i> {{ "Heute" }}
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="bi bi-lightning-charge"></i> Schnellzugriff
          </h5>
          <div class="d-flex flex-wrap gap-2">
            {% if 'admin' in session.get('user_berechtigungen', []) or 'bestellungen_freigeben' in session.get('user_berechtigungen', []) %}
            <a href="{{ url_for('ersatzteile.bestellung_liste', status='Zur Freigabe') }}" class="btn btn-outline-success">
              <i class="bi bi-check-circle"></i> Bestellungen freigeben
            </a>
            {% endif %}
            <a href="{{ url_for('ersatzteile.ersatzteil_liste', bestandswarnung='1') }}" class="btn btn-outline-warning" id="bestandswarnungBtn" style="display: none;">
              <i class="bi bi-exclamation-triangle"></i> Bestandswarnungen
            </a>
            <a href="{{ url_for('schichtbuch.themaneu') }}" class="btn btn-primary">
              <i class="bi bi-plus-circle"></i> Neues Thema
            </a>
            <a href="{{ url_for('schichtbuch.themaliste') }}" class="btn btn-outline-primary">
              <i class="bi bi-list-ul"></i> Alle Themen
            </a>
            <a href="{{ url_for('ersatzteile.ersatzteil_liste') }}" class="btn btn-outline-success" id="ersatzteilBtn" style="display: none;">
              <i class="bi bi-tools"></i> Ersatzteile
            </a>
            {% if 'admin' in session.get('user_berechtigungen', []) %}
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
              <i class="bi bi-gear"></i> Adminbereich
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Benachrichtigungen -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-bell"></i> Benachrichtigungen
          </h5>
          <a href="#" id="benachrichtigungenLink" class="btn btn-sm btn-outline-primary">
            Alle anzeigen <i class="bi bi-arrow-right"></i>
          </a>
        </div>
        <div class="card-body" id="benachrichtigungenContainer">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">LÃ¤dt...</span>
            </div>
            <p class="mt-2 text-muted">Benachrichtigungen werden geladen...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status-Statistiken -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-bar-chart"></i> Status-Ãœbersicht
          </h5>
          <span class="badge bg-secondary" id="statusGesamt">Gesamt: <span class="spinner-border spinner-border-sm"></span> Themen</span>
        </div>
        <div class="card-body" id="statusContainer">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">LÃ¤dt...</span>
            </div>
            <p class="mt-2 text-muted">Daten werden geladen...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ersatzteile-Statistiken -->
  <div class="row mb-4" id="ersatzteilSection" style="display: none;">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-tools"></i> Ersatzteile-Ãœbersicht
          </h5>
          <div class="d-flex gap-2">
            <a href="{{ url_for('ersatzteile.ersatzteil_liste') }}" class="btn btn-sm btn-outline-primary">
              Alle anzeigen <i class="bi bi-arrow-right"></i>
            </a>
            <a href="{{ url_for('ersatzteile.ersatzteil_liste', bestandswarnung='1') }}" class="btn btn-sm btn-outline-warning" id="warnungLink">
              Bestandswarnungen
            </a>
          </div>
        </div>
        <div class="card-body" id="ersatzteilContainer">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">LÃ¤dt...</span>
            </div>
            <p class="mt-2 text-muted">Daten werden geladen...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Aktuelle Themen -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-clock-history"></i> Aktuelle Themen
          </h5>
          <a href="{{ url_for('schichtbuch.themaliste') }}" class="btn btn-sm btn-outline-primary">
            Alle anzeigen <i class="bi bi-arrow-right"></i>
          </a>
        </div>
        <div class="card-body" id="aktuelleThemenContainer">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">LÃ¤dt...</span>
            </div>
            <p class="mt-2 text-muted">Daten werden geladen...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Meine Themen -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-person-check"></i> Meine Themen
          </h5>
          <span class="badge bg-primary" id="meineThemenBadge">...</span>
        </div>
        <div class="card-body" id="meineThemenContainer">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">LÃ¤dt...</span>
            </div>
            <p class="mt-2 text-muted">Daten werden geladen...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AktivitÃ¤tsÃ¼bersicht -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-activity"></i> Letzte AktivitÃ¤ten
          </h5>
        </div>
        <div class="card-body" id="aktivitaetenContainer">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">LÃ¤dt...</span>
            </div>
            <p class="mt-2 text-muted">Daten werden geladen...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .timeline {
    position: relative;
  }

  .timeline-item {
    position: relative;
  }

  .timeline-marker {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 0 2px #0066cc;
  }

  .card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
  }

  .list-group-item {
    border-left: none;
    border-right: none;
    transition: background-color 0.2s ease-in-out;
  }

  .list-group-item:hover {
    background-color: #f8f9fa;
  }

  .list-group-item:first-child {
    border-top: none;
  }

  .list-group-item:last-child {
    border-bottom: none;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Dashboard-Daten per AJAX laden
    fetch('{{ url_for("dashboard.api_dashboard") }}')
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP-Fehler! Status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // Status-Statistiken rendern
        renderStatusStats(data.status_daten, data.gesamt);
        
        // Ersatzteile-Sektion rendern
        if (data.ersatzteil_stats && data.ersatzteil_stats.gesamt > 0) {
          renderErsatzteile(data.ersatzteil_stats, data.ersatzteil_warnungen);
        }
        
        // Aktuelle Themen rendern
        renderAktuelleThemen(data.aktuelle_themen);
        
        // Meine Themen rendern
        renderMeineThemen(data.meine_themen);
        
        // AktivitÃ¤ten rendern
        renderAktivitaeten(data.aktivitaeten);
      } else {
        console.error('Fehler beim Laden der Dashboard-Daten:', data.error);
        if (data.details) {
          console.error('Details:', data.details);
        }
        showError('Fehler beim Laden der Dashboard-Daten: ' + (data.error || 'Unbekannter Fehler'));
      }
    })
    .catch(error => {
      console.error('Fehler:', error);
      showError('Fehler bei der Verbindung zum Server: ' + error.message);
    });
  
  function renderStatusStats(statusDaten, gesamt) {
    const container = document.getElementById('statusContainer');
    const badge = document.getElementById('statusGesamt');
    
    badge.textContent = `Gesamt: ${gesamt} Themen`;
    
    if (statusDaten.length === 0) {
      container.innerHTML = '<div class="alert alert-info mb-0"><i class="bi bi-info-circle"></i> Es sind noch keine Themen im System vorhanden.</div>';
      return;
    }
    
    let html = '<div class="row g-3">';
    statusDaten.forEach(status => {
      const prozent = gesamt > 0 ? ((status.Anzahl / gesamt * 100).toFixed(1)) : 0;
      const farbe = status.Farbe || '#6c757d';
      html += `
        <div class="col-md-6 col-lg-3">
          <div class="card border-0 shadow-sm" style="border-left: 4px solid ${farbe} !important;">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="card-subtitle mb-2 text-muted">${status.Status}</h6>
                  <h3 class="mb-0">${status.Anzahl}</h3>
                </div>
                <div class="badge rounded-pill" style="background-color: ${farbe}; color: white; opacity: 0.8;">
                  ${prozent}%
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;
  }
  
  function renderErsatzteile(stats, warnungen) {
    const section = document.getElementById('ersatzteilSection');
    const container = document.getElementById('ersatzteilContainer');
    const ersatzteilBtn = document.getElementById('ersatzteilBtn');
    const bestandswarnungBtn = document.getElementById('bestandswarnungBtn');
    const warnungLink = document.getElementById('warnungLink');
    
    section.style.display = 'block';
    if (ersatzteilBtn) ersatzteilBtn.style.display = 'inline-block';
    if (bestandswarnungBtn) bestandswarnungBtn.style.display = 'inline-block';
    
    if (warnungen.length > 0 && warnungLink) {
      warnungLink.innerHTML = `Bestandswarnungen <span class="badge bg-warning text-dark ms-1">${warnungen.length}</span>`;
    }
    if (warnungen.length > 0 && bestandswarnungBtn) {
      bestandswarnungBtn.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Bestandswarnungen <span class="badge bg-warning text-dark ms-1">${warnungen.length}</span>`;
    }
    
    let html = '<div class="row g-3 mb-3">';
    html += `
      <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-light">
          <div class="card-body text-center">
            <h6 class="card-subtitle mb-2 text-muted">Gesamt Ersatzteile</h6>
            <h3 class="mb-0">${stats.gesamt}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm" style="border-left: 4px solid #ffc107 !important;">
          <div class="card-body text-center">
            <h6 class="card-subtitle mb-2 text-muted">Bestandswarnungen</h6>
            <h3 class="mb-0 text-warning">${stats.warnungen}</h3>
          </div>
        </div>
      </div>
    `;
    
    if (stats.kategorien && stats.kategorien.length > 0) {
      html += '<div class="col-md-6"><h6 class="mb-2">Top Kategorien</h6><div class="d-flex flex-wrap gap-2">';
      stats.kategorien.forEach(kat => {
        html += `<span class="badge bg-secondary">${kat.Kategorie || 'Ohne Kategorie'}: ${kat.Anzahl}</span>`;
      });
      html += '</div></div>';
    }
    
    html += '</div>';
    
    if (warnungen.length > 0) {
      html += `
        <div class="mt-3">
          <h6 class="mb-2"><i class="bi bi-exclamation-triangle text-warning"></i> Ersatzteile mit niedrigem Bestand</h6>
          <div class="list-group list-group-flush">
      `;
      warnungen.forEach(ersatzteil => {
        const detailUrl = '{{ url_for("ersatzteile.ersatzteil_detail", ersatzteil_id=0) }}'.replace('/0', '/' + ersatzteil.ID);
        html += `
          <a href="${detailUrl}" 
             class="list-group-item list-group-item-action">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2 mb-1">
                  <strong>${ersatzteil.Bezeichnung}</strong>
                  ${ersatzteil.Kategorie ? `<span class="badge bg-secondary">${ersatzteil.Kategorie}</span>` : ''}
                </div>
                <small class="text-muted"><i class="bi bi-upc"></i> ${ersatzteil.Bestellnummer}</small>
              </div>
              <div class="text-end">
                <div class="text-warning fw-bold">
                  <i class="bi bi-box"></i> ${ersatzteil.AktuellerBestand} ${ersatzteil.Einheit || ''}
                </div>
                <small class="text-muted">Mindest: ${ersatzteil.Mindestbestand} ${ersatzteil.Einheit || ''}</small>
              </div>
            </div>
          </a>
        `;
      });
      html += '</div></div>';
    } else {
      html += '<div class="alert alert-success mb-0"><i class="bi bi-check-circle"></i> Keine Bestandswarnungen - alle Ersatzteile sind ausreichend vorhanden.</div>';
    }
    
    container.innerHTML = html;
  }
  
  function renderAktuelleThemen(themen) {
    const container = document.getElementById('aktuelleThemenContainer');
    
    if (themen.length === 0) {
      container.innerHTML = `
        <div class="text-center text-muted py-4">
          <i class="bi bi-inbox" style="font-size: 3rem;"></i>
          <p class="mt-2 mb-0">Keine Themen vorhanden</p>
        </div>
      `;
      return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    const themaDetailUrl = '{{ url_for("schichtbuch.thema_detail", thema_id=0) }}';
    themen.forEach(thema => {
      const farbe = thema.StatusFarbe || '#6c757d';
      const datum = thema.LetzteAktivitaet ? thema.LetzteAktivitaet.substring(0, 10) : '';
      const url = themaDetailUrl.replace('/0', '/' + thema.ID);
      html += `
        <a href="${url}" 
           class="list-group-item list-group-item-action">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-1">
                <span class="badge" style="background-color: ${farbe}; color: white;">${thema.Status}</span>
                <small class="text-muted">${thema.Bereich} / ${thema.Gewerk}</small>
              </div>
              <div class="small text-muted">
                ${thema.Abteilung ? `<i class="bi bi-building"></i> ${thema.Abteilung}` : ''}
                ${thema.LetzterMitarbeiter ? `<span class="ms-2"><i class="bi bi-person"></i> ${thema.LetzterMitarbeiter}</span>` : ''}
              </div>
            </div>
            <div class="text-end">
              <small class="text-muted d-block">${datum}</small>
              <small class="text-muted">#${thema.ID}</small>
            </div>
          </div>
        </a>
      `;
    });
    html += '</div>';
    container.innerHTML = html;
  }
  
  function renderMeineThemen(themen) {
    const container = document.getElementById('meineThemenContainer');
    const badge = document.getElementById('meineThemenBadge');
    
    if (badge) badge.textContent = themen.length;
    
    if (themen.length === 0) {
      container.innerHTML = `
        <div class="text-center text-muted py-4">
          <i class="bi bi-inbox" style="font-size: 3rem;"></i>
          <p class="mt-2 mb-0">Sie haben noch keine Themen bearbeitet</p>
          <a href="{{ url_for('schichtbuch.themaneu') }}" class="btn btn-sm btn-primary mt-3">
            <i class="bi bi-plus-circle"></i> Erstes Thema erstellen
          </a>
        </div>
      `;
      return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    const themaDetailUrl = '{{ url_for("schichtbuch.thema_detail", thema_id=0) }}';
    themen.forEach(thema => {
      const farbe = thema.StatusFarbe || '#6c757d';
      const datum = thema.LetzteBemerkung ? thema.LetzteBemerkung.substring(0, 10) : '';
      const url = themaDetailUrl.replace('/0', '/' + thema.ID);
      html += `
        <a href="${url}" 
           class="list-group-item list-group-item-action">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-1">
                <span class="badge" style="background-color: ${farbe}; color: white;">${thema.Status}</span>
                <small class="text-muted">${thema.Bereich} / ${thema.Gewerk}</small>
              </div>
              <div class="small text-muted">
                ${thema.Abteilung ? `<i class="bi bi-building"></i> ${thema.Abteilung}` : ''}
              </div>
            </div>
            <div class="text-end">
              <small class="text-muted d-block">${datum}</small>
              <small class="text-muted">#${thema.ID}</small>
            </div>
          </div>
        </a>
      `;
    });
    html += '</div>';
    container.innerHTML = html;
  }
  
  function renderAktivitaeten(aktivitaeten) {
    const container = document.getElementById('aktivitaetenContainer');
    
    if (aktivitaeten.length === 0) {
      container.innerHTML = `
        <div class="text-center text-muted py-4">
          <i class="bi bi-inbox" style="font-size: 3rem;"></i>
          <p class="mt-2 mb-0">Noch keine AktivitÃ¤ten vorhanden</p>
        </div>
      `;
      return;
    }
    
    let html = '<div class="timeline">';
    const themaDetailUrl = '{{ url_for("schichtbuch.thema_detail", thema_id=0) }}';
    aktivitaeten.forEach(aktivitaet => {
      const datum = aktivitaet.Datum ? aktivitaet.Datum.substring(0, 16) : '';
      const bemerkung = aktivitaet.Bemerkung.length > 150 ? aktivitaet.Bemerkung.substring(0, 150) + '...' : aktivitaet.Bemerkung;
      const url = themaDetailUrl.replace('/0', '/' + aktivitaet.ThemaID);
      html += `
        <div class="timeline-item mb-3">
          <div class="d-flex">
            <div class="flex-shrink-0">
              <div class="timeline-marker" style="background-color: #0066cc;"></div>
            </div>
            <div class="flex-grow-1 ms-3">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>${aktivitaet.Mitarbeiter}</strong>
                  ${aktivitaet.Taetigkeit ? `<span class="badge bg-secondary ms-2">${aktivitaet.Taetigkeit}</span>` : ''}
                  <p class="mb-1 mt-1">${bemerkung}</p>
                  <small class="text-muted">
                    <a href="${url}" class="text-decoration-none">
                      <i class="bi bi-link-45deg"></i> ${aktivitaet.Bereich} / ${aktivitaet.Gewerk} (#${aktivitaet.ThemaID})
                    </a>
                  </small>
                </div>
                <small class="text-muted ms-3">${datum}</small>
              </div>
            </div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;
  }
  
  function showError(message) {
    const containers = ['statusContainer', 'ersatzteilContainer', 'aktuelleThemenContainer', 'meineThemenContainer', 'aktivitaetenContainer'];
    containers.forEach(id => {
      const container = document.getElementById(id);
      if (container) {
        container.innerHTML = `<div class="alert alert-danger mb-0"><i class="bi bi-exclamation-triangle"></i> ${message}</div>`;
      }
    });
  }
});
  // Benachrichtigungen laden
  (function() {
    const container = document.getElementById('benachrichtigungenContainer');
    if (!container) return;

    fetch('{{ url_for("dashboard.api_benachrichtigungen") }}')
      .then(response => response.json())
      .then(data => {
        if (!data.benachrichtigungen || data.benachrichtigungen.length === 0) {
          container.innerHTML = `
            <div class="text-center py-3">
              <p class="text-muted mb-0">Keine ungelesenen Benachrichtigungen</p>
            </div>
          `;
          return;
        }

        let html = '<div class="list-group list-group-flush">';
        data.benachrichtigungen.slice(0, 5).forEach(notif => {
          const datum = notif.ErstelltAm ? new Date(notif.ErstelltAm).toLocaleString('de-DE') : '';
          const gelesenClass = notif.Gelesen ? '' : 'list-group-item-warning';
          html += `
            <div class="list-group-item ${gelesenClass}">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h6 class="mb-1">${notif.Titel}</h6>
                  <p class="mb-1">${notif.Nachricht}</p>
                  <small class="text-muted">${datum}</small>
                </div>
                ${!notif.Gelesen ? '<span class="badge bg-primary">Neu</span>' : ''}
              </div>
            </div>
          `;
        });
        html += '</div>';

        if (data.ungelesen_count > 5) {
          html += `
            <div class="card-footer text-center">
              <a href="#" class="btn btn-sm btn-outline-primary">
                ${data.ungelesen_count - 5} weitere Benachrichtigungen
              </a>
            </div>
          `;
        }

        container.innerHTML = html;
      })
      .catch(error => {
        console.error('Fehler beim Laden der Benachrichtigungen:', error);
        container.innerHTML = `
          <div class="text-center py-3">
            <p class="text-danger mb-0">Fehler beim Laden der Benachrichtigungen</p>
          </div>
        `;
      });
  })();
</script>
{% endblock %}
