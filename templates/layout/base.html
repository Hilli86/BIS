<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title or "BIS" }}</title>
  
  <!-- PWA Meta Tags -->
  <meta name="application-name" content="BIS">
  <meta name="description" content="Betriebsinformationssystem - Schichtbuch und Verwaltung">
  <meta name="theme-color" content="#0066cc">
  
  <!-- iOS PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="BIS">
  
  <!-- Icons fÃ¼r iOS -->
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-180.png') }}">
  <link rel="apple-touch-icon" sizes="120x120" href="{{ url_for('static', filename='icons/icon-120.png') }}">
  <link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='icons/icon-152.png') }}">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/icon-180.png') }}">
  
  <!-- Standard Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/icon-32.png') }}">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">
  
  <!-- Web App Manifest -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    /* --- Globale Skalierung: 100% Zoom â‰ˆ bisherige 80% --- */
    html {
      font-size: 90%;
      -webkit-text-size-adjust: 100%; /* iOS: automatische TextvergrÃ¶ÃŸerung verhindern */
    }

    /* --- Seitenlayout --- */
    body {
      background-color: #f8f9fa;
    }

    .sidebar {
      min-height: 100vh;
      height: 100vh;
      width: 240px;
      background-color: #e9ecef;
      padding: 1rem;
      padding-bottom: 1rem;
      position: fixed;
      top: 0;
      left: 0;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      transition: transform 0.3s ease-in-out;
      z-index: 1040;
      box-sizing: border-box;
    }

    .sidebar h6 {
      text-transform: uppercase;
      font-size: 0.8rem;
      color: #6c757d;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }

    .sidebar a {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: #212529;
      padding: 0.5rem;
      border-radius: 0.5rem;
      transition: background-color 0.2s ease-in-out;
    }

    .sidebar a:hover {
      background-color: #dee2e6;
    }

    .sidebar a.active {
      background-color: #ced4da;
      font-weight: 600;
    }

    .sidebar a svg {
      margin-right: 8px;
    }

    .main-content {
      padding: 1.5rem;
      transition: margin-left 0.3s ease-in-out;
    }

    .main-content.with-sidebar {
      margin-left: 260px;
    }

    /* --- Kartenstil --- */
    .card {
      border: 1px solid #ddd;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      margin-bottom: 1rem;
      border-radius: 0.5rem;
    }

    .card:last-child {
      margin-bottom: 0;
    }

    .navbar {
      display: none; /* Sidebar ersetzt Navbar */
    }

    /* Mitarbeiter unten */
    .sidebar-footer {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #dee2e6;
      font-size: 0.9rem;
      color: #495057;
    }

    /* --- Hamburger-MenÃ¼ --- */
    .menu-toggle {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1050;
      background-color: #e9ecef;
      border: none;
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .menu-toggle:hover {
      background-color: #dee2e6;
    }

    .menu-toggle span {
      display: block;
      width: 25px;
      height: 3px;
      background-color: #212529;
      margin: 5px 0;
      transition: 0.3s;
    }

    /* Overlay fÃ¼r mobile GerÃ¤te */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1030;
    }

    /* --- Mobile Ansicht --- */
    /* Seitenleiste ausblenden bei kleinen Bildschirmen ODER bei geringer HÃ¶he (Querformat) */
    @media (max-width: 768px), (max-height: 600px) {
      .sidebar {
        transform: translateX(-100%);
        height: 100vh;
        max-height: 100vh;
        width: 280px;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0 !important;
        padding: 4rem 1rem 1rem 1rem;
      }

      .main-content.with-sidebar {
        margin-left: 0 !important;
      }

      .menu-toggle {
        display: block;
      }

      .sidebar-overlay.show {
        display: block;
      }

      /* Sidebar-Footer im Querformat besser positionieren */
      .sidebar-footer {
        position: relative;
        margin-top: 2rem;
        padding-top: 1rem;
        margin-bottom: 1rem;
      }

      /* Sicherstellen, dass Sidebar-Inhalt scrollbar ist */
      .sidebar {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch;
        height: 100vh !important;
        max-height: 100vh !important;
        box-sizing: border-box;
        touch-action: pan-y;
        overscroll-behavior: contain;
      }
      
      /* Touch-Scrolling fÃ¼r iOS verbessern */
      .sidebar::-webkit-scrollbar {
        width: 4px;
      }
      
      .sidebar::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .sidebar::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 2px;
      }
      
      /* Sicherstellen, dass alle Sidebar-Elemente scrollbar sind */
      .sidebar > * {
        flex-shrink: 0;
      }
    }
    
    /* --- iOS-Zoom auf Eingabefelder verhindern (Wareneingang, Formulare) --- */
    @media (max-width: 768px) {
      input,
      select,
      textarea {
        font-size: 16px !important; /* verhindert Auto-Zoom beim Fokus auf iOS */
      }
    }
    
    /* --- Druck-Styles --- */
    @media print {
      /* Navigation komplett ausblenden */
      .sidebar,
      .menu-toggle,
      .sidebar-overlay {
        display: none !important;
      }
      
      /* Hauptinhalt ohne Sidebar-Margin und Padding */
      .main-content {
        margin-left: 0 !important;
        padding: 0 !important;
      }
      
      /* Body-Hintergrund weiÃŸ fÃ¼r Druck */
      body {
        background-color: white !important;
      }
    }
  </style>

  {% block styles %}{% endblock %}

</head>

<body>

  {% if session.user_id %}
  <!-- ğŸ”¹ Hamburger-MenÃ¼ fÃ¼r Mobile -->
  <button class="menu-toggle" id="menuToggle" aria-label="MenÃ¼">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- ğŸ”¹ Overlay fÃ¼r Mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- ğŸ”¹ Seitenleiste -->
  <div class="sidebar" id="sidebar">
    <div class="d-flex align-items-center mb-3">
      <img src="{{ url_for('static', filename='icons/icon-120.png') }}" alt="BIS Logo" style="width: 32px; height: 32px; margin-right: 10px; border-radius: 6px;">
      <h5 class="mb-0">Binca Manufaktur</h5>
    </div>
  
    <a href="{{ url_for('dashboard.dashboard') }}" class="{% if request.endpoint == 'dashboard.dashboard' %}active{% endif %}">
      ğŸ“Š Dashboard
      <span id="notificationBadge" class="badge bg-danger ms-2" style="display: none;">0</span>
    </a>

    {% if 'admin' in session.get('user_berechtigungen', []) %}
    <a href="{{ url_for('admin.dashboard') }}" class="{% if request.endpoint == 'admin.dashboard' %}active{% endif %}">
      âš™ï¸ Adminbereich
    </a>
    {% endif %}

    <h6>Schichtbuch</h6>
    <a href="{{ url_for('schichtbuch.suche_thema') }}" class="{% if request.endpoint == 'schichtbuch.suche_thema' %}active{% endif %}">
      ğŸ” Suche Thema
    </a>
    <a href="{{ url_for('schichtbuch.themaliste') }}" class="{% if request.endpoint == 'sbthemaliste' %}active{% endif %}">
      ğŸ§¾ Themenliste
    </a>

    <h6>Bestellwesen</h6>
    <a href="{{ url_for('ersatzteile.angebotsanfrage_liste') }}" class="{% if request.endpoint and 'angebotsanfrage' in request.endpoint %}active{% endif %}">
      ğŸ“‹ Angebotsanfragen
    </a>
    <a href="{{ url_for('ersatzteile.bestellung_liste') }}" class="{% if request.endpoint and 'bestellung' in request.endpoint and 'wareneingang' not in request.endpoint %}active{% endif %}">
      ğŸ›’ Bestellungen
    </a>
    {% if 'admin' in session.get('user_berechtigungen', []) or 'artikel_buchen' in session.get('user_berechtigungen', []) %}
    <a href="{{ url_for('ersatzteile.wareneingang') }}" class="{% if request.endpoint and 'wareneingang' in request.endpoint %}active{% endif %}">
      ğŸ“¦ Wareneingang buchen
    </a>
    {% endif %}

    <h6>Ersatzteile</h6>
    <a href="{{ url_for('ersatzteile.suche_artikel') }}" class="{% if request.endpoint and 'suche' in request.endpoint %}active{% endif %}">
      ğŸ” Suche Artikel
    </a>
    <a href="{{ url_for('ersatzteile.ersatzteil_liste') }}" class="{% if request.endpoint and 'ersatzteile' in request.endpoint and 'lieferant' not in request.endpoint and 'lagerbuchung' not in request.endpoint and 'suche' not in request.endpoint and 'inventur' not in request.endpoint and 'angebotsanfrage' not in request.endpoint and 'bestellung' not in request.endpoint and 'wareneingang' not in request.endpoint %}active{% endif %}">
      ğŸ”§ Artikelliste
    </a>
    <a href="{{ url_for('ersatzteile.inventurliste') }}" class="{% if request.endpoint and 'inventur' in request.endpoint %}active{% endif %}">
      ğŸ“‹ Inventurliste
    </a>
    <a href="{{ url_for('ersatzteile.lieferanten_liste') }}" class="{% if request.endpoint and 'lieferant' in request.endpoint %}active{% endif %}">
      ğŸ“¦ Lieferanten
    </a>
    <a href="{{ url_for('ersatzteile.lagerbuchungen_liste') }}" class="{% if request.endpoint and 'lagerbuchung' in request.endpoint %}active{% endif %}">
      ğŸ“‹ Lagerbuchungen
    </a>

    <hr>

    <div class="sidebar-footer">
      {% if session.user_id %}
        <div class="mb-2">
          <strong>ğŸ‘¤ {{ session.user_name }}</strong><br>
          {% if session.user_abteilung %}
            <small class="text-muted">ğŸ¢ {{ session.user_abteilung }}</small>
          {% else %}
            <small class="text-muted">ğŸ¢ Keine Abteilung</small>
          {% endif %}
        </div>
        <div class="d-flex flex-column gap-2">
          <a href="{{ url_for('auth.profil') }}" class="text-decoration-none">
            <i class="bi bi-person"></i> Mein Profil
          </a>
          <a href="{{ url_for('auth.logout') }}" class="text-decoration-none text-danger">
            <i class="bi bi-box-arrow-right"></i> Abmelden
          </a>
        </div>
      {% else %}
        <a href="{{ url_for('auth.login') }}">Anmelden</a>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- ğŸ”¹ Hauptinhalt -->
  <div class="main-content {% if session.user_id %}with-sidebar{% endif %}">
    <!-- Flash-Meldungen anzeigen -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="container-fluid mt-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert" style="z-index: 9999; position: relative;">
              <strong>{% if category == 'danger' or category == 'error' %}âš ï¸ Fehler:{% elif category == 'success' %}âœ… Erfolg:{% elif category == 'warning' %}âš ï¸ Warnung:{% else %}â„¹ï¸ Info:{% endif %}</strong> {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    
    {% block content %}
    {% endblock %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>window.bootstrap = bootstrap;</script>

  <script>
    // Mobile MenÃ¼ Toggle (nur wenn Elemente vorhanden sind)
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');

    if (menuToggle && sidebar && overlay) {
      function toggleMenu() {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('show');
      }

      menuToggle.addEventListener('click', toggleMenu);
      overlay.addEventListener('click', toggleMenu);

      // Funktion zum PrÃ¼fen, ob mobile Ansicht aktiv ist
      function isMobileView() {
        return window.innerWidth <= 768 || window.innerHeight <= 600;
      }

      // MenÃ¼ schlieÃŸen bei Klick auf einen Link (nur auf mobilen GerÃ¤ten)
      function setupMobileMenuClose() {
        if (isMobileView()) {
          const sidebarLinks = sidebar.querySelectorAll('a');
          sidebarLinks.forEach(link => {
            link.addEventListener('click', () => {
              sidebar.classList.remove('open');
              overlay.classList.remove('show');
            });
          });
        }
      }

      // Initial setup
      setupMobileMenuClose();

      // Bei GrÃ¶ÃŸenÃ¤nderung neu prÃ¼fen
      window.addEventListener('resize', () => {
        // MenÃ¼ automatisch schlieÃŸen bei Wechsel zu Desktop-Ansicht
        if (!isMobileView()) {
          sidebar.classList.remove('open');
          overlay.classList.remove('show');
        }
      });
    }

    // Service Worker registrieren
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/service-worker.js')
          .then(registration => {
            console.log('Service Worker registriert:', registration.scope);
          })
          .catch(error => {
            console.log('Service Worker Registrierung fehlgeschlagen:', error);
          });
      });
    }

    // Benachrichtigungen laden und anzeigen
    function loadBenachrichtigungen() {
      fetch('{{ url_for("schichtbuch.api_benachrichtigungen") }}', {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const badge = document.getElementById('notificationBadge');
          if (badge) {
            if (data.anzahl_ungelesen > 0) {
              badge.textContent = data.anzahl_ungelesen > 99 ? '99+' : data.anzahl_ungelesen;
              badge.style.display = 'inline-block';
            } else {
              badge.style.display = 'none';
            }
          }

          // Neue Benachrichtigungen als Toast anzeigen
          if (data.benachrichtigungen && data.benachrichtigungen.length > 0) {
            // Nur die neuesten 3 anzeigen (um Spam zu vermeiden)
            const neue = data.benachrichtigungen.slice(0, 3);
            neue.forEach(notif => {
              showNotificationToast(notif);
            });
          }
        }
      })
      .catch(error => {
        console.error('Fehler beim Laden der Benachrichtigungen:', error);
      });
    }

    // Toast-Benachrichtigung anzeigen
    function showNotificationToast(notif) {
      // PrÃ¼fen ob diese Benachrichtigung bereits angezeigt wurde
      const storageKey = `notif_shown_${notif.ID}`;
      if (localStorage.getItem(storageKey)) {
        return; // Bereits angezeigt
      }

      // Toast-Container erstellen falls nicht vorhanden
      let toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
      }

      // Toast erstellen
      const toastId = 'toast-' + Date.now();
      const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              <strong>${notif.Titel}</strong><br>
              <small>${notif.Nachricht}</small>
              <div class="mt-2">
                <a href="${'{{ url_for("schichtbuch.thema_detail", thema_id=0) }}'.replace('/0', `/${notif.ThemaID}`)}" 
                   class="btn btn-sm btn-light me-2" onclick="markAsRead(${notif.ID})">
                  Ansehen
                </a>
                <button type="button" class="btn btn-sm btn-outline-light" onclick="markAsRead(${notif.ID}); document.getElementById('${toastId}').remove();">
                  SchlieÃŸen
                </button>
              </div>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close" onclick="markAsRead(${notif.ID})"></button>
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHtml);
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, { delay: 10000 });
      toast.show();
      
      // Als angezeigt markieren
      localStorage.setItem(storageKey, 'true');
      
      // Toast nach dem Ausblenden entfernen
      toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
      });
    }

    // Benachrichtigung als gelesen markieren
    function markAsRead(benachrichtigungId) {
      fetch(`{{ url_for("schichtbuch.api_benachrichtigung_gelesen", benachrichtigung_id=0) }}`.replace('/0', `/${benachrichtigungId}`), {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'

        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Badge aktualisieren
          loadBenachrichtigungen();
        }
      })
      .catch(error => {
        console.error('Fehler beim Markieren als gelesen:', error);
      });
    }

    // Benachrichtigungen beim Laden der Seite abrufen
    {% if session.user_id %}
    // Sofort beim Laden ausfÃ¼hren (auch wenn DOM bereits geladen ist)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        loadBenachrichtigungen();
      });
    } else {
      // DOM ist bereits geladen
      loadBenachrichtigungen();
    }
    
    // Alle 30 Sekunden aktualisieren
    setInterval(loadBenachrichtigungen, 30000);
    
    // Bei Seitenwechsel auch aktualisieren (fÃ¼r Single-Page-App-Verhalten)
    // Event-Listener fÃ¼r alle Navigation-Links
    document.addEventListener('click', function(e) {
      const link = e.target.closest('a');
      if (link && link.href && !link.href.startsWith('#')) {
        // Kurz warten, dann Benachrichtigungen neu laden
        setTimeout(loadBenachrichtigungen, 500);
      }
    });
    
    // Auch beim ZurÃ¼ck-Button im Browser
    window.addEventListener('popstate', function() {
      setTimeout(loadBenachrichtigungen, 500);
    });
    {% endif %}
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>

